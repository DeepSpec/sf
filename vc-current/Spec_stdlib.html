<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>Spec_stdlib: Specification of external malloc, free, exit functions</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/vc.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 5: Verifiable C</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">Spec_stdlib<span class="subtitle">Specification of external malloc, free, exit functions</span></h1>


<div class="doc">

<div class="paragraph"> </div>

<a id="lab178"></a><h1 class="section">Abstract Predicate Definition</h1>

</div>
<div class="code">

<span class="id" title="keyword">Require</span> <a class="idref" href="Preface.html#"><span class="id" title="library">VC.Preface</span></a>. <span class="comment">(*&nbsp;Check&nbsp;for&nbsp;the&nbsp;right&nbsp;version&nbsp;of&nbsp;VST&nbsp;*)</span><br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="library">VST.floyd.proofauto</span>.<br/>
<span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <span class="id" title="library">VC.stdlib</span>.<br/>
</div>

<div class="doc">
In the first view chapters of this volume (<a href="Verif_stack.html"><span class="inlineref">Verif_stack</span></a>,
  <a href="Verif_triang.html"><span class="inlineref">Verif_triang</span></a>, etc.) we demonstrated all-in-one-file C programs,
  and we used a form of <span class="inlinecode"><span class="id" title="var">malloc_token</span></span> with the type, 
</div>
<div class="code">

<span class="id" title="keyword">Require</span> <span class="id" title="library">VST.floyd.library</span>. <span class="comment">(*&nbsp;Only&nbsp;needed&nbsp;for&nbsp;the&nbsp;next&nbsp;line&nbsp;*)</span><br/>
<span class="id" title="keyword">About</span> <span class="id" title="axiom">VST.floyd.library.malloc_token</span>.<br/>
<span class="comment">(*&nbsp;&nbsp;library.malloc_token&nbsp;:&nbsp;compspecs&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;share&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;type&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;val&nbsp;<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>&nbsp;mpred<br/>
&nbsp;&nbsp;&nbsp;&nbsp;Arguments&nbsp;library.malloc_token&nbsp;{cs}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*)</span><br/>
</div>

<div class="doc">
That is, <span class="inlinecode"><span class="id" title="var">malloc_token</span></span> takes an implicit compspecs argument,
   and the interpretation of the <span class="inlinecode"><span class="id" title="keyword">type</span></span> argument depends on the
   compspecs.  Basically, the <span class="inlinecode"><span class="id" title="var">malloc_token</span></span> needs to know how many
   bytes the malloc'd record is, so it needs the compspecs in order
   to interpret the type.
       But now we are doing <i>modular</i> C programming, in which each .c file
   can have its own struct and union types -- that is, its own compspecs.
   Our <span class="inlinecode"><span class="id" title="var">malloc_token</span></span> with a compspecs parameter cannot assume that
   every module will have the same compspecs.  For modular programming,
   we'll start with a more primitive form,  <span class="inlinecode"><span class="id" title="var">malloc_token_sz</span></span>, that just 
   depends on the <i>size</i> of the object, of type <span class="inlinecode"><span class="id" title="var">Z</span></span>.  No compspecs required.
      Later in this file, we show how to recover the type-based
   <span class="inlinecode"><span class="id" title="var">malloc_token</span></span> <i>within</i> each module.

<div class="paragraph"> </div>

   In the memory-manager APD we have two abstract predicates, <span class="inlinecode"><span class="id" title="var">mem_mgr</span></span>
   and <span class="inlinecode"><span class="id" title="var">malloc_token</span></span>.  The predicate <span class="inlinecode"><span class="id" title="var">mem_mgr</span></span> represents the state
   of the memory manager's free list.  That is, when you call <span class="inlinecode"><span class="id" title="var">free</span>(<span class="id" title="var">p</span>)</span>
    you might imagine that the memory-block at address p gets
    added back into a free list (or some other data structure), and
    when you call <span class="inlinecode"><span class="id" title="var">malloc</span>(<span class="id" title="var">n</span>)</span> then it takes a block from the free list.
    Since the internal representation of the free list is private to
     this module (<span class="inlinecode"><span class="id" title="var">stdlib</span></span>), it's an abstract predicate.

<div class="paragraph"> </div>


</div>
<div class="code">

<span class="id" title="keyword">Record</span> <a id="MallocFreeAPD" class="idref" href="#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a> := {<br/>
&nbsp;&nbsp;&nbsp;<a id="mem_mgr" class="idref" href="#mem_mgr"><span class="id" title="projection">mem_mgr</span></a>: <span class="id" title="definition">globals</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="definition">mpred</span>;<br/>
&nbsp;&nbsp;&nbsp;<a id="malloc_token_sz" class="idref" href="#malloc_token_sz"><span class="id" title="projection">malloc_token_sz</span></a>: <span class="id" title="definition">share</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Numbers.BinNums.html#Z"><span class="id" title="inductive">Z</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="inductive">val</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="definition">mpred</span>;<br/>
&nbsp;&nbsp;&nbsp;<a id="malloc_token_sz_valid_pointer" class="idref" href="#malloc_token_sz_valid_pointer"><span class="id" title="projection">malloc_token_sz_valid_pointer</span></a>: <span class="id" title="keyword">∀</span> <a id="sh:4" class="idref" href="#sh:4"><span class="id" title="binder">sh</span></a> <a id="sz:5" class="idref" href="#sz:5"><span class="id" title="binder">sz</span></a> <a id="p:6" class="idref" href="#p:6"><span class="id" title="binder">p</span></a>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Spec_stdlib.html#sz:5"><span class="id" title="variable">sz</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#306329b0eca7a2b86c198702f594ad8e"><span class="id" title="notation">≤</span></a> 0 <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Spec_stdlib.html#malloc_token_sz:3"><span class="id" title="method">malloc_token_sz</span></a> <a class="idref" href="Spec_stdlib.html#sh:4"><span class="id" title="variable">sh</span></a> <a class="idref" href="Spec_stdlib.html#sz:5"><span class="id" title="variable">sz</span></a> <a class="idref" href="Spec_stdlib.html#p:6"><span class="id" title="variable">p</span></a> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="definition">valid_pointer</span> <a class="idref" href="Spec_stdlib.html#p:6"><span class="id" title="variable">p</span></a>;<br/>
&nbsp;&nbsp;&nbsp;<a id="malloc_token_sz_local_facts" class="idref" href="#malloc_token_sz_local_facts"><span class="id" title="projection">malloc_token_sz_local_facts</span></a>:  <span class="id" title="keyword">∀</span> <a id="sh:8" class="idref" href="#sh:8"><span class="id" title="binder">sh</span></a> <a id="sz:9" class="idref" href="#sz:9"><span class="id" title="binder">sz</span></a> <a id="p:10" class="idref" href="#p:10"><span class="id" title="binder">p</span></a>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Spec_stdlib.html#malloc_token_sz:3"><span class="id" title="method">malloc_token_sz</span></a> <a class="idref" href="Spec_stdlib.html#sh:8"><span class="id" title="variable">sh</span></a> <a class="idref" href="Spec_stdlib.html#sz:9"><span class="id" title="variable">sz</span></a> <a class="idref" href="Spec_stdlib.html#p:10"><span class="id" title="variable">p</span></a> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="notation">!!</span> <span class="id" title="definition">malloc_compatible</span> <a class="idref" href="Spec_stdlib.html#sz:9"><span class="id" title="variable">sz</span></a> <a class="idref" href="Spec_stdlib.html#p:10"><span class="id" title="variable">p</span></a><br/>
}.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Resolve</span> <span class="id" title="var">malloc_token_sz_valid_pointer</span> : <span class="id" title="var">valid_pointer</span>.<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Resolve</span> <span class="id" title="var">malloc_token_sz_local_facts</span> : <span class="id" title="var">saturate_local</span>.<br/>
</div>

<div class="doc">
<a id="lab179"></a><h1 class="section">Abstract Specification Interface</h1>

<div class="paragraph"> </div>

 As usual, build a Section to parameterize the interface by the APD: 
</div>
<div class="code">
<span class="id" title="keyword">Section</span> <a id="MallocFreeASI" class="idref" href="#MallocFreeASI"><span class="id" title="section">MallocFreeASI</span></a>.<br/>
<span class="id" title="keyword">Variable</span> <a id="MallocFreeASI.M" class="idref" href="#MallocFreeASI.M"><span class="id" title="variable">M</span></a>:<a class="idref" href="Spec_stdlib.html#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a>.<br/>
</div>

<div class="doc">
Specification of <span class="inlinecode"><span class="id" title="var">malloc</span></span> has the same issue with <span class="inlinecode"><span class="id" title="var">compspecs</span></span> that we
  discussed above for <span class="inlinecode"><span class="id" title="var">malloc_token</span></span>:  That is, we need the ASI to be 
  independent of any particular module's struct/union declarations.
  So we will define <span class="inlinecode"><span class="id" title="var">malloc_spec_sz</span></span> which is a size-based, not type-based,
  specification. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="malloc_spec_sz" class="idref" href="#malloc_spec_sz"><span class="id" title="definition">malloc_spec_sz</span></a> :=<br/>
&nbsp;<span class="id" title="notation">DECLARE</span> <span class="id" title="definition">_malloc</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">WITH</span> <a id="n:15" class="idref" href="#n:15"><span class="id" title="binder">n</span></a><span class="id" title="notation">:</span><a class="idref" href="http://coq.inria.fr/library//Coq.Numbers.BinNums.html#Z"><span class="id" title="inductive">Z</span></a><span class="id" title="notation">,</span> <a id="gv:16" class="idref" href="#gv:16"><span class="id" title="binder">gv</span></a><span class="id" title="notation">:</span> <span class="id" title="definition">globals</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PRE</span> <span class="id" title="notation">[</span> <span class="id" title="definition">size_t</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">(</span>0 <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#6f909ea2391c6073ff1047e870dd64e<sub>2</sub>"><span class="id" title="notation">≤</span></a> <a class="idref" href="Spec_stdlib.html#n:13"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#6f909ea2391c6073ff1047e870dd64e<sub>2</sub>"><span class="id" title="notation">≤</span></a> <span class="id" title="definition">Ptrofs.max_unsigned</span><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PARAMS</span> <span class="id" title="notation">(</span><span class="id" title="definition">Vptrofs</span> (<span class="id" title="definition">Ptrofs.repr</span> <a class="idref" href="Spec_stdlib.html#n:13"><span class="id" title="variable">n</span></a>)<span class="id" title="notation">)</span> <span class="id" title="notation">GLOBALS</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#gv:14"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#MallocFreeASI.M"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:14"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">POST</span> <span class="id" title="notation">[</span> <span class="id" title="definition">tptr</span> <span class="id" title="definition">tvoid</span> <span class="id" title="notation">]</span> <span class="id" title="notation">EX</span> <a id="p:17" class="idref" href="#p:17"><span class="id" title="binder">p</span></a>:<span class="id" title="var">_</span><span class="id" title="notation">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">LOCAL</span> <span class="id" title="notation">(</span><span class="id" title="constructor">temp</span> <span class="id" title="definition">ret_temp</span> <a class="idref" href="Spec_stdlib.html#p:17"><span class="id" title="variable">p</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#MallocFreeASI.M"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:16"><span class="id" title="variable">gv</span></a><span class="id" title="notation">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="definition">eq_dec</span> <a class="idref" href="Spec_stdlib.html#p:17"><span class="id" title="variable">p</span></a> <span class="id" title="definition">nullval</span> <span class="id" title="keyword">then</span> <span class="id" title="method">emp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="Spec_stdlib.html#malloc_token_sz"><span class="id" title="projection">malloc_token_sz</span></a> <a class="idref" href="Spec_stdlib.html#MallocFreeASI.M"><span class="id" title="variable">M</span></a> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#n:15"><span class="id" title="variable">n</span></a> <a class="idref" href="Spec_stdlib.html#p:17"><span class="id" title="variable">p</span></a> <span class="id" title="notation">×</span> <span class="id" title="definition">memory_block</span> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#n:15"><span class="id" title="variable">n</span></a> <a class="idref" href="Spec_stdlib.html#p:17"><span class="id" title="variable">p</span></a>)<span class="id" title="notation">)</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="free_spec_sz" class="idref" href="#free_spec_sz"><span class="id" title="definition">free_spec_sz</span></a> :=<br/>
&nbsp;<span class="id" title="notation">DECLARE</span> <span class="id" title="definition">_free</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">WITH</span> <a id="n:21" class="idref" href="#n:21"><span class="id" title="binder">n</span></a><span class="id" title="notation">:</span><a class="idref" href="http://coq.inria.fr/library//Coq.Numbers.BinNums.html#Z"><span class="id" title="inductive">Z</span></a><span class="id" title="notation">,</span> <a id="p:22" class="idref" href="#p:22"><span class="id" title="binder">p</span></a><span class="id" title="notation">:</span><span class="id" title="inductive">val</span><span class="id" title="notation">,</span> <a id="gv:23" class="idref" href="#gv:23"><span class="id" title="binder">gv</span></a><span class="id" title="notation">:</span> <span class="id" title="definition">globals</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PRE</span> <span class="id" title="notation">[</span> <span class="id" title="definition">tptr</span> <span class="id" title="definition">tvoid</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PARAMS</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#p:19"><span class="id" title="variable">p</span></a><span class="id" title="notation">)</span> <span class="id" title="notation">GLOBALS</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#gv:20"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#MallocFreeASI.M"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:20"><span class="id" title="variable">gv</span></a><span class="id" title="notation">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="definition">eq_dec</span> <a class="idref" href="Spec_stdlib.html#p:19"><span class="id" title="variable">p</span></a> <span class="id" title="definition">nullval</span> <span class="id" title="keyword">then</span> <span class="id" title="method">emp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="Spec_stdlib.html#malloc_token_sz"><span class="id" title="projection">malloc_token_sz</span></a> <a class="idref" href="Spec_stdlib.html#MallocFreeASI.M"><span class="id" title="variable">M</span></a> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#n:18"><span class="id" title="variable">n</span></a> <a class="idref" href="Spec_stdlib.html#p:19"><span class="id" title="variable">p</span></a> <span class="id" title="notation">×</span> <span class="id" title="definition">memory_block</span> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#n:18"><span class="id" title="variable">n</span></a> <a class="idref" href="Spec_stdlib.html#p:19"><span class="id" title="variable">p</span></a>)<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">POST</span> <span class="id" title="notation">[</span> <span class="id" title="constructor">Tvoid</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">LOCAL</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#MallocFreeASI.M"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:23"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span>.<br/>
</div>

<div class="doc">
 Of course the <span class="inlinecode"><span class="id" title="var">exit</span></span> system call is not really part of the malloc/free 
   library, but this is a convenient place to put its specification. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="exit_spec" class="idref" href="#exit_spec"><span class="id" title="definition">exit_spec</span></a> :=<br/>
&nbsp;<span class="id" title="notation">DECLARE</span> <span class="id" title="definition">_exit</span><br/>
&nbsp;<span class="id" title="notation">WITH</span> <a id="i:25" class="idref" href="#i:25"><span class="id" title="binder">i</span></a><span class="id" title="notation">:</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Numbers.BinNums.html#Z"><span class="id" title="inductive">Z</span></a><br/>
&nbsp;<span class="id" title="notation">PRE</span> <span class="id" title="notation">[</span><span class="id" title="definition">tint</span><span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span> <span class="id" title="notation">PARAMS</span> <span class="id" title="notation">(</span><span class="id" title="constructor">Vint</span> (<span class="id" title="definition">Int.repr</span> <a class="idref" href="Spec_stdlib.html#i:24"><span class="id" title="variable">i</span></a>)<span class="id" title="notation">)</span> <span class="id" title="notation">GLOBALS</span> <span class="id" title="notation">()</span> <span class="id" title="notation">SEP</span><span class="id" title="notation">()</span><br/>
&nbsp;<span class="id" title="notation">POST</span> <span class="id" title="notation">[</span> <span class="id" title="definition">tvoid</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span><span class="id" title="notation">(</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><span class="id" title="notation">)</span> <span class="id" title="notation">LOCAL</span><span class="id" title="notation">()</span> <span class="id" title="notation">SEP</span><span class="id" title="notation">()</span>.<br/>
</div>

<div class="doc">
And now we can construct the ASI, which (as usual) is just a list
  of (APD-parameterized) funspecs. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="MallocFreeASI" class="idref" href="#MallocFreeASI"><span class="id" title="definition">MallocFreeASI</span></a>:<span class="id" title="definition">funspecs</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">[</span></a> <a class="idref" href="Spec_stdlib.html#malloc_spec_sz"><span class="id" title="definition">malloc_spec_sz</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <a class="idref" href="Spec_stdlib.html#free_spec_sz"><span class="id" title="definition">free_spec_sz</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">;</span></a> <a class="idref" href="Spec_stdlib.html#exit_spec"><span class="id" title="definition">exit_spec</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#e76c6291366b599375c28eba0aae94bb"><span class="id" title="notation">]</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="Spec_stdlib.html#MallocFreeASI"><span class="id" title="section">MallocFreeASI</span></a>.<br/>
</div>

<div class="doc">
<a id="lab180"></a><h1 class="section">Type-based specification of malloc and free</h1>

<div class="paragraph"> </div>

 Of course, it is much easer for the user to use a funspec for
  malloc whose postcondition has a <span class="inlinecode"><span class="id" title="var">data_at_</span></span> of the right type.
  So here we will define an alternate <span class="inlinecode"><span class="id" title="var">malloc_token</span></span> and <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span>
  that uses compspecs and types. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="malloc_token" class="idref" href="#malloc_token"><span class="id" title="definition">malloc_token</span></a> {<a id="cs:26" class="idref" href="#cs:26"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} (<a id="M:27" class="idref" href="#M:27"><span class="id" title="binder">M</span></a>:<a class="idref" href="Spec_stdlib.html#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a>) <a id="sh:28" class="idref" href="#sh:28"><span class="id" title="binder">sh</span></a> <a id="t:29" class="idref" href="#t:29"><span class="id" title="binder">t</span></a> <a id="v:30" class="idref" href="#v:30"><span class="id" title="binder">v</span></a> := <br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">!!</span> <span class="id" title="definition">field_compatible</span> <a class="idref" href="Spec_stdlib.html#t:29"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a> <a class="idref" href="Spec_stdlib.html#v:30"><span class="id" title="variable">v</span></a> <span class="id" title="notation">&amp;&amp;</span> <br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="Spec_stdlib.html#malloc_token_sz"><span class="id" title="projection">malloc_token_sz</span></a> <a class="idref" href="Spec_stdlib.html#M:27"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#sh:28"><span class="id" title="variable">sh</span></a> (<span class="id" title="definition">sizeof</span> <a class="idref" href="Spec_stdlib.html#t:29"><span class="id" title="variable">t</span></a>) <a class="idref" href="Spec_stdlib.html#v:30"><span class="id" title="variable">v</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="malloc_token_valid_pointer" class="idref" href="#malloc_token_valid_pointer"><span class="id" title="lemma">malloc_token_valid_pointer</span></a>: <span class="id" title="keyword">∀</span> {<a id="cs:31" class="idref" href="#cs:31"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} <a id="M:32" class="idref" href="#M:32"><span class="id" title="binder">M</span></a> <a id="sh:33" class="idref" href="#sh:33"><span class="id" title="binder">sh</span></a> <a id="t:34" class="idref" href="#t:34"><span class="id" title="binder">t</span></a> <a id="p:35" class="idref" href="#p:35"><span class="id" title="binder">p</span></a>, <br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">sizeof</span> <a class="idref" href="Spec_stdlib.html#t:34"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#306329b0eca7a2b86c198702f594ad8e"><span class="id" title="notation">≤</span></a> 0 <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a> <a class="idref" href="Spec_stdlib.html#M:32"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#sh:33"><span class="id" title="variable">sh</span></a> <a class="idref" href="Spec_stdlib.html#t:34"><span class="id" title="variable">t</span></a> <a class="idref" href="Spec_stdlib.html#p:35"><span class="id" title="variable">p</span></a> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="definition">valid_pointer</span> <a class="idref" href="Spec_stdlib.html#p:35"><span class="id" title="variable">p</span></a>.<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a>.<br/>
&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="method">andp_left2</span>. <span class="id" title="tactic">apply</span> <a class="idref" href="Spec_stdlib.html#malloc_token_sz_valid_pointer"><span class="id" title="projection">malloc_token_sz_valid_pointer</span></a>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Ltac</span> <span class="id" title="var">malloc_token_data_at_valid_pointer</span> :=<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;If&nbsp;the&nbsp;size&nbsp;of&nbsp;t&nbsp;is&nbsp;unknown,&nbsp;can&nbsp;still&nbsp;prove&nbsp;valid&nbsp;pointer<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;from&nbsp;(malloc_token&nbsp;sh&nbsp;t&nbsp;p&nbsp;*&nbsp;...&nbsp;*&nbsp;data_at<span class="inlinecode"><span class="id" title="var">_</span></span>&nbsp;sh&nbsp;t&nbsp;p)&nbsp;&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> &#x22A2; ?<span class="id" title="var">A</span> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="definition">valid_pointer</span> ?<span class="id" title="var">p</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">A</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="keyword">context</span> [<a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ?<span class="id" title="var">t</span> <span class="id" title="var">p</span>] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> (<span class="id" title="tactic">assert</span> (<span class="id" title="definition">sizeof</span> <span class="id" title="var">t</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#306329b0eca7a2b86c198702f594ad8e"><span class="id" title="notation">≤</span></a> 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">by</span> (<span class="id" title="tactic">simpl</span> <span class="id" title="var">sizeof</span> <span class="id" title="keyword">in</span> *; <span class="id" title="var">rep_lia</span>); <span class="id" title="tactic">fail</span> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> (<span class="id" title="tactic">assert</span> (<span class="id" title="definition">sizeof</span> <span class="id" title="var">t</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> 0)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">by</span> (<span class="id" title="tactic">simpl</span> <span class="id" title="var">sizeof</span> <span class="id" title="keyword">in</span> *; <span class="id" title="var">rep_lia</span>); <span class="id" title="tactic">fail</span> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="definition">zlt</span> 0 (<span class="id" title="definition">sizeof</span> <span class="id" title="var">t</span>));<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span> <span class="id" title="keyword">with</span> <span class="id" title="var">valid_pointer</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="keyword">context</span> [<a class="idref" href="Spec_stdlib.html#malloc_token_sz"><span class="id" title="projection">malloc_token_sz</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ?<span class="id" title="var">n</span> <span class="id" title="var">p</span>] ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> (<span class="id" title="tactic">assert</span> (<span class="id" title="var">n</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#306329b0eca7a2b86c198702f594ad8e"><span class="id" title="notation">≤</span></a> 0) <span class="id" title="tactic">by</span> <span class="id" title="var">rep_lia</span>; <span class="id" title="tactic">fail</span> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> (<span class="id" title="tactic">assert</span> (<span class="id" title="var">n</span> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> 0) <span class="id" title="tactic">by</span> <span class="id" title="var">rep_lia</span>; <span class="id" title="tactic">fail</span> 1);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="definition">zlt</span> 0 <span class="id" title="var">n</span>);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span> <span class="id" title="keyword">with</span> <span class="id" title="var">valid_pointer</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Extern</span> 1 (<a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="definition">valid_pointer</span> <span class="id" title="var">_</span>) ⇒<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">simple</span> <span class="id" title="tactic">apply</span> <a class="idref" href="Spec_stdlib.html#malloc_token_valid_pointer"><span class="id" title="lemma">malloc_token_valid_pointer</span></a>; <span class="id" title="var">data_at_valid_aux</span>) : <span class="id" title="var">valid_pointer</span>.<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Extern</span> 4 (<span class="id" title="var">_</span> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="definition">valid_pointer</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="var">malloc_token_data_at_valid_pointer</span> : <span class="id" title="var">valid_pointer</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="malloc_token_local_facts" class="idref" href="#malloc_token_local_facts"><span class="id" title="lemma">malloc_token_local_facts</span></a>:  <span class="id" title="keyword">∀</span> {<a id="cs:36" class="idref" href="#cs:36"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} <a id="M:37" class="idref" href="#M:37"><span class="id" title="binder">M</span></a> <a id="sh:38" class="idref" href="#sh:38"><span class="id" title="binder">sh</span></a> <a id="t:39" class="idref" href="#t:39"><span class="id" title="binder">t</span></a> <a id="p:40" class="idref" href="#p:40"><span class="id" title="binder">p</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a> <a class="idref" href="Spec_stdlib.html#M:37"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#sh:38"><span class="id" title="variable">sh</span></a> <a class="idref" href="Spec_stdlib.html#t:39"><span class="id" title="variable">t</span></a> <a class="idref" href="Spec_stdlib.html#p:40"><span class="id" title="variable">p</span></a> <span class="id" title="notation"><span class="nowrap">&vert;--</span></span> <span class="id" title="notation">!!</span> <span class="id" title="notation">(</span><span class="id" title="definition">field_compatible</span> <a class="idref" href="Spec_stdlib.html#t:39"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a> <a class="idref" href="Spec_stdlib.html#p:40"><span class="id" title="variable">p</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a> <span class="id" title="definition">malloc_compatible</span> (<span class="id" title="definition">sizeof</span> <a class="idref" href="Spec_stdlib.html#t:39"><span class="id" title="variable">t</span></a>) <a class="idref" href="Spec_stdlib.html#p:40"><span class="id" title="variable">p</span></a><span class="id" title="notation">)</span>.<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">intros</span>.<br/>
&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a>.<br/>
&nbsp;<span class="id" title="var">normalize</span>. <span class="id" title="tactic">rewrite</span> <span class="id" title="lemma">prop_and</span>.<br/>
&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="method">andp_right</span>. <span class="id" title="tactic">apply</span> <span class="id" title="method">prop_right</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;<span class="id" title="tactic">apply</span> <a class="idref" href="Spec_stdlib.html#malloc_token_sz_local_facts"><span class="id" title="projection">malloc_token_sz_local_facts</span></a>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Resolve</span> <span class="id" title="var">malloc_token_local_facts</span> : <span class="id" title="var">saturate_local</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="malloc_spec" class="idref" href="#malloc_spec"><span class="id" title="definition">malloc_spec</span></a> (<a id="M:41" class="idref" href="#M:41"><span class="id" title="binder">M</span></a>:<a class="idref" href="Spec_stdlib.html#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a>) {<a id="cs:42" class="idref" href="#cs:42"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} (<a id="t:43" class="idref" href="#t:43"><span class="id" title="binder">t</span></a>: <span class="id" title="inductive">type</span>) :=<br/>
&nbsp;<span class="id" title="notation">DECLARE</span> <span class="id" title="definition">_malloc</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">WITH</span> <a id="gv:45" class="idref" href="#gv:45"><span class="id" title="binder">gv</span></a><span class="id" title="notation">:</span> <span class="id" title="definition">globals</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PRE</span> <span class="id" title="notation">[</span> <span class="id" title="definition">size_t</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">(</span>0 <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#6f909ea2391c6073ff1047e870dd64e<sub>2</sub>"><span class="id" title="notation">≤</span></a> <span class="id" title="definition">sizeof</span> <a class="idref" href="Spec_stdlib.html#t:43"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#6f909ea2391c6073ff1047e870dd64e<sub>2</sub>"><span class="id" title="notation">≤</span></a> <span class="id" title="definition">Ptrofs.max_unsigned</span><span class="id" title="notation">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">complete_legal_cosu_type</span> <a class="idref" href="Spec_stdlib.html#t:43"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><span class="id" title="notation">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="definition">natural_aligned</span> <span class="id" title="definition">natural_alignment</span> <a class="idref" href="Spec_stdlib.html#t:43"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PARAMS</span> <span class="id" title="notation">(</span><span class="id" title="definition">Vptrofs</span> (<span class="id" title="definition">Ptrofs.repr</span> (<span class="id" title="definition">sizeof</span> <a class="idref" href="Spec_stdlib.html#t:43"><span class="id" title="variable">t</span></a>))<span class="id" title="notation">)</span> <span class="id" title="notation">GLOBALS</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#gv:44"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#M:41"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:44"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">POST</span> <span class="id" title="notation">[</span> <span class="id" title="definition">tptr</span> <span class="id" title="definition">tvoid</span> <span class="id" title="notation">]</span> <span class="id" title="notation">EX</span> <a id="p:46" class="idref" href="#p:46"><span class="id" title="binder">p</span></a>:<span class="id" title="var">_</span><span class="id" title="notation">,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">LOCAL</span> <span class="id" title="notation">(</span><span class="id" title="constructor">temp</span> <span class="id" title="definition">ret_temp</span> <a class="idref" href="Spec_stdlib.html#p:46"><span class="id" title="variable">p</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#M:41"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:45"><span class="id" title="variable">gv</span></a><span class="id" title="notation">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="definition">eq_dec</span> <a class="idref" href="Spec_stdlib.html#p:46"><span class="id" title="variable">p</span></a> <span class="id" title="definition">nullval</span> <span class="id" title="keyword">then</span> <span class="id" title="method">emp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a> <a class="idref" href="Spec_stdlib.html#M:41"><span class="id" title="variable">M</span></a> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#t:43"><span class="id" title="variable">t</span></a> <a class="idref" href="Spec_stdlib.html#p:46"><span class="id" title="variable">p</span></a> <span class="id" title="notation">×</span> <span class="id" title="definition">data_at_</span> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#t:43"><span class="id" title="variable">t</span></a> <a class="idref" href="Spec_stdlib.html#p:46"><span class="id" title="variable">p</span></a>)<span class="id" title="notation">)</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="free_spec" class="idref" href="#free_spec"><span class="id" title="definition">free_spec</span></a> (<a id="M:47" class="idref" href="#M:47"><span class="id" title="binder">M</span></a>:<a class="idref" href="Spec_stdlib.html#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a>)  {<a id="cs:48" class="idref" href="#cs:48"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} (<a id="t:49" class="idref" href="#t:49"><span class="id" title="binder">t</span></a>: <span class="id" title="inductive">type</span>) :=<br/>
&nbsp;<span class="id" title="notation">DECLARE</span> <span class="id" title="definition">_free</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">WITH</span> <a id="p:52" class="idref" href="#p:52"><span class="id" title="binder">p</span></a><span class="id" title="notation">:</span> <span class="id" title="inductive">val</span><span class="id" title="notation">,</span> <a id="gv:53" class="idref" href="#gv:53"><span class="id" title="binder">gv</span></a><span class="id" title="notation">:</span> <span class="id" title="definition">globals</span><br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PRE</span> <span class="id" title="notation">[</span> <span class="id" title="definition">tptr</span> <span class="id" title="definition">tvoid</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PARAMS</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#p:50"><span class="id" title="variable">p</span></a><span class="id" title="notation">)</span> <span class="id" title="notation">GLOBALS</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#gv:51"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#M:47"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:51"><span class="id" title="variable">gv</span></a><span class="id" title="notation">;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <span class="id" title="definition">eq_dec</span> <a class="idref" href="Spec_stdlib.html#p:50"><span class="id" title="variable">p</span></a> <span class="id" title="definition">nullval</span> <span class="id" title="keyword">then</span> <span class="id" title="method">emp</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> (<a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a> <a class="idref" href="Spec_stdlib.html#M:47"><span class="id" title="variable">M</span></a> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#t:49"><span class="id" title="variable">t</span></a> <a class="idref" href="Spec_stdlib.html#p:50"><span class="id" title="variable">p</span></a> <span class="id" title="notation">×</span> <span class="id" title="definition">data_at_</span> <span class="id" title="definition">Ews</span> <a class="idref" href="Spec_stdlib.html#t:49"><span class="id" title="variable">t</span></a> <a class="idref" href="Spec_stdlib.html#p:50"><span class="id" title="variable">p</span></a>)<span class="id" title="notation">)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">POST</span> <span class="id" title="notation">[</span> <span class="id" title="constructor">Tvoid</span> <span class="id" title="notation">]</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">PROP</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">LOCAL</span> <span class="id" title="notation">()</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="notation">SEP</span> <span class="id" title="notation">(</span><a class="idref" href="Spec_stdlib.html#mem_mgr"><span class="id" title="projection">mem_mgr</span></a> <a class="idref" href="Spec_stdlib.html#M:47"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#gv:53"><span class="id" title="variable">gv</span></a><span class="id" title="notation">)</span>.<br/>
</div>

<div class="doc">
<a id="lab181"></a><h2 class="section">How to use the type-based <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span></h2>

<div class="paragraph"> </div>

 Both <span class="inlinecode"><span class="id" title="var">malloc_spec_sz</span></span> and <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span> are specifications of the 
  same malloc function, so any given program (.c file) can be verified
  using either of the specs.  However, since the ASI provides
  <span class="inlinecode"><span class="id" title="var">malloc_spec_sz</span></span>, then in order to use <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span> in the verification
  of the client, one must do <span class="inlinecode"><span class="id" title="var">forward_call</span></span> with the (optional)
  <span class="inlinecode"><span class="id" title="var">funspec_sub</span></span> argument.

<div class="paragraph"> </div>

   Here we prove that (for any compspecs), 
    <span class="inlinecode"><span class="id" title="var">malloc_spec_sz</span></span> implies <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="malloc_spec_sub" class="idref" href="#malloc_spec_sub"><span class="id" title="lemma">malloc_spec_sub</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span>  (<a id="M:54" class="idref" href="#M:54"><span class="id" title="binder">M</span></a>:<a class="idref" href="Spec_stdlib.html#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a>) {<a id="cs:55" class="idref" href="#cs:55"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} (<a id="t:56" class="idref" href="#t:56"><span class="id" title="binder">t</span></a>: <span class="id" title="inductive">type</span>), <br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="definition">funspec_sub</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a> (<a class="idref" href="Spec_stdlib.html#malloc_spec_sz"><span class="id" title="definition">malloc_spec_sz</span></a> <a class="idref" href="Spec_stdlib.html#M:54"><span class="id" title="variable">M</span></a>)) (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a> (<a class="idref" href="Spec_stdlib.html#malloc_spec"><span class="id" title="definition">malloc_spec</span></a> <a class="idref" href="Spec_stdlib.html#M:54"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#t:56"><span class="id" title="variable">t</span></a>)).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">do_funspec_sub</span>. <span class="id" title="tactic">rename</span> <span class="id" title="var">w</span> <span class="id" title="var">into</span> <span class="id" title="var">gv</span>. <span class="id" title="tactic">clear</span> <span class="id" title="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">Exists</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="definition">sizeof</span> <span class="id" title="var">t</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">gv</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="method">emp</span>. <span class="id" title="tactic">simpl</span>; <span class="id" title="var">entailer</span>!.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">tau</span> ? ?. <span class="id" title="var">Exists</span> (<span class="id" title="definition">eval_id</span> <span class="id" title="definition">ret_temp</span> <span class="id" title="var">tau</span>).<br/>
&nbsp;&nbsp;<span class="id" title="var">entailer</span>!.<br/>
&nbsp;&nbsp;<span class="id" title="var">if_tac</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">assert_PROP</span> (<span class="id" title="definition">field_compatible</span> <span class="id" title="var">t</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a> (<span class="id" title="definition">eval_id</span> <span class="id" title="definition">ret_temp</span> <span class="id" title="var">tau</span>)).<br/>
&nbsp;&nbsp;{ <span class="id" title="var">entailer</span>!.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="lemma">malloc_compatible_field_compatible</span>; <span class="id" title="tactic">auto</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">entailer</span>!.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <span class="id" title="lemma">memory_block_data_at_</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="free_spec_sub" class="idref" href="#free_spec_sub"><span class="id" title="lemma">free_spec_sub</span></a>:<br/>
&nbsp;<span class="id" title="keyword">∀</span> (<a id="M:57" class="idref" href="#M:57"><span class="id" title="binder">M</span></a>:<a class="idref" href="Spec_stdlib.html#MallocFreeAPD"><span class="id" title="record">MallocFreeAPD</span></a>) {<a id="cs:58" class="idref" href="#cs:58"><span class="id" title="binder">cs</span></a>: <span class="id" title="class">compspecs</span>} (<a id="t:59" class="idref" href="#t:59"><span class="id" title="binder">t</span></a>: <span class="id" title="inductive">type</span>), <br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="definition">funspec_sub</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a> (<a class="idref" href="Spec_stdlib.html#free_spec_sz"><span class="id" title="definition">free_spec_sz</span></a> <a class="idref" href="Spec_stdlib.html#M:57"><span class="id" title="variable">M</span></a>)) (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#snd"><span class="id" title="definition">snd</span></a> (<a class="idref" href="Spec_stdlib.html#free_spec"><span class="id" title="definition">free_spec</span></a> <a class="idref" href="Spec_stdlib.html#M:57"><span class="id" title="variable">M</span></a> <a class="idref" href="Spec_stdlib.html#t:59"><span class="id" title="variable">t</span></a>)).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">do_funspec_sub</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">w</span> <span class="id" title="keyword">as</span> [<span class="id" title="var">p</span> <span class="id" title="var">gv</span>]. <span class="id" title="tactic">clear</span> <span class="id" title="var">H</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">Exists</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="definition">sizeof</span> <span class="id" title="var">t</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">p</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">gv</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <span class="id" title="method">emp</span>. <span class="id" title="tactic">simpl</span>; <span class="id" title="var">entailer</span>!.<br/>
&nbsp;&nbsp;<span class="id" title="var">if_tac</span>; <span class="id" title="tactic">trivial</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">sep_apply</span> <span class="id" title="lemma">data_at__memory_block_cancel</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Spec_stdlib.html#malloc_token"><span class="id" title="definition">malloc_token</span></a>; <span class="id" title="var">entailer</span>!.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Now, the pattern for using <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span> will be as shown in
  <a href="VSU_stack.html"><span class="inlineref">VSU_stack</span></a>, like this:

<div class="paragraph"> </div>

   <span class="inlinecode"><span class="id" title="var">forward_call</span></span> <span class="inlinecode">(<span class="id" title="var">malloc_spec_sub</span></span> <span class="inlinecode"><span class="id" title="var">M</span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span> <span class="inlinecode"><span class="id" title="var">gv</span></span>

<div class="paragraph"> </div>

   <span class="inlinecode"><span class="id" title="var">forward_call</span></span> <span class="inlinecode">(<span class="id" title="var">free_spec_sub</span></span> <span class="inlinecode"><span class="id" title="var">M</span></span> <span class="inlinecode">(<span class="id" title="var">Tstruct</span></span> <span class="inlinecode"><span class="id" title="var">_cons</span></span> <span class="inlinecode"><span class="id" title="var">noattr</span>))</span> <span class="inlinecode">(<span class="id" title="var">q</span>,</span> <span class="inlinecode"><span class="id" title="var">gv</span>)</span>

<div class="paragraph"> </div>

   It works like this:  <span class="inlinecode"><span class="id" title="var">t</span></span> (or, for example, <span class="inlinecode"><span class="id" title="var">Tstruct</span></span> <span class="inlinecode"><span class="id" title="var">_cons</span></span> <span class="inlinecode"><span class="id" title="var">noattr</span></span>) is
   any type of the client's choosing, interpreted using the client's own
   compspecs.  <span class="inlinecode"><span class="id" title="var">forward_call</span></span> looks up <span class="inlinecode"><span class="id" title="var">malloc</span></span> in the imported
   ASIs (that is, in the Gprog), and finds <span class="inlinecode"><span class="id" title="var">malloc_spec_sz</span></span> as its 
   specification.   Then it uses the <span class="inlinecode"><span class="id" title="var">funspec_sub</span></span> proof to adapt
   the spec into <span class="inlinecode"><span class="id" title="var">malloc_spec</span></span> <span class="inlinecode"><span class="id" title="var">M</span></span> <span class="inlinecode">{<span class="id" title="var">cs</span>}</span> <span class="inlinecode"><span class="id" title="var">t</span></span>, where the <span class="inlinecode"><span class="id" title="var">cs</span></span> argument is
   instantiated using the <i>client's</i>  compspecs, as desired.

<div class="paragraph"> </div>

   And similarly for <span class="inlinecode"><span class="id" title="var">free</span></span>.

<div class="paragraph"> </div>

<a id="lab182"></a><h2 class="section">Next Chapter: <a href="VSU_stack.html"><span class="inlineref">VSU_stack</span></a></h2>

</div>
<div class="code">

<span class="comment">(*&nbsp;2023-09-27&nbsp;19:43&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>