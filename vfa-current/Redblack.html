<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>Redblack: Red-Black Trees</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/vfa.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 3: Verified Functional Algorithms</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
   <li class='section_name'><a href='deps.html'>Roadmap</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">Redblack<span class="subtitle">Red-Black Trees</span></h1>


<div class="doc">

<div class="paragraph"> </div>

 Red-black trees are a kind of <i>balanced</i> binary search tree (BST).
    Keeping the tree balanced ensures that the worst-case running
    time of operations is logarithmic rather than linear. 
<div class="paragraph"> </div>

 This chapter uses Okasaki's algorithms for red-black trees.
    If you don't recall those or haven't seem them in a while, read one
    of the following:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Red-Black Trees in a Functional Setting, by Chris Okasaki.
      <i>Journal of Functional Programming</i>, 9(4):471-477, July 1999.
      Available from <a href="https://doi.org/10.1017/S0956796899003494"><span class="inlineref" <a href='https://doi.org/10.1017/S0956796899003494</span></a>.'>https://doi.org/10.1017/S0956796899003494</span></a>.</a>
      Archived at
      <a href="https://web.archive.org/web/20070926220746 <a href='http://www.eecs.usma.edu/webs/people/okasaki/jfp99.ps"><span'>http://www.eecs.usma.edu/webs/people/okasaki/jfp99.ps"><span</a>class="inlineref" <a href='https://web.archive.org/web/20070926220746/http://www.eecs.usma.edu/webs/people/okasaki/jfp99.ps</span></a>.'>https://web.archive.org/web/20070926220746/http://www.eecs.usma.edu/webs/people/okasaki/jfp99.ps</span></a>.</a>

<div class="paragraph"> </div>


</li>
<li> <i>Purely Functional Data Structures</i>, by Chris Okasaki. Section
      3.3.  Cambridge University Press, 1998.

</li>
</ul>

<div class="paragraph"> </div>

    You can also consult Wikipedia or other standard textbooks, though
    they are likely to use different, imperative implementations. 
<div class="paragraph"> </div>

 This chapter is based on the Coq standard library module
    <span class="inlinecode"><span class="id" title="var">MSetRBT</span></span>, which can be found at
    <span class="inlinecode"><span class="id" title="var">https</span>://<span class="id" title="var">coq.inria.fr</span>/<span class="id" title="var">distrib</span>/<span class="id" title="var">current</span>/<span class="id" title="var">stdlib</span>/<span class="id" title="var">Coq.MSets.MSetRBT.html</span></span>.
    The design decisions for that module are described in the
    following paper:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Efficient Verified Red-Black Trees, by Andrew W. Appel,
      September 2011.  Available from
      <a href="http://www.cs.princeton.edu/~appel/papers/redblack.pdf"><span class="inlineref" <a href='http://www.cs.princeton.edu/~appel/papers/redblack.pdf</span></a>.'>http://www.cs.princeton.edu/~appel/papers/redblack.pdf</span></a>.</a> 

</li>
</ul>
</div>

<div class="doc">
<a id="lab200"></a><h1 class="section">Implementation</h1>

<div class="paragraph"> </div>

 We use the <span class="inlinecode"><span class="id" title="var">int</span></span> type axiomatized in <a href="Extract.html"><span class="inlineref">Extract</span></a> as the
    key type. 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="key" class="idref" href="#key"><span class="id" title="definition">key</span></a> := <a class="idref" href="Extract.html#int"><span class="id" title="axiom">int</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a id="color" class="idref" href="#color"><span class="id" title="inductive">color</span></a> := <a id="Red" class="idref" href="#Red"><span class="id" title="constructor">Red</span></a> | <a id="Black" class="idref" href="#Black"><span class="id" title="constructor">Black</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a id="tree" class="idref" href="#tree"><span class="id" title="inductive">tree</span></a> (<a id="V:3" class="idref" href="#V:3"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) : <span class="id" title="keyword">Type</span> :=<br/>
| <a id="E" class="idref" href="#E"><span class="id" title="constructor">E</span></a> : <a class="idref" href="Redblack.html#tree:4"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:3"><span class="id" title="variable">V</span></a><br/>
| <a id="T" class="idref" href="#T"><span class="id" title="constructor">T</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#tree:4"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:3"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#V:3"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#tree:4"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:3"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#tree:4"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:3"><span class="id" title="variable">V</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="var">Arguments</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> {<span class="id" title="var">V</span>}.<br/>
<span class="id" title="var">Arguments</span> <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> {<span class="id" title="var">V</span>}.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="empty_tree" class="idref" href="#empty_tree"><span class="id" title="definition">empty_tree</span></a> (<a id="V:6" class="idref" href="#V:6"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:6"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a>.<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" title="var">lookup</span></span> implementation for red-black trees is exactly
    the same as the <span class="inlinecode"><span class="id" title="var">lookup</span></span> for BSTs, except that the <span class="inlinecode"><span class="id" title="var">T</span></span> constructor
    carries a <span class="inlinecode"><span class="id" title="var">color</span></span> component that is ignored. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="lookup" class="idref" href="#lookup"><span class="id" title="definition">lookup</span></a> {<a id="V:7" class="idref" href="#V:7"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="d:8" class="idref" href="#d:8"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:7"><span class="id" title="variable">V</span></a>) (<a id="x:9" class="idref" href="#x:9"><span class="id" title="binder">x</span></a>: <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="t:10" class="idref" href="#t:10"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:7"><span class="id" title="variable">V</span></a>) : <a class="idref" href="Redblack.html#V:7"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t:10"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#d:8"><span class="id" title="variable">d</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">tl</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">tr</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <a class="idref" href="Redblack.html#x:9"><span class="id" title="variable">x</span></a> <span class="id" title="var">k</span> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup:11"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:8"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#x:9"><span class="id" title="variable">x</span></a> <span class="id" title="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <span class="id" title="var">k</span> <a class="idref" href="Redblack.html#x:9"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup:11"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:8"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#x:9"><span class="id" title="variable">x</span></a> <span class="id" title="var">tr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
We won't explain the <span class="inlinecode"><span class="id" title="var">insert</span></span> algorithm here; read Okasaki's
    work if you want to understand it.  In fact, you'll need very
    little understanding of it to follow along with the verification
    below. It uses <span class="inlinecode"><span class="id" title="var">balance</span></span> and <span class="inlinecode"><span class="id" title="var">ins</span></span> as helpers:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">ins</span></span> recurses down the tree to find where to insert, and is
      mostly the same as the BST <span class="inlinecode"><span class="id" title="var">insert</span></span> algorithm.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" title="var">balance</span></span> takes care of rebalancing the tree on the way back
      up. 

</li>
</ul>
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="balance" class="idref" href="#balance"><span class="id" title="definition">balance</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<a id="V:13" class="idref" href="#V:13"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="c:14" class="idref" href="#c:14"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="t<sub>1</sub>:15" class="idref" href="#t<sub>1</sub>:15"><span class="id" title="binder">t<sub>1</sub></span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:13"><span class="id" title="variable">V</span></a>) (<a id="k:16" class="idref" href="#k:16"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="vk:17" class="idref" href="#vk:17"><span class="id" title="binder">vk</span></a> : <a class="idref" href="Redblack.html#V:13"><span class="id" title="variable">V</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="t<sub>2</sub>:18" class="idref" href="#t<sub>2</sub>:18"><span class="id" title="binder">t<sub>2</sub></span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:13"><span class="id" title="variable">V</span></a>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:13"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#c:14"><span class="id" title="variable">c</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>:15"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k:16"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk:17"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>:18"><span class="id" title="variable">t<sub>2</sub></span></a><br/>
&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t<sub>1</sub>:15"><span class="id" title="variable">t<sub>1</sub></span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">c</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#c:14"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#k:16"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk:17"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>:18"><span class="id" title="variable">t<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">b</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">c</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#c:14"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#k:16"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk:17"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>:18"><span class="id" title="variable">t<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t<sub>2</sub>:18"><span class="id" title="variable">t<sub>2</sub></span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">b</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">c</span>) <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>:15"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k:16"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk:17"><span class="id" title="variable">vk</span></a> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#c:14"><span class="id" title="variable">c</span></a> <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">b</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">c</span> <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span>)  ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>:15"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k:16"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk:17"><span class="id" title="variable">vk</span></a> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#c:14"><span class="id" title="variable">c</span></a> <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>:15"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k:16"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk:17"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>:18"><span class="id" title="variable">t<sub>2</sub></span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="ins" class="idref" href="#ins"><span class="id" title="definition">ins</span></a> {<a id="V:22" class="idref" href="#V:22"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="x:23" class="idref" href="#x:23"><span class="id" title="binder">x</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="vx:24" class="idref" href="#vx:24"><span class="id" title="binder">vx</span></a> : <a class="idref" href="Redblack.html#V:22"><span class="id" title="variable">V</span></a>) (<a id="t:25" class="idref" href="#t:25"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:22"><span class="id" title="variable">V</span></a>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:22"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t:25"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="Redblack.html#x:23"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:24"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">c</span> <span class="id" title="var">a</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">b</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <a class="idref" href="Redblack.html#x:23"><span class="id" title="variable">x</span></a> <span class="id" title="var">y</span> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <span class="id" title="var">c</span> (<a class="idref" href="Redblack.html#ins:26"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x:23"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:24"><span class="id" title="variable">vx</span></a> <span class="id" title="var">a</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <span class="id" title="var">y</span> <a class="idref" href="Redblack.html#x:23"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <span class="id" title="var">c</span> <span class="id" title="var">a</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#ins:26"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x:23"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:24"><span class="id" title="variable">vx</span></a> <span class="id" title="var">b</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">c</span> <span class="id" title="var">a</span> <a class="idref" href="Redblack.html#x:23"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:24"><span class="id" title="variable">vx</span></a> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="make_black" class="idref" href="#make_black"><span class="id" title="definition">make_black</span></a> {<a id="V:28" class="idref" href="#V:28"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="t:29" class="idref" href="#t:29"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:28"><span class="id" title="variable">V</span></a>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:28"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t:29"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="insert" class="idref" href="#insert"><span class="id" title="definition">insert</span></a> {<a id="V:31" class="idref" href="#V:31"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="x:32" class="idref" href="#x:32"><span class="id" title="binder">x</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="vx:33" class="idref" href="#vx:33"><span class="id" title="binder">vx</span></a> : <a class="idref" href="Redblack.html#V:31"><span class="id" title="variable">V</span></a>) (<a id="t:34" class="idref" href="#t:34"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:31"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;&nbsp;<a class="idref" href="Redblack.html#make_black"><span class="id" title="definition">make_black</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x:32"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:33"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#t:34"><span class="id" title="variable">t</span></a>).<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" title="var">elements</span></span> implementation is the same as for BSTs,
    except that it ignores colors. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="elements_aux" class="idref" href="#elements_aux"><span class="id" title="definition">elements_aux</span></a> {<a id="V:35" class="idref" href="#V:35"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="t:36" class="idref" href="#t:36"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:35"><span class="id" title="variable">V</span></a>) (<a id="acc:37" class="idref" href="#acc:37"><span class="id" title="binder">acc</span></a>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#V:35"><span class="id" title="variable">V</span></a>))<br/>
&nbsp;&nbsp;: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#V:35"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t:36"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#acc:37"><span class="id" title="variable">acc</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> ⇒ <a class="idref" href="Redblack.html#elements_aux:38"><span class="id" title="definition">elements_aux</span></a> <span class="id" title="var">l</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">k</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#::list_scope:x_'::'_x"><span class="id" title="notation">::</span></a> <a class="idref" href="Redblack.html#elements_aux:38"><span class="id" title="definition">elements_aux</span></a> <span class="id" title="var">r</span> <a class="idref" href="Redblack.html#acc:37"><span class="id" title="variable">acc</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="elements" class="idref" href="#elements"><span class="id" title="definition">elements</span></a> {<a id="V:40" class="idref" href="#V:40"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="t:41" class="idref" href="#t:41"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:40"><span class="id" title="variable">V</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#V:40"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;&nbsp;<a class="idref" href="Redblack.html#elements_aux"><span class="id" title="definition">elements_aux</span></a> <a class="idref" href="Redblack.html#t:41"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a>.<br/>
</div>

<div class="doc">
Sedgewick has proposed <i>left-leaning red-black trees</i>, which
    have a simpler <span class="inlinecode"><span class="id" title="var">balance</span></span> function but a more complicated
    representation invariant. He does this in order to make the proof
    of correctness easier: there are fewer cases in the <span class="inlinecode"><span class="id" title="var">balance</span></span>
    function, and therefore fewer cases in the case-analysis of the
    proof of correctness of <span class="inlinecode"><span class="id" title="var">balance</span></span>. But as you will see, our proofs
    about <span class="inlinecode"><span class="id" title="var">balance</span></span> will have automated case analyses, so we don't
    care how many cases there are! 
</div>

<div class="doc">
<a id="lab201"></a><h1 class="section">Case-Analysis Automation</h1>

<div class="paragraph"> </div>

 Before verifying the correctness of our red-black tree
    implementation, let's warm up by proving that the result of any
    <span class="inlinecode"><span class="id" title="var">insert</span></span> is a nonempty tree. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ins_not_E" class="idref" href="#ins_not_E"><span class="id" title="lemma">ins_not_E</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:42" class="idref" href="#V:42"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="x:43" class="idref" href="#x:43"><span class="id" title="binder">x</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="vx:44" class="idref" href="#vx:44"><span class="id" title="binder">vx</span></a> : <a class="idref" href="Redblack.html#V:42"><span class="id" title="variable">V</span></a>) (<a id="t:45" class="idref" href="#t:45"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:42"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x:43"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:44"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#t:45"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;<span class="inlinecode"><span class="id" title="tactic">destruct</span></span>&nbsp;on&nbsp;the&nbsp;topmost&nbsp;case,&nbsp;<span class="inlinecode"><span class="id" title="var">ltb</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">k</span></span>.&nbsp;We&nbsp;can&nbsp;use<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="inlinecode"><span class="id" title="tactic">destruct</span></span>&nbsp;instead&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">bdestruct</span></span>&nbsp;because&nbsp;we&nbsp;don't&nbsp;need&nbsp;to&nbsp;know<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;whether&nbsp;<span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">&lt;</span> <span class="inlinecode"><span class="id" title="var">k</span></span>&nbsp;or&nbsp;<span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">≥</span> <span class="inlinecode"><span class="id" title="var">k</span></span>.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <span class="id" title="var">x</span> <span class="id" title="var">k</span>).<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;A&nbsp;huge&nbsp;goal!&nbsp;&nbsp;The&nbsp;proof&nbsp;of&nbsp;this&nbsp;goal&nbsp;begins&nbsp;by&nbsp;matching<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;against&nbsp;a&nbsp;color.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Another&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>,&nbsp;this&nbsp;time&nbsp;against&nbsp;a&nbsp;tree.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">t<sub>1</sub></span>).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Another&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>&nbsp;against&nbsp;a&nbsp;tree.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">t<sub>2</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Yet&nbsp;another&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>.&nbsp;This&nbsp;pattern&nbsp;deserves&nbsp;automation.&nbsp;&nbsp;The<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;following&nbsp;tactic&nbsp;applies&nbsp;<span class="inlinecode"><span class="id" title="tactic">destruct</span></span>&nbsp;whenever&nbsp;the&nbsp;current&nbsp;goal&nbsp;is<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>&nbsp;against&nbsp;a&nbsp;color&nbsp;or&nbsp;a&nbsp;tree.&nbsp;*)</span><br/><hr class='doublespaceincode'/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span>  <span class="id" title="keyword">end</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;apply&nbsp;that&nbsp;tactic&nbsp;repeatedly.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span>  <span class="id" title="keyword">end</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Now&nbsp;we're&nbsp;down&nbsp;to&nbsp;a&nbsp;base&nbsp;case.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;And&nbsp;another&nbsp;base&nbsp;case.&nbsp;We&nbsp;could&nbsp;match&nbsp;against&nbsp;those,&nbsp;too.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="tactic">discriminate</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;restart&nbsp;the&nbsp;proof&nbsp;to&nbsp;incorporate&nbsp;this&nbsp;automation.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Abort</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ins_not_E" class="idref" href="#ins_not_E"><span class="id" title="lemma">ins_not_E</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:46" class="idref" href="#V:46"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="x:47" class="idref" href="#x:47"><span class="id" title="binder">x</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="vx:48" class="idref" href="#vx:48"><span class="id" title="binder">vx</span></a> : <a class="idref" href="Redblack.html#V:46"><span class="id" title="variable">V</span></a>) (<a id="t:49" class="idref" href="#t:49"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:46"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x:47"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx:48"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#t:49"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> ?<span class="id" title="var">x</span> <span class="id" title="keyword">then</span> <span class="id" title="var">_</span> <span class="id" title="keyword">else</span> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span>  <span class="id" title="keyword">end</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="tactic">discriminate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
This automation of case analysis will be quite useful in the
    rest of our development. 
</div>

<div class="doc">
<a id="lab202"></a><h1 class="section">The BST Invariant</h1>

<div class="paragraph"> </div>

 The BST invariant is mostly the same for red-black trees as
    it was for ordinary BSTs as defined in <a href="SearchTree.html"><span class="inlineref">SearchTree</span></a>.  We
    adapt it by ignoring the color of each node, and changing from <span class="inlinecode"><span class="id" title="var">nat</span></span>
    keys to <span class="inlinecode"><span class="id" title="var">int</span></span>. 
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">ForallT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> holds if <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">k</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> holds for every <span class="inlinecode">(<span class="id" title="var">k</span>,</span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> node
    of tree <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="ForallT" class="idref" href="#ForallT"><span class="id" title="definition">ForallT</span></a> {<a id="V:50" class="idref" href="#V:50"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="P:51" class="idref" href="#P:51"><span class="id" title="binder">P</span></a>: <a class="idref" href="Extract.html#int"><span class="id" title="axiom">int</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#V:50"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) (<a id="t:52" class="idref" href="#t:52"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:50"><span class="id" title="variable">V</span></a>) : <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t:52"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#True"><span class="id" title="inductive">True</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">c</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> ⇒ <a class="idref" href="Redblack.html#P:51"><span class="id" title="variable">P</span></a> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a> <a class="idref" href="Redblack.html#ForallT:53"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:51"><span class="id" title="variable">P</span></a> <span class="id" title="var">l</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a> <a class="idref" href="Redblack.html#ForallT:53"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:51"><span class="id" title="variable">P</span></a> <span class="id" title="var">r</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Inductive</span> <a id="BST" class="idref" href="#BST"><span class="id" title="inductive">BST</span></a> {<a id="V:55" class="idref" href="#V:55"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <span class="id" title="var">V</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a id="ST_E" class="idref" href="#ST_E"><span class="id" title="constructor">ST_E</span></a> : <a class="idref" href="Redblack.html#BST:56"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a><br/>
| <a id="ST_T" class="idref" href="#ST_T"><span class="id" title="constructor">ST_T</span></a> : <span class="id" title="keyword">∀</span> (<a id="c:58" class="idref" href="#c:58"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="l:59" class="idref" href="#l:59"><span class="id" title="binder">l</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:55"><span class="id" title="variable">V</span></a>) (<a id="k:60" class="idref" href="#k:60"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:61" class="idref" href="#v:61"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:55"><span class="id" title="variable">V</span></a>) (<a id="r:62" class="idref" href="#r:62"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:55"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':63" class="idref" href="#k':63"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':63"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:60"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l:59"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':64" class="idref" href="#k':64"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':64"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:60"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r:62"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST:56"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l:59"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST:56"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r:62"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST:56"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#c:58"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l:59"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:60"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:61"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:62"><span class="id" title="variable">r</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="empty_tree_BST" class="idref" href="#empty_tree_BST"><span class="id" title="lemma">empty_tree_BST</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:65" class="idref" href="#V:65"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>), <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (@<a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> <a class="idref" href="Redblack.html#V:65"><span class="id" title="variable">V</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a>. <span class="id" title="tactic">constructor</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Let's show that <span class="inlinecode"><span class="id" title="var">insert</span></span> preserves the BST invariant, that is: 
</div>
<div class="code">

<span class="id" title="keyword">Theorem</span> <a id="insert_BST" class="idref" href="#insert_BST"><span class="id" title="lemma">insert_BST</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:66" class="idref" href="#V:66"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:67" class="idref" href="#t:67"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:66"><span class="id" title="variable">V</span></a>) (<a id="v:68" class="idref" href="#v:68"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:66"><span class="id" title="variable">V</span></a>) (<a id="k:69" class="idref" href="#k:69"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:67"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:69"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:68"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:67"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
It will take quite a bit of work, but automation will help. 
<div class="paragraph"> </div>

 First, we show that if a non-empty tree would be a BST, then the
    balanced version of it is also a BST: 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="balance_BST" class="idref" href="#balance_BST"><span class="id" title="lemma">balance_BST</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:70" class="idref" href="#V:70"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="c:71" class="idref" href="#c:71"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="l:72" class="idref" href="#l:72"><span class="id" title="binder">l</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:70"><span class="id" title="variable">V</span></a>) (<a id="k:73" class="idref" href="#k:73"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="v:74" class="idref" href="#v:74"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:70"><span class="id" title="variable">V</span></a>) (<a id="r:75" class="idref" href="#r:75"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:70"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':76" class="idref" href="#k':76"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':76"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:73"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l:72"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':77" class="idref" href="#k':77"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':77"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:73"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r:75"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l:72"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r:75"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c:71"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l:72"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:73"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:74"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:75"><span class="id" title="variable">r</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">V</span> <span class="id" title="var">c</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> <span class="id" title="var">PL</span> <span class="id" title="var">PR</span> <span class="id" title="var">BL</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;58&nbsp;cases&nbsp;remaining.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Now&nbsp;the&nbsp;tree&nbsp;gets&nbsp;bigger,&nbsp;and&nbsp;the&nbsp;proof&nbsp;gets&nbsp;more&nbsp;complicated.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;intro&nbsp;pattern&nbsp;<span class="inlinecode">?</span>&nbsp;means&nbsp;to&nbsp;let&nbsp;Coq&nbsp;choose&nbsp;the&nbsp;name.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">PR</span> <span class="id" title="keyword">as</span> [? <span class="id" title="var">_</span>]. <span class="id" title="var">lia</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>5</sub></span> <span class="id" title="keyword">as</span> [? <span class="id" title="var">_</span>]. <span class="id" title="var">lia</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>5</sub></span> <span class="id" title="keyword">as</span> [<span class="id" title="var">_</span> [? <span class="id" title="var">_</span>]]. <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>5</sub></span> <span class="id" title="keyword">as</span> [<span class="id" title="var">_</span> [<span class="id" title="var">_</span> ?]]. <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="var">inv</span> <span class="id" title="var">H<sub>7</sub></span>. <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;53&nbsp;cases&nbsp;remain.&nbsp;This&nbsp;could&nbsp;go&nbsp;on&nbsp;for&nbsp;a&nbsp;while...&nbsp;*)</span><br/>
<br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
Let's use some of what we discovered above to automate.
    Whenever we have a subgoal of the form
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ForallT</span> <span class="id" title="var">_</span> (<span class="id" title="var">T</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)
</span>    we can split it.  Whenever we have a hypothesis of the form
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">BST</span> (<span class="id" title="var">T</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)
</span>    we can invert it.  And with a hypothesis
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ForallT</span> <span class="id" title="var">_</span> (<span class="id" title="var">T</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)
</span>    we can simplify then destruct it.  Actually, the simplification
    is optional -- Coq will do the destruct without needing the
    simplification.  Anything else seems able to be finished with
    <span class="inlinecode"><span class="id" title="tactic">constructor</span></span>, <span class="inlinecode"><span class="id" title="tactic">auto</span></span>, and <span class="inlinecode"><span class="id" title="var">lia</span></span>.  Let's see how far that can
    take us...  
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="balance_BST" class="idref" href="#balance_BST"><span class="id" title="lemma">balance_BST</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:78" class="idref" href="#V:78"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="c:79" class="idref" href="#c:79"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="l:80" class="idref" href="#l:80"><span class="id" title="binder">l</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:78"><span class="id" title="variable">V</span></a>) (<a id="k:81" class="idref" href="#k:81"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="v:82" class="idref" href="#v:82"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:78"><span class="id" title="variable">V</span></a>) (<a id="r:83" class="idref" href="#r:83"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:78"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':84" class="idref" href="#k':84"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':84"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:81"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l:80"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':85" class="idref" href="#k':85"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':85"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:81"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r:83"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l:80"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r:83"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c:79"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l:80"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:81"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:82"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:83"><span class="id" title="variable">r</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? ?] ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="tactic">constructor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">lia</span>.<br/>
</div>

<div class="doc">
41 cases remain.  It's a little disappointing that we didn't clear
    more of them.  Let's look at why are we stuck.

<div class="paragraph"> </div>

    All the remaining subgoals appear to be about proving an inequality
    over all the nodes of a subtree.  For example, the first subgoal
    follows from the hypotheses:

<div class="paragraph"> </div>

<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ForallT</span> (<span class="id" title="keyword">fun</span> (<span class="id" title="var">k'</span> : <span class="id" title="var">int</span>) (<span class="id" title="var">_</span> : <span class="id" title="var">V</span>) ⇒ <span class="id" title="var">Abs</span> <span class="id" title="var">k'</span> &gt; <span class="id" title="var">Abs</span> <span class="id" title="var">k<sub>0</sub></span>) <span class="id" title="var">r<sub>2</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Abs</span> <span class="id" title="var">k<sub>1</sub></span> &lt; <span class="id" title="var">Abs</span> <span class="id" title="var">k<sub>0</sub></span>
</span>    The other goals look similar. 
</div>
<div class="code">
<hr class='doublespaceincode'/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
To make progress, we can set up some helper lemmas. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ForallT_imp" class="idref" href="#ForallT_imp"><span class="id" title="lemma">ForallT_imp</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:86" class="idref" href="#V:86"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="P:87" class="idref" href="#P:87"><span class="id" title="binder">P</span></a> <a id="Q:88" class="idref" href="#Q:88"><span class="id" title="binder">Q</span></a> : <a class="idref" href="Extract.html#int"><span class="id" title="axiom">int</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#V:86"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) <a id="t:89" class="idref" href="#t:89"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:87"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#t:89"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="k:90" class="idref" href="#k:90"><span class="id" title="binder">k</span></a> <a id="v:91" class="idref" href="#v:91"><span class="id" title="binder">v</span></a>, <a class="idref" href="Redblack.html#P:87"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#k:90"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:91"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#Q:88"><span class="id" title="variable">Q</span></a> <a class="idref" href="Redblack.html#k:90"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:91"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#Q:88"><span class="id" title="variable">Q</span></a> <a class="idref" href="Redblack.html#t:89"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? ?]]. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>; <span class="id" title="tactic">auto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ForallT_greater" class="idref" href="#ForallT_greater"><span class="id" title="lemma">ForallT_greater</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:92" class="idref" href="#V:92"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:93" class="idref" href="#t:93"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:92"><span class="id" title="variable">V</span></a>) (<a id="k:94" class="idref" href="#k:94"><span class="id" title="binder">k</span></a> <a id="k<sub>0</sub>:95" class="idref" href="#k<sub>0</sub>:95"><span class="id" title="binder">k<sub>0</sub></span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':96" class="idref" href="#k':96"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':96"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:94"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#t:93"><span class="id" title="variable">t</span></a>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:94"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>:95"><span class="id" title="variable">k<sub>0</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':97" class="idref" href="#k':97"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':97"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>:95"><span class="id" title="variable">k<sub>0</sub></span></a>) <a class="idref" href="Redblack.html#t:93"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_imp"><span class="id" title="lemma">ForallT_imp</span></a>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>1</sub></span>. <span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ForallT_less" class="idref" href="#ForallT_less"><span class="id" title="lemma">ForallT_less</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:98" class="idref" href="#V:98"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:99" class="idref" href="#t:99"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:98"><span class="id" title="variable">V</span></a>) (<a id="k:100" class="idref" href="#k:100"><span class="id" title="binder">k</span></a> <a id="k<sub>0</sub>:101" class="idref" href="#k<sub>0</sub>:101"><span class="id" title="binder">k<sub>0</sub></span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':102" class="idref" href="#k':102"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':102"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:100"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#t:99"><span class="id" title="variable">t</span></a>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:100"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>:101"><span class="id" title="variable">k<sub>0</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':103" class="idref" href="#k':103"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':103"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>:101"><span class="id" title="variable">k<sub>0</sub></span></a>) <a class="idref" href="Redblack.html#t:99"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>; <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_imp"><span class="id" title="lemma">ForallT_imp</span></a>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>1</sub></span>. <span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Now we can return to automating the proof. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="balance_BST" class="idref" href="#balance_BST"><span class="id" title="lemma">balance_BST</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:104" class="idref" href="#V:104"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="c:105" class="idref" href="#c:105"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="l:106" class="idref" href="#l:106"><span class="id" title="binder">l</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:104"><span class="id" title="variable">V</span></a>) (<a id="k:107" class="idref" href="#k:107"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="v:108" class="idref" href="#v:108"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:104"><span class="id" title="variable">V</span></a>) (<a id="r:109" class="idref" href="#r:109"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:104"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':110" class="idref" href="#k':110"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':110"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:107"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l:106"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':111" class="idref" href="#k':111"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':111"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:107"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r:109"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l:106"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r:109"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c:105"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l:106"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:107"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:108"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:109"><span class="id" title="variable">r</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? ?] ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="tactic">constructor</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">auto</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">lia</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;<span class="inlinecode"><span class="id" title="var">all</span>:</span> <span class="inlinecode"><span class="id" title="var">t</span></span>&nbsp;applies&nbsp;<span class="inlinecode"><span class="id" title="var">t</span></span>&nbsp;to&nbsp;every&nbsp;subgoal.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">try</span> <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_greater"><span class="id" title="lemma">ForallT_greater</span></a>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_less"><span class="id" title="lemma">ForallT_less</span></a>; <span class="id" title="tactic">eauto</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">lia</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab203"></a><h4 class="section">Exercise: 2 stars, standard (balanceP)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">balance</span></span> preserves <span class="inlinecode"><span class="id" title="var">ForallT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span>. Use proof automation
    with <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="keyword">goal</span></span> and/or <span class="inlinecode"><span class="id" title="var">all</span>:</span>.
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="balanceP" class="idref" href="#balanceP"><span class="id" title="lemma">balanceP</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:112" class="idref" href="#V:112"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="P:113" class="idref" href="#P:113"><span class="id" title="binder">P</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#V:112"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) (<a id="c:114" class="idref" href="#c:114"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="l:115" class="idref" href="#l:115"><span class="id" title="binder">l</span></a> <a id="r:116" class="idref" href="#r:116"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:112"><span class="id" title="variable">V</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="k:117" class="idref" href="#k:117"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:118" class="idref" href="#v:118"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:112"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:113"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#l:115"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:113"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#r:116"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#P:113"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#k:117"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:118"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:113"><span class="id" title="variable">P</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c:114"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l:115"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:117"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:118"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:116"><span class="id" title="variable">r</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab204"></a><h4 class="section">Exercise: 2 stars, standard (insP)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">ins</span></span> preserves <span class="inlinecode"><span class="id" title="var">ForallT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span>. Hint: proceed by induction on <span class="inlinecode"><span class="id" title="var">t</span></span>.
    Use the previous lemma. There's no need for automated case analysis. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="insP" class="idref" href="#insP"><span class="id" title="lemma">insP</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:119" class="idref" href="#V:119"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="P:120" class="idref" href="#P:120"><span class="id" title="binder">P</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#V:119"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) (<a id="t:121" class="idref" href="#t:121"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:119"><span class="id" title="variable">V</span></a>) (<a id="k:122" class="idref" href="#k:122"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:123" class="idref" href="#v:123"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:119"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:120"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#t:121"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#P:120"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#k:122"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:123"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P:120"><span class="id" title="variable">P</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:122"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:123"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:121"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab205"></a><h4 class="section">Exercise: 3 stars, standard (ins_BST)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">ins</span></span> maintains <span class="inlinecode"><span class="id" title="var">BST</span></span>.  Proceed by induction on <span class="inlinecode"><span class="id" title="var">t</span></span>.
    You don't need any automated case analysis. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ins_BST" class="idref" href="#ins_BST"><span class="id" title="lemma">ins_BST</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:124" class="idref" href="#V:124"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:125" class="idref" href="#t:125"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:124"><span class="id" title="variable">V</span></a>) (<a id="k:126" class="idref" href="#k:126"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:127" class="idref" href="#v:127"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:124"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:125"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:126"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:127"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:125"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab206"></a><h4 class="section">Exercise: 2 stars, standard (insert_BST)</h4>

<div class="paragraph"> </div>

 Prove the main theorem: <span class="inlinecode"><span class="id" title="var">insert</span></span> preserves <span class="inlinecode"><span class="id" title="var">BST</span></span>. You do
    not need induction. 
</div>
<div class="code">

<span class="id" title="keyword">Theorem</span> <a id="insert_BST" class="idref" href="#insert_BST"><span class="id" title="lemma">insert_BST</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:128" class="idref" href="#V:128"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:129" class="idref" href="#t:129"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:128"><span class="id" title="variable">V</span></a>) (<a id="v:130" class="idref" href="#v:130"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:128"><span class="id" title="variable">V</span></a>) (<a id="k:131" class="idref" href="#k:131"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:129"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:131"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:130"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:129"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>


<div class="doc">
<a id="lab207"></a><h1 class="section">Verification</h1>

<div class="paragraph"> </div>

 We now verify that the equational specification of maps holds for
    red-black trees:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lookup</span> <span class="id" title="var">d</span> <span class="id" title="var">k</span> <span class="id" title="var">empty_tree</span> = <span class="id" title="var">d</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lookup</span> <span class="id" title="var">d</span> <span class="id" title="var">k</span> (<span class="id" title="var">insert</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span>) = <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lookup</span> <span class="id" title="var">d</span> <span class="id" title="var">k'</span> (<span class="id" title="var">insert</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span>) = <span class="id" title="var">lookup</span> <span class="id" title="var">d</span> <span class="id" title="var">k'</span> <span class="id" title="var">t</span>       <span class="id" title="keyword">if</span> <span class="id" title="var">k</span> ≠ <span class="id" title="var">k'</span>
</span>
<div class="paragraph"> </div>

    The first equation is trivial to verify. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="lookup_empty" class="idref" href="#lookup_empty"><span class="id" title="lemma">lookup_empty</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:132" class="idref" href="#V:132"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:133" class="idref" href="#d:133"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:132"><span class="id" title="variable">V</span></a>) (<a id="k:134" class="idref" href="#k:134"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:133"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k:134"><span class="id" title="variable">k</span></a> (@<a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> <a class="idref" href="Redblack.html#V:132"><span class="id" title="variable">V</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#d:133"><span class="id" title="variable">d</span></a>.<br/>
<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">auto</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The next two equations are more challenging because of <span class="inlinecode"><span class="id" title="var">balance</span></span>. 
<div class="paragraph"> </div>

<a id="lab208"></a><h4 class="section">Exercise: 4 stars, standard (balance_lookup)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">balance</span></span> preserves the result of <span class="inlinecode"><span class="id" title="var">lookup</span></span> on non-empty
    trees. Use the same proof technique as in <span class="inlinecode"><span class="id" title="var">balance_BST</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="balance_lookup" class="idref" href="#balance_lookup"><span class="id" title="lemma">balance_lookup</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:135" class="idref" href="#V:135"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:136" class="idref" href="#d:136"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:135"><span class="id" title="variable">V</span></a>) (<a id="c:137" class="idref" href="#c:137"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="k:138" class="idref" href="#k:138"><span class="id" title="binder">k</span></a> <a id="k':139" class="idref" href="#k':139"><span class="id" title="binder">k'</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:140" class="idref" href="#v:140"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:135"><span class="id" title="variable">V</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="l:141" class="idref" href="#l:141"><span class="id" title="binder">l</span></a> <a id="r:142" class="idref" href="#r:142"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:135"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l:141"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r:142"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':143" class="idref" href="#k':143"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':143"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:138"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#l:141"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <a id="k':144" class="idref" href="#k':144"><span class="id" title="binder">k'</span></a> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':144"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#::Z_scope:x_'&gt;'_x"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:138"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#r:142"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:136"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':139"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c:137"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l:141"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:138"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:140"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:142"><span class="id" title="variable">r</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':139"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#f1746f02f141d025b1e53605943919bf"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:138"><span class="id" title="variable">k</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:136"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':139"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#l:141"><span class="id" title="variable">l</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k':139"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#0f6d3b46a03d1336a5ac68936077dc<sub>02</sub>"><span class="id" title="notation">&gt;?</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k:138"><span class="id" title="variable">k</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:136"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':139"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#r:142"><span class="id" title="variable">r</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="Redblack.html#v:140"><span class="id" title="variable">v</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab209"></a><h4 class="section">Exercise: 3 stars, standard (lookup_ins_eq)</h4>

<div class="paragraph"> </div>

 Verify the second equation, though for <span class="inlinecode"><span class="id" title="var">ins</span></span> rather than <span class="inlinecode"><span class="id" title="var">insert</span></span>.
    Proceed by induction on the evidence that <span class="inlinecode"><span class="id" title="var">t</span></span> is a <span class="inlinecode"><span class="id" title="var">BST</span></span>.  Note
    that precondition <span class="inlinecode"><span class="id" title="var">BST</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> will be essential in your proof, unlike
    the ordinary BST's we saw in <a href="SearchTree.html"><span class="inlineref">SearchTree</span></a>.

<div class="paragraph"> </div>

    Hint: no automation of case analysis is needed; rely on the lemmas
    we've already proved above about <span class="inlinecode"><span class="id" title="var">balance</span></span> and <span class="inlinecode"><span class="id" title="var">ins</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="lookup_ins_eq" class="idref" href="#lookup_ins_eq"><span class="id" title="lemma">lookup_ins_eq</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:145" class="idref" href="#V:145"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:146" class="idref" href="#d:146"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:145"><span class="id" title="variable">V</span></a>) (<a id="t:147" class="idref" href="#t:147"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:145"><span class="id" title="variable">V</span></a>) (<a id="k:148" class="idref" href="#k:148"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:149" class="idref" href="#v:149"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:145"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:147"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:146"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k:148"><span class="id" title="variable">k</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:148"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:149"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:147"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#v:149"><span class="id" title="variable">v</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab210"></a><h4 class="section">Exercise: 3 stars, standard (lookup_ins_neq)</h4>

<div class="paragraph"> </div>

 Verify the third equation, again for <span class="inlinecode"><span class="id" title="var">ins</span></span> instead of <span class="inlinecode"><span class="id" title="var">insert</span></span>.
    The same hints as for the second equation hold. 
</div>
<div class="code">

<span class="id" title="keyword">Theorem</span> <a id="lookup_ins_neq" class="idref" href="#lookup_ins_neq"><span class="id" title="lemma">lookup_ins_neq</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:150" class="idref" href="#V:150"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:151" class="idref" href="#d:151"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:150"><span class="id" title="variable">V</span></a>) (<a id="t:152" class="idref" href="#t:152"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:150"><span class="id" title="variable">V</span></a>) (<a id="k:153" class="idref" href="#k:153"><span class="id" title="binder">k</span></a> <a id="k':154" class="idref" href="#k':154"><span class="id" title="binder">k'</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="v:155" class="idref" href="#v:155"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:150"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:152"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#k:153"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#k':154"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:151"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':154"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:153"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:155"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:152"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:151"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':154"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#t:152"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Finish verifying the second and third equations. The proofs are
    almost identical to each other. No induction is needed. 
<div class="paragraph"> </div>

<a id="lab211"></a><h4 class="section">Exercise: 2 stars, standard (lookup_insert)</h4>

</div>
<div class="code">

<span class="id" title="keyword">Theorem</span> <a id="lookup_insert_eq" class="idref" href="#lookup_insert_eq"><span class="id" title="lemma">lookup_insert_eq</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:156" class="idref" href="#V:156"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:157" class="idref" href="#d:157"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:156"><span class="id" title="variable">V</span></a>) (<a id="t:158" class="idref" href="#t:158"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:156"><span class="id" title="variable">V</span></a>) (<a id="k:159" class="idref" href="#k:159"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="v:160" class="idref" href="#v:160"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:156"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:158"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:157"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k:159"><span class="id" title="variable">k</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:159"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:160"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:158"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#v:160"><span class="id" title="variable">v</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Theorem</span> <a id="lookup_insert_neq" class="idref" href="#lookup_insert_neq"><span class="id" title="lemma">lookup_insert_neq</span></a>: <span class="id" title="keyword">∀</span> (<a id="V:161" class="idref" href="#V:161"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:162" class="idref" href="#d:162"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:161"><span class="id" title="variable">V</span></a>) (<a id="t:163" class="idref" href="#t:163"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:161"><span class="id" title="variable">V</span></a>) (<a id="k:164" class="idref" href="#k:164"><span class="id" title="binder">k</span></a> <a id="k':165" class="idref" href="#k':165"><span class="id" title="binder">k'</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="v:166" class="idref" href="#v:166"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:161"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:163"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#k:164"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#k':165"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:162"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':165"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:164"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:166"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:163"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:162"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':165"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#t:163"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 That concludes the verification of the map equations for red-black
    trees.  We have proved these main theorems: 
</div>
<div class="code">

<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#empty_tree_BST"><span class="id" title="lemma">empty_tree_BST</span></a> :<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<a id="V:167" class="idref" href="#V:167"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (@<a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> <a class="idref" href="Redblack.html#V:167"><span class="id" title="variable">V</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#insert_BST"><span class="id" title="axiom">insert_BST</span></a> :<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<a id="V:168" class="idref" href="#V:168"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:169" class="idref" href="#t:169"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:168"><span class="id" title="variable">V</span></a>) (<a id="v:170" class="idref" href="#v:170"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:168"><span class="id" title="variable">V</span></a>) (<a id="k:171" class="idref" href="#k:171"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:169"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:171"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:170"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:169"><span class="id" title="variable">t</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#lookup_empty"><span class="id" title="lemma">lookup_empty</span></a> :<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<a id="V:172" class="idref" href="#V:172"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:173" class="idref" href="#d:173"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:172"><span class="id" title="variable">V</span></a>) (<a id="k:174" class="idref" href="#k:174"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:173"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k:174"><span class="id" title="variable">k</span></a> (@<a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> <a class="idref" href="Redblack.html#V:172"><span class="id" title="variable">V</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#d:173"><span class="id" title="variable">d</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#lookup_insert_eq"><span class="id" title="axiom">lookup_insert_eq</span></a> :<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<a id="V:175" class="idref" href="#V:175"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:176" class="idref" href="#d:176"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:175"><span class="id" title="variable">V</span></a>) (<a id="t:177" class="idref" href="#t:177"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:175"><span class="id" title="variable">V</span></a>) (<a id="k:178" class="idref" href="#k:178"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:179" class="idref" href="#v:179"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:175"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:177"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:176"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k:178"><span class="id" title="variable">k</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:178"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:179"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:177"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#v:179"><span class="id" title="variable">v</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#lookup_insert_neq"><span class="id" title="axiom">lookup_insert_neq</span></a> :<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<a id="V:180" class="idref" href="#V:180"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="d:181" class="idref" href="#d:181"><span class="id" title="binder">d</span></a> : <a class="idref" href="Redblack.html#V:180"><span class="id" title="variable">V</span></a>) (<a id="t:182" class="idref" href="#t:182"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:180"><span class="id" title="variable">V</span></a>) (<a id="k:183" class="idref" href="#k:183"><span class="id" title="binder">k</span></a> <a id="k':184" class="idref" href="#k':184"><span class="id" title="binder">k'</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:185" class="idref" href="#v:185"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:180"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t:182"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#k:183"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'&lt;&gt;'_x"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#k':184"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:181"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':184"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:183"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:185"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:182"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#d:181"><span class="id" title="variable">d</span></a> <a class="idref" href="Redblack.html#k':184"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#t:182"><span class="id" title="variable">t</span></a>.<br/>
</div>

<div class="doc">
We could now proceed to reprove all the facts about <span class="inlinecode"><span class="id" title="var">elements</span></span>
    that we developed in <a href="SearchTree.html"><span class="inlineref">SearchTree</span></a>.  But since <span class="inlinecode"><span class="id" title="var">elements</span></span> does
    not not pay attention to colors, and does not rebalance the tree,
    these proofs should be a simple copy-paste from that chapter, with
    only minor edits.  This would be an uninteresting exercise, so we
    don't pursue it here. 
</div>

<div class="doc">
<a id="lab212"></a><h1 class="section">Efficiency</h1>

<div class="paragraph"> </div>

 Red-black trees are more efficient than ordinary search
    trees, because red-black trees stay balanced.  The <span class="inlinecode"><span class="id" title="var">insert</span></span>
    operation ensures that these <i>red-black invariants</i> hold: 
<div class="paragraph"> </div>

<ul class="doclist">
<li> Local Invariant: No red node has a red child.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Global Invariant: Every path from the root to a leaf has the
      same number of black nodes. 
</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

 Together these invariants guarantee that no leaf is more
    than twice as deep as another leaf, a property that we will here
    call <i>approximately balanced</i>.  The maximum depth of a node is
    therefore <span class="inlinecode">2</span> <span class="inlinecode"><span class="id" title="var">log</span></span> <span class="inlinecode"><span class="id" title="var">N</span></span>, so the running-time of <span class="inlinecode"><span class="id" title="var">insert</span></span> and <span class="inlinecode"><span class="id" title="var">lookup</span></span>
    is <span class="inlinecode"><span class="id" title="var">O</span>(<span class="id" title="var">log</span></span> <span class="inlinecode"><span class="id" title="var">N</span>)</span>, where <span class="inlinecode"><span class="id" title="var">N</span></span> is the number of nodes in the tree.

<div class="paragraph"> </div>

    Coq does not have a formal time--cost model for its execution, so
    we cannot verify that logarithmic running time in Coq.  But we can
    prove that the trees are approximately balanced. 
<div class="paragraph"> </div>

 These ensure that the tree remains approximately balanced. 
<div class="paragraph"> </div>

 Relation <span class="inlinecode"><span class="id" title="var">RB</span></span>, below, formalizes the red-black
    invariants. Proposition <span class="inlinecode"><span class="id" title="var">RB</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">n</span></span> holds when <span class="inlinecode"><span class="id" title="var">t</span></span> satisfies the
    red-black invariants, assuming that <span class="inlinecode"><span class="id" title="var">c</span></span> is the color of <span class="inlinecode"><span class="id" title="var">t</span></span>'s
    parent, and <span class="inlinecode"><span class="id" title="var">n</span></span> is the black height that <span class="inlinecode"><span class="id" title="var">t</span></span> is supposed to have.

<div class="paragraph"> </div>

    If <span class="inlinecode"><span class="id" title="var">t</span></span> happens to have no parent (i.e., it is the entire tree),
    then it will be colored black by <span class="inlinecode"><span class="id" title="var">insert</span></span>, so it won't actually
    matter what color its (non-existent) parent might purportedly
    have: whether red or black, it can't violate the local invariant.

<div class="paragraph"> </div>

    If <span class="inlinecode"><span class="id" title="var">t</span></span> is a leaf, then it likewise won't matter what its parent
    color is, and its black height must be zero. 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="RB" class="idref" href="#RB"><span class="id" title="inductive">RB</span></a> {<a id="V:186" class="idref" href="#V:186"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <span class="id" title="var">V</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a id="RB_leaf" class="idref" href="#RB_leaf"><span class="id" title="constructor">RB_leaf</span></a>: <span class="id" title="keyword">∀</span> (<a id="c:189" class="idref" href="#c:189"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>), <a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="Redblack.html#c:189"><span class="id" title="variable">c</span></a> 0<br/>
| <a id="RB_r" class="idref" href="#RB_r"><span class="id" title="constructor">RB_r</span></a>: <span class="id" title="keyword">∀</span> (<a id="l:190" class="idref" href="#l:190"><span class="id" title="binder">l</span></a> <a id="r:191" class="idref" href="#r:191"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:186"><span class="id" title="variable">V</span></a>) (<a id="k:192" class="idref" href="#k:192"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:193" class="idref" href="#v:193"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:186"><span class="id" title="variable">V</span></a>) (<a id="n:194" class="idref" href="#n:194"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l:190"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n:194"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r:191"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n:194"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#l:190"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:192"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:193"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:191"><span class="id" title="variable">r</span></a>) <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:194"><span class="id" title="variable">n</span></a><br/>
| <a id="RB_b" class="idref" href="#RB_b"><span class="id" title="constructor">RB_b</span></a>: <span class="id" title="keyword">∀</span> (<a id="c:195" class="idref" href="#c:195"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="l:196" class="idref" href="#l:196"><span class="id" title="binder">l</span></a> <a id="r:197" class="idref" href="#r:197"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:186"><span class="id" title="variable">V</span></a>) (<a id="k:198" class="idref" href="#k:198"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:199" class="idref" href="#v:199"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:186"><span class="id" title="variable">V</span></a>) (<a id="n:200" class="idref" href="#n:200"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l:196"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:200"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r:197"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:200"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB:187"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#l:196"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:198"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:199"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:197"><span class="id" title="variable">r</span></a>) <a class="idref" href="Redblack.html#c:195"><span class="id" title="variable">c</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <a class="idref" href="Redblack.html#n:200"><span class="id" title="variable">n</span></a>).<br/>
</div>

<div class="doc">
<a id="lab213"></a><h4 class="section">Exercise: 1 star, standard (RB_blacken_parent)</h4>

<div class="paragraph"> </div>

 Prove that blackening a parent would preserve the red-black
    invariants. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="RB_blacken_parent" class="idref" href="#RB_blacken_parent"><span class="id" title="lemma">RB_blacken_parent</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:201" class="idref" href="#V:201"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:202" class="idref" href="#t:202"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:201"><span class="id" title="variable">V</span></a>) (<a id="n:203" class="idref" href="#n:203"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:202"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n:203"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:202"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:203"><span class="id" title="variable">n</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Relation <span class="inlinecode"><span class="id" title="var">NearlyRB</span></span> expresses, "the tree is a red-black tree,
    except that it's nonempty and it is permitted to have two
    consecutive red nodes at the root only."  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="NearlyRB" class="idref" href="#NearlyRB"><span class="id" title="inductive">NearlyRB</span></a> {<a id="V:204" class="idref" href="#V:204"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <span class="id" title="var">V</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a id="NearlyRB_r" class="idref" href="#NearlyRB_r"><span class="id" title="constructor">NearlyRB_r</span></a> : <span class="id" title="keyword">∀</span> (<a id="l:207" class="idref" href="#l:207"><span class="id" title="binder">l</span></a> <a id="r:208" class="idref" href="#r:208"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:204"><span class="id" title="variable">V</span></a>) (<a id="k:209" class="idref" href="#k:209"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:210" class="idref" href="#v:210"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:204"><span class="id" title="variable">V</span></a>) (<a id="n:211" class="idref" href="#n:211"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l:207"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:211"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r:208"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:211"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#NearlyRB:205"><span class="id" title="inductive">NearlyRB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#l:207"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:209"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:210"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:208"><span class="id" title="variable">r</span></a>) <a class="idref" href="Redblack.html#n:211"><span class="id" title="variable">n</span></a><br/>
| <a id="NearlyRB_b" class="idref" href="#NearlyRB_b"><span class="id" title="constructor">NearlyRB_b</span></a> : <span class="id" title="keyword">∀</span> (<a id="l:212" class="idref" href="#l:212"><span class="id" title="binder">l</span></a> <a id="r:213" class="idref" href="#r:213"><span class="id" title="binder">r</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:204"><span class="id" title="variable">V</span></a>) (<a id="k:214" class="idref" href="#k:214"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:215" class="idref" href="#v:215"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:204"><span class="id" title="variable">V</span></a>) (<a id="n:216" class="idref" href="#n:216"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l:212"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:216"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r:213"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:216"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#NearlyRB:205"><span class="id" title="inductive">NearlyRB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#l:212"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k:214"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:215"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r:213"><span class="id" title="variable">r</span></a>) (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <a class="idref" href="Redblack.html#n:216"><span class="id" title="variable">n</span></a>).<br/>
</div>

<div class="doc">
<a id="lab214"></a><h4 class="section">Exercise: 4 stars, standard (ins_RB)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">ins</span></span> creates a tree that is either red-black or nearly
    so, depending on what the parent's color was.

<div class="paragraph"> </div>

    The proof is already completed for you, except for the tactic
    <span class="inlinecode"><span class="id" title="var">prove_RB</span></span>. Replace the provided <span class="inlinecode"><span class="id" title="var">admit</span></span> with your own proof
    automation. Use a technique similar to <span class="inlinecode"><span class="id" title="var">ins_not_E</span></span> and
    <span class="inlinecode"><span class="id" title="var">balance_lookup</span></span> -- that is, write a <span class="inlinecode"><span class="id" title="tactic">repeat</span></span> <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="keyword">goal</span></span> that
    finds opportunities to use tactics such as <span class="inlinecode"><span class="id" title="var">bdestruct</span></span>,
    <span class="inlinecode"><span class="id" title="tactic">destruct</span></span>, <span class="inlinecode"><span class="id" title="var">inv</span></span>, and <span class="inlinecode"><span class="id" title="tactic">constructor</span></span>; as well as previously proved
    lemmas and <span class="inlinecode"><span class="id" title="tactic">auto</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Ltac</span> <span class="id" title="var">prove_RB</span> := <span class="id" title="var">admit</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ins_RB" class="idref" href="#ins_RB"><span class="id" title="lemma">ins_RB</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:217" class="idref" href="#V:217"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="k:218" class="idref" href="#k:218"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:219" class="idref" href="#v:219"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:217"><span class="id" title="variable">V</span></a>) (<a id="t:220" class="idref" href="#t:220"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:217"><span class="id" title="variable">V</span></a>) (<a id="n:221" class="idref" href="#n:221"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">(</span></a><a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:220"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:221"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#NearlyRB"><span class="id" title="inductive">NearlyRB</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:218"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:219"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:220"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#n:221"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">(</span></a><a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:220"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n:221"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:218"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:219"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:220"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:221"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">)</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">split</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;- <span class="comment">(*&nbsp;Instantiate&nbsp;the&nbsp;inductive&nbsp;hypotheses.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHt1</span> <span class="id" title="var">n</span>). <span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHt2</span> <span class="id" title="var">n</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Derive&nbsp;what&nbsp;propositional&nbsp;facts&nbsp;we&nbsp;can&nbsp;from&nbsp;the&nbsp;hypotheses.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Get&nbsp;rid&nbsp;of&nbsp;some&nbsp;extraneous&nbsp;hypotheses.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">H</span> <span class="id" title="var">H<sub>1</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Finish&nbsp;with&nbsp;automation.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">prove_RB</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;- <span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHt1</span> <span class="id" title="var">n<sub>0</sub></span>). <span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHt2</span> <span class="id" title="var">n<sub>0</sub></span>). <span class="id" title="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">H<sub>0</sub></span> <span class="id" title="var">H<sub>2</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">prove_RB</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;- <span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHt1</span> <span class="id" title="var">n<sub>0</sub></span>). <span class="id" title="tactic">specialize</span> (<span class="id" title="var">IHt2</span> <span class="id" title="var">n<sub>0</sub></span>). <span class="id" title="tactic">intuition</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">H<sub>0</sub></span> <span class="id" title="var">H<sub>2</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">prove_RB</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;There's&nbsp;nothing&nbsp;more&nbsp;you&nbsp;need&nbsp;to&nbsp;fill&nbsp;in&nbsp;here.&nbsp;Just&nbsp;don't<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;forget&nbsp;to&nbsp;change&nbsp;the&nbsp;<span class="inlinecode"><span class="id" title="var">Admitted</span>.</span>&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="keyword">Qed</span>.</span>&nbsp;when&nbsp;you&nbsp;have<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;finished&nbsp;developing&nbsp;<span class="inlinecode"><span class="id" title="var">prove_RB</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Therefore, <span class="inlinecode"><span class="id" title="var">ins</span></span> produces a red-black tree when given one as input
 though the parent color changes. 
</div>
<div class="code">
<span class="id" title="keyword">Corollary</span> <a id="ins_red" class="idref" href="#ins_red"><span class="id" title="lemma">ins_red</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:222" class="idref" href="#V:222"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:223" class="idref" href="#t:223"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:222"><span class="id" title="variable">V</span></a>) (<a id="k:224" class="idref" href="#k:224"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:225" class="idref" href="#v:225"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:222"><span class="id" title="variable">V</span></a>) (<a id="n:226" class="idref" href="#n:226"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:223"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n:226"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k:224"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:225"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:223"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:226"><span class="id" title="variable">n</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">apply</span> <a class="idref" href="Redblack.html#ins_RB"><span class="id" title="axiom">ins_RB</span></a>. <span class="id" title="tactic">assumption</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab215"></a><h4 class="section">Exercise: 1 star, standard (RB_blacken_root)</h4>

<div class="paragraph"> </div>

 Prove that blackening a subtree root (whose hypothetical parent is
    black) would preserve the red-black invariants, though the black
    height of the subtree might change (and the color of the parent
    would need to become red). 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="RB_blacken_root" class="idref" href="#RB_blacken_root"><span class="id" title="lemma">RB_blacken_root</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:227" class="idref" href="#V:227"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:228" class="idref" href="#t:228"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:227"><span class="id" title="variable">V</span></a>) (<a id="n:229" class="idref" href="#n:229"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:228"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n:229"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">∃</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">(</span></a><a id="n':230" class="idref" href="#n':230"><span class="id" title="binder">n'</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">),</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#make_black"><span class="id" title="definition">make_black</span></a> <a class="idref" href="Redblack.html#t:228"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n':230"><span class="id" title="variable">n'</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab216"></a><h4 class="section">Exercise: 1 star, standard (insert_RB)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">insert</span></span> produces a red-black tree when given one as
    input.  This can be done entirely with lemmas already proved. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="insert_RB" class="idref" href="#insert_RB"><span class="id" title="lemma">insert_RB</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:231" class="idref" href="#V:231"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:232" class="idref" href="#t:232"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:231"><span class="id" title="variable">V</span></a>) (<a id="k:233" class="idref" href="#k:233"><span class="id" title="binder">k</span></a> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<a id="v:234" class="idref" href="#v:234"><span class="id" title="binder">v</span></a> : <a class="idref" href="Redblack.html#V:231"><span class="id" title="variable">V</span></a>) (<a id="n:235" class="idref" href="#n:235"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:232"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n:235"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">∃</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">(</span></a><a id="n':236" class="idref" href="#n':236"><span class="id" title="binder">n'</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">),</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k:233"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v:234"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t:232"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n':236"><span class="id" title="variable">n'</span></a>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab217"></a><h4 class="section">Exercise: 4 stars, advanced (redblack_bound)</h4>

<div class="paragraph"> </div>

 To confirm that red-black trees are approximately balanced, define
    functions to compute the height (i.e., maximum depth) and minimum
    depth of a red-black tree, and prove that the height is bounded by
    twice the minimum depth, plus 1.  Hints:

<div class="paragraph"> </div>

<ul class="doclist">
<li> The standard library has <span class="inlinecode"><span class="id" title="var">min</span></span> and <span class="inlinecode"><span class="id" title="var">max</span></span> functions for <span class="inlinecode"><span class="id" title="var">nat</span></span>.

<div class="paragraph"> </div>


</li>
<li> Note that <span class="inlinecode"><span class="id" title="var">RB</span></span> does not require the root to be <span class="inlinecode"><span class="id" title="var">Black</span></span>.

<div class="paragraph"> </div>


</li>
<li> Prove two auxiliary lemmas, one about an upper bound on the
      number of black nodes in a path, and another about a lower
      bound. Combine those lemmas to prove the main theorem.

<div class="paragraph"> </div>


</li>
<li> All of the proofs can be quite short. The challenge is to invent
      helpful lemmas. 

</li>
</ul>
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="height" class="idref" href="#height"><span class="id" title="definition">height</span></a> {<a id="V:237" class="idref" href="#V:237"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="t:238" class="idref" href="#t:238"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:237"><span class="id" title="variable">V</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;REPLACE&nbsp;THIS&nbsp;LINE&nbsp;WITH&nbsp;":=&nbsp;_your_definition_&nbsp;."&nbsp;*)</span>. <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="mindepth" class="idref" href="#mindepth"><span class="id" title="definition">mindepth</span></a> {<a id="V:240" class="idref" href="#V:240"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>} (<a id="t:241" class="idref" href="#t:241"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:240"><span class="id" title="variable">V</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;REPLACE&nbsp;THIS&nbsp;LINE&nbsp;WITH&nbsp;":=&nbsp;_your_definition_&nbsp;."&nbsp;*)</span>. <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="redblack_balanced" class="idref" href="#redblack_balanced"><span class="id" title="lemma">redblack_balanced</span></a> : <span class="id" title="keyword">∀</span> (<a id="V:243" class="idref" href="#V:243"><span class="id" title="binder">V</span></a> : <span class="id" title="keyword">Type</span>) (<a id="t:244" class="idref" href="#t:244"><span class="id" title="binder">t</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="Redblack.html#V:243"><span class="id" title="variable">V</span></a>) (<a id="c:245" class="idref" href="#c:245"><span class="id" title="binder">c</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<a id="n:246" class="idref" href="#n:246"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t:244"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#c:245"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#n:246"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Redblack.html#height"><span class="id" title="axiom">height</span></a> <a class="idref" href="Redblack.html#t:244"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#cb53cf0ee22c036a03b4a9281c68b5a<sub>3</sub>"><span class="id" title="notation">≤</span></a> 2 <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#ea2ff3d561159081cea6fb2e8113cc<sub>54</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#mindepth"><span class="id" title="axiom">mindepth</span></a> <a class="idref" href="Redblack.html#t:244"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> 1)%<span class="id" title="var">nat</span>.<br/>
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
<span class="comment">(*&nbsp;Do&nbsp;not&nbsp;modify&nbsp;the&nbsp;following&nbsp;line:&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a id="manual_grade_for_redblack_bound" class="idref" href="#manual_grade_for_redblack_bound"><span class="id" title="definition">manual_grade_for_redblack_bound</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Strings.String.html#string"><span class="id" title="inductive">string</span></a>) := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab218"></a><h1 class="section">Performance of Extracted Code</h1>

<div class="paragraph"> </div>

 We can extract the red-black tree implementation: 
</div>
<div class="code">

<span class="id" title="keyword">Extraction</span> "redblack.ml" <span class="id" title="var">empty_tree</span> <span class="id" title="var">insert</span> <span class="id" title="var">lookup</span> <span class="id" title="var">elements</span>.<br/>
</div>

<div class="doc">
Run it in the OCaml top level with these commands:
<pre>
    #use "redblack.ml";;
    #use "test_searchtree.ml";;
</pre>

<div class="paragraph"> </div>

    On a recent machine with a 2.9 GHz Intel Core i<sub>9</sub> that prints:
<pre>
    Insert and lookup 1000000 random integers in 0.860663 seconds.
    Insert and lookup 20000 random integers in 0.007908 seconds.
    Insert and lookup 20000 consecutive integers in 0.004668 seconds.
</pre>

<div class="paragraph"> </div>

    That execution uses the bytecode interpreter.  The native compiler
    will have better performance:
<pre>
      $ ocamlopt -c redblack.mli redblack.ml
      $ ocamlopt redblack.cmx -open Redblack test_searchtree.ml -o test_redblack
      $ ./test_redblack
</pre>

<div class="paragraph"> </div>

On the same machine that prints,
<pre>
    Insert and lookup 1000000 random integers in 0.475669 seconds.
    Insert and lookup 20000 random integers in 0.00312 seconds.
    Insert and lookup 20000 consecutive integers in 0.001183 seconds.
</pre>
 
<div class="paragraph"> </div>

 The benchmark measurements above (and in <a href="Extract.html"><span class="inlineref">Extract</span></a>)
    demonstrate the following:

<div class="paragraph"> </div>

<ul class="doclist">
<li> On random insertions, red-black trees are about the same as
      ordinary BSTs.

<div class="paragraph"> </div>


</li>
<li> On consecutive insertions, red-black trees are <i>much</i> faster
      than ordinary BSTs.

<div class="paragraph"> </div>


</li>
<li> Red-black trees are about as fast on consecutive insertions as
      on random. 

</li>
</ul>
</div>
<div class="code">

<span class="comment">(*&nbsp;2022-07-21&nbsp;14:28&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>