<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>Redblack: Red-Black Trees</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/vfa.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 3: Verified Functional Algorithms</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
   <li class='section_name'><a href='deps.html'>Roadmap</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">Redblack<span class="subtitle">Red-Black Trees</span></h1>

<div class="code">
</div>

<div class="doc">

<div class="paragraph"> </div>

 Red-black trees are a kind of <i>balanced</i> binary search tree (BST).
    Keeping the tree balanced ensures that the worst-case running
    time of operations is logarithmic rather than linear. 
<div class="paragraph"> </div>

 This chapter uses Okasaki's algorithms for red-black trees.
    If you don't recall those or haven't seem them in a while, read one
    of the following:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Red-Black Trees in a Functional Setting, by Chris Okasaki.
      <i>Journal of Functional Programming</i>, 9(4):471-477, July 1999.
      Available from <a href="https://doi.org/10.1017/S0956796899003494"><span class="inlineref">https://doi.org/10.1017/S0956796899003494</span></a>.
      Archived at
      <a href="https://web.archive.org/web/20070926220746/http://www.eecs.usma.edu/webs/people/okasaki/jfp99.ps"><span class="inlineref">https://web.archive.org/web/20070926220746/http://www.eecs.usma.edu/webs/people/okasaki/jfp99.ps</span></a>.

<div class="paragraph"> </div>


</li>
<li> <i>Purely Functional Data Structures</i>, by Chris Okasaki. Section
      3.3.  Cambridge University Press, 1998.

</li>
</ul>

<div class="paragraph"> </div>

    You can also consult Wikipedia or other standard textbooks, though
    they are likely to use different, imperative implementations. 
<div class="paragraph"> </div>

 This chapter is based on the Coq standard library module
    <span class="inlinecode"><span class="id" title="var">MSetRBT</span></span>, which can be found at
    <span class="inlinecode"><span class="id" title="var">https</span>://<span class="id" title="var">coq.inria.fr</span>/<span class="id" title="var">distrib</span>/<span class="id" title="var">current</span>/<span class="id" title="var">stdlib</span>/<span class="id" title="var">Coq.MSets.MSetRBT.html</span></span>.
    The design decisions for that module are described in the
    following paper:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Efficient Verified Red-Black Trees, by Andrew W. Appel,
      September 2011.  Available from
      <a href="http://www.cs.princeton.edu/~appel/papers/redblack.pdf"><span class="inlineref">http://www.cs.princeton.edu/~appel/papers/redblack.pdf</span></a>.  
</li>
</ul>

</div>

<div class="doc">
<a name="lab183"></a><h1 class="section">Implementation</h1>

<div class="paragraph"> </div>

 A <span class="inlinecode"><span class="id" title="keyword">Section</span></span> enables declaration of some <span class="inlinecode"><span class="id" title="keyword">Variable</span></span>s, which are in
    scope throughout. That saves us from having to write <span class="inlinecode"><span class="id" title="var">V</span></span> and
    <span class="inlinecode"><span class="id" title="var">default</span></span> as arguments to most of the definitions in the
    chapter. The variables do get inserted by Coq as arguments after
    the section is closed. 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Section</span> <a name="ValueType"><span class="id" title="section">ValueType</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Variable</span> <a name="ValueType.V"><span class="id" title="variable">V</span></a> : <span class="id" title="keyword">Type</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Variable</span> <a name="ValueType.default"><span class="id" title="variable">default</span></a> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>.<br/>
</div>

<div class="doc">
We use the <span class="inlinecode"><span class="id" title="var">int</span></span> type axiomatized in <a href="Extract.html"><span class="inlineref">Extract</span></a> as the key
      type. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="key"><span class="id" title="definition">key</span></a> := <a class="idref" href="Extract.html#int"><span class="id" title="axiom">int</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <a name="color"><span class="id" title="inductive">color</span></a> := <a name="Red"><span class="id" title="constructor">Red</span></a> | <a name="Black"><span class="id" title="constructor">Black</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <a name="tree"><span class="id" title="inductive">tree</span></a> : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;| <a name="E"><span class="id" title="constructor">E</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a><br/>
&nbsp;&nbsp;| <a name="T"><span class="id" title="constructor">T</span></a> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="empty_tree"><span class="id" title="definition">empty_tree</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a>.<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" title="var">lookup</span></span> implementation for red-black trees is exactly the same
      as the <span class="inlinecode"><span class="id" title="var">lookup</span></span> for BSTs, except that the <span class="inlinecode"><span class="id" title="var">T</span></span> constructor
      carries a <span class="inlinecode"><span class="id" title="var">color</span></span> component that is ignored. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="lookup"><span class="id" title="definition">lookup</span></a> (<span class="id" title="var">x</span>: <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#ValueType.default"><span class="id" title="variable">default</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">tl</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">tr</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">k</span> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">tl</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <span class="id" title="var">k</span> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">tr</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
We won't explain the <span class="inlinecode"><span class="id" title="var">insert</span></span> algorithm here; read Okasaki's
      work if you want to understand it.  In fact, you'll need very
      little understanding of it to follow along with the verification
      below. It uses <span class="inlinecode"><span class="id" title="var">balance</span></span> and <span class="inlinecode"><span class="id" title="var">ins</span></span> as helpers:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">ins</span></span> recurses down the tree to find where to insert, and is
        mostly the same as the BST <span class="inlinecode"><span class="id" title="var">insert</span></span> algorithm.

<div class="paragraph"> </div>


</li>
<li> <span class="inlinecode"><span class="id" title="var">balance</span></span> takes care of rebalancing the tree on the way back
        up. 
</li>
</ul>

</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="balance"><span class="id" title="definition">balance</span></a> (<span class="id" title="var">rb</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">t<sub>1</sub></span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">vk</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">t<sub>2</sub></span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#rb"><span class="id" title="variable">rb</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>"><span class="id" title="variable">t<sub>2</sub></span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t<sub>1</sub>"><span class="id" title="variable">t<sub>1</sub></span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">c</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">c</span> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>"><span class="id" title="variable">t<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">b</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">c</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">c</span> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>"><span class="id" title="variable">t<sub>2</sub></span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">a</span> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t<sub>2</sub>"><span class="id" title="variable">t<sub>2</sub></span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">b</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">c</span>) <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk"><span class="id" title="variable">vk</span></a> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">c</span> <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">b</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <span class="id" title="var">c</span> <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span>)  ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk"><span class="id" title="variable">vk</span></a> <span class="id" title="var">b</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">c</span> <span class="id" title="var">z</span> <span class="id" title="var">vz</span> <span class="id" title="var">d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">_</span> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#t<sub>1</sub>"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#vk"><span class="id" title="variable">vk</span></a> <a class="idref" href="Redblack.html#t<sub>2</sub>"><span class="id" title="variable">t<sub>2</sub></span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="ins"><span class="id" title="definition">ins</span></a> (<span class="id" title="var">x</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">vx</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">c</span> <span class="id" title="var">a</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">b</span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="var">y</span> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <span class="id" title="var">c</span> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <span class="id" title="var">a</span>) <span class="id" title="var">y</span> <span class="id" title="var">vy</span> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <span class="id" title="var">y</span> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <span class="id" title="var">c</span> <span class="id" title="var">a</span> <span class="id" title="var">y</span> <span class="id" title="var">vy</span> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <span class="id" title="var">b</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">c</span> <span class="id" title="var">a</span> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="make_black"><span class="id" title="definition">make_black</span></a> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span> ⇒ <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <span class="id" title="var">a</span> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="insert"><span class="id" title="definition">insert</span></a> (<span class="id" title="var">x</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">vx</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#make_black"><span class="id" title="definition">make_black</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>).<br/>
</div>

<div class="doc">
The <span class="inlinecode"><span class="id" title="var">elements</span></span> implementation is the same as for BSTs, except that it
      ignores colors. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="elements_tr"><span class="id" title="definition">elements_tr</span></a> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">acc</span>: <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>)) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="Redblack.html#acc"><span class="id" title="variable">acc</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> ⇒ <a class="idref" href="Redblack.html#elements_tr"><span class="id" title="definition">elements_tr</span></a> <span class="id" title="var">l</span> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">k</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#cbcf67aac0c2a85b8d93d37de9969adf"><span class="id" title="notation">::</span></a> <a class="idref" href="Redblack.html#elements_tr"><span class="id" title="definition">elements_tr</span></a> <span class="id" title="var">r</span> <a class="idref" href="Redblack.html#acc"><span class="id" title="variable">acc</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <a name="elements"><span class="id" title="definition">elements</span></a> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#elements_tr"><span class="id" title="definition">elements_tr</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Lists.List.html#ae9a5e1034e143b218b09d8e454472bd"><span class="id" title="notation">[]</span></a>.<br/>
</div>

<div class="doc">
<a name="lab184"></a><h1 class="section">Case-Analysis Automation</h1>

<div class="paragraph"> </div>

 Before verifying the correctness of our red-black tree
      implementation, let's warm up by proving that the result of any
      <span class="inlinecode"><span class="id" title="var">insert</span></span> is a nonempty tree. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ins_not_E"><span class="id" title="lemma">ins_not_E</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">vx</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;<span class="inlinecode"><span class="id" title="tactic">destruct</span></span>&nbsp;on&nbsp;the&nbsp;topmost&nbsp;case,&nbsp;<span class="inlinecode"><span class="id" title="var">ltb</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">k</span></span>.&nbsp;We&nbsp;can&nbsp;use<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="inlinecode"><span class="id" title="tactic">destruct</span></span>&nbsp;instead&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">bdestruct</span></span>&nbsp;because&nbsp;we&nbsp;don't&nbsp;need&nbsp;to&nbsp;know<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;whether&nbsp;<span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">&lt;</span> <span class="inlinecode"><span class="id" title="var">k</span></span>&nbsp;or&nbsp;<span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">≥</span> <span class="inlinecode"><span class="id" title="var">k</span></span>.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="Extract.html#ltb"><span class="id" title="axiom">ltb</span></a> <span class="id" title="var">x</span> <span class="id" title="var">k</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;A&nbsp;huge&nbsp;goal!&nbsp;&nbsp;The&nbsp;proof&nbsp;of&nbsp;this&nbsp;goal&nbsp;begins&nbsp;by&nbsp;matching<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;against&nbsp;a&nbsp;color.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Another&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>,&nbsp;this&nbsp;time&nbsp;against&nbsp;a&nbsp;tree.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <span class="id" title="var">x</span> <span class="id" title="var">vx</span> <span class="id" title="var">t<sub>1</sub></span>).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Another&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>&nbsp;against&nbsp;a&nbsp;tree.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">t<sub>2</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Yet&nbsp;another&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>.&nbsp;This&nbsp;pattern&nbsp;deserves&nbsp;automation.&nbsp;&nbsp;The<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;following&nbsp;tactic&nbsp;applies&nbsp;<span class="inlinecode"><span class="id" title="tactic">destruct</span></span>&nbsp;whenever&nbsp;the&nbsp;current&nbsp;goal<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;a&nbsp;<span class="inlinecode"><span class="id" title="keyword">match</span></span>&nbsp;against&nbsp;a&nbsp;color&nbsp;or&nbsp;a&nbsp;tree.&nbsp;*)</span><br/><hr class='doublespaceincode'/>

<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span>  <span class="id" title="keyword">end</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;apply&nbsp;that&nbsp;tactic&nbsp;repeatedly.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span>  <span class="id" title="keyword">end</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Now&nbsp;we're&nbsp;down&nbsp;to&nbsp;a&nbsp;base&nbsp;case.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">discriminate</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;And&nbsp;another&nbsp;base&nbsp;case.&nbsp;We&nbsp;could&nbsp;match&nbsp;against&nbsp;those,&nbsp;too.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="tactic">discriminate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;Let's&nbsp;restart&nbsp;the&nbsp;proof&nbsp;to&nbsp;incorporate&nbsp;this&nbsp;automation.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Abort</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ins_not_E"><span class="id" title="lemma">ins_not_E</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">vx</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#x"><span class="id" title="variable">x</span></a> <a class="idref" href="Redblack.html#vx"><span class="id" title="variable">vx</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">discriminate</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> ?<span class="id" title="var">x</span> <span class="id" title="keyword">then</span> <span class="id" title="var">_</span> <span class="id" title="keyword">else</span> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span>  <span class="id" title="keyword">end</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <span class="id" title="var">_</span>⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="tactic">discriminate</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
This automation of case analysis will be quite useful in the rest
      of our development. 
</div>

<div class="doc">
<a name="lab185"></a><h1 class="section">The BST Invariant</h1>

<div class="paragraph"> </div>

 The BST invariant is mostly the same for red-black trees as it
      was for ordinary BSTs as defined in <a href="SearchTree.html"><span class="inlineref">SearchTree</span></a>.  We adapt
      it by ignoring the color of each node, and changing from <span class="inlinecode"><span class="id" title="var">nat</span></span>
      keys to <span class="inlinecode"><span class="id" title="var">int</span></span>. 
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">ForallT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> holds if <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">k</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> holds for every <span class="inlinecode">(<span class="id" title="var">k</span>,</span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> node of
      tree <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="var">P</span>: <a class="idref" href="Extract.html#int"><span class="id" title="axiom">int</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) (<span class="id" title="var">t</span>: <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#True"><span class="id" title="inductive">True</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">c</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> ⇒ <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a> <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <span class="id" title="var">l</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a> <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <span class="id" title="var">r</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <a name="BST"><span class="id" title="inductive">BST</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="ST_E"><span class="id" title="constructor">ST_E</span></a> : <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a><br/>
&nbsp;&nbsp;| <a name="ST_T"><span class="id" title="constructor">ST_T</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">l</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="empty_tree_BST"><span class="id" title="lemma">empty_tree_BST</span></a>:  <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a>. <span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Let's show that <span class="inlinecode"><span class="id" title="var">insert</span></span> preserves the BST invariant, that is: 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="insert_BST"><span class="id" title="lemma">insert_BST</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">k</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
It will take quite a bit of work, but automation will help. 
<div class="paragraph"> </div>

 First, we show that if a non-empty tree would be a BST, then the
      balanced version of it is also a BST: 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="balance_BST"><span class="id" title="lemma">balance_BST</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">l</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">c</span> <span class="id" title="var">l</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">r</span> <span class="id" title="var">PL</span> <span class="id" title="var">PR</span> <span class="id" title="var">BL</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;58&nbsp;cases&nbsp;remaining.&nbsp;*)</span><br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>. <span class="id" title="tactic">assumption</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;Now&nbsp;the&nbsp;tree&nbsp;gets&nbsp;bigger,&nbsp;and&nbsp;the&nbsp;proof&nbsp;gets&nbsp;more&nbsp;complicated.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> ×. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;The&nbsp;intro&nbsp;pattern&nbsp;<span class="inlinecode">?</span>&nbsp;means&nbsp;to&nbsp;let&nbsp;Coq&nbsp;choose&nbsp;the&nbsp;name.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> <span class="id" title="var">PR</span> <span class="id" title="keyword">as</span> [? <span class="id" title="var">_</span>]. <span class="id" title="tactic">omega</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> ×. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> ×. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>5</sub></span> <span class="id" title="keyword">as</span> [? <span class="id" title="var">_</span>]. <span class="id" title="tactic">omega</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> ×. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>5</sub></span> <span class="id" title="keyword">as</span> [<span class="id" title="var">_</span> [? <span class="id" title="var">_</span>]]. <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> ×. <span class="id" title="tactic">destruct</span> <span class="id" title="var">H<sub>5</sub></span> <span class="id" title="keyword">as</span> [<span class="id" title="var">_</span> [<span class="id" title="var">_</span> ?]]. <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="var">inv</span> <span class="id" title="var">BR</span>. <span class="id" title="var">inv</span> <span class="id" title="var">H<sub>7</sub></span>. <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="comment">(*&nbsp;53&nbsp;cases&nbsp;remain.&nbsp;This&nbsp;could&nbsp;go&nbsp;on&nbsp;for&nbsp;a&nbsp;while...&nbsp;*)</span><br/>
<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
Let's use some of what we discovered above to automate.
      Whenever we have a subgoal of the form
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ForallT</span> <span class="id" title="var">_</span> (<span class="id" title="var">T</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)
<div class="paragraph"> </div>

</span>      we can split it.  Whenever we have a hypothesis of the form
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">BST</span> (<span class="id" title="var">T</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)
<div class="paragraph"> </div>

</span>      we can invert it.  And with a hypothesis
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ForallT</span> <span class="id" title="var">_</span> (<span class="id" title="var">T</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>)
<div class="paragraph"> </div>

</span>      we can simplify then destruct it.  Actually, the simplification
      is optional -- Coq will do the destruct without needing the
      simplification.  Anything else seems able to be finished with
      <span class="inlinecode"><span class="id" title="tactic">constructor</span></span>, <span class="inlinecode"><span class="id" title="tactic">auto</span></span>, and <span class="inlinecode"><span class="id" title="tactic">omega</span></span>.  Let's see how far that can
      take us...
   
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="balance_BST"><span class="id" title="lemma">balance_BST</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">l</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<span class="id" title="keyword">match</span> ?<span class="id" title="var">t</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">t</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? ?] ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">try</span> <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">omega</span>)).<br/>
</div>

<div class="doc">
41 cases remain.  It's a little disappointing that we didn't clear
      more of them.  Let's look at why are we stuck.

<div class="paragraph"> </div>

      All the remaining subgoals appear to be about proving an inequality
      over all the nodes of a subtree.  For example, the first subgoal
      follows from the hypotheses

<div class="paragraph"> </div>

<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ForallT</span> (<span class="id" title="keyword">fun</span> (<span class="id" title="var">k'</span> : <span class="id" title="var">int</span>) (<span class="id" title="var">_</span> : <span class="id" title="var">V</span>) ⇒ <span class="id" title="var">Abs</span> <span class="id" title="var">k'</span> &gt; <span class="id" title="var">Abs</span> <span class="id" title="var">k<sub>0</sub></span>) <span class="id" title="var">r<sub>2</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Abs</span> <span class="id" title="var">k<sub>1</sub></span> &lt; <span class="id" title="var">Abs</span> <span class="id" title="var">k<sub>0</sub></span>
<div class="paragraph"> </div>

</span>      The other goals look similar. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
To make progress, we can set up some helper lemmas. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ForallT_imp"><span class="id" title="lemma">ForallT_imp</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">P</span> <span class="id" title="var">Q</span> : <a class="idref" href="Extract.html#int"><span class="id" title="axiom">int</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) <span class="id" title="var">t</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span>, <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#Q"><span class="id" title="variable">Q</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#Q"><span class="id" title="variable">Q</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;- <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? ?]]. <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ForallT_greater"><span class="id" title="lemma">ForallT_greater</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">k</span> <span class="id" title="var">k<sub>0</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>"><span class="id" title="variable">k<sub>0</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>"><span class="id" title="variable">k<sub>0</sub></span></a>) <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_imp"><span class="id" title="lemma">ForallT_imp</span></a>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> <span class="id" title="var">H<sub>1</sub></span>. <span class="id" title="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ForallT_less"><span class="id" title="lemma">ForallT_less</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">k</span> <span class="id" title="var">k<sub>0</sub></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>  <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>"><span class="id" title="variable">k<sub>0</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k<sub>0</sub>"><span class="id" title="variable">k<sub>0</sub></span></a>) <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>; <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_imp"><span class="id" title="lemma">ForallT_imp</span></a>; <span class="id" title="tactic">eauto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">simpl</span> <span class="id" title="tactic">in</span> <span class="id" title="var">H<sub>1</sub></span>. <span class="id" title="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Now we can return to automating the proof. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="balance_BST"><span class="id" title="lemma">balance_BST</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">l</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">(</span></a><a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">)</span></a>) <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a>  (<span class="id" title="keyword">match</span> ?<span class="id" title="var">c</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">c</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a>  (<span class="id" title="keyword">match</span> ?<span class="id" title="var">s</span> <span class="id" title="keyword">with</span> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> ⇒ <span class="id" title="var">_</span> | <a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">_</span> <span class="id" title="keyword">end</span>)  ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">s</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  &#x22A2; <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) ⇒ <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">split</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <span class="id" title="var">_</span> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">destruct</span> <span class="id" title="var">H</span> <span class="id" title="keyword">as</span> [? [? ?] ]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|  <span class="id" title="var">H</span>: <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span> <span class="id" title="var">_</span>) &#x22A2; <span class="id" title="var">_</span> ⇒ <span class="id" title="var">inv</span> <span class="id" title="var">H</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="tactic">try</span> <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">omega</span>)).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;<span class="inlinecode"><span class="id" title="var">all</span>:</span> <span class="inlinecode"><span class="id" title="var">t</span></span>&nbsp;applies&nbsp;<span class="inlinecode"><span class="id" title="var">t</span></span>&nbsp;to&nbsp;every&nbsp;subgoal.&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">all</span>: <span class="id" title="tactic">try</span> <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_greater"><span class="id" title="lemma">ForallT_greater</span></a>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">eapply</span> <a class="idref" href="Redblack.html#ForallT_less"><span class="id" title="lemma">ForallT_less</span></a>; <span class="id" title="tactic">eauto</span>; <span class="id" title="tactic">try</span> <span class="id" title="tactic">omega</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a name="lab186"></a><h4 class="section">Exercise: 2 stars, standard (balanceP)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">balance</span></span> preserves <span class="inlinecode"><span class="id" title="var">ForallT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span>. Use proof automation
      with <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="keyword">goal</span></span> and/or <span class="inlinecode"><span class="id" title="var">all</span>:</span>.
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="balanceP"><span class="id" title="lemma">balanceP</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">P</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">l</span> <span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab187"></a><h4 class="section">Exercise: 2 stars, standard (insP)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">ins</span></span> preserves <span class="inlinecode"><span class="id" title="var">ForallT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span>. Hint: proceed by induction on <span class="inlinecode"><span class="id" title="var">t</span></span>.
      Use the previous lemma. There's no need for automated case analysis. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="insP"><span class="id" title="lemma">insP</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">P</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> <a class="idref" href="Redblack.html#P"><span class="id" title="variable">P</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab188"></a><h4 class="section">Exercise: 3 stars, standard (ins_BST)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">ins</span></span> maintains <span class="inlinecode"><span class="id" title="var">BST</span></span>.  Proceed by induction on the evidence
      that <span class="inlinecode"><span class="id" title="var">t</span></span> is a BST.  You don't need any automated case analysis. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ins_BST"><span class="id" title="lemma">ins_BST</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab189"></a><h4 class="section">Exercise: 2 stars, standard (insert_BST)</h4>

<div class="paragraph"> </div>

 Prove the main theorem: <span class="inlinecode"><span class="id" title="var">insert</span></span> preserves <span class="inlinecode"><span class="id" title="var">BST</span></span>. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="insert_BST"><span class="id" title="lemma">insert_BST</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">v</span> <span class="id" title="var">k</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>


<div class="doc">
<a name="lab190"></a><h1 class="section">Verification</h1>

<div class="paragraph"> </div>

 We now verify that the equational specification of maps holds for
      red-black trees:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lookup</span> <span class="id" title="var">k</span> <span class="id" title="var">empty_tree</span> = <span class="id" title="var">default</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lookup</span> <span class="id" title="var">k</span> (<span class="id" title="var">insert</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span>) = <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">lookup</span> <span class="id" title="var">k'</span> (<span class="id" title="var">insert</span> <span class="id" title="var">k</span> <span class="id" title="var">v</span> <span class="id" title="var">t</span>) = <span class="id" title="var">lookup</span> <span class="id" title="var">k'</span> <span class="id" title="var">t</span>       <span class="id" title="keyword">if</span> <span class="id" title="var">k</span> ≠ <span class="id" title="var">k'</span>
<div class="paragraph"> </div>

</span>
<div class="paragraph"> </div>

      The first equation is trivial to verify. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="lookup_empty"><span class="id" title="lemma">lookup_empty</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">k</span>, <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#ValueType.default"><span class="id" title="variable">default</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>. <span class="id" title="tactic">auto</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The next two equations are more challenging because of <span class="inlinecode"><span class="id" title="var">balance</span></span>. 
<div class="paragraph"> </div>

<a name="lab191"></a><h4 class="section">Exercise: 4 stars, standard (balance_lookup)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">balance</span></span> preserves the result of <span class="inlinecode"><span class="id" title="var">lookup</span></span> on
      non-empty trees. Hint: automate the case analysis similarly to
      <span class="inlinecode"><span class="id" title="var">balance_BST</span></span>. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="balance_lookup"><span class="id" title="lemma">balance_lookup</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">k</span> <span class="id" title="var">k'</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">l</span> <span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#143d73f5a64447681988da92e84a3de<sub>5</sub>"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#ForallT"><span class="id" title="definition">ForallT</span></a> (<span class="id" title="keyword">fun</span> <span class="id" title="var">k'</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#fbfa8c9e9a9b6d99f956a3a565fa7c7b"><span class="id" title="notation">&gt;</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a>) <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#f1746f02f141d025b1e53605943919bf"><span class="id" title="notation">&lt;?</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="keyword">if</span> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#0f6d3b46a03d1336a5ac68936077dc<sub>02</sub>"><span class="id" title="notation">&gt;?</span></a> <a class="idref" href="Extract.html#Abs"><span class="id" title="axiom">Abs</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab192"></a><h4 class="section">Exercise: 3 stars, standard (lookup_ins_eq)</h4>

<div class="paragraph"> </div>

 Verify the second equation, though for <span class="inlinecode"><span class="id" title="var">ins</span></span> rather than
      <span class="inlinecode"><span class="id" title="var">insert</span></span>.  Proceed by induction on the evidence that <span class="inlinecode"><span class="id" title="var">t</span></span> is a
      <span class="inlinecode"><span class="id" title="var">BST</span></span>.  Note that precondition <span class="inlinecode"><span class="id" title="var">BST</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> will be essential in your
      proof, unlike the ordinary BST's we saw in <a href="SearchTree.html"><span class="inlineref">SearchTree</span></a>.

<div class="paragraph"> </div>

      Hint: no automation of case analysis is needed; rely on the
      lemmas we've already proved above about <span class="inlinecode"><span class="id" title="var">balance</span></span> and <span class="inlinecode"><span class="id" title="var">ins</span></span>. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="lookup_ins_eq"><span class="id" title="lemma">lookup_ins_eq</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab193"></a><h4 class="section">Exercise: 3 stars, standard (lookup_ins_neq)</h4>

<div class="paragraph"> </div>

 Verify the third equation, again for <span class="inlinecode"><span class="id" title="var">ins</span></span> instead of <span class="inlinecode"><span class="id" title="var">insert</span></span>.
      The same hints as for the second equation hold.  
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="lookup_ins_neq"><span class="id" title="lemma">lookup_ins_neq</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> <span class="id" title="var">k'</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Finally, finish verify the second and third equations.  The
      proofs are almost identical.  
<div class="paragraph"> </div>

<a name="lab194"></a><h4 class="section">Exercise: 3 stars, standard (lookup_insert)</h4>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="lookup_insert_eq"><span class="id" title="lemma">lookup_insert_eq</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Theorem</span> <a name="lookup_insert_neq"><span class="id" title="lemma">lookup_insert_neq</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> <span class="id" title="var">k'</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
<font size=-2>&#9744;</font> 
<div class="paragraph"> </div>

 That concludes the verification of the map equations for red-black trees.
      We have proved these main theorems: 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#empty_tree_BST"><span class="id" title="lemma">empty_tree_BST</span></a> : <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#insert_BST"><span class="id" title="axiom">insert_BST</span></a> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>).<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#lookup_empty"><span class="id" title="lemma">lookup_empty</span></a> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#empty_tree"><span class="id" title="definition">empty_tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#ValueType.default"><span class="id" title="variable">default</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#lookup_insert_eq"><span class="id" title="axiom">lookup_insert_eq</span></a> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Check</span> <a class="idref" href="Redblack.html#lookup_insert_neq"><span class="id" title="axiom">lookup_insert_neq</span></a> :<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> <span class="id" title="var">k'</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#BST"><span class="id" title="inductive">BST</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a0a5068f83a704fcfbda8cd473a6cfea"><span class="id" title="notation">≠</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Redblack.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="Redblack.html#k'"><span class="id" title="variable">k'</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>.<br/>
</div>

<div class="doc">
We could now proceed to reprove all the facts about <span class="inlinecode"><span class="id" title="var">elements</span></span>
      that we developed in <a href="SearchTree.html"><span class="inlineref">SearchTree</span></a>.  But since <span class="inlinecode"><span class="id" title="var">elements</span></span>
      does not not pay attention to colors, and does not rebalance the
      tree, these proofs should be a simple copy-paste from that
      chapter, with only minor edits.  This would be an uninteresting
      exercise, so we don't pursue it here. 
</div>

<div class="doc">
<a name="lab195"></a><h1 class="section">Efficiency</h1>

<div class="paragraph"> </div>

 Red-black trees are more efficient than ordinary search trees,
      because red-black trees stay balanced.  The <span class="inlinecode"><span class="id" title="var">insert</span></span> operation
      ensures that these <i>red-black invariants</i> hold: 
<div class="paragraph"> </div>

<ul class="doclist">
<li> Local Invariant: No red node has a red child.

<div class="paragraph"> </div>

<ul class="doclist">
<li> Global Invariant: Every path from the root to a leaf has the
        same number of black nodes. 
</li>
</ul>

</li>
</ul>

<div class="paragraph"> </div>

 Together these invariants guarantee that no leaf is more
      than twice as deep as another leaf, a property that we will here
      call <i>approximately balanced</i>.  The maximum depth of a node is
      therefore <span class="inlinecode">2</span> <span class="inlinecode"><span class="id" title="var">log</span></span> <span class="inlinecode"><span class="id" title="var">N</span></span>, so the running-time of <span class="inlinecode"><span class="id" title="var">insert</span></span> and
      <span class="inlinecode"><span class="id" title="var">lookup</span></span> is <span class="inlinecode"><span class="id" title="var">O</span>(<span class="id" title="var">log</span></span> <span class="inlinecode"><span class="id" title="var">N</span>)</span>, where <span class="inlinecode"><span class="id" title="var">N</span></span> is the number of nodes in the
      tree.

<div class="paragraph"> </div>

      Coq does not have a formal time--cost model for its execution,
      so we cannot verify that logarithmic running time in Coq.  But
      we can prove that the trees are approximately balanced. 
<div class="paragraph"> </div>

 These ensure that the tree remains approximately balanced. 
<div class="paragraph"> </div>

 Relation <span class="inlinecode"><span class="id" title="var">RB</span></span>, below, formalizes the red-black
      invariants. Proposition <span class="inlinecode"><span class="id" title="var">RB</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">c</span></span> <span class="inlinecode"><span class="id" title="var">n</span></span> holds when <span class="inlinecode"><span class="id" title="var">t</span></span> satisfies the
      red-black invariants, assuming that <span class="inlinecode"><span class="id" title="var">c</span></span> is the color of <span class="inlinecode"><span class="id" title="var">t</span></span>'s
      parent, and <span class="inlinecode"><span class="id" title="var">n</span></span> is the black height that <span class="inlinecode"><span class="id" title="var">t</span></span> is supposed to
      have.

<div class="paragraph"> </div>

      If <span class="inlinecode"><span class="id" title="var">t</span></span> happens to have no parent (i.e., it is the entire tree),
      then it will be colored black by <span class="inlinecode"><span class="id" title="var">insert</span></span>, so it won't actually
      matter what color its (non-existent) parent might purportedly
      have: whether red or black, it can't violate the local
      invariant.

<div class="paragraph"> </div>

      If <span class="inlinecode"><span class="id" title="var">t</span></span> is a leaf, then it likewise won't matter what its parent
      color is, and its black height must be zero. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <a name="RB"><span class="id" title="inductive">RB</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="RB_leaf"><span class="id" title="constructor">RB_leaf</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>), <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#E"><span class="id" title="constructor">E</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> 0<br/>
&nbsp;&nbsp;| <a name="RB_r"><span class="id" title="constructor">RB_r</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">l</span> <span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>) <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a><br/>
&nbsp;&nbsp;| <a name="RB_b"><span class="id" title="constructor">RB_b</span></a>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">c</span> : <a class="idref" href="Redblack.html#color"><span class="id" title="inductive">color</span></a>) (<span class="id" title="var">l</span> <span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>) <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a>).<br/>
</div>

<div class="doc">
<a name="lab196"></a><h4 class="section">Exercise: 2 stars, standard (RB_blacken_parent)</h4>

<div class="paragraph"> </div>

 Prove that blackening a parent would preserve the red-black
      invariants. 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="RB_blacken_parent"><span class="id" title="lemma">RB_blacken_parent</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab197"></a><h4 class="section">Exercise: 2 stars, standard (RB_blacken_root)</h4>

<div class="paragraph"> </div>

 Prove that blackening a subtree root (whose hypothetical parent
      is black) would preserve the red-black invariants, though the
      black height of the subtree might change (and the color of the
      parent would need to become red). 
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="RB_blacken_root"><span class="id" title="lemma">RB_blacken_root</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">∃</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">(</span></a><span class="id" title="var">n'</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">),</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#make_black"><span class="id" title="definition">make_black</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n'"><span class="id" title="variable">n'</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Relation <span class="inlinecode"><span class="id" title="var">NearlyRB</span></span> expresses, "the tree is a red-black tree,
      except that it's nonempty and it is permitted to have two
      consecutive red nodes at the root only."  
</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Inductive</span> <a name="NearlyRB"><span class="id" title="inductive">NearlyRB</span></a> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;| <a name="NearlyRB_r"><span class="id" title="constructor">NearlyRB_r</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">l</span> <span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#NearlyRB"><span class="id" title="inductive">NearlyRB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>) <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a><br/>
&nbsp;&nbsp;| <a name="NearlyRB_b"><span class="id" title="constructor">NearlyRB_b</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">l</span> <span class="id" title="var">r</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#NearlyRB"><span class="id" title="inductive">NearlyRB</span></a> (<a class="idref" href="Redblack.html#T"><span class="id" title="constructor">T</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#l"><span class="id" title="variable">l</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#r"><span class="id" title="variable">r</span></a>) (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#S"><span class="id" title="constructor">S</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a>).<br/>
</div>

<div class="doc">
<a name="lab198"></a><h4 class="section">Exercise: 5 stars, standard (ins_RB)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">ins</span></span> creates a tree that is either red-black or
      nearly so, depending on what the parent's color was.  You will
      need significant case-analysis automation in a similar style to
      the proofs of <span class="inlinecode"><span class="id" title="var">ins_not_E</span></span> and <span class="inlinecode"><span class="id" title="var">balance_lookup</span></span>. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="ins_RB"><span class="id" title="lemma">ins_RB</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">(</span></a><a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#NearlyRB"><span class="id" title="inductive">NearlyRB</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">∧</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">(</span></a><a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#ba2b0e492d2b4675a0acf3ea92aabadd"><span class="id" title="notation">)</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">intro</span> <span class="id" title="var">n</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">split</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="var">inv</span> <span class="id" title="var">H</span>; <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">constructor</span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;× <span class="id" title="tactic">destruct</span> (<span class="id" title="var">IHt1</span> <span class="id" title="var">n</span>); <span class="id" title="tactic">clear</span> <span class="id" title="var">IHt1</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">destruct</span> (<span class="id" title="var">IHt2</span> <span class="id" title="var">n</span>); <span class="id" title="tactic">clear</span> <span class="id" title="var">IHt2</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">H<sub>0</sub></span> <span class="id" title="var">H<sub>6</sub></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">specialize</span> (<span class="id" title="var">H<sub>2</sub></span> <span class="id" title="var">H<sub>7</sub></span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">H</span> <span class="id" title="var">H<sub>1</sub></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="Redblack.html#balance"><span class="id" title="definition">balance</span></a>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Therefore, <span class="inlinecode"><span class="id" title="var">ins</span></span> produces a red-black tree when given one as
      input -- though the parent color changes. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="keyword">Corollary</span> <a name="ins_red"><span class="id" title="lemma">ins_red</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#ins"><span class="id" title="definition">ins</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Black"><span class="id" title="constructor">Black</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a>).<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">apply</span> <a class="idref" href="Redblack.html#ins_RB"><span class="id" title="axiom">ins_RB</span></a>. <span class="id" title="tactic">assumption</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
<a name="lab199"></a><h4 class="section">Exercise: 2 stars, standard (insert_RB)</h4>

<div class="paragraph"> </div>

 Prove that <span class="inlinecode"><span class="id" title="var">insert</span></span> produces a red-black tree when given one as
      input.  This can be done entirely with lemmas already proved. 
</div>
<div class="code">

<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="insert_RB"><span class="id" title="lemma">insert_RB</span></a> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) (<span class="id" title="var">k</span> : <a class="idref" href="Redblack.html#key"><span class="id" title="definition">key</span></a>) (<span class="id" title="var">v</span> : <a class="idref" href="Redblack.html#ValueType.V"><span class="id" title="variable">V</span></a>) (<span class="id" title="var">n</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">∃</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">(</span></a><span class="id" title="var">n'</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#a883bdd010993579f99d60b3775bcf54"><span class="id" title="notation">),</span></a> <a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> (<a class="idref" href="Redblack.html#insert"><span class="id" title="definition">insert</span></a> <a class="idref" href="Redblack.html#k"><span class="id" title="variable">k</span></a> <a class="idref" href="Redblack.html#v"><span class="id" title="variable">v</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a>) <a class="idref" href="Redblack.html#Red"><span class="id" title="constructor">Red</span></a> <a class="idref" href="Redblack.html#n'"><span class="id" title="variable">n'</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a name="lab200"></a><h4 class="section">Exercise: 4 stars, advanced (redblack_bound)</h4>

<div class="paragraph"> </div>

 To confirm that red-black trees are approximately balanced,
      define functions to compute the height (i.e., maximum depth) and
      minimum depth of a red-black tree, and prove that the height is
      bounded by twice the minimum depth, possibly plus 1.  Hints:

<div class="paragraph"> </div>

<ul class="doclist">
<li> Prove two auxiliary lemmas, one about height and the other
        about mindepth, and then combine them to get the result.  The
        lemma about height will need a slightly complicated induction
        hypothesis for the proof to go through.

<div class="paragraph"> </div>


</li>
<li> Depending on how you defined <span class="inlinecode"><span class="id" title="var">height</span></span> and <span class="inlinecode"><span class="id" title="var">mindepth</span></span>, the
        tactic <span class="inlinecode"><span class="id" title="var">zify</span></span> (defined in the standard library
        <span class="inlinecode"><span class="id" title="var">Coq.omega.PreOmega</span></span>) may be useful as a preliminary to using
        <span class="inlinecode"><span class="id" title="tactic">omega</span></span> when proving these lemmas. 
</li>
</ul>

</div>
<div class="code">

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="height"><span class="id" title="definition">height</span></a> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;REPLACE&nbsp;THIS&nbsp;LINE&nbsp;WITH&nbsp;":=&nbsp;_your_definition_&nbsp;."&nbsp;*)</span>. <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <a name="mindepth"><span class="id" title="definition">mindepth</span></a> (<span class="id" title="var">t</span> : <a class="idref" href="Redblack.html#tree"><span class="id" title="inductive">tree</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;REPLACE&nbsp;THIS&nbsp;LINE&nbsp;WITH&nbsp;":=&nbsp;_your_definition_&nbsp;."&nbsp;*)</span>. <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>

<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <a name="redblack_balanced"><span class="id" title="lemma">redblack_balanced</span></a> : <span class="id" title="keyword">∀</span> <span class="id" title="var">t</span> <span class="id" title="var">c</span> <span class="id" title="var">n</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Redblack.html#RB"><span class="id" title="inductive">RB</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="Redblack.html#c"><span class="id" title="variable">c</span></a> <a class="idref" href="Redblack.html#n"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#1c93e43e07fbeaeb6a625cb6614beb5d"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="Redblack.html#height"><span class="id" title="axiom">height</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#cb53cf0ee22c036a03b4a9281c68b5a<sub>3</sub>"><span class="id" title="notation">≤</span></a> 2 <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#ea2ff3d561159081cea6fb2e8113cc<sub>54</sub>"><span class="id" title="notation">×</span></a> <a class="idref" href="Redblack.html#mindepth"><span class="id" title="axiom">mindepth</span></a> <a class="idref" href="Redblack.html#t"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Peano.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> 1)%<span class="id" title="var">nat</span>.<br/>
&nbsp;&nbsp;<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/><hr class='doublespaceincode'/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Do&nbsp;not&nbsp;modify&nbsp;the&nbsp;following&nbsp;line:&nbsp;*)</span><br/>
<span class="id" title="keyword">Definition</span> <a name="manual_grade_for_redblack_bound"><span class="id" title="definition">manual_grade_for_redblack_bound</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">×</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Strings.String.html#string"><span class="id" title="inductive">string</span></a>) := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="Redblack.html#ValueType"><span class="id" title="section">ValueType</span></a>.<br/>
</div>

<div class="doc">
<a name="lab201"></a><h1 class="section">Performance of Extracted Code</h1>

<div class="paragraph"> </div>

 We can extract the red-black tree implementation: 
</div>
<div class="code">

<br/>
<span class="id" title="keyword">Extraction</span> "redblack.ml" <span class="id" title="var">empty_tree</span> <span class="id" title="var">insert</span> <span class="id" title="var">lookup</span> <span class="id" title="var">elements</span>.<br/>
</div>

<div class="doc">
Run it in the OCaml top level with these commands:
<pre>
      #use "redblack.ml";;
      #use "test_searchtree.ml";;
</pre>

<div class="paragraph"> </div>

    On a recent machine with a 2.9 GHz Intel Core i<sub>9</sub> that prints:
<pre>
      Insert and lookup 1000000 random integers in 0.860663 seconds.
      Insert and lookup 20000 random integers in 0.007908 seconds.
      Insert and lookup 20000 consecutive integers in 0.004668 seconds.
</pre>

<div class="paragraph"> </div>

    That execution uses the bytecode interpreter.  The native compiler
    will have better performance:
<pre>
      $ ocamlopt -c redblack.mli redblack.ml
      $ ocamlopt redblack.cmx -open Redblack test_searchtree.ml -o test_redblack
      $ ./test_redblack
</pre>

<div class="paragraph"> </div>

On the same machine that prints,
<pre>
      Insert and lookup 1000000 random integers in 0.475669 seconds.
      Insert and lookup 20000 random integers in 0.00312 seconds.
      Insert and lookup 20000 consecutive integers in 0.001183 seconds.
</pre>

<div class="paragraph"> </div>

 The benchmark measurements above (and in <a href="Extract.html"><span class="inlineref">Extract</span></a>)
    demonstrate the following:

<div class="paragraph"> </div>

<ul class="doclist">
<li> On random insertions, red-black trees are about the same as
      ordinary BSTs.

<div class="paragraph"> </div>


</li>
<li> On consecutive insertions, red-black trees are <i>much</i> faster
      than ordinary BSTs.

<div class="paragraph"> </div>


</li>
<li> Red-black trees are about as fast on consecutive insertions as
      on random. 
</li>
</ul>

</div>
<div class="code">

<br/>
<span class="comment">(*&nbsp;2020-07-24&nbsp;23:15:11&nbsp;(UTC+00)&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>