<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>WPgen: Weakest Precondition Generator</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/slf.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 6: Separation Logic Foundations</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
   <li class='section_name'><a href='deps.html'>Roadmap</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">WPgen<span class="subtitle">Weakest Precondition Generator</span></h1>


<div class="code">

<span class="id" title="keyword">Set Implicit Arguments</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">SLF</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="WPsem.html#"><span class="id" title="library">WPsem</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">f</span> : <a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">b</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">v</span> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">h</span> : <a class="idref" href="LibSepReference.html#heap"><span class="id" title="definition">heap</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">P</span> : <span class="id" title="keyword">Prop</span>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">H</span> : <a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">Q</span> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>.<br/>
</div>

<div class="doc">
<a id="lab251"></a><h1 class="section">First Pass</h1>

<div class="paragraph"> </div>

 In the previous chapter, we have introduced a predicate called <span class="inlinecode"><span class="id" title="var">wp</span></span>
    to describe the weakest precondition of a term <span class="inlinecode"><span class="id" title="var">t</span></span> with respect to
    a given postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span>. The weakest precondition <span class="inlinecode"><span class="id" title="var">wp</span></span> is defined
    by the equivalence: <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> if and only if <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    With respect to this "characterization of the semantics of <span class="inlinecode"><span class="id" title="var">wp</span></span>",
    we could prove "wp-style" reasoning rules. For example, the lemma
    <span class="inlinecode"><span class="id" title="var">wp_seq</span></span> asserts: <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">r</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    In this chapter, we introduce a function, called <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, to
    "effectively compute" the weakest precondition of a term.
    The value of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is defined recursively over the structure
    of the term <span class="inlinecode"><span class="id" title="var">t</span></span>, and ultimately produces a formula that is logically
    equivalent to <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    The major difference between <span class="inlinecode"><span class="id" title="var">wp</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is that, whereas <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>
    is a predicate that we can reason about by "applying" reasoning rules,
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is a predicate that we can reason about simply by "unfolding"
    its definition. Moreover, <span class="inlinecode"><span class="id" title="var">wp</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> differs on the way they handle
    variable substitution. Consider, e.g., a let-binding. The wp-style
    reasoning rule for a let-binding introduces a substitution of the form
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>, which the user must simplify explicitly. On the
    contrary, when working with <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, all the substitutions get automatically
    simplified during the initial evaluation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on the source program;
    the end-user sees none of these substitutions.

<div class="paragraph"> </div>

    At a high level, the introduction of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is a key ingredient to
    smoothening the user-experience of conducting interactive proofs in
    Separation Logic. The matter of the present chapter is to show:

<div class="paragraph"> </div>

<ul class="doclist">
<li> how to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> as a recursive function that computes in Coq,

</li>
<li> how to integrate support for the frame rule in this recursive definition,

</li>
<li> how to carry out practical proofs using <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.

</li>
</ul>

<div class="paragraph"> </div>

    A bonus section explains how to establish the soundness theorem for
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. 
<div class="paragraph"> </div>

 The "first pass" section that comes next is fairly short.
    It only gives a bird-eye tour of the steps of the construction.
    Detailed explanations are provided in the main body of the chapter. 
<div class="paragraph"> </div>

 As first approximation, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is defined as a recursive function
    that pattern matches on its argument <span class="inlinecode"><span class="id" title="var">t</span></span>, and produces the appropriate
    heap predicate in each case. The definitions somewhat mimic those of
    <span class="inlinecode"><span class="id" title="var">wp</span></span>. For example, where the rule <span class="inlinecode"><span class="id" title="var">wp_let</span></span> asserts the entailment,
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>,
    the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is such that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>
    is, by definition, equal to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>.
    One special case is that of applications. We define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span>
    as <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span>, that is, we fall back onto the semantical
    definition of weakest precondition.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> (<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    From there, to obtain the actual definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we need to
    refine the above definition in four steps.

<div class="paragraph"> </div>

    In a first step, we modify the definition in order to make it
    structurally recursive. Indeed, in the above the recursive call
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> is not made to a strict subterm of
    <span class="inlinecode"><span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, thus Coq refuse this definition as it stands.

<div class="paragraph"> </div>

    To fix the issue, we change the definition to the form <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>,
    where <span class="inlinecode"><span class="id" title="var">E</span></span> denotes an association list bindings values to variables.
    The intention is that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> computes the weakest precondition
    for the term obtained by substituting all the bindings from <span class="inlinecode"><span class="id" title="var">E</span></span> in <span class="inlinecode"><span class="id" title="var">t</span></span>.
    (This term is described by the operation <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> in the chapter.)

<div class="paragraph"> </div>

    The updated definition looks as follows. Observe how, when traversing
    <span class="inlinecode"><span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, the context <span class="inlinecode"><span class="id" title="var">E</span></span> gets extended as <span class="inlinecode">(<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span></span>.
    Observe also how, when reaching a variable <span class="inlinecode"><span class="id" title="var">x</span></span>, a lookup for <span class="inlinecode"><span class="id" title="var">x</span></span>
    into the context <span class="inlinecode"><span class="id" title="var">E</span></span> is performed for recovering the value that,
    morally, should have been substituted for <span class="inlinecode"><span class="id" title="var">x</span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lookup</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>) <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
<div class="paragraph"> </div>

 In a second step, we slightly tweak the definition so as to swap
    the place where <span class="inlinecode"><span class="id" title="var">Q</span></span> is taken as argument with the place where
    the pattern matching on <span class="inlinecode"><span class="id" title="var">t</span></span> occurs. The idea is to make it obvious
    that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> can be computed without any knowledge of <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    The type of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is <span class="inlinecode">(<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span></span>, a type which we
    thereafter call <span class="inlinecode"><span class="id" title="var">formula</span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lookup</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">wp</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>) <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
<div class="paragraph"> </div>

 In a third step, we introduce auxiliary definitions to improve
    the readability of the output of calls to <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For example,
    we let <span class="inlinecode"><span class="id" title="var">wpgen_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> be a shorthand for <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>.
    Likewise, we let <span class="inlinecode"><span class="id" title="var">wpgen_let</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> be a shorthand for
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>. Using these auxiliary
    definitions, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> rewrites as follows.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen_val</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">wpgen_var</span> <span class="id" title="var">E</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen_let</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    Each of the auxiliary definitions introduced comes with a custom notation
    that enables a nice display of the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For example, we set
    up the notation <span class="inlinecode"><span class="id" title="var">Let'</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> to stand for
    <span class="inlinecode"><span class="id" title="var">wpgen_let</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span>)</span>.
    Thanks to this notation, the result of computing <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a source term
    <span class="inlinecode"><span class="id" title="keyword">Let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> (which is an Coq expression of type <span class="inlinecode"><span class="id" title="var">trm</span></span>) will be a
    formula displayed in the form <span class="inlinecode"><span class="id" title="var">Let'</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> (which is an Coq
    expression of type <span class="inlinecode"><span class="id" title="var">formula</span></span>).

<div class="paragraph"> </div>

    Thanks to these auxiliary definitions and pieces of notation, the formula
    that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> produces as output reads pretty much like the source term
    provided as input. 
<div class="paragraph"> </div>

 In a fourth step, we refine the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> in order to equip
    it with inherent support for applications of the structural rules of the
    logic, namely the frame rule and the rule of consequence. To achieve this,
    we consider a well-crafted predicate called <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>, and insert it
    at the head of the output of every call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, including all its
    recursive calls. The definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> thus now admits the following
    structure.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ ...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| ...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).
</span>    Without entering the details, the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> is a function
    of type <span class="inlinecode"><span class="id" title="var">formula</span>→<span class="id" title="var">formula</span></span> that captures the essence of the wp-style
    consequence-frame structural rule. This rule, called <span class="inlinecode"><span class="id" title="var">wp_conseq_frame</span></span>
    in the previous chapter, asserts:
    <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span></span> <span class="inlinecode"><span class='gray-font'>\</span>*+</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">===&gt;</span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span></span>  <span class="inlinecode">→</span>  <span class="inlinecode">(<span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span>)</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode">(<span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span>)</span>. 
<div class="paragraph"> </div>

 This concludes our little journey towards the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.

<div class="paragraph"> </div>

    For conducting proofs in practice, there remains to state lemmas and
    define tactics to assist the user in the manipulation of the formula
    produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. Ultimately, the end-user only manipulates CFML's
    "x-tactics" (recall the first two chapters), without ever being
    required to understand how <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is defined.

<div class="paragraph"> </div>

    In other words, the contents of this chapter reveals the details
    that we work very hard to make completely invisible to the end user. 
</div>

<div class="doc">
<a id="lab252"></a><h1 class="section">More Details</h1>

</div>

<div class="doc">
<a id="lab253"></a><h2 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Term Rules</h2>

<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">wpgen</span></span> computes a heap predicate that has the same meaning as <span class="inlinecode"><span class="id" title="var">wp</span></span>.
    In essence, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> takes the form of a recursive function that,
    like <span class="inlinecode"><span class="id" title="var">wp</span></span>, expects a term <span class="inlinecode"><span class="id" title="var">t</span></span> and a postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span>, and produces
    a heap predicate. The function is recursively defined and its result
    is guided by the structure of the term <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    In essence, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> admits the following shape:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_if</span> <span class="id" title="var">v<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).
</span>    Our first goal is to figure out how to fill in the dots for each of the
    term constructors.

<div class="paragraph"> </div>

    The intention that guides us for filling the dot is the soundness theorem
    for <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, which takes the following form:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wpgen</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span> ==&gt; <span class="id" title="var">wp</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span>
</span>    This entailment asserts in particular that, if we are able to establish
    a statement of the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, then we can derive from it
    <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. The latter is also equivalent to <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.
    Thus, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> can be viewed as a practical tool to establish triples.

<div class="paragraph"> </div>

    Remark: the main difference between <span class="inlinecode"><span class="id" title="var">wpgen</span></span> and a "traditional" weakest
    precondition generator (as the reader might have seen for Hoare logic)
    is that here we compute the weakest precondition of a raw term, that is,
    a term not annotated with any invariant or specification. 
</div>

<div class="doc">
<a id="lab254"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Values</h3>

<div class="paragraph"> </div>

 Consider first the case of a value <span class="inlinecode"><span class="id" title="var">v</span></span>. Recall the reasoning
    rule for values in weakest-precondition style. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_val" class="idref" href="#wp_val"><span class="id" title="axiom">wp_val</span></a> : <span class="id" title="keyword">∀</span> <a id="v:1" class="idref" href="#v:1"><span class="id" title="binder">v</span></a> <a id="Q:2" class="idref" href="#Q:2"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q:2"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#v:1"><span class="id" title="variable">v</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <a class="idref" href="WPgen.html#v:1"><span class="id" title="variable">v</span></a>) <a class="idref" href="WPgen.html#Q:2"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
The soundness theorem for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> requires the entailment
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> to hold.

<div class="paragraph"> </div>

    To satisfy this entailment, according to the rule <span class="inlinecode"><span class="id" title="var">wp_val</span></span>,
    it suffices to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>.

<div class="paragraph"> </div>

    Concretely, we fill in the first dots as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab255"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Functions</h3>

<div class="paragraph"> </div>

 Consider the case of a function definition <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.
    Recall that the <span class="inlinecode"><span class="id" title="var">wp</span></span> reasoning rule for functions is very
    similar to that for values. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_fun" class="idref" href="#wp_fun"><span class="id" title="axiom">wp_fun</span></a> : <span class="id" title="keyword">∀</span> <a id="x:4" class="idref" href="#x:4"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:5" class="idref" href="#t<sub>1</sub>:5"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="Q:6" class="idref" href="#Q:6"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q:6"><span class="id" title="variable">Q</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:4"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:5"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <a class="idref" href="WPgen.html#x:4"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:5"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="WPgen.html#Q:6"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
So, likewise, we can define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for functions and for
    recursive functions as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>   ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
<div class="paragraph"> </div>

 An important observation is that we here do not attempt to
    recursively compute <span class="inlinecode"><span class="id" title="var">wpgen</span></span> over the body of the function.
    This is something that we could do, and that we will see how
    to achieve further on, yet we postpone it for now because it is
    relatively technical. In practice, if the program features a
    local function definition, the user may explicitly request the
    computation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> over the body of that function. Thus,
    the fact that we do not recursively traverse functions bodies
    does not harm expressiveness. 
</div>

<div class="doc">
<a id="lab256"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Sequence</h3>

<div class="paragraph"> </div>

 Recall the <span class="inlinecode"><span class="id" title="var">wp</span></span> reasoning rule for a sequence <span class="inlinecode"><span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_seq" class="idref" href="#wp_seq"><span class="id" title="axiom">wp_seq</span></a> : <span class="id" title="keyword">∀</span> <a id="t<sub>1</sub>:8" class="idref" href="#t<sub>1</sub>:8"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:9" class="idref" href="#t<sub>2</sub>:9"><span class="id" title="binder">t<sub>2</sub></span></a> <a id="Q:10" class="idref" href="#Q:10"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:8"><span class="id" title="variable">t<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:11" class="idref" href="#v:11"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:9"><span class="id" title="variable">t<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:10"><span class="id" title="variable">Q</span></a>) <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:8"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:9"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:10"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
The intention is for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to admit the same semantics as <span class="inlinecode"><span class="id" title="var">wp</span></span>.
    We thus expect the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> to have a
    similar shape as <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>.

<div class="paragraph"> </div>

    We therefore define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>. The definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    thus gets refined as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab257"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Let-Bindings</h3>

<div class="paragraph"> </div>

 The case of let bindings is similar to that of sequences,
    except that it involves a substitution. Recall the <span class="inlinecode"><span class="id" title="var">wp</span></span> rule: 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_let" class="idref" href="#wp_let"><span class="id" title="axiom">wp_let</span></a> : <span class="id" title="keyword">∀</span> <a id="x:13" class="idref" href="#x:13"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:14" class="idref" href="#t<sub>1</sub>:14"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:15" class="idref" href="#t<sub>2</sub>:15"><span class="id" title="binder">t<sub>2</sub></span></a> <a id="Q:16" class="idref" href="#Q:16"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:14"><span class="id" title="variable">t<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:17" class="idref" href="#v:17"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:13"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v:17"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:15"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:16"><span class="id" title="variable">Q</span></a>) <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <a class="idref" href="WPgen.html#x:13"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:14"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:15"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:16"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
We fill in the dots as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> (<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>    One important observation to make at this point is that the
    function <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is no longer structurally recursive. Indeed,
    while the first recursive call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is invoked on <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>, which
    is a strict subterm of <span class="inlinecode"><span class="id" title="var">t</span></span>, the second call is invoked on
    <span class="inlinecode"><span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, which is not a strict subterm of <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    It is technically possible to convince Coq that the function <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    terminates, yet with great effort. Alternatively, we can circumvent
    the problem altogether by casting the function in a form that makes
    it structurally recursive. Concretely, we will see further on how to
    add as argument to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> a substitution context (written <span class="inlinecode"><span class="id" title="var">E</span></span>) to
    delay the computation of substitutions until the leaves of the recursion. 
</div>

<div class="doc">
<a id="lab258"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Variables</h3>

<div class="paragraph"> </div>

 We have seen no reasoning rules for establishing a triple for a program
    variable, that is, to prove <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. Indeed, <span class="inlinecode"><span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span>
    is a stuck term: its execution does not produce an output.

<div class="paragraph"> </div>

    While a source term may contain program variables, all these variables
    should get substituted away before the execution reaches them.

<div class="paragraph"> </div>

    In the case of the function <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, a variable bound by let-binding
    get substituted while traversing that let-binding construct. Thus,
    if a free variable is reached by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, it means that this variable
    was originally a dangling free variable, and therefore that the initial
    source term was invalid.

<div class="paragraph"> </div>

    Although we have presented no reasoning rules for <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>
    nor for <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, we nevertheless have to provide some
    meaningful definition for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. This definition should
    capture the fact that this case must not happen. The heap predicate
    <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span> captures this intention perfectly well.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
<div class="paragraph"> </div>

 Remark: the definition of \<span class="inlinecode"><span class="id" title="var">False</span></span> translates the fact that,
    technically, we could have stated a Separation Logic rule
    for free variables, using <span class="inlinecode"><span class="id" title="var">False</span></span> as a premise <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>
    as precondition. There are three canonical ways of presenting
    this rule, they are shown next. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="wp_var" class="idref" href="#wp_var"><span class="id" title="lemma">wp_var</span></a> : <span class="id" title="keyword">∀</span> <a id="x:19" class="idref" href="#x:19"><span class="id" title="binder">x</span></a> <a id="Q:20" class="idref" href="#Q:20"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <a class="idref" href="WPgen.html#x:19"><span class="id" title="variable">x</span></a>) <a class="idref" href="WPgen.html#Q:20"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">h</span> <span class="id" title="var">Hh</span>. <span class="id" title="tactic">destruct</span> (<a class="idref" href="LibSepReference.html#SepSimplArgs.hpure_inv"><span class="id" title="lemma">hpure_inv</span></a> <span class="id" title="var">Hh</span>). <span class="id" title="var">false</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="triple_var" class="idref" href="#triple_var"><span class="id" title="lemma">triple_var</span></a> : <span class="id" title="keyword">∀</span> <a id="x:21" class="idref" href="#x:21"><span class="id" title="binder">x</span></a> <a id="H:22" class="idref" href="#H:22"><span class="id" title="binder">H</span></a> <a id="Q:23" class="idref" href="#Q:23"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <a class="idref" href="WPgen.html#x:21"><span class="id" title="variable">x</span></a>) <a class="idref" href="WPgen.html#H:22"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:23"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="var">false</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="triple_var'" class="idref" href="#triple_var'"><span class="id" title="lemma">triple_var'</span></a> : <span class="id" title="keyword">∀</span> <a id="x:24" class="idref" href="#x:24"><span class="id" title="binder">x</span></a> <a id="Q:25" class="idref" href="#Q:25"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <a class="idref" href="WPgen.html#x:24"><span class="id" title="variable">x</span></a>) <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="WPgen.html#Q:25"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="axiom">wp_equiv</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#wp_var"><span class="id" title="lemma">wp_var</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
All these rules are correct, albeit totally useless. 
</div>

<div class="doc">
<a id="lab259"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Function Applications</h3>

<div class="paragraph"> </div>

 Consider an application in A-normal form, that is,
    an application of the form <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span>.

<div class="paragraph"> </div>

    We have seen <span class="inlinecode"><span class="id" title="var">wp</span></span>-style rules to reason about the application of
    a known function, e.g. <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode">(<span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span>.
    However, if <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> is an abstrat value (e.g., a Coq variable
    of type <span class="inlinecode"><span class="id" title="var">val</span></span>), we have no reasoning rule at hand that applies.

<div class="paragraph"> </div>

    Thus, we will simply define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. In other words, to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for
    a function application, we fall back to the semantic definition
    of <span class="inlinecode"><span class="id" title="var">wp</span></span>. We thus extend the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> as follows.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span>) <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>    As we carry out verification proofs in practice, when reaching
    an application we will face a goal of the form:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> ==&gt; <span class="id" title="var">wpgen</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span>) <span class="id" title="var">Q</span>
</span>    By revealing the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on applications, we get:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H</span> ==&gt; <span class="id" title="var">wp</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span>) <span class="id" title="var">Q</span>
</span>    Then, by exploiting the equivalence with triples, we obtain:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">triple</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span>) <span class="id" title="var">H</span> <span class="id" title="var">Q</span>
</span>    Such a proof obligation can be discharged by invoking a specification
    triple for the function <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span>.

<div class="paragraph"> </div>

    In other words, by falling back to the semantics definition when
    reaching a function application, we allow the user to choose which
    specification lemma to exploit for reasoning about this particular
    function application. 
<div class="paragraph"> </div>

 Remark: we assume throughout the course that terms are written
    in A-normal form. Nevertheless, we need to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> even
    on terms that are not in A-normal form. One possibility is
    to map all these terms to <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>. In the specific case of an
    application of the form <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> where <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> are
    not both values, it is still correct to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>))</span>
    as <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>. So, we need not bother checking in the
    definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that the arguments of <span class="inlinecode"><span class="id" title="var">trm_app</span></span> are actually
    values. 
<div class="paragraph"> </div>

 Thus, the most concise definition for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on applications is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab260"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Conditionals</h3>

<div class="paragraph"> </div>

 The last remaining case is that for conditionals. Recall the
    <span class="inlinecode"><span class="id" title="var">wp</span></span>-style reasoning rule stated using a Coq conditional. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_if" class="idref" href="#wp_if"><span class="id" title="axiom">wp_if</span></a> : <span class="id" title="keyword">∀</span> (<a id="b:26" class="idref" href="#b:26"><span class="id" title="binder">b</span></a>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>) <a id="t<sub>1</sub>:27" class="idref" href="#t<sub>1</sub>:27"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:28" class="idref" href="#t<sub>2</sub>:28"><span class="id" title="binder">t<sub>2</sub></span></a> <a id="Q:29" class="idref" href="#Q:29"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> <a class="idref" href="WPgen.html#b:26"><span class="id" title="variable">b</span></a> <span class="id" title="keyword">then</span> (<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:27"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:29"><span class="id" title="variable">Q</span></a>) <span class="id" title="keyword">else</span> (<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:28"><span class="id" title="variable">t<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:29"><span class="id" title="variable">Q</span></a>)<a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> (<a class="idref" href="LibSepReference.html#val_bool"><span class="id" title="constructor">val_bool</span></a> <a class="idref" href="WPgen.html#b:26"><span class="id" title="variable">b</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:27"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:28"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:29"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
We need to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for all conditionals in A-normal form, i.e.,
    all terms of the form <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>0</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, where <span class="inlinecode"><span class="id" title="var">v<sub>0</sub></span></span> could be a
    value of unknown shape. Typically, a program may feature a conditional
    <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> that, after substitution for <span class="inlinecode"><span class="id" title="var">x</span></span>, becomes
    <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, for some abstract <span class="inlinecode"><span class="id" title="var">v</span></span> of type <span class="inlinecode"><span class="id" title="var">val</span></span> that
    we might not yet know to be a boolean value.

<div class="paragraph"> </div>

    Yet, the rule <span class="inlinecode"><span class="id" title="var">wp_if</span></span> only applies when the first argument of <span class="inlinecode"><span class="id" title="var">trm_if</span></span>
    is syntactically a boolean value <span class="inlinecode"><span class="id" title="var">b</span></span>. To handle this mismatch, we
    set up <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to pattern-match a conditional as <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>,
    and then express using a Separation Logic existential quantifier that
    there should exist a boolean <span class="inlinecode"><span class="id" title="var">b</span></span> such that <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">trm_val</span></span> <span class="inlinecode">(<span class="id" title="var">val_bool</span></span> <span class="inlinecode"><span class="id" title="var">b</span>)</span>.

<div class="paragraph"> </div>

    This way, we delay the moment at which the argument of the conditional
    needs to be shown to be a boolean value. The formal definition is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_if</span> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span><span class="id" title="tactic">∃</span> (<span class="id" title="var">b</span>:<span class="id" title="var">bool</span>), <span class='gray-font'>\</span>[<span class="id" title="var">t<sub>0</sub></span> = <span class="id" title="var">trm_val</span> (<span class="id" title="var">val_bool</span> <span class="id" title="var">b</span>)]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span>* (<span class="id" title="keyword">if</span> <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span>) <span class="id" title="var">Q</span> <span class="id" title="keyword">else</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab261"></a><h3 class="section">Summary of the Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Term Rules</h3>

<div class="paragraph"> </div>

 In summary, we have defined:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> (<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_if</span> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span><span class="id" title="tactic">∃</span> (<span class="id" title="var">b</span>:<span class="id" title="var">bool</span>), <span class='gray-font'>\</span>[<span class="id" title="var">t<sub>0</sub></span> = <span class="id" title="var">trm_val</span> (<span class="id" title="var">val_bool</span> <span class="id" title="var">b</span>)]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span>* (<span class="id" title="keyword">if</span> <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span>) <span class="id" title="var">Q</span> <span class="id" title="keyword">else</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    As pointed out earlier, this definition is not structurally recursive
    and thus not accepted by Coq, due to the recursive call
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. Our next step is to fix this issue. 
</div>

<div class="doc">
<a id="lab262"></a><h2 class="section">Computing with <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h2>

<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is not structurally recursive because of the substitutions
    that takes places in-between recursive calls. To fix this, we are
    going to delay the substitutions until the leaves of the recursion.

<div class="paragraph"> </div>

    To that end, we introduce a substitution context, written <span class="inlinecode"><span class="id" title="var">E</span></span>, to
    record the substitutions that should have been performed.

<div class="paragraph"> </div>

    Concretely, we modify the function to take the form <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>,
    where <span class="inlinecode"><span class="id" title="var">E</span></span> denotes a set of bindings from variables to values.
    The intention is that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> computes the weakest precondition
    for the term <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, which denotes the result of substituting
    all bindings from E inside the term <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>

<div class="doc">
<a id="lab263"></a><h3 class="section">Definition of Contexts and Operations on Them</h3>

<div class="paragraph"> </div>

 The simplest way to define a context <span class="inlinecode"><span class="id" title="var">E</span></span> is as an association
    list relating variables to values. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="ctx" class="idref" href="#ctx"><span class="id" title="definition">ctx</span></a> : <span class="id" title="keyword">Type</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">*</span></a><a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>).<br/>
</div>

<div class="doc">
Before we explain how to revisit the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> using
    contexts, we need to define the "iterated substitution" operation.
    This operation, written <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, describes the substitution
    of all the bindings form <span class="inlinecode"><span class="id" title="var">E</span></span> inside a term <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    The definition of iterated substitution is relatively standard:
    we traverse the term recursively and, when reaching a variable,
    we perform a lookup in the context <span class="inlinecode"><span class="id" title="var">E</span></span>. We need to take care
    to respect variable shadowing. To that end, when traversing a
    binder that binds a variable <span class="inlinecode"><span class="id" title="var">x</span></span>, we remove all occurrences of <span class="inlinecode"><span class="id" title="var">x</span></span>
    that might exist in <span class="inlinecode"><span class="id" title="var">E</span></span>.

<div class="paragraph"> </div>

    The formal definition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> involves two auxiliary functions:
    lookup and removal on association lists.

<div class="paragraph"> </div>

    The definition of the operation <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> on association lists
    is standard. It returns an option on a value. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="lookup" class="idref" href="#lookup"><span class="id" title="definition">lookup</span></a> (<a id="x:31" class="idref" href="#x:31"><span class="id" title="binder">x</span></a>:<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>) (<a id="E:32" class="idref" href="#E:32"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#E:32"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">y</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><span class="id" title="var">E<sub>1</sub></span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="LibSepVar.html#var_eq"><span class="id" title="definition">var_eq</span></a> <a class="idref" href="WPgen.html#x:31"><span class="id" title="variable">x</span></a> <span class="id" title="var">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="WPgen.html#lookup:33"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:31"><span class="id" title="variable">x</span></a> <span class="id" title="var">E<sub>1</sub></span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The definition of the removal operation, written <span class="inlinecode"><span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>, is
    also standard. It returns a filtered context. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="rem" class="idref" href="#rem"><span class="id" title="definition">rem</span></a> (<a id="x:35" class="idref" href="#x:35"><span class="id" title="binder">x</span></a>:<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>) (<a id="E:36" class="idref" href="#E:36"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) : <a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#E:36"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">y</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><span class="id" title="var">E<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="E<sub>1</sub>':39" class="idref" href="#E<sub>1</sub>':39"><span class="id" title="binder">E<sub>1</sub>'</span></a> := <a class="idref" href="WPgen.html#rem:37"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:35"><span class="id" title="variable">x</span></a> <span class="id" title="var">E<sub>1</sub></span> <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <a class="idref" href="LibSepVar.html#var_eq"><span class="id" title="definition">var_eq</span></a> <a class="idref" href="WPgen.html#x:35"><span class="id" title="variable">x</span></a> <span class="id" title="var">y</span> <span class="id" title="keyword">then</span> <a class="idref" href="WPgen.html#E<sub>1</sub>':39"><span class="id" title="variable">E<sub>1</sub>'</span></a> <span class="id" title="keyword">else</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">y</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E<sub>1</sub>':39"><span class="id" title="variable">E<sub>1</sub>'</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The definition of the operation <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> can then be expressed
    as a recursive function over the term <span class="inlinecode"><span class="id" title="var">t</span></span>. It invokes <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>
    when reaching a variable <span class="inlinecode"><span class="id" title="var">x</span></span>. It invokes <span class="inlinecode"><span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> when traversing
    a binding on the name <span class="inlinecode"><span class="id" title="var">x</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="isubst" class="idref" href="#isubst"><span class="id" title="definition">isubst</span></a> (<a id="E:40" class="idref" href="#E:40"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:41" class="idref" href="#t:41"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:41"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="WPgen.html#t:41"><span class="id" title="variable">t</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Remark: it is also possible to define the substitution by iterating
    the unary substitution <span class="inlinecode"><span class="id" title="tactic">subst</span></span> over the list of bindings from <span class="inlinecode"><span class="id" title="var">E</span></span>.
    However, this alternative approach yields a less efficient function
    and leads to more complicated proofs. 
<div class="paragraph"> </div>

 In what follows, we present the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> case by
    case. Throughout these definitions, recall that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is
    interpreted as the weakest precondition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>

<div class="doc">
<a id="lab264"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">wpgen</span></span>: the Let-Binding Case</h3>

<div class="paragraph"> </div>

 When <span class="inlinecode"><span class="id" title="var">wpgen</span></span> traverses a let-binding, rather than eagerly performing
    a substitution, it simply extends the current context.

<div class="paragraph"> </div>

    Concretely, a call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> triggers a recursive
    call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. The corresponding definition is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab265"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">wpgen</span></span>: the Variable Case</h3>

<div class="paragraph"> </div>

 When <span class="inlinecode"><span class="id" title="var">wpgen</span></span> reaches a variable, it lookups for a binding on the
    variable <span class="inlinecode"><span class="id" title="var">x</span></span> inside the context <span class="inlinecode"><span class="id" title="var">E</span></span>. Concretely, the evaluation
    of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> triggers a call to <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>.

<div class="paragraph"> </div>

    If the context <span class="inlinecode"><span class="id" title="var">E</span></span> binds the variable <span class="inlinecode"><span class="id" title="var">x</span></span> to some value <span class="inlinecode"><span class="id" title="var">v</span></span>, then
    the operation <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> returns <span class="inlinecode"><span class="id" title="var">Some</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>. In that case, <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    returns the weakest precondition for that value <span class="inlinecode"><span class="id" title="var">v</span></span>, that is, <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>.

<div class="paragraph"> </div>

    Otherwise, if <span class="inlinecode"><span class="id" title="var">E</span></span> does not bind <span class="inlinecode"><span class="id" title="var">x</span></span>, the lookup operation returns <span class="inlinecode"><span class="id" title="var">None</span></span>.
    In that case, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> returns <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>, which we have explained to be
    the weakest precondition for a stuck program.
<br/>
<span class="inlinecode">&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lookup</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab266"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">wpgen</span></span>: the Application Case</h3>

<div class="paragraph"> </div>

 In the previous definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> (the one without contexts),
    we argued that, in the case where <span class="inlinecode"><span class="id" title="var">t</span></span> denotes an application, the
    result of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> should be simply <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    In the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> with contexts, the interpretation of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is the weakest precondition of the term <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>
    (which denotes the result of substituting variables from <span class="inlinecode"><span class="id" title="var">E</span></span> in <span class="inlinecode"><span class="id" title="var">t</span></span>).

<div class="paragraph"> </div>

    When <span class="inlinecode"><span class="id" title="var">t</span></span> is an application, we thus define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> as the
    formula <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, which simplifies to
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span> after eliminating the eta-expansion.
<br/>
<span class="inlinecode">&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..
</span>
</div>

<div class="doc">
<a id="lab267"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">wpgen</span></span>: the Function Definition Case</h3>

<div class="paragraph"> </div>

 Consider the case where <span class="inlinecode"><span class="id" title="var">t</span></span> is a function definition, for example
    <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>. Here again, the formula <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is interpreted
    as the weakest precondition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    By unfolding the definition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> in the case where <span class="inlinecode"><span class="id" title="var">t</span></span> is
    <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>, we obtain <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>.

<div class="paragraph"> </div>

    The corresponding value is <span class="inlinecode"><span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>.
    The weakest precondition for that value is
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">(<span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>))</span>.

<div class="paragraph"> </div>

    Thus, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> handles functions, and recursive functions,
    as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> (<span class="id" title="var">rem</span> <span class="id" title="var">f</span> <span class="id" title="var">E</span>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab268"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">wpgen</span></span>: at Last, an Executable Function</h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WpgenExec1" class="idref" href="#WpgenExec1"><span class="id" title="module">WpgenExec1</span></a>.<br/>
</div>

<div class="doc">
At last, we arrive to a definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that type-checks in Coq,
    and that can be used to effectively compute weakest preconditions in
    Separation Logic. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="WpgenExec1.wpgen" class="idref" href="#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:44" class="idref" href="#E:44"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:45" class="idref" href="#t:45"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) (<a id="Q:46" class="idref" href="#Q:46"><span class="id" title="binder">Q</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>) : <a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:45"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="v:49" class="idref" href="#v:49"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span> <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="v:50" class="idref" href="#v:50"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:50"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span> <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:45"><span class="id" title="variable">t</span></a>) <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">(</span></a><a id="b:51" class="idref" href="#b:51"><span class="id" title="binder">b</span></a>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">),</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><span class="id" title="var">t<sub>0</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> (<a class="idref" href="LibSepReference.html#val_bool"><span class="id" title="constructor">val_bool</span></a> <a class="idref" href="WPgen.html#b:51"><span class="id" title="variable">b</span></a>)<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> <a class="idref" href="WPgen.html#b:51"><span class="id" title="variable">b</span></a> <span class="id" title="keyword">then</span> (<a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> <span class="id" title="keyword">else</span> (<a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>) <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Compared with the presentation using the form <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, the new
    presentation using the form <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> has the main benefits that
    it is structurally recursive, thus easy to define in Coq.
    Moreover, it is algorithmically more efficient in general, because
    it performs substitutions lazily rather than eagerly. 
<div class="paragraph"> </div>

 Let us state the soundness theorem and its corollary for establishing
    triples for functions. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec1.wpgen_sound" class="idref" href="#WpgenExec1.wpgen_sound"><span class="id" title="axiom">wpgen_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="E:52" class="idref" href="#E:52"><span class="id" title="binder">E</span></a> <a id="t:53" class="idref" href="#t:53"><span class="id" title="binder">t</span></a> <a id="Q:54" class="idref" href="#Q:54"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:52"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:53"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:54"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:52"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:53"><span class="id" title="variable">t</span></a>) <a class="idref" href="WPgen.html#Q:54"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
The entailment above asserts in particular that if we can derive
    <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> by proving <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. 
<div class="paragraph"> </div>

 A useful corrolary combines the soundness theorem with the rule
    <span class="inlinecode"><span class="id" title="var">triple_app_fun</span></span>, which allows establishing triples for functions.
    Recall the rule <span class="inlinecode"><span class="id" title="var">triple_app_fun</span></span> from <span class="inlinecode"><span class="id" title="var">Rules</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec1.triple_app_fun" class="idref" href="#WpgenExec1.triple_app_fun"><span class="id" title="axiom">triple_app_fun</span></a> : <span class="id" title="keyword">∀</span> <a id="x:56" class="idref" href="#x:56"><span class="id" title="binder">x</span></a> <a id="v<sub>1</sub>:57" class="idref" href="#v<sub>1</sub>:57"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:58" class="idref" href="#v<sub>2</sub>:58"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="t<sub>1</sub>:59" class="idref" href="#t<sub>1</sub>:59"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:60" class="idref" href="#H:60"><span class="id" title="binder">H</span></a> <a id="Q:61" class="idref" href="#Q:61"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:57"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:56"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:59"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:56"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:58"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:59"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="WPgen.html#H:60"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:61"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:57"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:58"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:60"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:61"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Reformulating the rule above into a rule for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> takes 3 steps.

<div class="paragraph"> </div>

    First, we rewrite the premise <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> using <span class="inlinecode"><span class="id" title="var">wp</span></span>.
    It becomes <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    Second, we observe that the term <span class="inlinecode"><span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> is equal to
    <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>. (This equality is captured by the lemma
    <span class="inlinecode"><span class="id" title="var">subst_eq_isubst_one</span></span> proved in the bonus section of the chapter.)
    Thus, the heap predicate <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is equivalent to
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>.

<div class="paragraph"> </div>

    Third, according to <span class="inlinecode"><span class="id" title="var">wpgen_sound</span></span>, the predicate
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> is entailed by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>.
    Thus, we can use the latter as premise in place of the former.
    We thereby obtain the following lemma. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec1.triple_app_fun_from_wpgen" class="idref" href="#WpgenExec1.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:63" class="idref" href="#v<sub>1</sub>:63"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:64" class="idref" href="#v<sub>2</sub>:64"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:65" class="idref" href="#x:65"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:66" class="idref" href="#t<sub>1</sub>:66"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:67" class="idref" href="#H:67"><span class="id" title="binder">H</span></a> <a id="Q:68" class="idref" href="#Q:68"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:63"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:65"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:66"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:67"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:65"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:64"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:66"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:68"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:63"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:64"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:67"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:68"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
<a id="lab269"></a><h3 class="section">Executing <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a Concrete Program</h3>

</div>
<div class="code">

<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span>.<br/>
</div>

<div class="doc">
Let us exploit <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span> to demonstrate the
    computation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a practical program.

<div class="paragraph"> </div>

    Recall the function <span class="inlinecode"><span class="id" title="var">incr</span></span> (defined in Rules), and its
    specification, whose statement appears below. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WpgenExec1.triple_incr" class="idref" href="#WpgenExec1.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:70" class="idref" href="#p:70"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:71" class="idref" href="#n:71"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:70"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:70"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:71"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:70"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:71"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WpgenExec1.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="comment">(*&nbsp;Read&nbsp;the&nbsp;goal&nbsp;here...&nbsp;*)</span><br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
The goal takes the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">body</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, where <span class="inlinecode"><span class="id" title="var">H</span></span> denotes
    the precondition, <span class="inlinecode"><span class="id" title="var">Q</span></span> the postcondition, and <span class="inlinecode"><span class="id" title="var">body</span></span> the body of
    the function <span class="inlinecode"><span class="id" title="var">incr</span></span>.

<div class="paragraph"> </div>

    Observe the invocations of <span class="inlinecode"><span class="id" title="var">wp</span></span> on the application of primitive
    operations.

<div class="paragraph"> </div>

    Observe that the goal is nevertheless somewhat hard to relate
    to the original program.

<div class="paragraph"> </div>

    In what follows, we explain how to remedy the situation, and
    set up <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is such a way that its output is human-readable,
    moreover resembles the original source code. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WpgenExec1"><span class="id" title="module">WpgenExec1</span></a>.<br/>
</div>

<div class="doc">
<a id="lab270"></a><h2 class="section">Optimizing the Readability of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> Output</h2>

<div class="paragraph"> </div>

 To improve the readability of the formulae produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>,
    we take the following 3 steps:

<div class="paragraph"> </div>

<ul class="doclist">
<li> first, we modify the presentation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> so that the
      <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span> <span class="inlinecode">⇒</span> appears insides the branches of the
      <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> rather than around it,

</li>
<li> second, we introduce one auxiliary definition for each branch
      of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span>,

</li>
<li> third, we introduce one piece of notation for each of these
      auxiliary definitions. 

</li>
</ul>
</div>

<div class="doc">
<a id="lab271"></a><h3 class="section">Reability Step 1: Moving the Function below the Branches.</h3>

<div class="paragraph"> </div>

 We distribute the <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> into the branches of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.
    Concretely, we change from:
<br/>
<span class="inlinecode">&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span>     ⇒  <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>  ⇒  <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    to the equivalent form:
<br/>
<span class="inlinecode">&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : (<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span>     ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>  ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
<div class="paragraph"> </div>

 The result type of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is <span class="inlinecode">(<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span></span>.
    Thereafter, we let <span class="inlinecode"><span class="id" title="var">formula</span></span> be a shorthand for this type. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="formula" class="idref" href="#formula"><span class="id" title="definition">formula</span></a> : <span class="id" title="keyword">Type</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span></span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>.<br/>
</div>

<div class="doc">
<a id="lab272"></a><h3 class="section">Readability Steps 2 and 3, Illustrated on the Case of Sequences</h3>

<div class="paragraph"> </div>

 We introduce auxiliary definitions to denote the result of each of the
    branches of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> construct. Concretely, we change from:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒  <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    to the equivalent form:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒  <span class="id" title="var">wpgen_seq</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    where <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> is defined as shown below.

</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="wpgen_seq" class="idref" href="#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a id="F<sub>1</sub>:72" class="idref" href="#F<sub>1</sub>:72"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:73" class="idref" href="#F<sub>2</sub>:73"><span class="id" title="binder">F<sub>2</sub></span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:74" class="idref" href="#Q:74"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F<sub>1</sub>:72"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:75" class="idref" href="#v:75"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F<sub>2</sub>:73"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:74"><span class="id" title="variable">Q</span></a>).<br/>
</div>

<div class="doc">
Remark: above, <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> denote the results of the recursive calls,
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, respectively.

<div class="paragraph"> </div>

    With the above definitions, <span class="inlinecode"><span class="id" title="var">wgpen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>
    evaluates to <span class="inlinecode"><span class="id" title="var">wp_seq</span></span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>. 
<div class="paragraph"> </div>

 Finally, we introduce a piece of notation for each case. In the case
    of the sequence, we set up the notation defined next to so that any
    formula of the form <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> gets displayed as <span class="inlinecode"><span class="id" title="var">Seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> <span class="inlinecode"></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="5e1c6eec1a5d39cff38db256f6c459cd" class="idref" href="#5e1c6eec1a5d39cff38db256f6c459cd"><span class="id" title="notation">&quot;</span></a>'Seq' F<sub>1</sub> ; F<sub>2</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> <span class="id" title="var">F<sub>1</sub></span> <span class="id" title="var">F<sub>2</sub></span>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 68, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">format</span> "'[v' 'Seq'  '[' F<sub>1</sub> ']'  ';'  '/'  '[' F<sub>2</sub> ']' ']'").<br/>
</div>

<div class="doc">
Thanks to this notation, the <span class="inlinecode"><span class="id" title="var">wpgen</span></span> of a sequence <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> displays as
    <span class="inlinecode"><span class="id" title="var">Seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> where <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> denote the <span class="inlinecode"><span class="id" title="var">wpgen</span></span> of <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>,
    respectively. 
</div>

<div class="doc">
<a id="lab273"></a><h3 class="section">Readability Step 2: Auxiliary Definitions for other Constructs</h3>

<div class="paragraph"> </div>

 We generalize the approach illustrated for sequences to every other
    term construct. The corresponding definitions are stated below.
    It is not required to understand the details in this subsection. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="wpgen_val" class="idref" href="#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a id="v:76" class="idref" href="#v:76"><span class="id" title="binder">v</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:77" class="idref" href="#Q:77"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q:77"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#v:76"><span class="id" title="variable">v</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_let" class="idref" href="#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a id="F<sub>1</sub>:78" class="idref" href="#F<sub>1</sub>:78"><span class="id" title="binder">F<sub>1</sub></span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) (<a id="F2of:79" class="idref" href="#F2of:79"><span class="id" title="binder">F2of</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:80" class="idref" href="#Q:80"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F<sub>1</sub>:78"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:81" class="idref" href="#v:81"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F2of:79"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#v:81"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#Q:80"><span class="id" title="variable">Q</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_if" class="idref" href="#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a id="t:82" class="idref" href="#t:82"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) (<a id="F<sub>1</sub>:83" class="idref" href="#F<sub>1</sub>:83"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:84" class="idref" href="#F<sub>2</sub>:84"><span class="id" title="binder">F<sub>2</sub></span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:85" class="idref" href="#Q:85"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">(</span></a><a id="b:86" class="idref" href="#b:86"><span class="id" title="binder">b</span></a>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">),</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#t:82"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> (<a class="idref" href="LibSepReference.html#val_bool"><span class="id" title="constructor">val_bool</span></a> <a class="idref" href="WPgen.html#b:86"><span class="id" title="variable">b</span></a>)<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> <a class="idref" href="WPgen.html#b:86"><span class="id" title="variable">b</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="WPgen.html#F<sub>1</sub>:83"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:85"><span class="id" title="variable">Q</span></a> <span class="id" title="keyword">else</span> <a class="idref" href="WPgen.html#F<sub>2</sub>:84"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:85"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_fail" class="idref" href="#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a> : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:87" class="idref" href="#Q:87"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_var" class="idref" href="#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> (<a id="E:88" class="idref" href="#E:88"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="x:89" class="idref" href="#x:89"><span class="id" title="binder">x</span></a>:<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:89"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E:88"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The new definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> reads as follows. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WpgenExec2" class="idref" href="#WpgenExec2"><span class="id" title="module">WpgenExec2</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="WpgenExec2.wpgen" class="idref" href="#WpgenExec2.wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:90" class="idref" href="#E:90"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:91" class="idref" href="#t:91"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:91"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:91"><span class="id" title="variable">t</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a class="idref" href="WPgen.html#wpgen:92"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:92"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#wpgen:92"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <a id="v:94" class="idref" href="#v:94"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:92"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:94"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#wpgen:92"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:92"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:90"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
This definition is, up to unfolding of the new intermediate definitions,
    totally equivalent to the previous one. We will prove the soundness
    result and its corollary further on. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec2.wpgen_sound" class="idref" href="#WpgenExec2.wpgen_sound"><span class="id" title="axiom">wpgen_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="E:95" class="idref" href="#E:95"><span class="id" title="binder">E</span></a> <a id="t:96" class="idref" href="#t:96"><span class="id" title="binder">t</span></a> <a id="Q:97" class="idref" href="#Q:97"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#WpgenExec2.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:95"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:96"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:97"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:95"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:96"><span class="id" title="variable">t</span></a>) <a class="idref" href="WPgen.html#Q:97"><span class="id" title="variable">Q</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Parameter</span> <a id="WpgenExec2.triple_app_fun_from_wpgen" class="idref" href="#WpgenExec2.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:99" class="idref" href="#v<sub>1</sub>:99"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:100" class="idref" href="#v<sub>2</sub>:100"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:101" class="idref" href="#x:101"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:102" class="idref" href="#t<sub>1</sub>:102"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:103" class="idref" href="#H:103"><span class="id" title="binder">H</span></a> <a id="Q:104" class="idref" href="#Q:104"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:99"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:101"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:102"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:103"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WpgenExec2.wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:101"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:100"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:102"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:104"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:99"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:100"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:103"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:104"><span class="id" title="variable">Q</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WpgenExec2"><span class="id" title="module">WpgenExec2</span></a>.<br/>
</div>

<div class="doc">
<a id="lab274"></a><h3 class="section">Readability Step 3: Notation for Auxiliary Definitions</h3>

<div class="paragraph"> </div>

 We generalize the notation introduced for sequences to every other
    term construct. The corresponding notation is defined below.
    It is not required to understand the details from this subsection.

<div class="paragraph"> </div>

    To avoid conflicts with other existing notation, we write
    <span class="inlinecode"><span class="id" title="var">Let'</span></span> and <span class="inlinecode"><span class="id" title="var">If'</span></span> in place of <span class="inlinecode"><span class="id" title="keyword">Let</span></span> and <span class="inlinecode"><span class="id" title="var">If</span></span>.

<div class="paragraph"> </div>

    Here again, it is not required to understand all the details. 
</div>
<div class="code">

<span class="id" title="var">Declare</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'Val'_x" class="idref" href="#::wpgen_scope:'Val'_x"><span class="id" title="notation">&quot;</span></a>'Val' v" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69) : <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="321f87d5a3363707e9951f717202b7a<sub>6</sub>" class="idref" href="#321f87d5a3363707e9951f717202b7a<sub>6</sub>"><span class="id" title="notation">&quot;</span></a>'Let'' x ':=' F<sub>1</sub> 'in' F<sub>2</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> <span class="id" title="var">F<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="x:106" class="idref" href="#x:106"><span class="id" title="binder">x</span></a> ⇒ <span class="id" title="var">F<sub>2</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69, <span class="id" title="var">x</span> <span class="id" title="var">ident</span>, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>,<br/>
&nbsp;&nbsp;<span class="id" title="var">format</span> "'[v' '[' 'Let''  x  ':='  F<sub>1</sub>  'in' ']'  '/'  '[' F<sub>2</sub> ']' ']'")<br/>
&nbsp;&nbsp;: <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'If'''_x_'Then'_x_'Else'_x" class="idref" href="#::wpgen_scope:'If'''_x_'Then'_x_'Else'_x"><span class="id" title="notation">&quot;</span></a>'If'' b 'Then' F<sub>1</sub> 'Else' F<sub>2</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> <span class="id" title="var">b</span> <span class="id" title="var">F<sub>1</sub></span> <span class="id" title="var">F<sub>2</sub></span>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69) : <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'Fail'" class="idref" href="#::wpgen_scope:'Fail'"><span class="id" title="notation">&quot;</span></a>'Fail'" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69) : <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
In addition, we introduce handy notation of the result of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>
    where <span class="inlinecode"><span class="id" title="var">t</span></span> denotes an application. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'App'_x_x" class="idref" href="#::wpgen_scope:'App'_x_x"><span class="id" title="notation">&quot;</span></a>'App' f v<sub>1</sub> " :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">f</span> <span class="id" title="var">v<sub>1</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 68, <span class="id" title="var">f</span>, <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 0) : <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
<a id="lab275"></a><h3 class="section">Test of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> with Notation.</h3>

<div class="paragraph"> </div>

 Consider again the example of <span class="inlinecode"><span class="id" title="var">incr</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WPgenWithNotation" class="idref" href="#WPgenWithNotation"><span class="id" title="module">WPgenWithNotation</span></a>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span> <span class="id" title="var">WpgenExec2</span>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="WPgenWithNotation.triple_incr" class="idref" href="#WPgenWithNotation.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:107" class="idref" href="#p:107"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:108" class="idref" href="#n:108"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:107"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:107"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:108"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:107"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:108"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WpgenExec2.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="comment">(*&nbsp;Read&nbsp;the&nbsp;goal&nbsp;here...&nbsp;It&nbsp;is&nbsp;of&nbsp;the&nbsp;form&nbsp;<span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">F</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;<span class="inlinecode"><span class="id" title="var">F</span></span>&nbsp;vaguely&nbsp;looks&nbsp;like&nbsp;the&nbsp;code&nbsp;of&nbsp;the&nbsp;body&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">incr</span></span>.&nbsp;*)</span><br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
Up to proper tabulation, alpha-renaming, and removal of
    parentheses (and dummy quotes after <span class="inlinecode"><span class="id" title="keyword">Let</span></span> and <span class="inlinecode"><span class="id" title="var">If</span></span>),
    the formula <span class="inlinecode"><span class="id" title="var">F</span></span> reads as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Let</span> <span class="id" title="var">n</span> := <span class="id" title="var">App</span> <span class="id" title="var">val_get</span> <span class="id" title="var">p</span> <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Let</span> <span class="id" title="var">m</span> := <span class="id" title="var">App</span> (<span class="id" title="var">val_add</span> <span class="id" title="var">n</span>) 1 <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">App</span> (<span class="id" title="var">val_set</span> <span class="id" title="var">p</span>) <span class="id" title="var">m</span>
</span>
<div class="paragraph"> </div>

 With the introduction of intermediate definitions for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> and
    the introduction of associated notations for each term construct,
    what we achieved is that the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is, for any input term
    <span class="inlinecode"><span class="id" title="var">t</span></span>, a human readable formula whose display closely resembles the
    syntax source code of the term <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WPgenWithNotation"><span class="id" title="module">WPgenWithNotation</span></a>.<br/>
</div>

<div class="doc">
<a id="lab276"></a><h2 class="section">Extension of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to Handle Structural Rules</h2>

<div class="paragraph"> </div>

 The definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> proposed so far integrates the logic of
    the reasoning rules for terms, however it lacks support for conveniently
    exploiting the structural rules of the logic.

<div class="paragraph"> </div>

    We fix this next, by showing how to tweak the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> in
    such a way that, by construction, it satisfies both:
<ul class="doclist">
<li> the frame rule, which asserts
      <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span></span> <span class="inlinecode"><span class='gray-font'>\</span>*+</span> <span class="inlinecode"><span class="id" title="var">H</span>)</span>,

</li>
<li> and the rule of consequence, which asserts that <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span></span> <span class="inlinecode">===&gt;</span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span></span> implies
      <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span></span>.

</li>
</ul>

<div class="paragraph"> </div>


</div>

<div class="doc">
<a id="lab277"></a><h3 class="section">Introduction of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> in the Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h3>

<div class="paragraph"> </div>

 Recall from the previous chapter the statement of the frame rule
    in <span class="inlinecode"><span class="id" title="var">wp</span></span>-style. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_frame" class="idref" href="#wp_frame"><span class="id" title="axiom">wp_frame</span></a> : <span class="id" title="keyword">∀</span> <a id="t:109" class="idref" href="#t:109"><span class="id" title="binder">t</span></a> <a id="H:110" class="idref" href="#H:110"><span class="id" title="binder">H</span></a> <a id="Q:111" class="idref" href="#Q:111"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:109"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:111"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:110"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:109"><span class="id" title="variable">t</span></a> (<a class="idref" href="WPgen.html#Q:111"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:110"><span class="id" title="variable">H</span></a>).<br/>
</div>

<div class="doc">
We would like <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to satisfy the same rule, so that we can
    exploit the frame rule while reasoning about a program using
    the heap predicate produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.

<div class="paragraph"> </div>

    With the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> set up so far, it is possible
    to prove, for any concrete term <span class="inlinecode"><span class="id" title="var">t</span></span>, that the frame property
    <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span></span> <span class="inlinecode"><span class='gray-font'>\</span>*+</span> <span class="inlinecode"><span class="id" title="var">H</span>)</span> holds.
    However, establishing this result requires an induction over
    the entire structure of the term <span class="inlinecode"><span class="id" title="var">t</span></span>---a lot of tedious work.

<div class="paragraph"> </div>

    Instead, we are going to tweak the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> so as to
    produce, at every step of the recursion, a special token to capture
    the idea that whatever the details of the output predicate produced
    by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, this predicate does satisfy the frame property. 
<div class="paragraph"> </div>

 We achieve this magic by introducing a predicate called <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>,
    and inserting it at the head of the output produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    (and all of its recursive invocation) as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : (<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen_val</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).
</span>    The interest of the insertion of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> above is that every result
    of a computation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> on a concrete term <span class="inlinecode"><span class="id" title="var">t</span></span> is, by construction,
    of the form <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span> for some argument <span class="inlinecode"><span class="id" title="var">F</span></span>.

<div class="paragraph"> </div>

    There remains to investigate how <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> should be defined. 
</div>

<div class="doc">
<a id="lab278"></a><h3 class="section">Properties of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="MkstructProp" class="idref" href="#MkstructProp"><span class="id" title="module">MkstructProp</span></a>.<br/>
</div>

<div class="doc">
Let us state the properties that <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> should satisfy. 
<div class="paragraph"> </div>

 Because <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> appears between the prototype and the <span class="inlinecode"><span class="id" title="keyword">match</span></span>
    in the body of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> must have type
    <span class="inlinecode"><span class="id" title="var">formula</span>→<span class="id" title="var">formula</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct" class="idref" href="#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>.<br/>
</div>

<div class="doc">
There remains to find a suitable definition for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> that enables
    the frame property and the consequence property. These properties can
    be stated by mimicking the rules <span class="inlinecode"><span class="id" title="var">wp_frame</span></span> and <span class="inlinecode"><span class="id" title="var">wp_conseq</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_frame" class="idref" href="#MkstructProp.mkstruct_frame"><span class="id" title="axiom">mkstruct_frame</span></a> : <span class="id" title="keyword">∀</span> (<a id="F:114" class="idref" href="#F:114"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) <a id="H:115" class="idref" href="#H:115"><span class="id" title="binder">H</span></a> <a id="Q:116" class="idref" href="#Q:116"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:114"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:116"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:115"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:114"><span class="id" title="variable">F</span></a> (<a class="idref" href="WPgen.html#Q:116"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:115"><span class="id" title="variable">H</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_conseq" class="idref" href="#MkstructProp.mkstruct_conseq"><span class="id" title="axiom">mkstruct_conseq</span></a> : <span class="id" title="keyword">∀</span> (<a id="F:118" class="idref" href="#F:118"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) <a id="Q<sub>1</sub>:119" class="idref" href="#Q<sub>1</sub>:119"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:120" class="idref" href="#Q<sub>2</sub>:120"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:119"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:120"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:118"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:119"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:118"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:120"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
In addition, it should be possible to erase <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> from the head
    of the output produced <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> when we do not need to apply any
    structural rule. In other words, we need to be able to prove
    <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> by proving <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">F</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, for any <span class="inlinecode"><span class="id" title="var">H</span></span>.
    This erasure property is captured by the following entailment. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_erase" class="idref" href="#MkstructProp.mkstruct_erase"><span class="id" title="axiom">mkstruct_erase</span></a> : <span class="id" title="keyword">∀</span> (<a id="F:122" class="idref" href="#F:122"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) <a id="Q:123" class="idref" href="#Q:123"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F:122"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:123"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:122"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:123"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Moreover, <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> should be monotone with respect to the formula:
    if <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> is stronger than <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>, then <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> should be stronger
    then <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_monotone" class="idref" href="#MkstructProp.mkstruct_monotone"><span class="id" title="axiom">mkstruct_monotone</span></a> : <span class="id" title="keyword">∀</span> <a id="F<sub>1</sub>:125" class="idref" href="#F<sub>1</sub>:125"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:126" class="idref" href="#F<sub>2</sub>:126"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="Q:127" class="idref" href="#Q:127"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="Q:128" class="idref" href="#Q:128"><span class="id" title="binder">Q</span></a>, <a class="idref" href="WPgen.html#F<sub>1</sub>:125"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:128"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:126"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:128"><span class="id" title="variable">Q</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:125"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:127"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:126"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:127"><span class="id" title="variable">Q</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#MkstructProp"><span class="id" title="module">MkstructProp</span></a>.<br/>
</div>

<div class="doc">
<a id="lab279"></a><h3 class="section">Realization of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

<div class="paragraph"> </div>

 Fortunately, it turns out that there exists a predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>
    satisfying the four required properties. To begin with, let us just
    pull out of our hat a definition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> that works. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="mkstruct" class="idref" href="#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a id="F:130" class="idref" href="#F:130"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> (<a id="Q:131" class="idref" href="#Q:131"><span class="id" title="binder">Q</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>) ⇒ <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="Q<sub>1</sub>:132" class="idref" href="#Q<sub>1</sub>:132"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="H:133" class="idref" href="#H:133"><span class="id" title="binder">H</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="WPgen.html#F:130"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:132"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:133"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#Q<sub>1</sub>:132"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:133"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q:131"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>.<br/>
</div>

<div class="doc">
We postpone to a bonus section the discussion of why it works and of how
    one could have guessed this definition. Again, it really does not matter
    the details of the definition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. All that matters is that
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> satisfies the three required properties: <span class="inlinecode"><span class="id" title="var">mkstruct_frame</span></span>,
    <span class="inlinecode"><span class="id" title="var">mkstruct_conseq</span></span>, and <span class="inlinecode"><span class="id" title="var">mkstruct_erase</span></span>. Let us establish these properties
    for the definition considered. (Proof details can be skipped over.) 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="mkstruct_frame" class="idref" href="#mkstruct_frame"><span class="id" title="lemma">mkstruct_frame</span></a> : <span class="id" title="keyword">∀</span> <a id="F:134" class="idref" href="#F:134"><span class="id" title="binder">F</span></a> <a id="H:135" class="idref" href="#H:135"><span class="id" title="binder">H</span></a> <a id="Q:136" class="idref" href="#Q:136"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:134"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:136"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:135"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:134"><span class="id" title="variable">F</span></a> (<a class="idref" href="WPgen.html#Q:136"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:135"><span class="id" title="variable">H</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span> <span class="id" title="var">H'</span> <span class="id" title="var">M</span>. <span class="id" title="var">xsimpl</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="mkstruct_conseq" class="idref" href="#mkstruct_conseq"><span class="id" title="lemma">mkstruct_conseq</span></a> : <span class="id" title="keyword">∀</span> <a id="F:137" class="idref" href="#F:137"><span class="id" title="binder">F</span></a> <a id="Q<sub>1</sub>:138" class="idref" href="#Q<sub>1</sub>:138"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:139" class="idref" href="#Q<sub>2</sub>:139"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:138"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:139"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:137"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:138"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:137"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:139"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">WQ</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span> <span class="id" title="var">H'</span> <span class="id" title="var">M</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">WQ</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="mkstruct_erase" class="idref" href="#mkstruct_erase"><span class="id" title="lemma">mkstruct_erase</span></a> : <span class="id" title="keyword">∀</span> <a id="F:140" class="idref" href="#F:140"><span class="id" title="binder">F</span></a> <a id="Q:141" class="idref" href="#Q:141"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F:140"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:141"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:140"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:141"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xsimpl</span>. <span class="id" title="var">xsimpl</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="mkstruct_monotone" class="idref" href="#mkstruct_monotone"><span class="id" title="lemma">mkstruct_monotone</span></a> : <span class="id" title="keyword">∀</span> <a id="F<sub>1</sub>:142" class="idref" href="#F<sub>1</sub>:142"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:143" class="idref" href="#F<sub>2</sub>:143"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="Q:144" class="idref" href="#Q:144"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="Q:145" class="idref" href="#Q:145"><span class="id" title="binder">Q</span></a>, <a class="idref" href="WPgen.html#F<sub>1</sub>:142"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:145"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:143"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:145"><span class="id" title="variable">Q</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:142"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:144"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:143"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:144"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">WF</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span> <span class="id" title="var">H</span> <span class="id" title="var">M</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xchange</span> <span class="id" title="var">WF</span>. <span class="id" title="var">xsimpl</span> <span class="id" title="var">Q'</span>. <span class="id" title="var">applys</span> <span class="id" title="var">M</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
An interesting property of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> is it has no effect on a
    formula of the form <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. Intuitively, such a formula already
    satisfies all the structural reasoning rules, hence adding
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> to it does not increase its expressive power. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="mkstruct_wp" class="idref" href="#mkstruct_wp"><span class="id" title="lemma">mkstruct_wp</span></a> : <span class="id" title="keyword">∀</span> <a id="t:146" class="idref" href="#t:146"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:146"><span class="id" title="variable">t</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">(</span></a><a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:146"><span class="id" title="variable">t</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">)</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">applys</span> <span class="id" title="lemma">fun_ext_1</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_antisym"><span class="id" title="lemma">himpl_antisym</span></a>.<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">H</span> <span class="id" title="var">Q'</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPsem.html#wp_conseq_frame"><span class="id" title="axiom">wp_conseq_frame</span></a> <span class="id" title="var">M</span>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#mkstruct_erase"><span class="id" title="lemma">mkstruct_erase</span></a>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Another interesting property of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> is its idempotence
    property, that is, it is such that <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode">(<span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span>)</span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>.

<div class="paragraph"> </div>

    Idempotence asserts that applying the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> more than
    once does not provide more expressiveness than applying it just once.

<div class="paragraph"> </div>

    Intuitively, idempotence reflects in particular the fact that two nested
    applications of the rule of consequence can always be combined into a
    single application of that rule (due to the transitivity of entailment);
    and that, similarly, two nested applications of the frame rule can always
    be combined into a single application of that rule (framing on <span class="inlinecode"><span class="id" title="var">H<sub>1</sub></span></span> then
    framing on <span class="inlinecode"><span class="id" title="var">H<sub>2</sub></span></span> is equivalent to framing on <span class="inlinecode"><span class="id" title="var">H<sub>1</sub></span></span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode"><span class="id" title="var">H<sub>2</sub></span></span>). 
<div class="paragraph"> </div>

<a id="lab280"></a><h4 class="section">Exercise: 3 stars, standard, especially useful (mkstruct_idempotent)</h4>
 Complete the proof of the idempotence of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>.
    Hint: leverage <span class="inlinecode"><span class="id" title="var">xpull</span></span> and <span class="inlinecode"><span class="id" title="var">xsimpl</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="mkstruct_idempotent" class="idref" href="#mkstruct_idempotent"><span class="id" title="lemma">mkstruct_idempotent</span></a> : <span class="id" title="keyword">∀</span> <a id="F:147" class="idref" href="#F:147"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:147"><span class="id" title="variable">F</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:147"><span class="id" title="variable">F</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">apply</span> <span class="id" title="lemma">fun_ext_1</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_antisym"><span class="id" title="lemma">himpl_antisym</span></a>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>


<div class="doc">
<a id="lab281"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that Includes <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

<div class="paragraph"> </div>

 Our final definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> refines the previous one by
    inserting the <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> predicate to the front of the
    <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> construct. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="wpgen" class="idref" href="#wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:148" class="idref" href="#E:148"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:149" class="idref" href="#t:149"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:149"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:149"><span class="id" title="variable">t</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a class="idref" href="WPgen.html#wpgen:150"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:150"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#wpgen:150"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <a id="v:152" class="idref" href="#v:152"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:150"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:152"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#wpgen:150"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:150"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:148"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>).<br/>
</div>

<div class="doc">
Again, we assert the soundness theorem and its corollary,
    and we postpone the proof. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wpgen_sound" class="idref" href="#wpgen_sound"><span class="id" title="axiom">wpgen_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="E:153" class="idref" href="#E:153"><span class="id" title="binder">E</span></a> <a id="t:154" class="idref" href="#t:154"><span class="id" title="binder">t</span></a> <a id="Q:155" class="idref" href="#Q:155"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:154"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:155"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:154"><span class="id" title="variable">t</span></a>) <a class="idref" href="WPgen.html#Q:155"><span class="id" title="variable">Q</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Parameter</span> <a id="triple_app_fun_from_wpgen" class="idref" href="#triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:157" class="idref" href="#v<sub>1</sub>:157"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:158" class="idref" href="#v<sub>2</sub>:158"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:159" class="idref" href="#x:159"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:160" class="idref" href="#t<sub>1</sub>:160"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:161" class="idref" href="#H:161"><span class="id" title="binder">H</span></a> <a id="Q:162" class="idref" href="#Q:162"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:157"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:159"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:160"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:161"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:159"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:158"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:160"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:162"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:157"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:158"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:161"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:162"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
<a id="lab282"></a><h3 class="section">Notation for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> and Test</h3>

<div class="paragraph"> </div>

 To avoid clutter in reading the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we introduce a
    lightweight shorthand to denote <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>, allowing it to display
    simply as <span class="inlinecode">`<span class="id" title="var">F</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="c1ee1c8b4cb553e4051fed8f18496dc<sub>8</sub>" class="idref" href="#c1ee1c8b4cb553e4051fed8f18496dc<sub>8</sub>"><span class="id" title="notation">&quot;</span></a>` F" := (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <span class="id" title="var">F</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10, <span class="id" title="var">format</span> "` F") : <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
Let us test again the readability of the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on
    a concrete example. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WPgenWithMkstruct" class="idref" href="#WPgenWithMkstruct"><span class="id" title="module">WPgenWithMkstruct</span></a>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="WPgenWithMkstruct.triple_incr" class="idref" href="#WPgenWithMkstruct.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:164" class="idref" href="#p:164"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:165" class="idref" href="#n:165"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:164"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:164"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:165"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:164"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:165"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
Up to proper tabulation, alpha-renaming, and removal of
    parentheses (and dummy quotes after <span class="inlinecode"><span class="id" title="keyword">Let</span></span> and <span class="inlinecode"><span class="id" title="var">If</span></span>),
    <span class="inlinecode"><span class="id" title="var">F</span></span> reads as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;`<span class="id" title="keyword">Let</span> <span class="id" title="var">n</span> := `(<span class="id" title="var">App</span> <span class="id" title="var">val_get</span> <span class="id" title="var">p</span>) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;`<span class="id" title="keyword">Let</span> <span class="id" title="var">m</span> := `(<span class="id" title="var">App</span> (<span class="id" title="var">val_add</span> <span class="id" title="var">n</span>) 1) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;`<span class="id" title="var">App</span> (<span class="id" title="var">val_set</span> <span class="id" title="var">p</span>) <span class="id" title="var">m</span>
</span>
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WPgenWithMkstruct"><span class="id" title="module">WPgenWithMkstruct</span></a>.<br/>
</div>

<div class="doc">
<a id="lab283"></a><h2 class="section">Lemmas for Handling <span class="inlinecode"><span class="id" title="var">wpgen</span></span> Goals</h2>

<div class="paragraph"> </div>

 The last major step of the setup of our Separation Logic
    based verification framework consists of lemmas and tactics
    to assist in the processing of formulas produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.
    For each term construct, and for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>, we introduce
    a dedicated lemma, called "x-lemma", to help with the
    elimination of the construct. 
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">xstruct_lemma</span></span> is a reformulation of <span class="inlinecode"><span class="id" title="var">mkstruct_erase</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xstruct_lemma" class="idref" href="#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="F:166" class="idref" href="#F:166"><span class="id" title="binder">F</span></a> <a id="H:167" class="idref" href="#H:167"><span class="id" title="binder">H</span></a> <a id="Q:168" class="idref" href="#Q:168"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:167"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F:166"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:168"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:167"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:166"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:168"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#mkstruct_erase"><span class="id" title="lemma">mkstruct_erase</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xval_lemma</span></span> reformulates the definition of <span class="inlinecode"><span class="id" title="var">wpgen_val</span></span>.
    It just unfolds the definition. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xval_lemma" class="idref" href="#xval_lemma"><span class="id" title="lemma">xval_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="v:169" class="idref" href="#v:169"><span class="id" title="binder">v</span></a> <a id="H:170" class="idref" href="#H:170"><span class="id" title="binder">H</span></a> <a id="Q:171" class="idref" href="#Q:171"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:170"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Q:171"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#v:169"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:170"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <a class="idref" href="WPgen.html#v:169"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#Q:171"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xlet_lemma</span></span> reformulates the definition of <span class="inlinecode"><span class="id" title="var">wpgen_let</span></span>.
    It just unfolds the definition. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xlet_lemma" class="idref" href="#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H:172" class="idref" href="#H:172"><span class="id" title="binder">H</span></a> <a id="F<sub>1</sub>:173" class="idref" href="#F<sub>1</sub>:173"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F2of:174" class="idref" href="#F2of:174"><span class="id" title="binder">F2of</span></a> <a id="Q:175" class="idref" href="#Q:175"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:172"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:173"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:176" class="idref" href="#v:176"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F2of:174"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#v:176"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#Q:175"><span class="id" title="variable">Q</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:172"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:173"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F2of:174"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#Q:175"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Likewise, <span class="inlinecode"><span class="id" title="var">xseq_lemma</span></span> reformulates <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xseq_lemma" class="idref" href="#xseq_lemma"><span class="id" title="lemma">xseq_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H:177" class="idref" href="#H:177"><span class="id" title="binder">H</span></a> <a id="F<sub>1</sub>:178" class="idref" href="#F<sub>1</sub>:178"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:179" class="idref" href="#F<sub>2</sub>:179"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="Q:180" class="idref" href="#Q:180"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:177"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:178"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:181" class="idref" href="#v:181"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F<sub>2</sub>:179"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:180"><span class="id" title="variable">Q</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:177"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:178"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:179"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:180"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xapp_lemma</span></span> applies to goals produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on an
    application. In such cases, the proof obligation is of the form
    <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    <span class="inlinecode"><span class="id" title="var">xapp_lemma</span></span> reformulates the frame-consequence rule, and
    states the premise of the rule using a <span class="inlinecode"><span class="id" title="var">triple</span></span>, because
    triples are used for stating specification lemmas. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xapp_lemma" class="idref" href="#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="t:182" class="idref" href="#t:182"><span class="id" title="binder">t</span></a> <a id="Q<sub>1</sub>:183" class="idref" href="#Q<sub>1</sub>:183"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="H<sub>1</sub>:184" class="idref" href="#H<sub>1</sub>:184"><span class="id" title="binder">H<sub>1</sub></span></a> <a id="H<sub>2</sub>:185" class="idref" href="#H<sub>2</sub>:185"><span class="id" title="binder">H<sub>2</sub></span></a> <a id="H:186" class="idref" href="#H:186"><span class="id" title="binder">H</span></a> <a id="Q:187" class="idref" href="#Q:187"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="WPgen.html#t:182"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#H<sub>1</sub>:184"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:183"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:186"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#H<sub>1</sub>:184"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:185"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:183"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:185"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q:187"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:186"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:182"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:187"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span> <span class="id" title="var">WH</span> <span class="id" title="var">WQ</span>. <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="axiom">wp_equiv</span></a>. <span class="id" title="var">applys</span>* <a class="idref" href="WPsem.html#triple_conseq_frame"><span class="id" title="axiom">triple_conseq_frame</span></a> <span class="id" title="var">M</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xwp_lemma</span></span> is another name for <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span>.
    It is used for establishing a triple for a function application. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xwp_lemma" class="idref" href="#xwp_lemma"><span class="id" title="lemma">xwp_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:188" class="idref" href="#v<sub>1</sub>:188"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:189" class="idref" href="#v<sub>2</sub>:189"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:190" class="idref" href="#x:190"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:191" class="idref" href="#t<sub>1</sub>:191"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:192" class="idref" href="#H:192"><span class="id" title="binder">H</span></a> <a id="Q:193" class="idref" href="#Q:193"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:188"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:190"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:191"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:192"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:190"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:189"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:191"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:193"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:188"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:189"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:192"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:193"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M<sub>1</sub></span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span>* <a class="idref" href="WPgen.html#triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab284"></a><h2 class="section">An Example Proof</h2>

<div class="paragraph"> </div>

 Let us illustrate how the "x-lemmas" help clarifying verification
    proof scripts. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithXlemmas" class="idref" href="#ProofsWithXlemmas"><span class="id" title="module">ProofsWithXlemmas</span></a>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXlemmas.triple_incr" class="idref" href="#ProofsWithXlemmas.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:194" class="idref" href="#p:194"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:195" class="idref" href="#n:195"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:194"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:194"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:195"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:194"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:195"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xwp_lemma"><span class="id" title="lemma">xwp_lemma</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Here&nbsp;the&nbsp;<span class="inlinecode"><span class="id" title="var">wpgen</span></span>&nbsp;function&nbsp;computes.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Observe&nbsp;how&nbsp;each&nbsp;node&nbsp;begin&nbsp;with&nbsp;<span class="inlinecode"><span class="id" title="var">mkstruct</span></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Observe&nbsp;how&nbsp;program&nbsp;variables&nbsp;are&nbsp;all&nbsp;eliminated.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>. { <span class="id" title="tactic">apply</span> <a class="idref" href="Rules.html#triple_get"><span class="id" title="axiom">triple_get</span></a>. } { <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xpull</span>; <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>. { <span class="id" title="tactic">apply</span> <a class="idref" href="Rules.html#triple_add"><span class="id" title="axiom">triple_add</span></a>. } { <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xpull</span>; <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>. { <span class="id" title="tactic">apply</span> <a class="idref" href="Rules.html#triple_set"><span class="id" title="axiom">triple_set</span></a>. } { <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab285"></a><h4 class="section">Exercise: 2 stars, standard, especially useful (triple_succ_using_incr_with_xlemmas)</h4>
 Using x-lemmas, verify the proof of <span class="inlinecode"><span class="id" title="var">triple_succ_using_incr</span></span>.
    (The proof was carried out using triples in chapter <a href="Rules.html"><span class="inlineref">Rules</span></a>.) 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXlemmas.triple_succ_using_incr_with_xlemmas" class="idref" href="#ProofsWithXlemmas.triple_succ_using_incr_with_xlemmas"><span class="id" title="lemma">triple_succ_using_incr_with_xlemmas</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:196" class="idref" href="#n:196"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.succ_using_incr"><span class="id" title="definition">succ_using_incr</span></a> <a class="idref" href="WPgen.html#n:196"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="v:197" class="idref" href="#v:197"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#v:197"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:196"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithXlemmas"><span class="id" title="module">ProofsWithXlemmas</span></a>.<br/>
</div>

<div class="doc">
<a id="lab286"></a><h2 class="section">Making Proof Scripts More Concise</h2>

<div class="paragraph"> </div>

 For each x-lemma, we introduce a dedicated tactic to apply
    that lemma and perform the associated bookkeeping. 
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">xstruct</span></span> eliminates the leading <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xstruct" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">val</span></span>, <span class="inlinecode"><span class="id" title="var">xseq</span></span> and <span class="inlinecode"><span class="id" title="var">xlet</span></span> invoke the corresponding x-lemmas,
   after calling <span class="inlinecode"><span class="id" title="var">xstruct</span></span> if a leading <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> is in the way. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xstruct_if_needed" :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> &#x22A2; ?<span class="id" title="var">H</span> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> ?<span class="id" title="var">F</span> ?<span class="id" title="var">Q</span> ⇒ <span class="id" title="var">xstruct</span> <span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xval" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xval_lemma"><span class="id" title="lemma">xval_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xlet" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xseq" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xseq_lemma"><span class="id" title="lemma">xseq_lemma</span></a>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> applys <span class="inlinecode"><span class="id" title="var">xapp_lemma</span></span>, after calling <span class="inlinecode"><span class="id" title="var">xseq</span></span> or <span class="inlinecode"><span class="id" title="var">xlet</span></span>
    if applicable. (We will subsequently define <span class="inlinecode"><span class="id" title="var">xapp</span></span> as an enhanced version
    of <span class="inlinecode"><span class="id" title="var">xapp_nosusbt</span></span> that is able to automatically perform substitutions. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xseq_xlet_if_needed" :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> &#x22A2; ?<span class="id" title="var">H</span> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> ?<span class="id" title="var">F</span> ?<span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">F</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> ?<span class="id" title="var">F<sub>1</sub></span> ?<span class="id" title="var">F<sub>2</sub></span> ⇒ <span class="id" title="var">xseq</span><br/>
&nbsp;&nbsp;| <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> ?<span class="id" title="var">F<sub>1</sub></span> ?<span class="id" title="var">F2of</span> ⇒ <span class="id" title="var">xlet</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xapp_nosubst" <span class="id" title="keyword">constr</span>(<span class="id" title="var">E</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a> <span class="id" title="var">E</span>; [ <span class="id" title="var">xsimpl</span> | <span class="id" title="var">xpull</span> ].<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xwp</span></span> applys <span class="inlinecode"><span class="id" title="var">xwp_lemma</span></span>, then requests Coq to evaluate the
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> function. (For technical reasons, we need to explicitly
    request the unfolding of <span class="inlinecode"><span class="id" title="var">wpgen_var</span></span>.) 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xwp" :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xwp_lemma"><span class="id" title="lemma">xwp_lemma</span></a>;<br/>
&nbsp;&nbsp;[ <span class="id" title="tactic">reflexivity</span><br/>
&nbsp;&nbsp;| <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a>; <span class="id" title="tactic">simpl</span> ].<br/>
</div>

<div class="doc">
Let us revisit the previous proof scripts using x-tactics
    instead of x-lemmas. The reader may contemplate the gain
    in conciseness. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithXtactics" class="idref" href="#ProofsWithXtactics"><span class="id" title="module">ProofsWithXtactics</span></a>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXtactics.triple_incr" class="idref" href="#ProofsWithXtactics.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:198" class="idref" href="#p:198"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:199" class="idref" href="#n:199"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:198"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:198"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:199"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:198"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:199"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <a class="idref" href="Rules.html#triple_get"><span class="id" title="axiom">triple_get</span></a>. <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <a class="idref" href="Rules.html#triple_add"><span class="id" title="axiom">triple_add</span></a>. <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <a class="idref" href="Rules.html#triple_set"><span class="id" title="axiom">triple_set</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab287"></a><h4 class="section">Exercise: 2 stars, standard, especially useful (triple_succ_using_incr_with_xtactics)</h4>
 Using x-tactics, verify the proof of <span class="inlinecode"><span class="id" title="var">succ_using_incr</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXtactics.triple_succ_using_incr_with_xtactics" class="idref" href="#ProofsWithXtactics.triple_succ_using_incr_with_xtactics"><span class="id" title="lemma">triple_succ_using_incr_with_xtactics</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:200" class="idref" href="#n:200"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.succ_using_incr"><span class="id" title="definition">succ_using_incr</span></a> <a class="idref" href="WPgen.html#n:200"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="v:201" class="idref" href="#v:201"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#v:201"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:200"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithXtactics"><span class="id" title="module">ProofsWithXtactics</span></a>.<br/>
</div>

<div class="doc">
<a id="lab288"></a><h2 class="section">Further Improvements to the <span class="inlinecode"><span class="id" title="var">xapp</span></span> Tactic.</h2>

<div class="paragraph"> </div>

 In this section, we describe two improvements to the <span class="inlinecode"><span class="id" title="var">xapp</span></span>
    tactic. 
<div class="paragraph"> </div>

 The pattern <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span>.</span> <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode">?</span> <span class="inlinecode"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>.</span> appears frequently
    in the above proofs. This pattern is typically useful whenever
    the specification <span class="inlinecode"><span class="id" title="var">E</span></span> features a postcondition of the form
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">v</span></span> <span class="inlinecode">=</span> <span class="inlinecode">..]</span> or of the form <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">v</span></span> <span class="inlinecode">=</span> <span class="inlinecode">..]</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode">..</span>.

<div class="paragraph"> </div>

    Likewise, the pattern <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span>.</span> <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode">?</span> <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>.</span> appears
    frequently. This pattern is typically useful whenever the
    specification <span class="inlinecode"><span class="id" title="var">E</span></span> features a postcondition of the form
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class='gray-font'>\</span><span class="id" title="tactic">∃</span></span> <span class="inlinecode"><span class="id" title="var">p</span>,</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">v</span></span> <span class="inlinecode">=</span> <span class="inlinecode">..]</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode">...</span> <span class="inlinecode"></span>.

<div class="paragraph"> </div>

    It therefore makes sense to introduce a tactic <span class="inlinecode"><span class="id" title="var">xapp</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> that,
    after calling <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>, attempts to invoke <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode">?</span> <span class="inlinecode">→</span>
    or <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode">?</span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>;</span> <span class="inlinecode"><span class="id" title="var">revert</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span>. In the latter case, to ensure that
    the name <span class="inlinecode"><span class="id" title="var">x</span></span> that we use does not modify the existing name of the
    bound variable, we play some Ltac hacks, captured by the tactic
    <span class="inlinecode"><span class="id" title="var">xapp_try_subst</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xapp_try_subst" := <span class="comment">(*&nbsp;for&nbsp;internal&nbsp;use&nbsp;only&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">∀</span> (<a id="r:203" class="idref" href="#r:203"><span class="id" title="binder">r</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#r:202"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">intros</span> ? →<br/>
&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">∀</span> (<a id="r:206" class="idref" href="#r:206"><span class="id" title="binder">r</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>), <span class="id" title="keyword">∀</span> <a id="x:207" class="idref" href="#x:207"><span class="id" title="binder">x</span></a>, <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#r:204"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="var">_</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">y</span> := <span class="id" title="tactic">fresh</span> <span class="id" title="var">x</span> <span class="id" title="keyword">in</span> <span class="id" title="tactic">intros</span> ? <span class="id" title="var">y</span> <span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>; <span class="id" title="var">revert</span> <span class="id" title="var">y</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xapp" <span class="id" title="keyword">constr</span>(<span class="id" title="var">E</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <span class="id" title="var">E</span>; <span class="id" title="var">xapp_try_subst</span>.<br/>
</div>

<div class="doc">
Explicitly providing arguments to <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> or <span class="inlinecode"><span class="id" title="var">xapp</span></span>
    is very tedious. To avoid that effort, we can set up the tactics
    to automatically look up for the relevant specification.

<div class="paragraph"> </div>

    To that end, we instrument <span class="inlinecode"><span class="id" title="tactic">eauto</span></span> to exploit a database of
    already-established specification triples. This database, named
    <span class="inlinecode"><span class="id" title="var">triple</span></span>, can be populated using the <span class="inlinecode"><span class="id" title="keyword">Hint</span></span> <span class="inlinecode"><span class="id" title="keyword">Resolve</span></span> <span class="inlinecode">...</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">triple</span></span>
    command, as illustrated below. 
</div>
<div class="code">

<span class="id" title="keyword">Hint Resolve</span> <span class="id" title="var">triple_get</span> <span class="id" title="var">triple_set</span> <span class="id" title="var">triple_ref</span> <span class="id" title="var">triple_free</span> <span class="id" title="var">triple_add</span> : <span class="id" title="var">triple</span>.<br/>
</div>

<div class="doc">
The argument-free variants <span class="inlinecode"><span class="id" title="var">xapp_subst</span></span> and <span class="inlinecode"><span class="id" title="var">xapp</span></span> are implemented
    by invoking <span class="inlinecode"><span class="id" title="tactic">eauto</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> <span class="inlinecode"><span class="id" title="var">triple</span></span> to retrieve the relevant
    specification.

<div class="paragraph"> </div>

    The definition from <span class="inlinecode"><span class="id" title="var">Direct</span></span> is slightly more powerful, in that
    it is also able to pick up an induction hypothesis from the
    context for instantiating the triple.

<div class="paragraph"> </div>

    DISCLAIMER: the tactic <span class="inlinecode"><span class="id" title="var">xapp</span></span> that leverages the <span class="inlinecode"><span class="id" title="var">triple</span></span> database
    is not able to automatically apply specifications that feature a
    premise that <span class="inlinecode"><span class="id" title="tactic">eauto</span></span> cannot solve. To exploit such specifications,
    one need to provide the specification explicitly (using <span class="inlinecode"><span class="id" title="var">xapp</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>),
    or to exploit a more complex hint mechanism (as done in CFML). (A
    poor-man's workaround consists in moving all the premises inside
    the precondition, however doing so harms readability.) 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xapp_nosubst" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>; [ <span class="id" title="tactic">solve</span> [ <span class="id" title="tactic">eauto</span> <span class="id" title="keyword">with</span> <span class="id" title="var">triple</span> ] | <span class="id" title="var">xsimpl</span> | <span class="id" title="var">xpull</span> ].<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xapp" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span>; <span class="id" title="var">xapp_try_subst</span>.<br/>
</div>

<div class="doc">
<a id="lab289"></a><h2 class="section">Demo of a Practical Proof using x-Tactics.</h2>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithAdvancedXtactics" class="idref" href="#ProofsWithAdvancedXtactics"><span class="id" title="module">ProofsWithAdvancedXtactics</span></a>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
The proof script for the verification of <span class="inlinecode"><span class="id" title="var">incr</span></span> using the tactic
    <span class="inlinecode"><span class="id" title="var">xapps</span></span> with implicit argument. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithAdvancedXtactics.triple_incr" class="idref" href="#ProofsWithAdvancedXtactics.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:208" class="idref" href="#p:208"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:209" class="idref" href="#n:209"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:208"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:208"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:209"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:208"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:209"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
In order to enable automatically exploiting the specification
    of <span class="inlinecode"><span class="id" title="var">triple</span></span> in the verification of <span class="inlinecode"><span class="id" title="var">succ_using_incr</span></span>, which
    includes a function call to <span class="inlinecode"><span class="id" title="var">triple</span></span>, we add it to the hint
    database <span class="inlinecode"><span class="id" title="var">triple</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Hint Resolve</span> <span class="id" title="var">triple_incr</span> : <span class="id" title="var">triple</span>.<br/>
</div>

<div class="doc">
<a id="lab290"></a><h4 class="section">Exercise: 2 stars, standard, especially useful (triple_succ_using_incr_with_xapps)</h4>
 Using the improved x-tactics, verify the proof of <span class="inlinecode"><span class="id" title="var">succ_using_incr</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithAdvancedXtactics.triple_succ_using_incr_with_xapps" class="idref" href="#ProofsWithAdvancedXtactics.triple_succ_using_incr_with_xapps"><span class="id" title="lemma">triple_succ_using_incr_with_xapps</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:210" class="idref" href="#n:210"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.succ_using_incr"><span class="id" title="definition">succ_using_incr</span></a> <a class="idref" href="WPgen.html#n:210"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="v:211" class="idref" href="#v:211"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#v:211"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:210"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 In summary, thanks to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> and its associated x-tactics,
    we are able to verify concrete programs in Separation Logic
    with concise proof scripts. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithAdvancedXtactics"><span class="id" title="module">ProofsWithAdvancedXtactics</span></a>.<br/>
</div>

<div class="doc">
<a id="lab291"></a><h1 class="section">Optional Material</h1>

</div>

<div class="doc">
<a id="lab292"></a><h2 class="section">Tactics <span class="inlinecode"><span class="id" title="var">xconseq</span></span> and <span class="inlinecode"><span class="id" title="var">xframe</span></span></h2>

<div class="paragraph"> </div>

 The tactic <span class="inlinecode"><span class="id" title="var">xconseq</span></span> applies the weakening rule, from the perspective of
    the user, it replaces the current postcondition with a stronger one.
    Optionally, the tactic can be passed an explicit argument, using
    the syntax <span class="inlinecode"><span class="id" title="var">xconseq</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    The tactic is implemented by applying the lemma <span class="inlinecode"><span class="id" title="var">xconseq_lemma</span></span>,
    stated below. 
<div class="paragraph"> </div>

<a id="lab293"></a><h4 class="section">Exercise: 1 star, standard, optional (xconseq_lemma)</h4>
 Prove the <span class="inlinecode"><span class="id" title="var">xconseq_lemma</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xconseq_lemma" class="idref" href="#xconseq_lemma"><span class="id" title="lemma">xconseq_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="Q<sub>1</sub>:212" class="idref" href="#Q<sub>1</sub>:212"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:213" class="idref" href="#Q<sub>2</sub>:213"><span class="id" title="binder">Q<sub>2</sub></span></a> <a id="H:214" class="idref" href="#H:214"><span class="id" title="binder">H</span></a> <a id="F:215" class="idref" href="#F:215"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:214"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:215"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:212"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:212"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:213"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:214"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:215"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:213"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xconseq" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xconseq_lemma"><span class="id" title="axiom">xconseq_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xconseq" <span class="id" title="keyword">constr</span>(<span class="id" title="var">Q</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xconseq_lemma"><span class="id" title="axiom">xconseq_lemma</span></a> <span class="id" title="var">Q</span>.<br/>
</div>

<div class="doc">
The tactic <span class="inlinecode"><span class="id" title="var">xframe</span></span> enables applying the frame rule on a formula
    produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. The syntax <span class="inlinecode"><span class="id" title="var">xframe</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> is used to specify
    the heap predicate to keep, and the syntax <span class="inlinecode"><span class="id" title="var">xframe_out</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> is used
    to specify the heap predicate to frame out---everything else is kept. 
<div class="paragraph"> </div>

<a id="lab294"></a><h4 class="section">Exercise: 2 stars, standard, optional (xframe_lemma)</h4>
 Prove the <span class="inlinecode"><span class="id" title="var">xframe_lemma</span></span>.
    Exploit the properties of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>; do not try to unfold the
    definition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xframe_lemma" class="idref" href="#xframe_lemma"><span class="id" title="lemma">xframe_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H<sub>1</sub>:216" class="idref" href="#H<sub>1</sub>:216"><span class="id" title="binder">H<sub>1</sub></span></a> <a id="H<sub>2</sub>:217" class="idref" href="#H<sub>2</sub>:217"><span class="id" title="binder">H<sub>2</sub></span></a> <a id="H:218" class="idref" href="#H:218"><span class="id" title="binder">H</span></a> <a id="Q:219" class="idref" href="#Q:219"><span class="id" title="binder">Q</span></a> <a id="Q<sub>1</sub>:220" class="idref" href="#Q<sub>1</sub>:220"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="F:221" class="idref" href="#F:221"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:218"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#H<sub>1</sub>:216"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:217"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H<sub>1</sub>:216"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:221"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:220"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:220"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:217"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q:219"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:218"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:221"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:219"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xframe" <span class="id" title="keyword">constr</span>(<span class="id" title="var">H</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> (@<a class="idref" href="WPgen.html#xframe_lemma"><span class="id" title="axiom">xframe_lemma</span></a> <span class="id" title="var">H</span>); [ <span class="id" title="var">xsimpl</span> | | ].<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xframe_out" <span class="id" title="keyword">constr</span>(<span class="id" title="var">H</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> (@<a class="idref" href="WPgen.html#xframe_lemma"><span class="id" title="axiom">xframe_lemma</span></a> <span class="id" title="var">_</span> <span class="id" title="var">H</span>); [ <span class="id" title="var">xsimpl</span> | | ].<br/>
</div>

<div class="doc">
Let's illustrate the use of <span class="inlinecode"><span class="id" title="var">xframe</span></span> on an example. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithStructuralXtactics" class="idref" href="#ProofsWithStructuralXtactics"><span class="id" title="module">ProofsWithStructuralXtactics</span></a>.<br/>
<span class="id" title="keyword">Import</span> <span class="id" title="var">ExamplePrograms</span>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ProofsWithStructuralXtactics.triple_incr_frame" class="idref" href="#ProofsWithStructuralXtactics.triple_incr_frame"><span class="id" title="lemma">triple_incr_frame</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:222" class="idref" href="#p:222"><span class="id" title="binder">p</span></a> <a id="q:223" class="idref" href="#q:223"><span class="id" title="binder">q</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:224" class="idref" href="#n:224"><span class="id" title="binder">n</span></a> <a id="m:225" class="idref" href="#m:225"><span class="id" title="binder">m</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:222"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:222"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:224"><span class="id" title="variable">n</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#q:223"><span class="id" title="variable">q</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:225"><span class="id" title="variable">m</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#p:222"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:224"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#q:223"><span class="id" title="variable">q</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:225"><span class="id" title="variable">m</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
</div>

<div class="doc">
Instead of calling <span class="inlinecode"><span class="id" title="var">xapp</span></span>, we put aside <span class="inlinecode"><span class="id" title="var">q</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">m</span></span> and focus on <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">n</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xframe</span> (<span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <span class="id" title="var">n</span>). <span class="comment">(*&nbsp;equivalent&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">xframe_out</span></span> <span class="inlinecode">(<span class="id" title="var">q</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">m</span>)</span>.&nbsp;*)</span><br/>
</div>

<div class="doc">
Then we can work in a smaller state that mentions only <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">n</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>.<br/>
</div>

<div class="doc">
Finally we check the check that the current state augmented with
    the framed predicate <span class="inlinecode"><span class="id" title="var">q</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">m</span></span> matches with the claimed postcondition. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithStructuralXtactics"><span class="id" title="module">ProofsWithStructuralXtactics</span></a>.<br/>
</div>

<div class="doc">
<a id="lab295"></a><h2 class="section">Soundness Proof for <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h2>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WPgenSound" class="idref" href="#WPgenSound"><span class="id" title="module">WPgenSound</span></a>.<br/>
</div>

<div class="doc">
<a id="lab296"></a><h3 class="section">Introduction of the Predicate <span class="inlinecode"><span class="id" title="var">formula_sound</span></span></h3>

<div class="paragraph"> </div>

 The soundness theorem that we aim to establish for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Parameter</span> <span class="id" title="var">wpgen_sound</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span> ==&gt; <span class="id" title="var">wp</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>) <span class="id" title="var">Q</span>.
</span>
<div class="paragraph"> </div>

 Before we enter the details of the proof, let us reformulate the
    soundness statement of the soundness theorem in a way that will
    make proof obligations and induction hypotheses easier to read.
    To that end, we introduce the predicate <span class="inlinecode"><span class="id" title="var">formula_sound</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>,
    which asserts that <span class="inlinecode"><span class="id" title="var">F</span></span> is a weakest-precondition style formula
    that entails <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. Formally: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="WPgenSound.formula_sound" class="idref" href="#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a id="t:226" class="idref" href="#t:226"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) (<a id="F:227" class="idref" href="#F:227"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <span class="id" title="keyword">Prop</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <a id="Q:228" class="idref" href="#Q:228"><span class="id" title="binder">Q</span></a>, <a class="idref" href="WPgen.html#F:227"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:228"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:226"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:228"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Using <span class="inlinecode"><span class="id" title="var">formula_sound</span></span>, the soundness theorem for <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    reformulates as follows. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenSound.wpgen_sound'" class="idref" href="#WPgenSound.wpgen_sound'"><span class="id" title="axiom">wpgen_sound'</span></a> : <span class="id" title="keyword">∀</span> <a id="E:229" class="idref" href="#E:229"><span class="id" title="binder">E</span></a> <a id="t:230" class="idref" href="#t:230"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:229"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:230"><span class="id" title="variable">t</span></a>) (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:229"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:230"><span class="id" title="variable">t</span></a>).<br/>
</div>

<div class="doc">
<a id="lab297"></a><h3 class="section">Soundness for the Case of Sequences</h3>

<div class="paragraph"> </div>

 Let us forget about the existence of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> for a minute,
    that is, pretend that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is defined without <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>.

<div class="paragraph"> </div>

    In that setting, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> evaluates to
    <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>.

<div class="paragraph"> </div>

    Recall the definition of <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Definition</span> <span class="id" title="var">wpgen_seq</span> (<span class="id" title="var">F<sub>1</sub></span> <span class="id" title="var">F<sub>2</sub></span>:<span class="id" title="var">formula</span>) : <span class="id" title="var">formula</span> := <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">F<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">F<sub>2</sub></span> <span class="id" title="var">Q</span>).
</span>
<div class="paragraph"> </div>

 Consider the soundness theorem <span class="inlinecode"><span class="id" title="var">wpgen_sound</span></span> and let us specialize
    it to the particular case where <span class="inlinecode"><span class="id" title="var">t</span></span> is of the form <span class="inlinecode"><span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>.
    The corresponding statement is: 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenSound.wpgen_sound_seq" class="idref" href="#WPgenSound.wpgen_sound_seq"><span class="id" title="axiom">wpgen_sound_seq</span></a> : <span class="id" title="keyword">∀</span> <a id="E:232" class="idref" href="#E:232"><span class="id" title="binder">E</span></a> <a id="t<sub>1</sub>:233" class="idref" href="#t<sub>1</sub>:233"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:234" class="idref" href="#t<sub>2</sub>:234"><span class="id" title="binder">t<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:232"><span class="id" title="variable">E</span></a> (<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:233"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:234"><span class="id" title="variable">t<sub>2</sub></span></a>)) (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:232"><span class="id" title="variable">E</span></a> (<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:233"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:234"><span class="id" title="variable">t<sub>2</sub></span></a>)).<br/>
</div>

<div class="doc">
In that statement:

<div class="paragraph"> </div>

<ul class="doclist">
<li> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> evaluates to
      <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>.

</li>
<li> <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> evaluates to
      <span class="inlinecode"><span class="id" title="var">trm_seq</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>.

</li>
</ul>

<div class="paragraph"> </div>

    Moreover, by induction hypothesis, we will be able to assume
    the soundness result to already hold for the subterms <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>.

<div class="paragraph"> </div>

    Thus, to establish the soundness of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for sequences, we
    have to prove the following result: 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenSound.wpgen_sound_seq'" class="idref" href="#WPgenSound.wpgen_sound_seq'"><span class="id" title="axiom">wpgen_sound_seq'</span></a> : <span class="id" title="keyword">∀</span> <a id="E:236" class="idref" href="#E:236"><span class="id" title="binder">E</span></a> <a id="t<sub>1</sub>:237" class="idref" href="#t<sub>1</sub>:237"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:238" class="idref" href="#t<sub>2</sub>:238"><span class="id" title="binder">t<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:237"><span class="id" title="variable">t<sub>1</sub></span></a>) (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:237"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:238"><span class="id" title="variable">t<sub>2</sub></span></a>) (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:238"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:237"><span class="id" title="variable">t<sub>1</sub></span></a>) (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:238"><span class="id" title="variable">t<sub>2</sub></span></a>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:237"><span class="id" title="variable">t<sub>1</sub></span></a>) (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:236"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:238"><span class="id" title="variable">t<sub>2</sub></span></a>)).<br/>
</div>

<div class="doc">
In the above statement, let us abstract <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> as <span class="inlinecode"><span class="id" title="var">t<sub>1</sub>'</span></span>
    and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> as <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span>, and similarly <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> as <span class="inlinecode"><span class="id" title="var">t<sub>2</sub>'</span></span>
    and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> as <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>. The statement reformulates as: 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_seq_sound" class="idref" href="#WPgenSound.wpgen_seq_sound"><span class="id" title="lemma">wpgen_seq_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="t<sub>1</sub>':240" class="idref" href="#t<sub>1</sub>':240"><span class="id" title="binder">t<sub>1</sub>'</span></a> <a id="t<sub>2</sub>':241" class="idref" href="#t<sub>2</sub>':241"><span class="id" title="binder">t<sub>2</sub>'</span></a> <a id="F<sub>1</sub>:242" class="idref" href="#F<sub>1</sub>:242"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:243" class="idref" href="#F<sub>2</sub>:243"><span class="id" title="binder">F<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>':240"><span class="id" title="variable">t<sub>1</sub>'</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:242"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>':241"><span class="id" title="variable">t<sub>2</sub>'</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:243"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>':240"><span class="id" title="variable">t<sub>1</sub>'</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>':241"><span class="id" title="variable">t<sub>2</sub>'</span></a>) (<a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:242"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:243"><span class="id" title="variable">F<sub>2</sub></span></a>).<br/>
</div>

<div class="doc">
This statement captures the essence of the correctness of
    the definition of <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span>. Let's prove it. 
</div>
<div class="code">

<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">S<sub>1</sub></span> <span class="id" title="var">S<sub>2</sub></span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Reveal&nbsp;the&nbsp;soundness&nbsp;statement&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Consider&nbsp;a&nbsp;postcondition&nbsp;<span class="inlinecode"><span class="id" title="var">Q</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Reveal&nbsp;<span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>,&nbsp;which&nbsp;is&nbsp;defined&nbsp;as&nbsp;<span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;By&nbsp;transitivity&nbsp;of&nbsp;entailment&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans"><span class="id" title="lemma">himpl_trans</span></a>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Apply&nbsp;the&nbsp;soundness&nbsp;result&nbsp;for&nbsp;<span class="inlinecode"><span class="id" title="var">wp</span></span>&nbsp;on&nbsp;sequences:<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;2:{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#wp_seq"><span class="id" title="axiom">wp_seq</span></a>. }<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Exploit&nbsp;the&nbsp;induction&nbsp;hypotheses&nbsp;to&nbsp;conclude&nbsp;*)</span><br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans"><span class="id" title="lemma">himpl_trans</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <span class="id" title="var">S<sub>1</sub></span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPsem.html#wp_conseq"><span class="id" title="lemma">wp_conseq</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">v</span>. <span class="id" title="var">applys</span> <span class="id" title="var">S<sub>2</sub></span>. } }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab298"></a><h3 class="section">Soundness of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for the Other Term Constructs</h3>

<div class="paragraph"> </div>

 The proof for the other term constructs are shown below and
    will be used to set up the main induction. The reader may
    skip over the proof details. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_val_sound" class="idref" href="#WPgenSound.wpgen_val_sound"><span class="id" title="lemma">wpgen_val_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="v:244" class="idref" href="#v:244"><span class="id" title="binder">v</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <a class="idref" href="WPgen.html#v:244"><span class="id" title="variable">v</span></a>) (<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <a class="idref" href="WPgen.html#v:244"><span class="id" title="variable">v</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#wp_val"><span class="id" title="axiom">wp_val</span></a>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_fun_val_sound" class="idref" href="#WPgenSound.wpgen_fun_val_sound"><span class="id" title="lemma">wpgen_fun_val_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="x:245" class="idref" href="#x:245"><span class="id" title="binder">x</span></a> <a id="t:246" class="idref" href="#t:246"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <a class="idref" href="WPgen.html#x:245"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t:246"><span class="id" title="variable">t</span></a>) (<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:245"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t:246"><span class="id" title="variable">t</span></a>)).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#wp_fun"><span class="id" title="axiom">wp_fun</span></a>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_fix_val_sound" class="idref" href="#WPgenSound.wpgen_fix_val_sound"><span class="id" title="lemma">wpgen_fix_val_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="f:247" class="idref" href="#f:247"><span class="id" title="binder">f</span></a> <a id="x:248" class="idref" href="#x:248"><span class="id" title="binder">x</span></a> <a id="t:249" class="idref" href="#t:249"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <a class="idref" href="WPgen.html#f:247"><span class="id" title="variable">f</span></a> <a class="idref" href="WPgen.html#x:248"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t:249"><span class="id" title="variable">t</span></a>) (<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <a class="idref" href="WPgen.html#f:247"><span class="id" title="variable">f</span></a> <a class="idref" href="WPgen.html#x:248"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t:249"><span class="id" title="variable">t</span></a>)).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="WPsem.html#wp_fix"><span class="id" title="lemma">wp_fix</span></a>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_let_sound" class="idref" href="#WPgenSound.wpgen_let_sound"><span class="id" title="lemma">wpgen_let_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="F<sub>1</sub>:250" class="idref" href="#F<sub>1</sub>:250"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F2of:251" class="idref" href="#F2of:251"><span class="id" title="binder">F2of</span></a> <a id="x:252" class="idref" href="#x:252"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:253" class="idref" href="#t<sub>1</sub>:253"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:254" class="idref" href="#t<sub>2</sub>:254"><span class="id" title="binder">t<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:253"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:250"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="v:255" class="idref" href="#v:255"><span class="id" title="binder">v</span></a>, <a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:252"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v:255"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:254"><span class="id" title="variable">t<sub>2</sub></span></a>) (<a class="idref" href="WPgen.html#F2of:251"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#v:255"><span class="id" title="variable">v</span></a>)<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <a class="idref" href="WPgen.html#x:252"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:253"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:254"><span class="id" title="variable">t<sub>2</sub></span></a>) (<a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:250"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F2of:251"><span class="id" title="variable">F2of</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">S<sub>1</sub></span> <span class="id" title="var">S<sub>2</sub></span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans"><span class="id" title="lemma">himpl_trans</span></a> <a class="idref" href="WPgen.html#wp_let"><span class="id" title="axiom">wp_let</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans"><span class="id" title="lemma">himpl_trans</span></a> <span class="id" title="var">S<sub>1</sub></span>. <span class="id" title="var">applys</span> <a class="idref" href="WPsem.html#wp_conseq"><span class="id" title="lemma">wp_conseq</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">v</span>. <span class="id" title="var">applys</span> <span class="id" title="var">S<sub>2</sub></span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_if_sound" class="idref" href="#WPgenSound.wpgen_if_sound"><span class="id" title="lemma">wpgen_if_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="F<sub>1</sub>:256" class="idref" href="#F<sub>1</sub>:256"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:257" class="idref" href="#F<sub>2</sub>:257"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="t<sub>0</sub>:258" class="idref" href="#t<sub>0</sub>:258"><span class="id" title="binder">t<sub>0</sub></span></a> <a id="t<sub>1</sub>:259" class="idref" href="#t<sub>1</sub>:259"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:260" class="idref" href="#t<sub>2</sub>:260"><span class="id" title="binder">t<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:259"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:256"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:260"><span class="id" title="variable">t<sub>2</sub></span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:257"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <a class="idref" href="WPgen.html#t<sub>0</sub>:258"><span class="id" title="variable">t<sub>0</sub></span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:259"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:260"><span class="id" title="variable">t<sub>2</sub></span></a>) (<a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> <a class="idref" href="WPgen.html#t<sub>0</sub>:258"><span class="id" title="variable">t<sub>0</sub></span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:256"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:257"><span class="id" title="variable">F<sub>2</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">S<sub>1</sub></span> <span class="id" title="var">S<sub>2</sub></span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">b</span> →.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans"><span class="id" title="lemma">himpl_trans</span></a> <a class="idref" href="WPgen.html#wp_if"><span class="id" title="axiom">wp_if</span></a>. <span class="id" title="var">case_if</span>. { <span class="id" title="var">applys</span> <span class="id" title="var">S<sub>1</sub></span>. } { <span class="id" title="var">applys</span> <span class="id" title="var">S<sub>2</sub></span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The formula <span class="inlinecode"><span class="id" title="var">wpgen_fail</span></span> is a sound formula not just for a variable
   <span class="inlinecode"><span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span>, but in fact for any term <span class="inlinecode"><span class="id" title="var">t</span></span>. Indeed, the entailment
   <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is always true. Hence the general statement
   for <span class="inlinecode"><span class="id" title="var">wpgen_fail</span></span> that appears next. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_fail_sound" class="idref" href="#WPgenSound.wpgen_fail_sound"><span class="id" title="lemma">wpgen_fail_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="t:261" class="idref" href="#t:261"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t:261"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The formula <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is a sound formula for a term <span class="inlinecode"><span class="id" title="var">t</span></span>, not just when
    <span class="inlinecode"><span class="id" title="var">t</span></span> is an application, but for any term <span class="inlinecode"><span class="id" title="var">t</span></span>. Hence the general
    statement for <span class="inlinecode"><span class="id" title="var">wp</span></span> that appears next. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wp_sound" class="idref" href="#WPgenSound.wp_sound"><span class="id" title="lemma">wp_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="t:262" class="idref" href="#t:262"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t:262"><span class="id" title="variable">t</span></a> (<a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:262"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>. <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_refl"><span class="id" title="lemma">himpl_refl</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab299"></a><h3 class="section">Soundness of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

<div class="paragraph"> </div>

 To carry out the soundness proof for <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we also need to justify
    that the addition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> to the head of every call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    preserves the entailment <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    Consider a term <span class="inlinecode"><span class="id" title="var">t</span></span>. The result of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> takes the form <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>,
    where <span class="inlinecode"><span class="id" title="var">F</span></span> denotes the main pattern matching on <span class="inlinecode"><span class="id" title="var">t</span></span> that occurs in the
    definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.

<div class="paragraph"> </div>

    Our goal is to show that if the formula <span class="inlinecode"><span class="id" title="var">F</span></span> is a valid weakest
    precondition for <span class="inlinecode"><span class="id" title="var">t</span></span>, then so is <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>. One way to prove
    this result is to exploit the fact that, when a formula <span class="inlinecode"><span class="id" title="var">F</span></span> is of
    the form <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, applying <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> does not alter its meaning
    (recall lemma <span class="inlinecode"><span class="id" title="var">mkstruct_wp</span></span>). 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.mkstruct_sound" class="idref" href="#WPgenSound.mkstruct_sound"><span class="id" title="lemma">mkstruct_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="t:263" class="idref" href="#t:263"><span class="id" title="binder">t</span></a> <a id="F:264" class="idref" href="#F:264"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t:263"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#F:264"><span class="id" title="variable">F</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t:263"><span class="id" title="variable">t</span></a> (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:264"><span class="id" title="variable">F</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPgen.html#mkstruct_wp"><span class="id" title="lemma">mkstruct_wp</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#mkstruct_monotone"><span class="id" title="lemma">mkstruct_monotone</span></a>. <span class="id" title="var">applys</span> <span class="id" title="var">M</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Another, lower-level proof for the same result reveals the definition
    of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> and exploits the consequence-frame rule for <span class="inlinecode"><span class="id" title="var">wp</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.mkstruct_sound'" class="idref" href="#WPgenSound.mkstruct_sound'"><span class="id" title="lemma">mkstruct_sound'</span></a> : <span class="id" title="keyword">∀</span> <a id="t:265" class="idref" href="#t:265"><span class="id" title="binder">t</span></a> <a id="F:266" class="idref" href="#F:266"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t:265"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#F:266"><span class="id" title="variable">F</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> <a class="idref" href="WPgen.html#t:265"><span class="id" title="variable">t</span></a> (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:266"><span class="id" title="variable">F</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Consider&nbsp;a&nbsp;postcondition&nbsp;<span class="inlinecode"><span class="id" title="var">Q</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Q</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Reveal&nbsp;the&nbsp;definition&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">mkstruct</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Extract&nbsp;the&nbsp;<span class="inlinecode"><span class="id" title="var">Q'</span></span>&nbsp;quantified&nbsp;in&nbsp;the&nbsp;definition&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">mkstruct</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span> <span class="id" title="var">H</span> <span class="id" title="var">N</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Instantiate&nbsp;the&nbsp;assumption&nbsp;on&nbsp;<span class="inlinecode"><span class="id" title="var">F</span></span>&nbsp;with&nbsp;that&nbsp;<span class="inlinecode"><span class="id" title="var">Q'</span></span>,&nbsp;and&nbsp;exploit&nbsp;it.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">lets</span> <span class="id" title="var">M'</span>: <span class="id" title="var">M</span> <span class="id" title="var">Q'</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M'</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Conclude&nbsp;using&nbsp;the&nbsp;structural&nbsp;rules&nbsp;for&nbsp;<span class="inlinecode"><span class="id" title="var">wp</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPsem.html#wp_conseq_frame"><span class="id" title="axiom">wp_conseq_frame</span></a>. <span class="id" title="var">applys</span> <span class="id" title="var">N</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab300"></a><h3 class="section">Lemmas Capturing Properties of Iterated Substitutions</h3>

<div class="paragraph"> </div>

 In the proof of soundness for <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we need to exploit two
    basic properties of the iterated substitution function <span class="inlinecode"><span class="id" title="var">isubst</span></span>.

<div class="paragraph"> </div>

    The first property asserts that the substitution for the empty
    context is the identity. This result is needed to cleanly state
    the final statement of the soundness theorem. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenSound.isubst_nil" class="idref" href="#WPgenSound.isubst_nil"><span class="id" title="axiom">isubst_nil</span></a> : <span class="id" title="keyword">∀</span> <a id="t:267" class="idref" href="#t:267"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> <a class="idref" href="WPgen.html#t:267"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#t:267"><span class="id" title="variable">t</span></a>.<br/>
</div>

<div class="doc">
The second property asserts that the substitution for a context
    <span class="inlinecode">(<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span></span> is the same as the substitution for the context <span class="inlinecode"><span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>
    followed with the substitution of <span class="inlinecode"><span class="id" title="var">x</span></span> by <span class="inlinecode"><span class="id" title="var">v</span></span> using the basic
    substitution function <span class="inlinecode"><span class="id" title="tactic">subst</span></span>. This second property is needed to
    handle the case of let-bindings. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenSound.isubst_rem" class="idref" href="#WPgenSound.isubst_rem"><span class="id" title="axiom">isubst_rem</span></a> : <span class="id" title="keyword">∀</span> <a id="x:269" class="idref" href="#x:269"><span class="id" title="binder">x</span></a> <a id="v:270" class="idref" href="#v:270"><span class="id" title="binder">v</span></a> <a id="E:271" class="idref" href="#E:271"><span class="id" title="binder">E</span></a> <a id="t:272" class="idref" href="#t:272"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:269"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:270"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:271"><span class="id" title="variable">E</span></a>) <a class="idref" href="WPgen.html#t:272"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:269"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v:270"><span class="id" title="variable">v</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:269"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E:271"><span class="id" title="variable">E</span></a>) <a class="idref" href="WPgen.html#t:272"><span class="id" title="variable">t</span></a>).<br/>
</div>

<div class="doc">
The proofs for these two lemmas is technical and of limited interest.
    They can be found in appendix near the end of this chapter. 
</div>

<div class="doc">
<a id="lab301"></a><h3 class="section">Main Induction for the Soundness Proof of <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h3>

<div class="paragraph"> </div>

 We prove the soundness of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> by structural induction on <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    As explained previously, the soundness lemma is stated with help of
    the predicate <span class="inlinecode"><span class="id" title="var">formula_sound</span></span>, in the form:
    <span class="inlinecode"><span class="id" title="var">formula_sound</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span>.

<div class="paragraph"> </div>

    For each term construct, the proof case consists of two steps:

<div class="paragraph"> </div>

<ul class="doclist">
<li> first, invoke the lemma <span class="inlinecode"><span class="id" title="var">mkstruct_sound</span></span> to justify soundness
      of the leading <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>,

</li>
<li> second, invoke the the soundness lemma specific to that term
      construct, e.g. <span class="inlinecode"><span class="id" title="var">wpgen_seq_sound</span></span> for sequences.

</li>
</ul>

<div class="paragraph"> </div>


</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_sound_induct" class="idref" href="#WPgenSound.wpgen_sound_induct"><span class="id" title="lemma">wpgen_sound_induct</span></a> : <span class="id" title="keyword">∀</span> <a id="E:274" class="idref" href="#E:274"><span class="id" title="binder">E</span></a> <a id="t:275" class="idref" href="#t:275"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenSound.formula_sound"><span class="id" title="definition">formula_sound</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:274"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:275"><span class="id" title="variable">t</span></a>) (<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:274"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:275"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">gen</span> <span class="id" title="var">E</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">simpl</span>;<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.mkstruct_sound"><span class="id" title="lemma">mkstruct_sound</span></a>.<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_val_sound"><span class="id" title="lemma">wpgen_val_sound</span></a>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">rename</span> <span class="id" title="var">v</span> <span class="id" title="var">into</span> <span class="id" title="var">x</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a>. <span class="id" title="var">case_eq</span> (<a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <span class="id" title="var">E</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span> <span class="id" title="var">v</span> <span class="id" title="var">EQ</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_val_sound"><span class="id" title="lemma">wpgen_val_sound</span></a>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span> <span class="id" title="var">N</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_fail_sound"><span class="id" title="lemma">wpgen_fail_sound</span></a>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_fun_val_sound"><span class="id" title="lemma">wpgen_fun_val_sound</span></a>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_fix_val_sound"><span class="id" title="lemma">wpgen_fix_val_sound</span></a>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wp_sound"><span class="id" title="lemma">wp_sound</span></a>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_seq_sound"><span class="id" title="lemma">wpgen_seq_sound</span></a>. { <span class="id" title="var">applys</span> <span class="id" title="var">IHt1</span>. } { <span class="id" title="var">applys</span> <span class="id" title="var">IHt2</span>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">rename</span> <span class="id" title="var">v</span> <span class="id" title="var">into</span> <span class="id" title="var">x</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_let_sound"><span class="id" title="lemma">wpgen_let_sound</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <span class="id" title="var">IHt1</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span> <span class="id" title="var">v</span>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPgen.html#WPgenSound.isubst_rem"><span class="id" title="axiom">isubst_rem</span></a>. <span class="id" title="var">applys</span> <span class="id" title="var">IHt2</span>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_if_sound"><span class="id" title="lemma">wpgen_if_sound</span></a>. { <span class="id" title="var">applys</span> <span class="id" title="var">IHt2</span>. } { <span class="id" title="var">applys</span> <span class="id" title="var">IHt3</span>. } }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab302"></a><h3 class="section">Statement of Soundness of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Closed Terms</h3>

<div class="paragraph"> </div>

 For a closed term <span class="inlinecode"><span class="id" title="var">t</span></span>, the context <span class="inlinecode"><span class="id" title="var">E</span></span> is instantiated as <span class="inlinecode"><span class="id" title="var">nil</span></span>,
    and <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">nil</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> simplifies to <span class="inlinecode"><span class="id" title="var">t</span></span>. We obtain the main
    soundness statement for <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.wpgen_sound" class="idref" href="#WPgenSound.wpgen_sound"><span class="id" title="lemma">wpgen_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="t:276" class="idref" href="#t:276"><span class="id" title="binder">t</span></a> <a id="Q:277" class="idref" href="#Q:277"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> <a class="idref" href="WPgen.html#t:276"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:277"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="axiom">wp</span></a> <a class="idref" href="WPgen.html#t:276"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:277"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">lets</span> <span class="id" title="var">N</span>: (<a class="idref" href="WPgen.html#wpgen_sound"><span class="id" title="axiom">wpgen_sound</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> <span class="id" title="var">t</span>). <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#WPgenSound.isubst_nil"><span class="id" title="axiom">isubst_nil</span></a> <span class="id" title="keyword">in</span> <span class="id" title="var">N</span>. <span class="id" title="var">applys</span>* <span class="id" title="var">N</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
A corollary can be derived for deriving a triple of the
    form <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> from <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">nil</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.triple_of_wpgen" class="idref" href="#WPgenSound.triple_of_wpgen"><span class="id" title="lemma">triple_of_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="t:278" class="idref" href="#t:278"><span class="id" title="binder">t</span></a> <a id="H:279" class="idref" href="#H:279"><span class="id" title="binder">H</span></a> <a id="Q:280" class="idref" href="#Q:280"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:279"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> <a class="idref" href="WPgen.html#t:278"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:280"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="WPgen.html#t:278"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#H:279"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:280"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="axiom">wp_equiv</span></a>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_sound"><span class="id" title="lemma">wpgen_sound</span></a>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The lemma <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span>, used by the tactic <span class="inlinecode"><span class="id" title="var">xwp</span></span>,
    is a variant of <span class="inlinecode"><span class="id" title="var">wpgen_of_triple</span></span> specialized for establishing
    a triple for a function application. (Recall that, in essence,
    this lemma is a reformulation of the rule <span class="inlinecode"><span class="id" title="var">triple_app_fun</span></span>.) 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.triple_app_fun_from_wpgen" class="idref" href="#WPgenSound.triple_app_fun_from_wpgen"><span class="id" title="lemma">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:281" class="idref" href="#v<sub>1</sub>:281"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:282" class="idref" href="#v<sub>2</sub>:282"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:283" class="idref" href="#x:283"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:284" class="idref" href="#t<sub>1</sub>:284"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:285" class="idref" href="#H:285"><span class="id" title="binder">H</span></a> <a id="Q:286" class="idref" href="#Q:286"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:281"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:283"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:284"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:285"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:283"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:282"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:284"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:286"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:281"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:282"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:285"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:286"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M<sub>1</sub></span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span> <a class="idref" href="WPsem.html#triple_app_fun"><span class="id" title="axiom">triple_app_fun</span></a> <span class="id" title="var">M<sub>1</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">asserts_rewrite</span> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <span class="id" title="var">x</span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">t<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v<sub>2</sub></span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <span class="id" title="var">t<sub>1</sub></span>).<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#WPgenSound.isubst_rem"><span class="id" title="axiom">isubst_rem</span></a>. <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#WPgenSound.isubst_nil"><span class="id" title="axiom">isubst_nil</span></a>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="axiom">wp_equiv</span></a>. <span class="id" title="var">xchange</span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_sound_induct"><span class="id" title="lemma">wpgen_sound_induct</span></a>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The lemma <span class="inlinecode"><span class="id" title="var">triple_app_fix_from_wpgen</span></span> is a variant of the above
    lemma suited for recursive functions. Note that the proof exploits a
    lemma called <span class="inlinecode"><span class="id" title="var">isubst_rem_2</span></span> which is an immediate generalization of
    the lemma <span class="inlinecode"><span class="id" title="var">isubst_rem</span></span>. The proof of <span class="inlinecode"><span class="id" title="var">isubst_rem_2</span></span> appears near
    the bottom of this file. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenSound.triple_app_fix_from_wpgen" class="idref" href="#WPgenSound.triple_app_fix_from_wpgen"><span class="id" title="lemma">triple_app_fix_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:287" class="idref" href="#v<sub>1</sub>:287"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:288" class="idref" href="#v<sub>2</sub>:288"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="f:289" class="idref" href="#f:289"><span class="id" title="binder">f</span></a> <a id="x:290" class="idref" href="#x:290"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:291" class="idref" href="#t<sub>1</sub>:291"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:292" class="idref" href="#H:292"><span class="id" title="binder">H</span></a> <a id="Q:293" class="idref" href="#Q:293"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:287"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <a class="idref" href="WPgen.html#f:289"><span class="id" title="variable">f</span></a> <a class="idref" href="WPgen.html#x:290"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:291"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:292"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#f:289"><span class="id" title="variable">f</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>1</sub>:287"><span class="id" title="variable">v<sub>1</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:290"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:288"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:291"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:293"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:287"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:288"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:292"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:293"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M<sub>1</sub></span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span> <a class="idref" href="Rules.html#triple_app_fix"><span class="id" title="axiom">triple_app_fix</span></a> <span class="id" title="var">M<sub>1</sub></span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">asserts_rewrite</span> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <span class="id" title="var">x</span> <span class="id" title="var">v<sub>2</sub></span> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <span class="id" title="var">f</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">f</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v<sub>1</sub></span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v<sub>2</sub></span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <span class="id" title="var">t<sub>1</sub></span>).<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">rewrite</span> <a class="idref" href="LibSepReference.html#isubst_rem_2"><span class="id" title="lemma">isubst_rem_2</span></a>. <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#WPgenSound.isubst_nil"><span class="id" title="axiom">isubst_nil</span></a>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="axiom">wp_equiv</span></a>. <span class="id" title="var">xchange</span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenSound.wpgen_sound_induct"><span class="id" title="lemma">wpgen_sound_induct</span></a>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WPgenSound"><span class="id" title="module">WPgenSound</span></a>.<br/>
</div>

<div class="doc">
<a id="lab303"></a><h2 class="section">Guessing the Definition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h2>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="MkstructGuess" class="idref" href="#MkstructGuess"><span class="id" title="module">MkstructGuess</span></a>.<br/>
</div>

<div class="doc">
How could we have possibly guessed the definition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>?

<div class="paragraph"> </div>

    Recall that we observed, in an exercise, that the definition
    of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> satisfies the idempotence property:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Lemma</span> <span class="id" title="var">mkstruct_idempotence</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">F</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="var">mkstruct</span> <span class="id" title="var">F</span>) = <span class="id" title="var">mkstruct</span> <span class="id" title="var">F</span>
</span>    This idempotence property reflects in particular the fact that consecutive
    applications of the frame rule can be combined into into a single
    application of this rule, and likewise for the rule of consequence. Since
    it seems to make some sense for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> to be idempotent, let us pretend
    that this property is a requirement for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>.

<div class="paragraph"> </div>

    In other words, assume that we are searching for a predicate satisfying
    4 properties: <span class="inlinecode"><span class="id" title="var">mkstruct_frame</span></span>, <span class="inlinecode"><span class="id" title="var">mkstruct_conseq</span></span>, <span class="inlinecode"><span class="id" title="var">mkstruct_erase</span></span>, and
    <span class="inlinecode"><span class="id" title="var">mkstruct_idempotence</span></span>.

<div class="paragraph"> </div>

    The following reasoning steps can lead to figure out a definition of
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> that satisfies these properties. 
<div class="paragraph"> </div>

 Recall the statement of <span class="inlinecode"><span class="id" title="var">mkstruct_frame</span></span> and of <span class="inlinecode"><span class="id" title="var">mkstruct_conseq</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructGuess.mkstruct_frame" class="idref" href="#MkstructGuess.mkstruct_frame"><span class="id" title="axiom">mkstruct_frame</span></a> : <span class="id" title="keyword">∀</span> <a id="F:294" class="idref" href="#F:294"><span class="id" title="binder">F</span></a> <a id="H:295" class="idref" href="#H:295"><span class="id" title="binder">H</span></a> <a id="Q:296" class="idref" href="#Q:296"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:294"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:296"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:295"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:294"><span class="id" title="variable">F</span></a> (<a class="idref" href="WPgen.html#Q:296"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:295"><span class="id" title="variable">H</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Parameter</span> <a id="MkstructGuess.mkstruct_conseq" class="idref" href="#MkstructGuess.mkstruct_conseq"><span class="id" title="axiom">mkstruct_conseq</span></a> : <span class="id" title="keyword">∀</span> <a id="F:298" class="idref" href="#F:298"><span class="id" title="binder">F</span></a> <a id="Q<sub>1</sub>:299" class="idref" href="#Q<sub>1</sub>:299"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:300" class="idref" href="#Q<sub>2</sub>:300"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:299"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:300"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:298"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:299"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:298"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:300"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
The two rules can be combined into a single one as follows
    (similarly to the way it is done for <span class="inlinecode"><span class="id" title="var">wp_conseq_frame</span></span>). 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructGuess.mkstruct_conseq_frame" class="idref" href="#MkstructGuess.mkstruct_conseq_frame"><span class="id" title="axiom">mkstruct_conseq_frame</span></a> : <span class="id" title="keyword">∀</span> <a id="F:302" class="idref" href="#F:302"><span class="id" title="binder">F</span></a> <a id="Q<sub>1</sub>:303" class="idref" href="#Q<sub>1</sub>:303"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:304" class="idref" href="#Q<sub>2</sub>:304"><span class="id" title="binder">Q<sub>2</sub></span></a> <a id="H:305" class="idref" href="#H:305"><span class="id" title="binder">H</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:303"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:305"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:304"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:305"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:302"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:303"><span class="id" title="variable">Q<sub>1</sub></span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:302"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:304"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
By the idempotence property <span class="inlinecode"><span class="id" title="var">mkstruct_idempotence</span></span>,
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span> should be equal to <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode">(<span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span>)</span>.
    Let's exploit this equality for the second occurrence of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructGuess.mkstruct_conseq_idempotence" class="idref" href="#MkstructGuess.mkstruct_conseq_idempotence"><span class="id" title="axiom">mkstruct_conseq_idempotence</span></a> : <span class="id" title="keyword">∀</span> <a id="F:307" class="idref" href="#F:307"><span class="id" title="binder">F</span></a> <a id="Q<sub>1</sub>:308" class="idref" href="#Q<sub>1</sub>:308"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:309" class="idref" href="#Q<sub>2</sub>:309"><span class="id" title="binder">Q<sub>2</sub></span></a> <a id="H:310" class="idref" href="#H:310"><span class="id" title="binder">H</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:308"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:310"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:309"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:310"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:307"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:308"><span class="id" title="variable">Q<sub>1</sub></span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:307"><span class="id" title="variable">F</span></a>) <a class="idref" href="WPgen.html#Q<sub>2</sub>:309"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
Now, let's replace <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span> with <span class="inlinecode"><span class="id" title="var">F'</span></span>. Doing so results in the
    statment shown below, which gives a sufficient condition for the
    statement <span class="inlinecode"><span class="id" title="var">mkstruct_conseq_idempotence</span></span> to hold. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructGuess.mkstruct_conseq_idempotence_generalized" class="idref" href="#MkstructGuess.mkstruct_conseq_idempotence_generalized"><span class="id" title="axiom">mkstruct_conseq_idempotence_generalized</span></a> : <span class="id" title="keyword">∀</span> <a id="F':312" class="idref" href="#F':312"><span class="id" title="binder">F'</span></a> <a id="Q<sub>1</sub>:313" class="idref" href="#Q<sub>1</sub>:313"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:314" class="idref" href="#Q<sub>2</sub>:314"><span class="id" title="binder">Q<sub>2</sub></span></a> <a id="H:315" class="idref" href="#H:315"><span class="id" title="binder">H</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:313"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:315"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:314"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:315"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#F':312"><span class="id" title="variable">F'</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:313"><span class="id" title="variable">Q<sub>1</sub></span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F':312"><span class="id" title="variable">F'</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:314"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
We can reformulate the above statement as an introduction rule
    by merging the hypothesis into the left-hand side of the entailment
    from the conclusion. We thereby obtain an introduction lemma
    for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructGuess.mkstruct_introduction" class="idref" href="#MkstructGuess.mkstruct_introduction"><span class="id" title="axiom">mkstruct_introduction</span></a> : <span class="id" title="keyword">∀</span> <a id="F':317" class="idref" href="#F':317"><span class="id" title="binder">F'</span></a> <a id="Q<sub>2</sub>:318" class="idref" href="#Q<sub>2</sub>:318"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="Q<sub>1</sub>:319" class="idref" href="#Q<sub>1</sub>:319"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="H:320" class="idref" href="#H:320"><span class="id" title="binder">H</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#Q<sub>1</sub>:319"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:320"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:318"><span class="id" title="variable">Q<sub>2</sub></span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:320"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#F':317"><span class="id" title="variable">F'</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:319"><span class="id" title="variable">Q<sub>1</sub></span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F':317"><span class="id" title="variable">F'</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:318"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
For this entailment to hold, because entailment is a reflexive relation,
    it is sufficient to define <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F'</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span></span>, that is, the right-hand side
    of the entailment, as equal to the contents of the left-hand side. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="MkstructGuess.mkstruct" class="idref" href="#MkstructGuess.mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a id="F':322" class="idref" href="#F':322"><span class="id" title="binder">F'</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> (<a id="Q<sub>2</sub>:323" class="idref" href="#Q<sub>2</sub>:323"><span class="id" title="binder">Q<sub>2</sub></span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>) ⇒ <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="Q<sub>1</sub>:324" class="idref" href="#Q<sub>1</sub>:324"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="H:325" class="idref" href="#H:325"><span class="id" title="binder">H</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#Q<sub>1</sub>:324"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:325"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:323"><span class="id" title="variable">Q<sub>2</sub></span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:325"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#F':322"><span class="id" title="variable">F'</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:324"><span class="id" title="variable">Q<sub>1</sub></span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a>.<br/>
</div>

<div class="doc">
As we have proved earlier in this chapter, this definition indeed satisfies
    the 4 desired properties: <span class="inlinecode"><span class="id" title="var">mkstruct_frame</span></span>, <span class="inlinecode"><span class="id" title="var">mkstruct_conseq</span></span>,
    <span class="inlinecode"><span class="id" title="var">mkstruct_erase</span></span>, and <span class="inlinecode"><span class="id" title="var">mkstruct_idempotence</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#MkstructGuess"><span class="id" title="module">MkstructGuess</span></a>.<br/>
</div>

<div class="doc">
<a id="lab304"></a><h2 class="section">Proof of Properties of Iterated Substitution</h2>

<div class="paragraph"> </div>

 In these proofs, we use the TLC tactic <span class="inlinecode"><span class="id" title="var">fequals</span></span> which is an enhanced
    variant of the tactic <span class="inlinecode"><span class="id" title="tactic">f_equal</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="IsubstProp" class="idref" href="#IsubstProp"><span class="id" title="module">IsubstProp</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">liblist_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">E</span> : <a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>.<br/>
</div>

<div class="doc">
Recall that <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> denotes the multi-substitution
    in the term <span class="inlinecode"><span class="id" title="var">t</span></span> of all bindings form the association list <span class="inlinecode"><span class="id" title="var">E</span></span>.

<div class="paragraph"> </div>

    The soundness proof for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> and the proof of its corollary
    <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span> rely on two key properties of
    iterated substitutions, captured by the lemmas called <span class="inlinecode"><span class="id" title="var">isubst_nil</span></span>
    and <span class="inlinecode"><span class="id" title="var">isubst_rem</span></span>, which we state and prove next.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">isubst</span> <span class="id" title="var">nil</span> <span class="id" title="var">t</span> = <span class="id" title="var">t</span><br/>
<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t</span>) = <span class="id" title="var">isubst</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t</span>
</span>
<div class="paragraph"> </div>

 The first lemma is straightforward by induction. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.isubst_nil" class="idref" href="#IsubstProp.isubst_nil"><span class="id" title="lemma">isubst_nil</span></a> : <span class="id" title="keyword">∀</span> <a id="t:326" class="idref" href="#t:326"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> <a class="idref" href="WPgen.html#t:326"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#t:326"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">t</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="var">fequals</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The second lemma is much more involved to prove.

<div class="paragraph"> </div>

    We introduce the notion of "two equivalent contexts"
    <span class="inlinecode"><span class="id" title="var">E<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">E<sub>2</sub></span></span>, and argue that substitution for two
    equivalent contexts yields the same result.

<div class="paragraph"> </div>

    We then introduce the notion of "contexts with disjoint
    domains", and argue that if <span class="inlinecode"><span class="id" title="var">E<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">E<sub>2</sub></span></span> are disjoint then
    <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">E<sub>1</sub></span></span> <span class="inlinecode">++</span> <span class="inlinecode"><span class="id" title="var">E<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span>. 
<div class="paragraph"> </div>

 Before we start, we describe the tactic <span class="inlinecode"><span class="id" title="var">case_var</span></span>, which
    helps with the case_analyses on variable equalities,
    and we prove an auxiliary lemma that describes the
    result of a lookup on a context from which a binding
    has been removed. It is defined in file <span class="inlinecode"><span class="id" title="var">LibSepVar.v</span></span> as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Tactic</span> <span class="id" title="keyword">Notation</span> "case_var" :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">repeat</span> <span class="id" title="tactic">rewrite</span> <span class="id" title="var">var_eq_spec</span> <span class="id" title="keyword">in</span> *; <span class="id" title="tactic">repeat</span> <span class="id" title="var">case_if</span>.
</span>    The tactic <span class="inlinecode"><span class="id" title="var">case_var</span>*</span> is a shorthand for <span class="inlinecode"><span class="id" title="var">case_var</span></span>
    followed with automation (essentially, <span class="inlinecode"><span class="id" title="tactic">eauto</span></span>).

<div class="paragraph"> </div>

 On key auxiliary lemma relates <span class="inlinecode"><span class="id" title="tactic">subst</span></span> and <span class="inlinecode"><span class="id" title="var">isubst</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.subst_eq_isubst_one" class="idref" href="#IsubstProp.subst_eq_isubst_one"><span class="id" title="lemma">subst_eq_isubst_one</span></a> : <span class="id" title="keyword">∀</span> <a id="x:327" class="idref" href="#x:327"><span class="id" title="binder">x</span></a> <a id="v:328" class="idref" href="#v:328"><span class="id" title="binder">v</span></a> <a id="t:329" class="idref" href="#t:329"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:327"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v:328"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#t:329"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:327"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:328"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t:329"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">case_var</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>. <span class="id" title="var">case_var</span>*. { <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#IsubstProp.isubst_nil"><span class="id" title="lemma">isubst_nil</span></a>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>. <span class="id" title="var">case_var</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">case_var</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">try</span> <span class="id" title="var">case_var</span>;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.isubst_nil"><span class="id" title="lemma">isubst_nil</span></a>; <span class="id" title="tactic">auto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. <span class="id" title="var">case_var</span>*. { <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#IsubstProp.isubst_nil"><span class="id" title="lemma">isubst_nil</span></a>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
A lemma about the lookup in a removal. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.lookup_rem" class="idref" href="#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a> : <span class="id" title="keyword">∀</span> <a id="x:330" class="idref" href="#x:330"><span class="id" title="binder">x</span></a> <a id="y:331" class="idref" href="#y:331"><span class="id" title="binder">y</span></a> <a id="E:332" class="idref" href="#E:332"><span class="id" title="binder">E</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:330"><span class="id" title="variable">x</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#y:331"><span class="id" title="variable">y</span></a> <a class="idref" href="WPgen.html#E:332"><span class="id" title="variable">E</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <span class="id" title="keyword">if</span> <a class="idref" href="LibSepVar.html#var_eq"><span class="id" title="definition">var_eq</span></a> <a class="idref" href="WPgen.html#x:330"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#y:331"><span class="id" title="variable">y</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> <span class="id" title="keyword">else</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:330"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E:332"><span class="id" title="variable">E</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">E</span> <span class="id" title="keyword">as</span> [|(<span class="id" title="var">z</span>,<span class="id" title="var">v</span>) <span class="id" title="var">E'</span>].<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">simpl</span>. <span class="id" title="var">case_var</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">simpl</span>. <span class="id" title="var">case_var</span>*; <span class="id" title="tactic">simpl</span>; <span class="id" title="var">case_var</span>*. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
A lemma about the removal over an append. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.rem_app" class="idref" href="#IsubstProp.rem_app"><span class="id" title="lemma">rem_app</span></a> : <span class="id" title="keyword">∀</span> <a id="x:333" class="idref" href="#x:333"><span class="id" title="binder">x</span></a> <a id="E<sub>1</sub>:334" class="idref" href="#E<sub>1</sub>:334"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:335" class="idref" href="#E<sub>2</sub>:335"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:333"><span class="id" title="variable">x</span></a> (<a class="idref" href="WPgen.html#E<sub>1</sub>:334"><span class="id" title="variable">E<sub>1</sub></span></a> <span class="id" title="notation">++</span> <a class="idref" href="WPgen.html#E<sub>2</sub>:335"><span class="id" title="variable">E<sub>2</sub></span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:333"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:334"><span class="id" title="variable">E<sub>1</sub></span></a> <span class="id" title="notation">++</span> <a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:333"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:335"><span class="id" title="variable">E<sub>2</sub></span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">E<sub>1</sub></span> <span class="id" title="keyword">as</span> [|(<span class="id" title="var">y</span>,<span class="id" title="var">w</span>) <span class="id" title="var">E<sub>1</sub>'</span>]; <span class="id" title="var">rew_list</span>; <span class="id" title="tactic">simpl</span>. { <span class="id" title="tactic">auto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">case_var</span>*. { <span class="id" title="var">rew_list</span>. <span class="id" title="var">fequals</span>. } }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The definition of equivalent contexts. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="IsubstProp.ctx_equiv" class="idref" href="#IsubstProp.ctx_equiv"><span class="id" title="definition">ctx_equiv</span></a> <a id="E<sub>1</sub>:336" class="idref" href="#E<sub>1</sub>:336"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:337" class="idref" href="#E<sub>2</sub>:337"><span class="id" title="binder">E<sub>2</sub></span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <a id="x:338" class="idref" href="#x:338"><span class="id" title="binder">x</span></a>, <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:338"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:336"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:338"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:337"><span class="id" title="variable">E<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
The fact that removal preserves equivalence. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.ctx_equiv_rem" class="idref" href="#IsubstProp.ctx_equiv_rem"><span class="id" title="lemma">ctx_equiv_rem</span></a> : <span class="id" title="keyword">∀</span> <a id="x:339" class="idref" href="#x:339"><span class="id" title="binder">x</span></a> <a id="E<sub>1</sub>:340" class="idref" href="#E<sub>1</sub>:340"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:341" class="idref" href="#E<sub>2</sub>:341"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#IsubstProp.ctx_equiv"><span class="id" title="definition">ctx_equiv</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:340"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:341"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#IsubstProp.ctx_equiv"><span class="id" title="definition">ctx_equiv</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:339"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:340"><span class="id" title="variable">E<sub>1</sub></span></a>) (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:339"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:341"><span class="id" title="variable">E<sub>2</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#IsubstProp.ctx_equiv"><span class="id" title="definition">ctx_equiv</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">do</span> 2 <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a>. <span class="id" title="var">case_var</span>*.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The fact that substitution for equivalent contexts
    yields equal results. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.isubst_ctx_equiv" class="idref" href="#IsubstProp.isubst_ctx_equiv"><span class="id" title="lemma">isubst_ctx_equiv</span></a> : <span class="id" title="keyword">∀</span> <a id="t:342" class="idref" href="#t:342"><span class="id" title="binder">t</span></a> <a id="E<sub>1</sub>:343" class="idref" href="#E<sub>1</sub>:343"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:344" class="idref" href="#E<sub>2</sub>:344"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#IsubstProp.ctx_equiv"><span class="id" title="definition">ctx_equiv</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:343"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:344"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:343"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t:342"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:344"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="WPgen.html#t:342"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">hint</span> <a class="idref" href="WPgen.html#IsubstProp.ctx_equiv_rem"><span class="id" title="lemma">ctx_equiv_rem</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">t</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="var">introv</span> <span class="id" title="var">EQ</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="var">fequals</span>*.<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">rewrite</span> <span class="id" title="var">EQ</span>. <span class="id" title="tactic">auto</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The definition of disjoint contexts. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="IsubstProp.ctx_disjoint" class="idref" href="#IsubstProp.ctx_disjoint"><span class="id" title="definition">ctx_disjoint</span></a> <a id="E<sub>1</sub>:345" class="idref" href="#E<sub>1</sub>:345"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:346" class="idref" href="#E<sub>2</sub>:346"><span class="id" title="binder">E<sub>2</sub></span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <a id="x:347" class="idref" href="#x:347"><span class="id" title="binder">x</span></a> <a id="v<sub>1</sub>:348" class="idref" href="#v<sub>1</sub>:348"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:349" class="idref" href="#v<sub>2</sub>:349"><span class="id" title="binder">v<sub>2</sub></span></a>, <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:347"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:345"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:348"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:347"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:346"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:349"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a>.<br/>
</div>

<div class="doc">
Removal preserves disjointness. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.ctx_disjoint_rem" class="idref" href="#IsubstProp.ctx_disjoint_rem"><span class="id" title="lemma">ctx_disjoint_rem</span></a> : <span class="id" title="keyword">∀</span> <a id="x:350" class="idref" href="#x:350"><span class="id" title="binder">x</span></a> <a id="E<sub>1</sub>:351" class="idref" href="#E<sub>1</sub>:351"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:352" class="idref" href="#E<sub>2</sub>:352"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#IsubstProp.ctx_disjoint"><span class="id" title="definition">ctx_disjoint</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:351"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:352"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#IsubstProp.ctx_disjoint"><span class="id" title="definition">ctx_disjoint</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:350"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:351"><span class="id" title="variable">E<sub>1</sub></span></a>) (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:350"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:352"><span class="id" title="variable">E<sub>2</sub></span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">D</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">K<sub>1</sub></span> <span class="id" title="var">K<sub>2</sub></span>. <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a> <span class="id" title="keyword">in</span> *.<br/>
&nbsp;&nbsp;<span class="id" title="var">case_var</span>. <span class="id" title="var">applys</span>* <span class="id" title="var">D</span> <span class="id" title="var">K<sub>1</sub></span> <span class="id" title="var">K<sub>2</sub></span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Lookup in the concatenation of two disjoint contexts 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.lookup_app" class="idref" href="#IsubstProp.lookup_app"><span class="id" title="lemma">lookup_app</span></a> : <span class="id" title="keyword">∀</span> <a id="x:353" class="idref" href="#x:353"><span class="id" title="binder">x</span></a> <a id="E<sub>1</sub>:354" class="idref" href="#E<sub>1</sub>:354"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:355" class="idref" href="#E<sub>2</sub>:355"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:353"><span class="id" title="variable">x</span></a> (<a class="idref" href="WPgen.html#E<sub>1</sub>:354"><span class="id" title="variable">E<sub>1</sub></span></a> <span class="id" title="notation">++</span> <a class="idref" href="WPgen.html#E<sub>2</sub>:355"><span class="id" title="variable">E<sub>2</sub></span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:353"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:354"><span class="id" title="variable">E<sub>1</sub></span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:353"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:355"><span class="id" title="variable">E<sub>2</sub></span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">E<sub>1</sub></span> <span class="id" title="keyword">as</span> [|(<span class="id" title="var">y</span>,<span class="id" title="var">w</span>) <span class="id" title="var">E<sub>1</sub>'</span>]; <span class="id" title="var">rew_list</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">auto</span>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">case_var</span>*. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The key induction shows that <span class="inlinecode"><span class="id" title="var">isubst</span></span> distributes over
    context concatenation. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.isubst_app" class="idref" href="#IsubstProp.isubst_app"><span class="id" title="lemma">isubst_app</span></a> : <span class="id" title="keyword">∀</span> <a id="t:356" class="idref" href="#t:356"><span class="id" title="binder">t</span></a> <a id="E<sub>1</sub>:357" class="idref" href="#E<sub>1</sub>:357"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:358" class="idref" href="#E<sub>2</sub>:358"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#E<sub>1</sub>:357"><span class="id" title="variable">E<sub>1</sub></span></a> <span class="id" title="notation">++</span> <a class="idref" href="WPgen.html#E<sub>2</sub>:358"><span class="id" title="variable">E<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#t:356"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:358"><span class="id" title="variable">E<sub>2</sub></span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:357"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t:356"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">hint</span> <a class="idref" href="WPgen.html#IsubstProp.ctx_disjoint_rem"><span class="id" title="lemma">ctx_disjoint_rem</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">t</span>. <span class="id" title="tactic">induction</span> <span class="id" title="var">t</span>; <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">rename</span> <span class="id" title="var">v</span> <span class="id" title="var">into</span> <span class="id" title="var">x</span>. <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#IsubstProp.lookup_app"><span class="id" title="lemma">lookup_app</span></a>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">case_eq</span> (<a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <span class="id" title="var">E<sub>1</sub></span>); <span class="id" title="var">introv</span> <span class="id" title="var">K<sub>1</sub></span>; <span class="id" title="var">case_eq</span> (<a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <span class="id" title="var">E<sub>2</sub></span>); <span class="id" title="var">introv</span> <span class="id" title="var">K<sub>2</sub></span>; <span class="id" title="tactic">auto</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">rewrite</span>* <span class="id" title="var">K<sub>2</sub></span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">rewrite</span>* <span class="id" title="var">K<sub>2</sub></span>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>. <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#IsubstProp.rem_app"><span class="id" title="lemma">rem_app</span></a>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>. <span class="id" title="tactic">do</span> 2 <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#IsubstProp.rem_app"><span class="id" title="lemma">rem_app</span></a>. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. { <span class="id" title="tactic">rewrite</span>* <a class="idref" href="WPgen.html#IsubstProp.rem_app"><span class="id" title="lemma">rem_app</span></a>. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="var">fequals</span>*. }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The next lemma asserts that the concatenation order is irrelevant
    in a substitution if the contexts have disjoint domains. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.isubst_app_swap" class="idref" href="#IsubstProp.isubst_app_swap"><span class="id" title="lemma">isubst_app_swap</span></a> : <span class="id" title="keyword">∀</span> <a id="t:359" class="idref" href="#t:359"><span class="id" title="binder">t</span></a> <a id="E<sub>1</sub>:360" class="idref" href="#E<sub>1</sub>:360"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:361" class="idref" href="#E<sub>2</sub>:361"><span class="id" title="binder">E<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#IsubstProp.ctx_disjoint"><span class="id" title="definition">ctx_disjoint</span></a> <a class="idref" href="WPgen.html#E<sub>1</sub>:360"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="WPgen.html#E<sub>2</sub>:361"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#E<sub>1</sub>:360"><span class="id" title="variable">E<sub>1</sub></span></a> <span class="id" title="notation">++</span> <a class="idref" href="WPgen.html#E<sub>2</sub>:361"><span class="id" title="variable">E<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#t:359"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#E<sub>2</sub>:361"><span class="id" title="variable">E<sub>2</sub></span></a> <span class="id" title="notation">++</span> <a class="idref" href="WPgen.html#E<sub>1</sub>:360"><span class="id" title="variable">E<sub>1</sub></span></a>) <a class="idref" href="WPgen.html#t:359"><span class="id" title="variable">t</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">D</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#IsubstProp.isubst_ctx_equiv"><span class="id" title="lemma">isubst_ctx_equiv</span></a>. <span class="id" title="var">applys</span>* <a class="idref" href="LibSepReference.html#ctx_disjoint_equiv_app"><span class="id" title="lemma">ctx_disjoint_equiv_app</span></a>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
We are ready to derive the desired property of <span class="inlinecode"><span class="id" title="var">isubst</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.isubst_rem" class="idref" href="#IsubstProp.isubst_rem"><span class="id" title="lemma">isubst_rem</span></a> : <span class="id" title="keyword">∀</span> <a id="x:362" class="idref" href="#x:362"><span class="id" title="binder">x</span></a> <a id="v:363" class="idref" href="#v:363"><span class="id" title="binder">v</span></a> <a id="E:364" class="idref" href="#E:364"><span class="id" title="binder">E</span></a> <a id="t:365" class="idref" href="#t:365"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:362"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a> <a class="idref" href="WPgen.html#v:363"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:364"><span class="id" title="variable">E</span></a>) <a class="idref" href="WPgen.html#t:365"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:362"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v:363"><span class="id" title="variable">v</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:362"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E:364"><span class="id" title="variable">E</span></a>) <a class="idref" href="WPgen.html#t:365"><span class="id" title="variable">t</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.subst_eq_isubst_one"><span class="id" title="lemma">subst_eq_isubst_one</span></a>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPgen.html#IsubstProp.isubst_app"><span class="id" title="lemma">isubst_app</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.isubst_app_swap"><span class="id" title="lemma">isubst_app_swap</span></a>.<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#IsubstProp.isubst_ctx_equiv"><span class="id" title="lemma">isubst_ctx_equiv</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span>. <span class="id" title="var">rew_list</span>. <span class="id" title="tactic">simpl</span>. <span class="id" title="var">case_var</span>*.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a>. <span class="id" title="var">case_var</span>*. } }<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">K<sub>1</sub></span> <span class="id" title="var">K<sub>2</sub></span>. <span class="id" title="var">simpls</span>. <span class="id" title="var">case_var</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="tactic">subst</span>. <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a> <span class="id" title="keyword">in</span> <span class="id" title="var">K<sub>1</sub></span>. <span class="id" title="var">case_var</span>*. } }<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
We also prove the variant lemma which is useful for handling recursive
    functions. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="IsubstProp.isubst_rem_2" class="idref" href="#IsubstProp.isubst_rem_2"><span class="id" title="lemma">isubst_rem_2</span></a> : <span class="id" title="keyword">∀</span> <a id="f:366" class="idref" href="#f:366"><span class="id" title="binder">f</span></a> <a id="x:367" class="idref" href="#x:367"><span class="id" title="binder">x</span></a> <a id="vf:368" class="idref" href="#vf:368"><span class="id" title="binder">vf</span></a> <a id="vx:369" class="idref" href="#vx:369"><span class="id" title="binder">vx</span></a> <a id="E:370" class="idref" href="#E:370"><span class="id" title="binder">E</span></a> <a id="t:371" class="idref" href="#t:371"><span class="id" title="binder">t</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#f:366"><span class="id" title="variable">f</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#vf:368"><span class="id" title="variable">vf</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:367"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#vx:369"><span class="id" title="variable">vx</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:370"><span class="id" title="variable">E</span></a>) <a class="idref" href="WPgen.html#t:371"><span class="id" title="variable">t</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:367"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#vx:369"><span class="id" title="variable">vx</span></a> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#f:366"><span class="id" title="variable">f</span></a> <a class="idref" href="WPgen.html#vf:368"><span class="id" title="variable">vf</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:367"><span class="id" title="variable">x</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#f:366"><span class="id" title="variable">f</span></a> <a class="idref" href="WPgen.html#E:370"><span class="id" title="variable">E</span></a>)) <a class="idref" href="WPgen.html#t:371"><span class="id" title="variable">t</span></a>)).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">do</span> 2 <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.subst_eq_isubst_one"><span class="id" title="lemma">subst_eq_isubst_one</span></a>. <span class="id" title="tactic">do</span> 2 <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPgen.html#IsubstProp.isubst_app"><span class="id" title="lemma">isubst_app</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.isubst_app_swap"><span class="id" title="lemma">isubst_app_swap</span></a>.<br/>
&nbsp;&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#IsubstProp.isubst_ctx_equiv"><span class="id" title="lemma">isubst_ctx_equiv</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span>. <span class="id" title="var">rew_list</span>. <span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> 2 <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a>. <span class="id" title="var">case_var</span>*. }<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="var">K<sub>1</sub></span> <span class="id" title="var">K<sub>2</sub></span>. <span class="id" title="var">rew_listx</span> <span class="id" title="keyword">in</span> *. <span class="id" title="var">simpls</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">do</span> 2 <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPgen.html#IsubstProp.lookup_rem"><span class="id" title="lemma">lookup_rem</span></a> <span class="id" title="keyword">in</span> <span class="id" title="var">K<sub>1</sub></span>. <span class="id" title="var">case_var</span>. }<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#IsubstProp"><span class="id" title="module">IsubstProp</span></a>.<br/>
</div>

<div class="doc">
<a id="lab305"></a><h2 class="section">Historical Notes</h2>

<div class="paragraph"> </div>

 Many verification tools based on Hoare Logic are based on a weakest-
    precondition generator. Typically, a tool takes as input a source code
    annotated with specifications and invariants, and produces a logical
    formula that entails the correctness of the program. This logical formula
    is typically expressed in first-order logic, and is discharged using
    automated tools such as SMT solvers.

<div class="paragraph"> </div>

    In contrast, the weakest-precondition generator presented in this chapter
    applies to un-annotated code. It thus produces a logical formula that does
    not depend at all on the specifications and invariants. Such formula,
    which can be constructed in a systematic manner, is called a "characteristic
    formula" in the literature. In general, a characteristic formula provides
    not just a sound but also a complete description of the semantics of a
    program. Discussion of completeness is beyond the scope of this course.

<div class="paragraph"> </div>

    The notion of characteristic formula was introduced work by
    <a href="Bib.html#Hennessy-and Milner 1985"><span class="inlineref">[Hennessy and Milner 1985]</span></a> on process calculi. It was first applied to
    program logic by <a href="Bib.html#Honda,-Berger, and Yoshida 2006"><span class="inlineref">[Honda, Berger, and Yoshida 2006]</span></a>. It was then applied
    to Separation Logic in the PhD work of <a href="Bib.html#Charguéraud-2010"><span class="inlineref">[Charguéraud 2010]</span></a>, which
    resulted in the CFML tool. CFML 1.0 used an external tool that produced
    characteristic formulae in the form of Coq axioms. Later work by
    <a href="Bib.html#Guéneau,-Myreen, Kumar and Norrish 2017"><span class="inlineref">[Guéneau, Myreen, Kumar and Norrish 2017]</span></a> showed how the
    characteristic formulae could be produced together with proofs justifying
    their correctness.

<div class="paragraph"> </div>

    In Charguéraud's PhD and in Guéneau et al.'s work, characteristic formulae
    were slightly more complicated than those presented here, because they did
    not leverage the weakest-precondition approach, which streamlines the
    presentation.

<div class="paragraph"> </div>

    Compared with Hoare Logic, one key aspect of characteristic formulae for
    Separation Logic is the need to support the frame rule. In this chapter,
    the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> introduced at every node of the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    serves that purpose. The definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> as stated in this chapter
    will probably be the matter of a publication in 2021. 
</div>
<div class="code">

<span class="comment">(*&nbsp;2022-02-08&nbsp;19:48&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>