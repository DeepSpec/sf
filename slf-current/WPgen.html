<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>WPgen: Weakest Precondition Generator</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/slf.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 6: Separation Logic Foundations</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
   <li class='section_name'><a href='deps.html'>Roadmap</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">WPgen<span class="subtitle">Weakest Precondition Generator</span></h1>


<div class="code">

<span class="id" title="keyword">Set Implicit Arguments</span>.<br/>
<span class="id" title="keyword">From</span> <span class="id" title="var">SLF</span> <span class="id" title="keyword">Require</span> <span class="id" title="keyword">Import</span> <a class="idref" href="WPsem.html#"><span class="id" title="library">WPsem</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">f</span> : <a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">b</span> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">v</span> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">h</span> : <a class="idref" href="LibSepReference.html#heap"><span class="id" title="definition">heap</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">P</span> : <span class="id" title="keyword">Prop</span>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">H</span> : <a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">Q</span> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>.<br/>
</div>

<div class="doc">
<a id="lab305"></a><h1 class="section">First Pass</h1>

<div class="paragraph"> </div>

 The previous chapter introduced a predicate called <span class="inlinecode"><span class="id" title="var">wp</span></span> to describe the
    weakest precondition of a term <span class="inlinecode"><span class="id" title="var">t</span></span> with respect to a given postcondition
    <span class="inlinecode"><span class="id" title="var">Q</span></span>. 
<div class="paragraph"> </div>

 The weakest precondition <span class="inlinecode"><span class="id" title="var">wp</span></span> was characterized by the equivalence
    <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> iff <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. We proved "wp-style" reasoning rules,
    such as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wp</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">r</span> ⇒ <span class="id" title="var">wp</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>) ==&gt; <span class="id" title="var">wp</span> (<span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>
</span>
<div class="paragraph"> </div>

    In this chapter, we introduce a function, called <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, to <i>compute</i> the
    weakest precondition of a term. 
<div class="paragraph"> </div>

 The value of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is defined recursively over the structure of the
    term <span class="inlinecode"><span class="id" title="var">t</span></span>, and it computes a formula that is logically equivalent to
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. The fundamental difference between <span class="inlinecode"><span class="id" title="var">wp</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is that,
    whereas <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is a predicate that we can reason about by applying
    reasoning rules, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is a predicate that we can reason about simply
    by <i>unfolding</i> its definition. (This sentence will probably make more sense
    to the reader later on in the chapter.)

<div class="paragraph"> </div>

    Another key difference between <span class="inlinecode"><span class="id" title="var">wp</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is that the formulae
    produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> no longer refer to program syntax. In particular, all
    program variables involved in a term <span class="inlinecode"><span class="id" title="var">t</span></span> in a statement of the form <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>
    are replaced with Coq variables when computing <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. The benefit of
    eliminating program variables is that formulae produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> can be
    manipulated without the need to simplify substitutions of the form
    <span class="inlinecode"><span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. Instead, the beta reduction mechanism of Coq will
    automatically perform substitutions for Coq variables.

<div class="paragraph"> </div>

    The reader might have encountered the term "weakest precondition generator"
    in the past. Such generators take as input a program annotated with all
    function specifications and loop invariants and produce a set of proof
    obligations that need to be checked in order to conclude that the code
    indeed satisfies its logical annotations. In contrast, the weakest
    preconditions computed by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> apply to a piece of code independent of
    any specification or invariant. More precisely, the computation of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> treats the postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span> as an abstract variable.

<div class="paragraph"> </div>

    At a high level, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is a key ingredient for smoothing the user
    experience of conducting interactive proofs in Separation Logic. The
    x-tactics presented in the first two chapters of the course were built on
    top of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. The matter of the present chapter is to show:

<div class="paragraph"> </div>

<ul class="doclist">
<li> how to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as a recursive function in Coq,

</li>
<li> how to integrate support for the frame rule in this definition,

</li>
<li> how to carry out practical proofs using <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.

</li>
</ul>

<div class="paragraph"> </div>

  The rest of the "first pass" section gives a high-level tour of the steps of
  the construction of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. The formal definitions and the set up of
  x-tactics follow in the "more details" section. The treatment of local
  functions is presented in the "optional material" section.

<div class="paragraph"> </div>

  This chapter is probably the most technical of the course. The reader who
  finds it hard to follow the entire chapter may safely jump to the next chapter
  at any point after the "first pass" section. 
</div>

<div class="doc">
<a id="lab306"></a><h2 class="section">The Basic Structure of <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h2>

<div class="paragraph"> </div>

 As first approximation, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is defined as a recursive function that
    pattern matches on its argument <span class="inlinecode"><span class="id" title="var">t</span></span>, and produces an appropriate heap
    predicate in each case. The definitions somewhat mimic the reasoning rules
    of <span class="inlinecode"><span class="id" title="var">wp</span></span>. Let us show the pattern of the definition and comment it
    afterwards.  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class='gray-font'>\</span><span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> (<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span> Recall from the previous chapter that the rule <span class="inlinecode"><span class="id" title="var">wp_val</span></span> asserts that <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>
    entails <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. Well, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is defined as <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>.

<div class="paragraph"> </div>

    Likewise, recall that the rule <span class="inlinecode"><span class="id" title="var">wp_let</span></span> asserts that
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span> entails <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.
    Well, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is such that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is
    defined to be <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>, that is, the
    same expression as in <span class="inlinecode"><span class="id" title="var">wp_let</span></span> only with <span class="inlinecode"><span class="id" title="var">wp</span></span> replaced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>.

<div class="paragraph"> </div>

    An interesting case is <span class="inlinecode"><span class="id" title="var">wgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. There are no rules on <span class="inlinecode"><span class="id" title="var">wp</span></span> to
    reason about variables, because they correspond to stuck terms. To reflect
    the fact that <span class="inlinecode"><span class="id" title="var">wgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> cannot be derived, we define it as
    <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>.

<div class="paragraph"> </div>

    The last key case is that of function calls. Consider a term <span class="inlinecode"><span class="id" title="var">t</span></span> that
    consists of a function application <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span>. How should we define
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>? We need to define it to be a heap predicate, call
    it <span class="inlinecode"><span class="id" title="var">H</span></span>, such that the function call <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> admits <span class="inlinecode"><span class="id" title="var">H</span></span> as
    precondition and <span class="inlinecode"><span class="id" title="var">Q</span></span> as postcondition. In other words, the definition of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> should consist of a heap predicate <span class="inlinecode"><span class="id" title="var">H</span></span> such that
    <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> holds. We do not know what this <span class="inlinecode"><span class="id" title="var">H</span></span> should be, so we simply
    quantify it existentially. This suggests why the definition of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> should be <span class="inlinecode"><span class='gray-font'>\</span><span class="id" title="tactic">∃</span></span> <span class="inlinecode"><span class="id" title="var">H</span>,</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span>]</span>. 
<div class="paragraph"> </div>

 To obtain the actual definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we need to refine the above
    definition in four steps. 
</div>

<div class="doc">
<a id="lab307"></a><h2 class="section">Step 1: <span class="inlinecode"><span class="id" title="var">wpgen</span></span> as a Recursive Function over Terms</h2>

<div class="paragraph"> </div>

 In a first step, we modify the definition in order to make it structurally
    recursive. Indeed, in the above the recursive call <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> is
    not made on a strict subterm of <span class="inlinecode"><span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, so Coq will reject this
    definition as it stands.

<div class="paragraph"> </div>

    To fix the issue, we change the definition to the form <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, where
    <span class="inlinecode"><span class="id" title="var">E</span></span> denotes an association list bindings values to variables. The intention
    is that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> computes the weakest precondition for the term
    obtained by substituting all the bindings from <span class="inlinecode"><span class="id" title="var">E</span></span> in <span class="inlinecode"><span class="id" title="var">t</span></span>. This term is
    described by the operation <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, which is formally defined later in
    the chapter.

<div class="paragraph"> </div>

    The updated definition looks as follows. Observe how, when traversing
    <span class="inlinecode"><span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, the context <span class="inlinecode"><span class="id" title="var">E</span></span> gets extended as <span class="inlinecode">(<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span></span>. Observe also
    how, when reaching a variable <span class="inlinecode"><span class="id" title="var">x</span></span>, a lookup for <span class="inlinecode"><span class="id" title="var">x</span></span> into the context <span class="inlinecode"><span class="id" title="var">E</span></span> is
    performed for recovering the value bound to <span class="inlinecode"><span class="id" title="var">x</span></span>.  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lookup</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class='gray-font'>\</span><span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab308"></a><h2 class="section">Step 2: <span class="inlinecode"><span class="id" title="var">wpgen</span></span> Reformulated to Eagerly Match on the Term</h2>

<div class="paragraph"> </div>

 In a second step, we slightly tweak the definition in order to move the
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span>, by which the postcondition is taken as argument, to
    place it inside every case of the pattern matching. The idea is to make it
    explicit that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> can be computed without any knowledge of <span class="inlinecode"><span class="id" title="var">Q</span></span>. In
    the definition shown below, <span class="inlinecode"><span class="id" title="var">formula</span></span> is a shorthand for the type
    <span class="inlinecode">(<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span></span>, which is the type of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lookup</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span><span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab309"></a><h2 class="section">Step 3: <span class="inlinecode"><span class="id" title="var">wpgen</span></span> Reformulated with Auxiliary Definitions</h2>

<div class="paragraph"> </div>

 In a third step, we introduce auxiliary definitions to improve the
    readability of the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For example, we let <span class="inlinecode"><span class="id" title="var">wpgen_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> be a
    shorthand for <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>. Likewise, we let
    <span class="inlinecode"><span class="id" title="var">wpgen_let</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> be a shorthand for
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>, where <span class="inlinecode"><span class="id" title="var">v</span></span> can appear in <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>.
    Using these auxiliary definitions, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> can be
    reformulated as follows.  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen_val</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">wpgen_var</span> <span class="id" title="var">E</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen_app</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen_let</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span> Each of the auxiliary definitions introduced for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> comes with a custom
    notation that enables a nice display of the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For example,
    the notation <span class="inlinecode"><span class="id" title="var">Let'</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> stands for <span class="inlinecode"><span class="id" title="var">wpgen_let</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span>)</span>.
    Thanks to this notation, the result of computing <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a source term
    <span class="inlinecode"><span class="id" title="keyword">Let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, which is an Coq expression of type <span class="inlinecode"><span class="id" title="var">trm</span></span>, is a Coq
    expression of type <span class="inlinecode"><span class="id" title="var">formula</span></span> displayed as <span class="inlinecode"><span class="id" title="var">Let'</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>.

<div class="paragraph"> </div>

    Thanks to these auxiliary definitions and pieces of notation, the formula
    that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> produces as output reads pretty much like the source term
    provided as input. The benefits, illustrated in the first two chapters
    (<a href="Basic.html"><span class="inlineref">Basic</span></a> and <a href="Repr.html"><span class="inlineref">Repr</span></a>), is that the proof obligations can be easily
    related to the source code that they arise from. 
</div>

<div class="doc">
<a id="lab310"></a><h2 class="section">Step 4: <span class="inlinecode"><span class="id" title="var">wpgen</span></span> Augmented with Support for Structural Rules</h2>

<div class="paragraph"> </div>

 In a fourth step, we refine the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> in order to equip it
    with inherent support for applications of the structural rules of the logic,
    namely the frame rule and the rule of consequence. To achieve this, we
    carefully craft a predicate called <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> and insert it at the head of
    the output of every call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, including all its recursive calls. In
    other words, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> hereafter has the following
    structure.  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ ...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| ...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).
</span> Without going into the details at this stage, the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> is a
    function of type <span class="inlinecode"><span class="id" title="var">formula</span>→<span class="id" title="var">formula</span></span> that captures the essence of the
    wp-style consequence-frame rule <span class="inlinecode"><span class="id" title="var">wp_conseq_frame</span></span>, presented the previous
    chapter. This rule asserts that <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span></span> <span class="inlinecode"><span class='gray-font'>\</span>*+</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">===&gt;</span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span></span> implies
    <span class="inlinecode">(<span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span>)</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode">(<span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q<sub>2</sub></span>)</span>. 
<div class="paragraph"> </div>

 This concludes our little journey towards the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For
    conducting proofs in practice, it remains to state lemmas and define
    "x-tactics" to assist the user in the manipulation of the formulae produced
    by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. Ultimately, the end-user only manipulates "x-tactics" as in the
    first two chapters, without ever being required to understand how <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is
    defined.

<div class="paragraph"> </div>

    The "more details" section recapitulates each of the four steps presented in
    the above summary, but explaining in detail all the Coq definitions
    involved. 
</div>

<div class="doc">
<a id="lab311"></a><h1 class="section">More Details</h1>

</div>

<div class="doc">
<a id="lab312"></a><h2 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Each Term Construct</h2>

<div class="paragraph"> </div>

 The function <span class="inlinecode"><span class="id" title="var">wpgen</span></span> computes a heap predicate that has the same meaning as
    <span class="inlinecode"><span class="id" title="var">wp</span></span>. In essence, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> takes the form of a recursive function that, like
    <span class="inlinecode"><span class="id" title="var">wp</span></span>, expects a term <span class="inlinecode"><span class="id" title="var">t</span></span> and a postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span> and produces a heap
    predicate. The function is recursively defined, and its result is guided by
    the structure of the term <span class="inlinecode"><span class="id" title="var">t</span></span>. In essence, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> has the
    following shape:  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_if</span> <span class="id" title="var">v<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    Our first goal is to figure out how to fill in the dots for each of the term
    constructors. The intention that guides us is the soundness theorem for
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, which has the following form:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">wpgen</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span> ==&gt; <span class="id" title="var">wp</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span>
</span> This entailment asserts in particular that, if we are able to establish a
    statement of the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, then we can derive <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>
    from it. The latter is also equivalent to <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. Thus, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> can
    be viewed as a practical tool for establishing triples.

<div class="paragraph"> </div>

    The reciprocal implication, namely <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, would correspond
    to a completeness theorem. Completeness is beyond the scope of this course.
    The historical notes section, located at the end of the chapter, contains a
    few comments on this question. 
</div>

<div class="doc">
<a id="lab313"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Values</h3>

<div class="paragraph"> </div>

 Consider first the case of a value <span class="inlinecode"><span class="id" title="var">v</span></span>. Recall the reasoning rule for values
    in weakest-precondition style. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_val" class="idref" href="#wp_val"><span class="id" title="axiom">wp_val</span></a> : <span class="id" title="keyword">∀</span> <a id="v:1" class="idref" href="#v:1"><span class="id" title="binder">v</span></a> <a id="Q:2" class="idref" href="#Q:2"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q:2"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#v:1"><span class="id" title="variable">v</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <a class="idref" href="WPgen.html#v:1"><span class="id" title="variable">v</span></a>) <a class="idref" href="WPgen.html#Q:2"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
The soundness theorem for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> requires the entailment
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> to hold.

<div class="paragraph"> </div>

    To satisfy this entailment, according to the rule <span class="inlinecode"><span class="id" title="var">wp_val</span></span>, it suffices to
    define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>.

<div class="paragraph"> </div>

    Concretely, we fill in the first dots as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab314"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Functions</h3>

<div class="paragraph"> </div>

 Consider the case of a function definition <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. Recall that the
    <span class="inlinecode"><span class="id" title="var">wp</span></span> reasoning rule for functions is very similar to the one for values. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_fun" class="idref" href="#wp_fun"><span class="id" title="axiom">wp_fun</span></a> : <span class="id" title="keyword">∀</span> <a id="x:4" class="idref" href="#x:4"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:5" class="idref" href="#t<sub>1</sub>:5"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="Q:6" class="idref" href="#Q:6"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q:6"><span class="id" title="variable">Q</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:4"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:5"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <a class="idref" href="WPgen.html#x:4"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:5"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="WPgen.html#Q:6"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Following this rule, we define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as
    <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">(<span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>. Likewise for recursive functions, we define
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fix</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">(<span class="id" title="var">val_fix</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>.

<div class="paragraph"> </div>

<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>   ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
<div class="paragraph"> </div>

 An interesting question that arises here is: why does
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> not trigger a recursive call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>?
    The long answer is detailed in the last section of this chapter (module
    <span class="inlinecode"><span class="id" title="var">WPgenRec</span></span>). The short answer is:

<div class="paragraph"> </div>

<ul class="doclist">
<li> it is not technically needed to recurse in the body of local functions, in
      the sense that the user does not loose any ability to reason about local
      functions;

</li>
<li> it may be interesting to recurse the body of local functions because it
      may save the need for the user to manually invoke the tactic <span class="inlinecode"><span class="id" title="var">xwp</span></span> for
      each local function.

</li>
</ul>

</div>

<div class="doc">
<a id="lab315"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Sequences</h3>

<div class="paragraph"> </div>

 Recall the <span class="inlinecode"><span class="id" title="var">wp</span></span> reasoning rule for a sequence <span class="inlinecode"><span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_seq" class="idref" href="#wp_seq"><span class="id" title="axiom">wp_seq</span></a> : <span class="id" title="keyword">∀</span> <a id="t<sub>1</sub>:8" class="idref" href="#t<sub>1</sub>:8"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:9" class="idref" href="#t<sub>2</sub>:9"><span class="id" title="binder">t<sub>2</sub></span></a> <a id="Q:10" class="idref" href="#Q:10"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:8"><span class="id" title="variable">t<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:11" class="idref" href="#v:11"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:9"><span class="id" title="variable">t<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:10"><span class="id" title="variable">Q</span></a>) <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:8"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:9"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:10"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
The intention is for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to admit the same semantics as <span class="inlinecode"><span class="id" title="var">wp</span></span>. We thus
    expect the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> to have a similar shape
    to <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>.

<div class="paragraph"> </div>

    We therefore define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span>)</span>. The definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is extended as
    follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab316"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Let-Bindings</h3>

<div class="paragraph"> </div>

 The case of let bindings is similar to that of sequences, except that it
    involves a substitution. Recall the <span class="inlinecode"><span class="id" title="var">wp</span></span> rule: 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_let" class="idref" href="#wp_let"><span class="id" title="axiom">wp_let</span></a> : <span class="id" title="keyword">∀</span> <a id="x:13" class="idref" href="#x:13"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:14" class="idref" href="#t<sub>1</sub>:14"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:15" class="idref" href="#t<sub>2</sub>:15"><span class="id" title="binder">t<sub>2</sub></span></a> <a id="Q:16" class="idref" href="#Q:16"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:14"><span class="id" title="variable">t<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:17" class="idref" href="#v:17"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:13"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v:17"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:15"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:16"><span class="id" title="variable">Q</span></a>) <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <a class="idref" href="WPgen.html#x:13"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:14"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:15"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:16"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
We fill in the dots as follows:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> (<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span> Observe that in the above definition, the second recursive call is invoked
    on <span class="inlinecode"><span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, which is not a strict subterm of <span class="inlinecode"><span class="id" title="var">t</span></span>. As explained
    earlier, this recursion pattern motivates the introduction of substitution
    contexts, written <span class="inlinecode"><span class="id" title="var">E</span></span>, to delay the computation of substitutions until the
    leaves of the recursion. 
</div>

<div class="doc">
<a id="lab317"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Variables</h3>

<div class="paragraph"> </div>

 We have seen no reasoning rules for establishing a triple for a program
    variable, that is, to prove <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. Indeed, <span class="inlinecode"><span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> is
    a stuck term: its execution does not produce an output. A source term may of
    course contain program variables, but all these variables should be
    substituted away before the execution reaches them.

<div class="paragraph"> </div>

    In the case of the function <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, a variable bound by a let-binding get
    substituted while traversing that let-binding construct. Thus, if a free
    variable is reached by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, it means that this variable was originally a
    dangling free variable, and therefore that the initial source term was
    invalid.

<div class="paragraph"> </div>

    But, although we have no reasoning rules for <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> nor
    for <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, we nevertheless have to provide some
    meaningful definition for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. This definition should
    capture the fact that this case must not happen. The heap predicate
    <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span> appropriately captures this intention.  <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
<div class="paragraph"> </div>

 Remark: the use of \<span class="inlinecode"><span class="id" title="var">False</span></span> embodies the fact that, technically, we could
    have stated a Separation Logic rule for free variables, using <span class="inlinecode"><span class="id" title="var">False</span></span> as
    precondition. There are three ways of presenting this rule: 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="wp_var" class="idref" href="#wp_var"><span class="id" title="lemma">wp_var</span></a> : <span class="id" title="keyword">∀</span> <a id="x:19" class="idref" href="#x:19"><span class="id" title="binder">x</span></a> <a id="Q:20" class="idref" href="#Q:20"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <a class="idref" href="WPgen.html#x:19"><span class="id" title="variable">x</span></a>) <a class="idref" href="WPgen.html#Q:20"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">h</span> <span class="id" title="var">Hh</span>. <span class="id" title="tactic">destruct</span> (<a class="idref" href="LibSepReference.html#SepSimplArgs.hpure_inv"><span class="id" title="lemma">hpure_inv</span></a> <span class="id" title="var">Hh</span>). <span class="id" title="var">false</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="triple_var" class="idref" href="#triple_var"><span class="id" title="lemma">triple_var</span></a> : <span class="id" title="keyword">∀</span> <a id="x:21" class="idref" href="#x:21"><span class="id" title="binder">x</span></a> <a id="H:22" class="idref" href="#H:22"><span class="id" title="binder">H</span></a> <a id="Q:23" class="idref" href="#Q:23"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <a class="idref" href="WPgen.html#x:21"><span class="id" title="variable">x</span></a>) <a class="idref" href="WPgen.html#H:22"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:23"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="var">false</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="triple_var'" class="idref" href="#triple_var'"><span class="id" title="lemma">triple_var'</span></a> : <span class="id" title="keyword">∀</span> <a id="x:24" class="idref" href="#x:24"><span class="id" title="binder">x</span></a> <a id="Q:25" class="idref" href="#Q:25"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <a class="idref" href="WPgen.html#x:24"><span class="id" title="variable">x</span></a>) <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="WPgen.html#Q:25"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="lemma">wp_equiv</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#wp_var"><span class="id" title="lemma">wp_var</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
All these rules are correct, albeit totally useless. 
</div>

<div class="doc">
<a id="lab318"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Function Applications</h3>

<div class="paragraph"> </div>

 Consider an application in A-normal form, that is, an application of the
    form <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span>. We have seen <span class="inlinecode"><span class="id" title="var">wp</span></span>-style rules to reason about the
    application of a known function, e.g. <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode">(<span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span>. Yet,
    typically the function <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> is a function specified in terms of <span class="inlinecode"><span class="id" title="var">triple</span></span>.
    (If <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> is a primitive function, or if it comes from a function argument,
    it might not even be the case that <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> admits the shape <span class="inlinecode"><span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>.)

<div class="paragraph"> </div>

    Thus, we wish to reason about an application <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> by exhibiting a
    triple of the form <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. As suggested earlier in the
    chapter, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> needs to correspond to
    some heap predicate <span class="inlinecode"><span class="id" title="var">H</span></span> for which <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> holds. 
<div class="paragraph"> </div>

 The formula that formalizes this intuition is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
<div class="paragraph"> </div>

 Another possibility would be to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> as
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. In other words, to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for a function
    application, we could fall back to the semantic definition of <span class="inlinecode"><span class="id" title="var">wp</span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wp</span> <span class="id" title="var">t</span> <span class="id" title="var">Q</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>    However, this definition would require converting the <span class="inlinecode"><span class="id" title="var">wp</span></span> into a <span class="inlinecode"><span class="id" title="var">triple</span></span>
    each time, because specifications are, by convention, expressed using the
    predicate <span class="inlinecode"><span class="id" title="var">triple</span></span>. 
<div class="paragraph"> </div>

 Remark: we assume throughout the course that terms are written in A-normal
    form. Nevertheless, we need to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span> even on terms that are not in
    A-normal form. One possibility is to map all these terms to <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>.
    However, even in the case of an application of the form <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>
    where <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> are not both values, it is still correct to define
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>))</span> as <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>. So, we need not bother
    checking in the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that the arguments of <span class="inlinecode"><span class="id" title="var">trm_app</span></span> are
    actually values. 
</div>

<div class="doc">
<a id="lab319"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for Conditionals</h3>

<div class="paragraph"> </div>

 Finally, consider an if-statement. Recall the <span class="inlinecode"><span class="id" title="var">wp</span></span>-style reasoning rule
    stated using a Coq conditional. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="wp_if" class="idref" href="#wp_if"><span class="id" title="axiom">wp_if</span></a> : <span class="id" title="keyword">∀</span> (<a id="b:26" class="idref" href="#b:26"><span class="id" title="binder">b</span></a>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>) <a id="t<sub>1</sub>:27" class="idref" href="#t<sub>1</sub>:27"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="t<sub>2</sub>:28" class="idref" href="#t<sub>2</sub>:28"><span class="id" title="binder">t<sub>2</sub></span></a> <a id="Q:29" class="idref" href="#Q:29"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> <a class="idref" href="WPgen.html#b:26"><span class="id" title="variable">b</span></a> <span class="id" title="keyword">then</span> (<a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:27"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:29"><span class="id" title="variable">Q</span></a>) <span class="id" title="keyword">else</span> (<a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:28"><span class="id" title="variable">t<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:29"><span class="id" title="variable">Q</span></a>)<a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> (<a class="idref" href="LibSepReference.html#val_bool"><span class="id" title="constructor">val_bool</span></a> <a class="idref" href="WPgen.html#b:26"><span class="id" title="variable">b</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:27"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#t<sub>2</sub>:28"><span class="id" title="variable">t<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#Q:29"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Typically, a source program may feature a conditional
    <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> that, after substitution for <span class="inlinecode"><span class="id" title="var">x</span></span>, becomes
    <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, for some abstract <span class="inlinecode"><span class="id" title="var">v</span></span> of type <span class="inlinecode"><span class="id" title="var">val</span></span>. Yet, in
    general, because we are working here with possibly ill-typed programs, this
    value is not know to be a boolean value. We therefore need to define <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    for all if-statements of the form <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>0</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, where <span class="inlinecode"><span class="id" title="var">v<sub>0</sub></span></span>
    could be a value of unknown shape.

<div class="paragraph"> </div>

    However, the reasoning rule <span class="inlinecode"><span class="id" title="var">wp_if</span></span> stated above features a right-hand side
    of the form <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">trm_if</span></span> <span class="inlinecode">(<span class="id" title="var">val_bool</span></span> <span class="inlinecode"><span class="id" title="var">b</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. It only applies when the
    first argument of <span class="inlinecode"><span class="id" title="var">trm_if</span></span> is syntactically a boolean value <span class="inlinecode"><span class="id" title="var">b</span></span>. To resolve
    this mismatch, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for a term <span class="inlinecode"><span class="id" title="var">trm_if</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>
    quantifies existentially over a boolean value <span class="inlinecode"><span class="id" title="var">b</span></span> such that
    <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">trm_val</span></span> <span class="inlinecode">(<span class="id" title="var">val_bool</span></span> <span class="inlinecode"><span class="id" title="var">b</span>)</span>. This way, if <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span> is not a boolean value, then
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_if</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is equivalent to <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>. Otherwise, if <span class="inlinecode"><span class="id" title="var">t<sub>0</sub></span></span>
    is of the form <span class="inlinecode"><span class="id" title="var">val_bool</span></span> <span class="inlinecode"><span class="id" title="var">b</span></span>, and we are able to perform a case analysis on
    <span class="inlinecode"><span class="id" title="var">b</span></span>, to switch between <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> depending on the value
    of <span class="inlinecode"><span class="id" title="var">b</span></span>. 
<div class="paragraph"> </div>

 The formal definition is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_if</span> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span><span class="id" title="tactic">∃</span> (<span class="id" title="var">b</span>:<span class="id" title="var">bool</span>), <span class='gray-font'>\</span>[<span class="id" title="var">t<sub>0</sub></span> = <span class="id" title="var">trm_val</span> (<span class="id" title="var">val_bool</span> <span class="id" title="var">b</span>)]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span>* (<span class="id" title="keyword">if</span> <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span>) <span class="id" title="var">Q</span> <span class="id" title="keyword">else</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...
</span>
</div>

<div class="doc">
<a id="lab320"></a><h3 class="section">Summary of the Definition So Far</h3>

<div class="paragraph"> </div>

 In summary, we have defined:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> (<span class="id" title="tactic">subst</span> <span class="id" title="var">x</span> <span class="id" title="var">v</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_if</span> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span><span class="id" title="tactic">∃</span> (<span class="id" title="var">b</span>:<span class="id" title="var">bool</span>), <span class='gray-font'>\</span>[<span class="id" title="var">t<sub>0</sub></span> = <span class="id" title="var">trm_val</span> (<span class="id" title="var">val_bool</span> <span class="id" title="var">b</span>)]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class='gray-font'>\</span>* (<span class="id" title="keyword">if</span> <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>1</sub></span>) <span class="id" title="var">Q</span> <span class="id" title="keyword">else</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">t<sub>2</sub></span>) <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    As pointed out earlier, this definition is not structurally recursive and is
    thus not accepted by Coq, due to the recursive call
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. Our next step is to fix this issue. 
</div>

<div class="doc">
<a id="lab321"></a><h2 class="section">Computing with <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h2>

<div class="paragraph"> </div>

 To make <span class="inlinecode"><span class="id" title="var">wpgen</span></span> structurally recursive, the idea is to postpone the
    substitutions until the leaves of the recursion. To that end, we introduce a
    substitution context, written <span class="inlinecode"><span class="id" title="var">E</span></span>, to record the substitutions that must be
    performed. Concretely, we modify the function to take the form <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>,
    where <span class="inlinecode"><span class="id" title="var">E</span></span> denotes a list of bindings from variables to values. The intention
    is that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> should compute the weakest precondition for the term
    <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, which denotes the result of substituting all bindings from E
    inside the term <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>

<div class="doc">
<a id="lab322"></a><h3 class="section">Contexts</h3>

<div class="paragraph"> </div>

 A context <span class="inlinecode"><span class="id" title="var">E</span></span> is represented as an association list relating variables to
    values. Recall that all values are closed, i.e., without free variables. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="ctx" class="idref" href="#ctx"><span class="id" title="definition">ctx</span></a> : <span class="id" title="keyword">Type</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#list"><span class="id" title="inductive">list</span></a> (<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#11c698c8685bb8ab1cf725545c085ac<sub>4</sub>"><span class="id" title="notation">*</span></a> <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>).<br/>
</div>

<div class="doc">
The "iterated substitution" operation, written <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, describes the
    substitution of <i>all</i> the bindings from a context <span class="inlinecode"><span class="id" title="var">E</span></span> into a term <span class="inlinecode"><span class="id" title="var">t</span></span>. 
<div class="paragraph"> </div>

 Its implementation is standard: the function traverses the term recursively
    and, when reaching a variable, performs a lookup in the context <span class="inlinecode"><span class="id" title="var">E</span></span>. The
    operation needs to take care to respect variable shadowing. To that end,
    when traversing a binder for a variable <span class="inlinecode"><span class="id" title="var">x</span></span>, all occurrences of <span class="inlinecode"><span class="id" title="var">x</span></span> that
    might previously exist in <span class="inlinecode"><span class="id" title="var">E</span></span> are removed.

<div class="paragraph"> </div>

    The formal definition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> involves two auxiliary functions -- lookup
    and removal -- on association lists. The definition of the operation
    <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> on association lists is standard. It returns an option on a
    value. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="lookup" class="idref" href="#lookup"><span class="id" title="definition">lookup</span></a> (<a id="x:31" class="idref" href="#x:31"><span class="id" title="binder">x</span></a>:<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>) (<a id="E:32" class="idref" href="#E:32"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#option"><span class="id" title="inductive">option</span></a> <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#E:32"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">y</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><span class="id" title="var">E<sub>1</sub></span> ⇒ <span class="id" title="keyword">if</span> <a class="idref" href="LibSepVar.html#var_eq"><span class="id" title="definition">var_eq</span></a> <a class="idref" href="WPgen.html#x:31"><span class="id" title="variable">x</span></a> <span class="id" title="var">y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="WPgen.html#lookup:33"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:31"><span class="id" title="variable">x</span></a> <span class="id" title="var">E<sub>1</sub></span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The definition of the removal operation, written <span class="inlinecode"><span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>, is also
    standard. It returns a filtered context. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="rem" class="idref" href="#rem"><span class="id" title="definition">rem</span></a> (<a id="x:35" class="idref" href="#x:35"><span class="id" title="binder">x</span></a>:<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>) (<a id="E:36" class="idref" href="#E:36"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) : <a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#E:36"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">y</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><span class="id" title="var">E<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <a id="E<sub>1</sub>':39" class="idref" href="#E<sub>1</sub>':39"><span class="id" title="binder">E<sub>1</sub>'</span></a> := <a class="idref" href="WPgen.html#rem:37"><span class="id" title="definition">rem</span></a> <a class="idref" href="WPgen.html#x:35"><span class="id" title="variable">x</span></a> <span class="id" title="var">E<sub>1</sub></span> <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">if</span> <a class="idref" href="LibSepVar.html#var_eq"><span class="id" title="definition">var_eq</span></a> <a class="idref" href="WPgen.html#x:35"><span class="id" title="variable">x</span></a> <span class="id" title="var">y</span> <span class="id" title="keyword">then</span> <a class="idref" href="WPgen.html#E<sub>1</sub>':39"><span class="id" title="variable">E<sub>1</sub>'</span></a> <span class="id" title="keyword">else</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">y</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><span class="id" title="var">v</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E<sub>1</sub>':39"><span class="id" title="variable">E<sub>1</sub>'</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The definition of the operation <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> can then be expressed as a
    recursive function over the term <span class="inlinecode"><span class="id" title="var">t</span></span>. It invokes <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> when it
    reaches a variable <span class="inlinecode"><span class="id" title="var">x</span></span>. It invokes <span class="inlinecode"><span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> when traversing a binding on
    the name <span class="inlinecode"><span class="id" title="var">x</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="isubst" class="idref" href="#isubst"><span class="id" title="definition">isubst</span></a> (<a id="E:40" class="idref" href="#E:40"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:41" class="idref" href="#t:41"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:41"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="WPgen.html#t:41"><span class="id" title="variable">t</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#isubst:42"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:40"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Remark: it is also possible to define the substitution by iterating the
    unary substitution <span class="inlinecode"><span class="id" title="tactic">subst</span></span> over the list of bindings from <span class="inlinecode"><span class="id" title="var">E</span></span>. However, this
    alternative approach yields a less efficient function and leads to more
    complicated proofs. 
<div class="paragraph"> </div>

 We now present the reformulated definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>, case by case.
    Throughout these definitions, recall that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is interpreted as the
    weakest precondition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>

<div class="doc">
<a id="lab323"></a><h3 class="section">The Let-Binding Case</h3>

<div class="paragraph"> </div>

 When the function <span class="inlinecode"><span class="id" title="var">wpgen</span></span> traverses a let-binding, rather than eagerly
    performing a substitution, it simply extends the current context.
    Concretely, a call to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> triggers a recursive call
    to <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. The corresponding definition is:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_let</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab324"></a><h3 class="section">The Variable Case</h3>

<div class="paragraph"> </div>

 When <span class="inlinecode"><span class="id" title="var">wpgen</span></span> reaches a variable, it looks for a binding on the variable <span class="inlinecode"><span class="id" title="var">x</span></span>
    inside the context <span class="inlinecode"><span class="id" title="var">E</span></span>. Concretely, the evaluation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_var</span></span> <span class="inlinecode"><span class="id" title="var">x</span>)</span>
    triggers a call to <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>. If the context <span class="inlinecode"><span class="id" title="var">E</span></span> binds the variable <span class="inlinecode"><span class="id" title="var">x</span></span>
    to some value <span class="inlinecode"><span class="id" title="var">v</span></span>, then the operation <span class="inlinecode"><span class="id" title="var">lookup</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> returns <span class="inlinecode"><span class="id" title="var">Some</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>. In that
    case, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> returns the weakest precondition for the value <span class="inlinecode"><span class="id" title="var">v</span></span>, that is,
    <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>. Otherwise, if <span class="inlinecode"><span class="id" title="var">E</span></span> does not bind <span class="inlinecode"><span class="id" title="var">x</span></span>, the lookup operation returns
    <span class="inlinecode"><span class="id" title="var">None</span></span>. In that case, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> returns <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">False</span>]</span>, the weakest precondition
    for a stuck program.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_var</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">lookup</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Some</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">None</span> ⇒ <span class='gray-font'>\</span>[<span class="id" title="var">False</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab325"></a><h3 class="section">The Application Case</h3>

<div class="paragraph"> </div>

 Recall the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> without substitution contexts:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ <span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> <span class="id" title="var">t</span> <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]
</span>
<div class="paragraph"> </div>

 In the definition with contexts, the term <span class="inlinecode"><span class="id" title="var">t</span></span> appearing in <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>
    needs to be replaced with <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_app</span> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ <span class="id" title="tactic">∃</span> <span class="id" title="var">H</span>, <span class="id" title="var">H</span> <span class='gray-font'>\</span>* <span class='gray-font'>\</span>[<span class="id" title="var">triple</span> (<span class="id" title="var">isubst</span> <span class="id" title="var">E</span> <span class="id" title="var">t</span>) <span class="id" title="var">H</span> <span class="id" title="var">Q</span>]<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..
</span>
</div>

<div class="doc">
<a id="lab326"></a><h3 class="section">The Function Definition Case</h3>

<div class="paragraph"> </div>

 Suppose <span class="inlinecode"><span class="id" title="var">t</span></span> is a function definition, for example <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>. Here
    again, the formula <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is interpreted as the weakest precondition of
    <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

    By unfolding the definition of <span class="inlinecode"><span class="id" title="var">isubst</span></span> in the case where <span class="inlinecode"><span class="id" title="var">t</span></span> is
    <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>, we obtain <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>.

<div class="paragraph"> </div>

    The corresponding value is <span class="inlinecode"><span class="id" title="var">trm_val</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>. The weakest
    precondition for that value is
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">(<span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">(<span class="id" title="var">rem</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">E</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>))</span>.

<div class="paragraph"> </div>

    Thus, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> handles functions (and recursive functions) as follows: 
<div class="paragraph"> </div>

 <br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> (<span class="id" title="var">rem</span> <span class="id" title="var">f</span> <span class="id" title="var">E</span>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;) <span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab327"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">wpgen</span></span>: At Last, an Executable Function</h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WpgenExec1" class="idref" href="#WpgenExec1"><span class="id" title="module">WpgenExec1</span></a>.<br/>
</div>

<div class="doc">
At last, we arrive at a definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that type-checks in Coq and
    that can be used to effectively compute weakest preconditions in Separation
    Logic. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="WpgenExec1.wpgen" class="idref" href="#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:44" class="idref" href="#E:44"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:45" class="idref" href="#t:45"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) (<a id="Q:46" class="idref" href="#Q:46"><span class="id" title="binder">Q</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>) : <a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:45"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="v:49" class="idref" href="#v:49"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span> <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="v:50" class="idref" href="#v:50"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:50"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span> <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="var">v<sub>2</sub></span> ⇒ <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="H:51" class="idref" href="#H:51"><span class="id" title="binder">H</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="WPgen.html#H:51"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:45"><span class="id" title="variable">t</span></a>) <a class="idref" href="WPgen.html#H:51"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">(</span></a><a id="b:52" class="idref" href="#b:52"><span class="id" title="binder">b</span></a>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">),</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><span class="id" title="var">t<sub>0</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> (<a class="idref" href="LibSepReference.html#val_bool"><span class="id" title="constructor">val_bool</span></a> <a class="idref" href="WPgen.html#b:52"><span class="id" title="variable">b</span></a>)<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> <a class="idref" href="WPgen.html#b:52"><span class="id" title="variable">b</span></a> <span class="id" title="keyword">then</span> (<a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a> <span class="id" title="keyword">else</span> (<a class="idref" href="WPgen.html#wpgen:47"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:44"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>) <a class="idref" href="WPgen.html#Q:46"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
In the next chapter, we will establish the soundness of the <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For the
    moment, we simply state the soundness theorem, then explain how it can be
    exploited for verifying concrete programs. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec1.wpgen_sound" class="idref" href="#WpgenExec1.wpgen_sound"><span class="id" title="axiom">wpgen_sound</span></a> : <span class="id" title="keyword">∀</span> <a id="E:53" class="idref" href="#E:53"><span class="id" title="binder">E</span></a> <a id="t:54" class="idref" href="#t:54"><span class="id" title="binder">t</span></a> <a id="Q:55" class="idref" href="#Q:55"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:53"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:54"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:55"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:53"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:54"><span class="id" title="variable">t</span></a>) <a class="idref" href="WPgen.html#Q:55"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
The entailment above asserts in particular that we can derive <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>
    by proving <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. A useful corollary combines this soundness
    theorem with the rule <span class="inlinecode"><span class="id" title="var">triple_app_fun</span></span>, which allows establishing triples
    for functions.

<div class="paragraph"> </div>

    Recall <span class="inlinecode"><span class="id" title="var">triple_app_fun</span></span> from chapter <a href="Rules.html"><span class="inlineref">Rules</span></a>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec1.triple_app_fun" class="idref" href="#WpgenExec1.triple_app_fun"><span class="id" title="axiom">triple_app_fun</span></a> : <span class="id" title="keyword">∀</span> <a id="x:57" class="idref" href="#x:57"><span class="id" title="binder">x</span></a> <a id="v<sub>1</sub>:58" class="idref" href="#v<sub>1</sub>:58"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:59" class="idref" href="#v<sub>2</sub>:59"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="t<sub>1</sub>:60" class="idref" href="#t<sub>1</sub>:60"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:61" class="idref" href="#H:61"><span class="id" title="binder">H</span></a> <a id="Q:62" class="idref" href="#Q:62"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:58"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:57"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:60"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#subst"><span class="id" title="definition">subst</span></a> <a class="idref" href="WPgen.html#x:57"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:59"><span class="id" title="variable">v<sub>2</sub></span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:60"><span class="id" title="variable">t<sub>1</sub></span></a>) <a class="idref" href="WPgen.html#H:61"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:62"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:58"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:59"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:61"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:62"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Reformulating the rule above into a rule for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> takes 3 steps.

<div class="paragraph"> </div>

    First, we rewrite the premise <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> using <span class="inlinecode"><span class="id" title="var">wp</span></span>. It
    becomes <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    Second, we observe that the term <span class="inlinecode"><span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> is equal to
    <span class="inlinecode"><span class="id" title="var">isubst</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>. (This equality is captured by the lemma
    <span class="inlinecode"><span class="id" title="var">subst_eq_isubst_one</span></span> proved in the next chapter.) Thus, the heap predicate
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="tactic">subst</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">v<sub>2</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is equivalent to <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span>.

<div class="paragraph"> </div>

    Third, according to <span class="inlinecode"><span class="id" title="var">wpgen_sound</span></span>, <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode">(<span class="id" title="var">isubst</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> is
    entailed by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">v<sub>2</sub></span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>. Thus, we can use the latter as premise
    in place of the former. We thereby obtain the following lemma, which is at
    the heart of the implementation of the tactic <span class="inlinecode"><span class="id" title="var">xwp</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WpgenExec1.triple_app_fun_from_wpgen" class="idref" href="#WpgenExec1.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:64" class="idref" href="#v<sub>1</sub>:64"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:65" class="idref" href="#v<sub>2</sub>:65"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:66" class="idref" href="#x:66"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:67" class="idref" href="#t<sub>1</sub>:67"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:68" class="idref" href="#H:68"><span class="id" title="binder">H</span></a> <a id="Q:69" class="idref" href="#Q:69"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:64"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:66"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:67"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:68"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:66"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:65"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:67"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:69"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:64"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:65"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:68"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:69"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
<a id="lab328"></a><h3 class="section">Executing <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a Concrete Program</h3>

</div>
<div class="code">

<span class="id" title="keyword">Import</span> <a class="idref" href="Rules.html#ExamplePrograms"><span class="id" title="module">ExamplePrograms</span></a>.<br/>
</div>

<div class="doc">
Let us exploit <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span> to demonstrate the computation of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a practical program. Recall the function <span class="inlinecode"><span class="id" title="var">incr</span></span> (defined in
    Rules), and its specification below. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WpgenExec1.triple_incr" class="idref" href="#WpgenExec1.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:71" class="idref" href="#p:71"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:72" class="idref" href="#n:72"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:71"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:71"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:72"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:71"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:72"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WpgenExec1.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="comment">(*&nbsp;Read&nbsp;the&nbsp;goal&nbsp;here...&nbsp;*)</span><br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
At the end of the above proof fragment, the goal takes the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">F</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>,
    where <span class="inlinecode"><span class="id" title="var">H</span></span> denotes the precondition, <span class="inlinecode"><span class="id" title="var">Q</span></span> the postcondition, and <span class="inlinecode"><span class="id" title="var">F</span></span> is a
    formula describing the body of the function <span class="inlinecode"><span class="id" title="var">incr</span></span>. Inside this formula, the
    reader can spot triples for the primitive operations involved. Observe that
    the goal is nevertheless somewhat hard to relate to the original program. In
    what follows, we explain how to remedy the situation by setting up <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    so that its output is human-readable and resembles the original source code.
    
</div>

<div class="doc">
<a id="lab329"></a><h3 class="section">Consequence and Frame Properties for <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h3>

<div class="paragraph"> </div>

<a id="lab330"></a><h4 class="section">Exercise: 3 stars, standard, especially useful (wpgen_conseq)</h4>
 Prove that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> satisfies the same consequence rule as <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. The
    statement is directly adapted from <span class="inlinecode"><span class="id" title="var">wp_conseq</span></span>, from <a href="WPsem.html"><span class="inlineref">WPsem</span></a>. Hint:
    begin the proof with <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode"><span class="id" title="var">t</span>.</span> <span class="inlinecode"><span class="id" title="tactic">induction</span></span> <span class="inlinecode"><span class="id" title="var">t</span>.</span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WpgenExec1.wpgen_conseq" class="idref" href="#WpgenExec1.wpgen_conseq"><span class="id" title="lemma">wpgen_conseq</span></a> : <span class="id" title="keyword">∀</span> <a id="t:73" class="idref" href="#t:73"><span class="id" title="binder">t</span></a> <a id="E:74" class="idref" href="#E:74"><span class="id" title="binder">E</span></a> <a id="Q<sub>1</sub>:75" class="idref" href="#Q<sub>1</sub>:75"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:76" class="idref" href="#Q<sub>2</sub>:76"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:75"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:76"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:74"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:73"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:75"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:74"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:73"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:76"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab331"></a><h4 class="section">Exercise: 4 stars, standard, especially useful (wpgen_frame)</h4>
 Prove that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> satisfies the same frame rule as <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. The
    statement is directly adapted from <span class="inlinecode"><span class="id" title="var">wp_frame</span></span>, from <a href="WPsem.html"><span class="inlineref">WPsem</span></a>. The
    sequence case is not easy. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WpgenExec1.wpgen_frame" class="idref" href="#WpgenExec1.wpgen_frame"><span class="id" title="lemma">wpgen_frame</span></a> : <span class="id" title="keyword">∀</span> <a id="t:77" class="idref" href="#t:77"><span class="id" title="binder">t</span></a> <a id="E:78" class="idref" href="#E:78"><span class="id" title="binder">E</span></a> <a id="H:79" class="idref" href="#H:79"><span class="id" title="binder">H</span></a> <a id="Q:80" class="idref" href="#Q:80"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:78"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:77"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:80"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:79"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WpgenExec1.wpgen"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:78"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:77"><span class="id" title="variable">t</span></a> (<a class="idref" href="WPgen.html#Q:80"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:79"><span class="id" title="variable">H</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WpgenExec1"><span class="id" title="module">WpgenExec1</span></a>.<br/>
</div>

<div class="doc">
<a id="lab332"></a><h2 class="section">Optimizing the Readability of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>'s Output</h2>

<div class="paragraph"> </div>

 To improve the readability of the formulae produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we take the
    following 3 steps:

<div class="paragraph"> </div>

<ul class="doclist">
<li> first, we modify the presentation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> so that the
      <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)</span> <span class="inlinecode">⇒</span> appears insides the branches of the
      <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> rather than around it,

</li>
<li> second, we introduce one auxiliary definition for each branch
      of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span>, and

</li>
<li> third, we introduce a Notation for each of these auxiliary definitions. 

</li>
</ul>
</div>

<div class="doc">
<a id="lab333"></a><h3 class="section">Reability Step 1: Moving the Function below the Branches.</h3>

<div class="paragraph"> </div>

 We distribute the <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> into the branches of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span>. Concretely, we
    change from:
<br/>
<span class="inlinecode">&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span>     ⇒  <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>  ⇒  <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    to the equivalent form:
<br/>
<span class="inlinecode">&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : (<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span>     ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>  ⇒  <span class="id" title="keyword">fun</span> (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> (<span class="id" title="var">isubst</span> (<span class="id" title="var">rem</span> <span class="id" title="var">x</span> <span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
<div class="paragraph"> </div>

 The result type of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is <span class="inlinecode">(<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span></span>. Hereafter, we let
    <span class="inlinecode"><span class="id" title="var">formula</span></span> be a shorthand for this type. This shorthand will improve
    readability, especially when defining the <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> combinator, which has
    type <span class="inlinecode"><span class="id" title="var">formula</span>→<span class="id" title="var">formula</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="formula" class="idref" href="#formula"><span class="id" title="definition">formula</span></a> : <span class="id" title="keyword">Type</span> := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span></span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>.<br/>
</div>

<div class="doc">
<a id="lab334"></a><h3 class="section">Readability Steps 2 and 3 for the Case of Sequences</h3>

<div class="paragraph"> </div>

 We next introduce auxiliary definitions to denote the result of each of the
    branches of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> construct. Concretely, we change from
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒  <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒ (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>2</sub></span> <span class="id" title="var">Q</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    to the equivalent form:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_seq</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒  <span class="id" title="var">wpgen_seq</span> (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="var">wpgen</span> <span class="id" title="var">E</span> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    where <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> is defined below. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="wpgen_seq" class="idref" href="#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a id="F<sub>1</sub>:81" class="idref" href="#F<sub>1</sub>:81"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:82" class="idref" href="#F<sub>2</sub>:82"><span class="id" title="binder">F<sub>2</sub></span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:83" class="idref" href="#Q:83"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F<sub>1</sub>:81"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:84" class="idref" href="#v:84"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F<sub>2</sub>:82"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:83"><span class="id" title="variable">Q</span></a>).<br/>
</div>

<div class="doc">
Here, <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> denote the results of the recursive calls, <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>
    and <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>, respectively.

<div class="paragraph"> </div>

    With the above definitions, <span class="inlinecode"><span class="id" title="var">wgpen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode">(<span class="id" title="var">trm_seq</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span> evaluates to
    <span class="inlinecode"><span class="id" title="var">wp_seq</span></span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode">(<span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span>)</span>. 
<div class="paragraph"> </div>

 Finally, we introduce a piece of notation for each case. For sequence, we
    set up the notation defined next to so that any formula of the form
    <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> gets displayed as <span class="inlinecode"><span class="id" title="var">Seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> <span class="inlinecode"></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="5e1c6eec1a5d39cff38db256f6c459cd" class="idref" href="#5e1c6eec1a5d39cff38db256f6c459cd"><span class="id" title="notation">&quot;</span></a>'Seq' F<sub>1</sub> ; F<sub>2</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> <span class="id" title="var">F<sub>1</sub></span> <span class="id" title="var">F<sub>2</sub></span>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 68, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>,<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">format</span> "'[v' 'Seq'  '[' F<sub>1</sub> ']'  ';'  '/'  '[' F<sub>2</sub> ']' ']'").<br/>
</div>

<div class="doc">
Thanks to this notation, the <span class="inlinecode"><span class="id" title="var">wpgen</span></span> of a sequence <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span> displays as
    <span class="inlinecode"><span class="id" title="var">Seq</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> <span class="inlinecode">;</span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> where <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span> denote the <span class="inlinecode"><span class="id" title="var">wpgen</span></span> of <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> and <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>,
    respectively. The "format" clause in the notation definition is there only
    to improve the pretty-printing of formulae. The semantics of <span class="inlinecode">'/'</span> is to
    encourage a line break. The semantics of square brackets is to delimit
    blocks. The "v" character next to the leading bracket encourages a vertical
    alignement of the blocks. Double spaces in the format clause indicate the
    need to pretty-print a single space, as opposed to an empty spacing. 
</div>

<div class="doc">
<a id="lab335"></a><h3 class="section">Readability Step 2: Auxiliary Definitions for other Constructs</h3>

<div class="paragraph"> </div>

 We generalize the approach illustrated above for sequences to every other
    term construct... 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="wpgen_val" class="idref" href="#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a id="v:85" class="idref" href="#v:85"><span class="id" title="binder">v</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:86" class="idref" href="#Q:86"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q:86"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#v:85"><span class="id" title="variable">v</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_let" class="idref" href="#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a id="F<sub>1</sub>:87" class="idref" href="#F<sub>1</sub>:87"><span class="id" title="binder">F<sub>1</sub></span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) (<a id="F2of:88" class="idref" href="#F2of:88"><span class="id" title="binder">F2of</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:89" class="idref" href="#Q:89"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F<sub>1</sub>:87"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:90" class="idref" href="#v:90"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F2of:88"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#v:90"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#Q:89"><span class="id" title="variable">Q</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_if" class="idref" href="#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a id="t:91" class="idref" href="#t:91"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) (<a id="F<sub>1</sub>:92" class="idref" href="#F<sub>1</sub>:92"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:93" class="idref" href="#F<sub>2</sub>:93"><span class="id" title="binder">F<sub>2</sub></span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:94" class="idref" href="#Q:94"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">(</span></a><a id="b:95" class="idref" href="#b:95"><span class="id" title="binder">b</span></a>:<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">),</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#t:91"><span class="id" title="variable">t</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> (<a class="idref" href="LibSepReference.html#val_bool"><span class="id" title="constructor">val_bool</span></a> <a class="idref" href="WPgen.html#b:95"><span class="id" title="variable">b</span></a>)<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><span class="id" title="keyword">if</span> <a class="idref" href="WPgen.html#b:95"><span class="id" title="variable">b</span></a> <span class="id" title="keyword">then</span> <a class="idref" href="WPgen.html#F<sub>1</sub>:92"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:94"><span class="id" title="variable">Q</span></a> <span class="id" title="keyword">else</span> <a class="idref" href="WPgen.html#F<sub>2</sub>:93"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:94"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_fail" class="idref" href="#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a> : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:96" class="idref" href="#Q:96"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#False"><span class="id" title="inductive">False</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_var" class="idref" href="#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> (<a id="E:97" class="idref" href="#E:97"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="x:98" class="idref" href="#x:98"><span class="id" title="binder">x</span></a>:<a class="idref" href="LibSepVar.html#var"><span class="id" title="definition">var</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#lookup"><span class="id" title="definition">lookup</span></a> <a class="idref" href="WPgen.html#x:98"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#E:97"><span class="id" title="variable">E</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#None"><span class="id" title="constructor">None</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#Some"><span class="id" title="constructor">Some</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="wpgen_app" class="idref" href="#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> (<a id="t:99" class="idref" href="#t:99"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:100" class="idref" href="#Q:100"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="H:101" class="idref" href="#H:101"><span class="id" title="binder">H</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="WPgen.html#H:101"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="WPgen.html#t:99"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#H:101"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:100"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>.<br/>
</div>

<div class="doc">
The new definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> reads as follows: 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WpgenExec2" class="idref" href="#WpgenExec2"><span class="id" title="module">WpgenExec2</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="WpgenExec2.wpgen" class="idref" href="#WpgenExec2.wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:102" class="idref" href="#E:102"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:103" class="idref" href="#t:103"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:103"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:103"><span class="id" title="variable">t</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a class="idref" href="WPgen.html#wpgen:104"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:104"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#wpgen:104"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <a id="v:106" class="idref" href="#v:106"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:104"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:106"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#wpgen:104"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:104"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:102"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WpgenExec2"><span class="id" title="module">WpgenExec2</span></a>.<br/>
</div>

<div class="doc">
<a id="lab336"></a><h3 class="section">Readability Step 3: Notations for Auxiliary Definitions</h3>

<div class="paragraph"> </div>

 We generalize the notation introduced for sequences to every other term
    construct. The corresponding notation is defined below. To avoid a conflict
    with the TLC notation for classical conditionals, we write <span class="inlinecode"><span class="id" title="var">If_</span></span> in place of
    <span class="inlinecode"><span class="id" title="var">If</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Declare Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'Val'_x" class="idref" href="#::wpgen_scope:'Val'_x"><span class="id" title="notation">&quot;</span></a>'Val' v" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69) : <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="252a34405ffc90be6d32ca8423964279" class="idref" href="#252a34405ffc90be6d32ca8423964279"><span class="id" title="notation">&quot;</span></a>'Let' x ':=' F<sub>1</sub> 'in' F<sub>2</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> <span class="id" title="var">F<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="x:107" class="idref" href="#x:107"><span class="id" title="binder">x</span></a> ⇒ <span class="id" title="var">F<sub>2</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69, <span class="id" title="var">x</span> <span class="id" title="var">name</span>, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>,<br/>
&nbsp;&nbsp;<span class="id" title="var">format</span> "'[v' '[' 'Let'  x  ':='  F<sub>1</sub>  'in' ']'  '/'  '[' F<sub>2</sub> ']' ']'")<br/>
&nbsp;&nbsp;: <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'If_'_x_'Then'_x_'Else'_x" class="idref" href="#::wpgen_scope:'If_'_x_'Then'_x_'Else'_x"><span class="id" title="notation">&quot;</span></a>'If_' b 'Then' F<sub>1</sub> 'Else' F<sub>2</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> <span class="id" title="var">b</span> <span class="id" title="var">F<sub>1</sub></span> <span class="id" title="var">F<sub>2</sub></span>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69) : <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'Fail'" class="idref" href="#::wpgen_scope:'Fail'"><span class="id" title="notation">&quot;</span></a>'Fail'" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_fail"><span class="id" title="definition">wpgen_fail</span></a>))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69) : <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
In addition, we introduce a handy notation for the result of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> where
    <span class="inlinecode"><span class="id" title="var">t</span></span> denotes an application. (We cover here only functions of arity one or
    two. The file <span class="inlinecode"><span class="id" title="var">LibSepReference.v</span></span> provides arity-generic definitions.) 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'App'_x_x" class="idref" href="#::wpgen_scope:'App'_x_x"><span class="id" title="notation">&quot;</span></a>'App' f v<sub>1</sub> " :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">f</span> <span class="id" title="var">v<sub>1</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 68, <span class="id" title="var">f</span>, <span class="id" title="var">v<sub>1</sub></span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 0) : <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="::wpgen_scope:'App'_x_x_x" class="idref" href="#::wpgen_scope:'App'_x_x_x"><span class="id" title="notation">&quot;</span></a>'App' f v<sub>1</sub> v<sub>2</sub> " :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">f</span> <span class="id" title="var">v<sub>1</sub></span>) <span class="id" title="var">v<sub>2</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 68, <span class="id" title="var">f</span>, <span class="id" title="var">v<sub>1</sub></span>, <span class="id" title="var">v<sub>2</sub></span> <span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 0) : <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
<a id="lab337"></a><h3 class="section">Demo of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> with Notation.</h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WPgenWithNotation" class="idref" href="#WPgenWithNotation"><span class="id" title="module">WPgenWithNotation</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="Rules.html#ExamplePrograms"><span class="id" title="module">ExamplePrograms</span></a> <a class="idref" href="WPgen.html#WpgenExec2"><span class="id" title="module">WpgenExec2</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
Here again, we temporarily axiomatize the soundness result for the purpose
    of looking at how that result can be exploited in practice. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenWithNotation.triple_app_fun_from_wpgen" class="idref" href="#WPgenWithNotation.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:108" class="idref" href="#v<sub>1</sub>:108"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:109" class="idref" href="#v<sub>2</sub>:109"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:110" class="idref" href="#x:110"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:111" class="idref" href="#t<sub>1</sub>:111"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:112" class="idref" href="#H:112"><span class="id" title="binder">H</span></a> <a id="Q:113" class="idref" href="#Q:113"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:108"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:110"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:111"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:112"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WpgenExec2.wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:110"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:109"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:111"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:113"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:108"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:109"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:112"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:113"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Consider again the example of <span class="inlinecode"><span class="id" title="var">incr</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenWithNotation.triple_incr" class="idref" href="#WPgenWithNotation.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:115" class="idref" href="#p:115"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:116" class="idref" href="#n:116"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:115"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:115"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:116"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:115"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:116"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenWithNotation.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="comment">(*&nbsp;Read&nbsp;the&nbsp;goal&nbsp;here...&nbsp;It&nbsp;is&nbsp;of&nbsp;the&nbsp;form&nbsp;<span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">F</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;where&nbsp;<span class="inlinecode"><span class="id" title="var">F</span></span>&nbsp;vaguely&nbsp;looks&nbsp;like&nbsp;the&nbsp;code&nbsp;of&nbsp;the&nbsp;body&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">incr</span></span>.&nbsp;*)</span><br/>
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
Up to whitespace, alpha-renaming, removal of parentheses, and removal of
    quotes after <span class="inlinecode"><span class="id" title="keyword">Let</span></span> and <span class="inlinecode"><span class="id" title="var">If</span></span>), the formula <span class="inlinecode"><span class="id" title="var">F</span></span> reads as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Let</span> <span class="id" title="var">n</span> := <span class="id" title="var">App</span> <span class="id" title="var">val_get</span> <span class="id" title="var">p</span> <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Let</span> <span class="id" title="var">m</span> := <span class="id" title="var">App</span> (<span class="id" title="var">val_add</span> <span class="id" title="var">n</span>) 1 <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">App</span> (<span class="id" title="var">val_set</span> <span class="id" title="var">p</span>) <span class="id" title="var">m</span>
</span>
<div class="paragraph"> </div>

 With the introduction of intermediate definitions for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> and the
    introduction of associated notations for each term construct, what we have
    achieved is that the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> is, for any input term <span class="inlinecode"><span class="id" title="var">t</span></span>, a human-
    readable formula whose display closely resembles the source code of <span class="inlinecode"><span class="id" title="var">t</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WPgenWithNotation"><span class="id" title="module">WPgenWithNotation</span></a>.<br/>
</div>

<div class="doc">
<a id="lab338"></a><h2 class="section">Extension of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to Handle Structural Rules</h2>

<div class="paragraph"> </div>

 The definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> proposed so far integrates the logic of the
    reasoning rules for terms. The lemmas <span class="inlinecode"><span class="id" title="var">wpgen_conseq</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen_frame</span></span>
    established earlier establish that <span class="inlinecode"><span class="id" title="var">wpgen</span></span> moreover supports the structural
    rules of the logic. Yet, when we are in the middle of the verification of a
    concrete program <span class="inlinecode"><span class="id" title="var">t</span></span>, the expression <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">nil</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is already simplified,
    making it hard to exploit the lemmas <span class="inlinecode"><span class="id" title="var">wpgen_conseq</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen_frame</span></span>.

<div class="paragraph"> </div>

    In order to support convenient application of these rules during the
    verification of concrete programs, we tweak the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> in
    such a way that, even after simplification, it obviously satisfies both the
    rule of consequence and the frame rule. 
</div>

<div class="doc">
<a id="lab339"></a><h3 class="section">Introduction of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> in the Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h3>

<div class="paragraph"> </div>

 The tweak consists of introducing, at every step of the recursion of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, a special predicate called <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> to capture the possibility of
    applying structural rules.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : (<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>)<span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span><span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> (<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen_val</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>).
</span>  With this definition, any output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is necessarily of the form
  <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>, for some formula <span class="inlinecode"><span class="id" title="var">F</span></span> describing the weakest precondition of <span class="inlinecode"><span class="id" title="var">t</span></span>.

<div class="paragraph"> </div>

  The next step is to investigate what properties <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> should satisfy. 
</div>

<div class="doc">
<a id="lab340"></a><h3 class="section">Properties of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="MkstructProp" class="idref" href="#MkstructProp"><span class="id" title="module">MkstructProp</span></a>.<br/>
</div>

<div class="doc">
Because <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> appears between the prototype and the <span class="inlinecode"><span class="id" title="keyword">match</span></span> in the body
    of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, it must have type <span class="inlinecode"><span class="id" title="var">formula</span>→<span class="id" title="var">formula</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct" class="idref" href="#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>.<br/>
</div>

<div class="doc">
Next, <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> should satisfy reasoning rules that mimic the statements of
    the frame rule and the consequence rule in weakest-precondition style
    (<span class="inlinecode"><span class="id" title="var">wp_frame</span></span> and <span class="inlinecode"><span class="id" title="var">wp_conseq</span></span>). 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_frame" class="idref" href="#MkstructProp.mkstruct_frame"><span class="id" title="axiom">mkstruct_frame</span></a> : <span class="id" title="keyword">∀</span> (<a id="F:118" class="idref" href="#F:118"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) <a id="H:119" class="idref" href="#H:119"><span class="id" title="binder">H</span></a> <a id="Q:120" class="idref" href="#Q:120"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:118"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:120"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:119"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:118"><span class="id" title="variable">F</span></a> (<a class="idref" href="WPgen.html#Q:120"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:119"><span class="id" title="variable">H</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_conseq" class="idref" href="#MkstructProp.mkstruct_conseq"><span class="id" title="axiom">mkstruct_conseq</span></a> : <span class="id" title="keyword">∀</span> (<a id="F:122" class="idref" href="#F:122"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) <a id="Q<sub>1</sub>:123" class="idref" href="#Q<sub>1</sub>:123"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:124" class="idref" href="#Q<sub>2</sub>:124"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:123"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:124"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:122"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:123"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:122"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:124"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
In addition, the user manipulating a formula produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> should be
    able to discard the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> from the head of the output when
    there is no need to apply the frame rule or the rule of consequence. The
    erasure property is captured by the following entailment. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_erase" class="idref" href="#MkstructProp.mkstruct_erase"><span class="id" title="axiom">mkstruct_erase</span></a> : <span class="id" title="keyword">∀</span> (<a id="F:126" class="idref" href="#F:126"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) <a id="Q:127" class="idref" href="#Q:127"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F:126"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:127"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F:126"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:127"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
Moreover, in order to complete the soundness proof for <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, the
    predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> should be covariant: if <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> entails <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>, then
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>1</sub></span></span> should entail <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F<sub>2</sub></span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="MkstructProp.mkstruct_monotone" class="idref" href="#MkstructProp.mkstruct_monotone"><span class="id" title="axiom">mkstruct_monotone</span></a> : <span class="id" title="keyword">∀</span> <a id="F<sub>1</sub>:129" class="idref" href="#F<sub>1</sub>:129"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:130" class="idref" href="#F<sub>2</sub>:130"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="Q:131" class="idref" href="#Q:131"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="Q:132" class="idref" href="#Q:132"><span class="id" title="binder">Q</span></a>, <a class="idref" href="WPgen.html#F<sub>1</sub>:129"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:132"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:130"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:132"><span class="id" title="variable">Q</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:129"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:131"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#MkstructProp.mkstruct"><span class="id" title="axiom">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:130"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:131"><span class="id" title="variable">Q</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#MkstructProp"><span class="id" title="module">MkstructProp</span></a>.<br/>
</div>

<div class="doc">
<a id="lab341"></a><h3 class="section">Realization of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

<div class="paragraph"> </div>

 The great news is that there exists a predicate satisfying the four required
    properties of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. The definition may appear magic at first, and
    indeed there is no need to deeply understand it or the proofs that follow.
    The only critical observation is that there exists a predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>
    satisfying the required properties. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="mkstruct" class="idref" href="#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a id="F:134" class="idref" href="#F:134"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <a id="Q:135" class="idref" href="#Q:135"><span class="id" title="binder">Q</span></a> ⇒ <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="Q<sub>1</sub>:136" class="idref" href="#Q<sub>1</sub>:136"><span class="id" title="binder">Q<sub>1</sub></span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="WPgen.html#F:134"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:136"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#Q<sub>1</sub>:136"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#5609a52f091556b9923d5758aa61f543"><span class="id" title="notation"><span class='gray-font'>\</span><span class="nowrap">&minus;&minus;&lowast;</span></span></a> <a class="idref" href="WPgen.html#Q:135"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a>.<br/>
</div>

<div class="doc">
The magic wand may appear somewhat puzzling, but the above statement is
    reminiscent from the statement of <span class="inlinecode"><span class="id" title="var">wp_ramified</span></span>, which captures the
    expressive power of all the structural reasoning rules of Separation Logic
    at once. If we unfold the definition of the magic wand, we can see more
    clearly that <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span> is a formula that describes a program that
    produces a postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span> when executed in the current state if and only
    if the formula <span class="inlinecode"><span class="id" title="var">F</span></span> describes a program that produces a postcondtion <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span></span> in
    a subset of the current state and if the postcondition <span class="inlinecode"><span class="id" title="var">Q<sub>1</sub></span></span> augmented with
    the remainder of the current state (i.e., the piece described by <span class="inlinecode"><span class="id" title="var">H</span></span>)
    corresponds to the postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="mkstruct'" class="idref" href="#mkstruct'"><span class="id" title="definition">mkstruct'</span></a> (<a id="F:137" class="idref" href="#F:137"><span class="id" title="binder">F</span></a>:<a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> (<a id="Q:138" class="idref" href="#Q:138"><span class="id" title="binder">Q</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>) ⇒ <a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">∃</span></a> <a id="Q<sub>1</sub>:139" class="idref" href="#Q<sub>1</sub>:139"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="H:140" class="idref" href="#H:140"><span class="id" title="binder">H</span></a><a class="idref" href="LibSepReference.html#961b41dcd8e5f7d3252676574333c51d"><span class="id" title="notation">,</span></a> <a class="idref" href="WPgen.html#F:137"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:139"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:140"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#Q<sub>1</sub>:139"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:140"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q:138"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>.<br/>
</div>

<div class="doc">
The four properties of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> can be easily verified. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="mkstruct_frame" class="idref" href="#mkstruct_frame"><span class="id" title="lemma">mkstruct_frame</span></a> : <span class="id" title="keyword">∀</span> <a id="F:141" class="idref" href="#F:141"><span class="id" title="binder">F</span></a> <a id="H:142" class="idref" href="#H:142"><span class="id" title="binder">H</span></a> <a id="Q:143" class="idref" href="#Q:143"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:141"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:143"><span class="id" title="variable">Q</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H:142"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:141"><span class="id" title="variable">F</span></a> (<a class="idref" href="WPgen.html#Q:143"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H:142"><span class="id" title="variable">H</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span>. <span class="id" title="var">xsimpl</span>*. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="mkstruct_conseq" class="idref" href="#mkstruct_conseq"><span class="id" title="lemma">mkstruct_conseq</span></a> : <span class="id" title="keyword">∀</span> <a id="F:144" class="idref" href="#F:144"><span class="id" title="binder">F</span></a> <a id="Q<sub>1</sub>:145" class="idref" href="#Q<sub>1</sub>:145"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:146" class="idref" href="#Q<sub>2</sub>:146"><span class="id" title="binder">Q<sub>2</sub></span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:145"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:146"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:144"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:145"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:144"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:146"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">WQ</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span>. <span class="id" title="var">xsimpl</span>*. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="mkstruct_erase" class="idref" href="#mkstruct_erase"><span class="id" title="lemma">mkstruct_erase</span></a> : <span class="id" title="keyword">∀</span> <a id="F:147" class="idref" href="#F:147"><span class="id" title="binder">F</span></a> <a id="Q:148" class="idref" href="#Q:148"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#F:147"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:148"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:147"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:148"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xsimpl</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="mkstruct_monotone" class="idref" href="#mkstruct_monotone"><span class="id" title="lemma">mkstruct_monotone</span></a> : <span class="id" title="keyword">∀</span> <a id="F<sub>1</sub>:149" class="idref" href="#F<sub>1</sub>:149"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:150" class="idref" href="#F<sub>2</sub>:150"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="Q:151" class="idref" href="#Q:151"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="Q:152" class="idref" href="#Q:152"><span class="id" title="binder">Q</span></a>, <a class="idref" href="WPgen.html#F<sub>1</sub>:149"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:152"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:150"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:152"><span class="id" title="variable">Q</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:149"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:151"><span class="id" title="variable">Q</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:150"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:151"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">WF</span>. <span class="id" title="var">unfolds</span> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a>. <span class="id" title="var">xpull</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">Q'</span>. <span class="id" title="var">xchanges</span> <span class="id" title="var">WF</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab342"></a><h3 class="section">Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> with <span class="inlinecode"><span class="id" title="var">mkstruct</span></span></h3>

<div class="paragraph"> </div>

 The final definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> refines the previous one by inserting the
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> predicate at the front of the <span class="inlinecode"><span class="id" title="keyword">match</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> construct. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="wpgen" class="idref" href="#wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:153" class="idref" href="#E:153"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:154" class="idref" href="#t:154"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:154"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> (<a class="idref" href="LibSepReference.html#val_fix"><span class="id" title="constructor">val_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">x</span> (<a class="idref" href="WPgen.html#rem"><span class="id" title="definition">rem</span></a> <span class="id" title="var">f</span> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a>)) <span class="id" title="var">t<sub>1</sub></span>))<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:154"><span class="id" title="variable">t</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a class="idref" href="WPgen.html#wpgen:155"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:155"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#wpgen:155"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <a id="v:157" class="idref" href="#v:157"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:155"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:157"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#wpgen:155"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:155"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:153"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>).<br/>
</div>

<div class="doc">
To avoid clutter in reading the output of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we introduce a
    lightweight shorthand to denote <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span>, allowing it to display simply
    as <span class="inlinecode">`<span class="id" title="var">F</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="c1ee1c8b4cb553e4051fed8f18496dc<sub>8</sub>" class="idref" href="#c1ee1c8b4cb553e4051fed8f18496dc<sub>8</sub>"><span class="id" title="notation">&quot;</span></a>` F" := (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <span class="id" title="var">F</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10, <span class="id" title="var">format</span> "` F") : <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
Once again, we temporarily axiomatize the soundness result for the purpose
    of looking at how that result can be exploited in practice. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="triple_app_fun_from_wpgen" class="idref" href="#triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:158" class="idref" href="#v<sub>1</sub>:158"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:159" class="idref" href="#v<sub>2</sub>:159"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:160" class="idref" href="#x:160"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:161" class="idref" href="#t<sub>1</sub>:161"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:162" class="idref" href="#H:162"><span class="id" title="binder">H</span></a> <a id="Q:163" class="idref" href="#Q:163"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:158"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:160"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:161"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:162"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:160"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:159"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:161"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:163"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:158"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:159"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:162"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:163"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
<a id="lab343"></a><h2 class="section">Implementation of X-tactics</h2>

</div>

<div class="doc">
<a id="lab344"></a><h3 class="section">X-lemmas for Implementing X-tactics</h3>

<div class="paragraph"> </div>

 The last major step in the setup of our verification framework consists of
    lemmas and tactics to assist in the processing of formulas produced by
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. For each term construct, and for <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>, we introduce a
    dedicated lemma, called "x...-lemma", to help with the elimination of that
    construct. 
<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">xstruct_lemma</span></span> is a reformulation of <span class="inlinecode"><span class="id" title="var">mkstruct_erase</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xstruct_lemma" class="idref" href="#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="F:165" class="idref" href="#F:165"><span class="id" title="binder">F</span></a> <a id="H:166" class="idref" href="#H:166"><span class="id" title="binder">H</span></a> <a id="Q:167" class="idref" href="#Q:167"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:166"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F:165"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:167"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:166"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:165"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:167"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#mkstruct_erase"><span class="id" title="lemma">mkstruct_erase</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xval_lemma</span></span> reformulates the definition of <span class="inlinecode"><span class="id" title="var">wpgen_val</span></span>. It just unfolds the
    definition. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xval_lemma" class="idref" href="#xval_lemma"><span class="id" title="lemma">xval_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="v:168" class="idref" href="#v:168"><span class="id" title="binder">v</span></a> <a id="H:169" class="idref" href="#H:169"><span class="id" title="binder">H</span></a> <a id="Q:170" class="idref" href="#Q:170"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:169"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Q:170"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#v:168"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:169"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <a class="idref" href="WPgen.html#v:168"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#Q:170"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xlet_lemma</span></span> reformulates the definition of <span class="inlinecode"><span class="id" title="var">wpgen_let</span></span>. It just unfolds the
    definition. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xlet_lemma" class="idref" href="#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H:171" class="idref" href="#H:171"><span class="id" title="binder">H</span></a> <a id="F<sub>1</sub>:172" class="idref" href="#F<sub>1</sub>:172"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F2of:173" class="idref" href="#F2of:173"><span class="id" title="binder">F2of</span></a> <a id="Q:174" class="idref" href="#Q:174"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:171"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:172"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:175" class="idref" href="#v:175"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F2of:173"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#v:175"><span class="id" title="variable">v</span></a> <a class="idref" href="WPgen.html#Q:174"><span class="id" title="variable">Q</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:171"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:172"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F2of:173"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#Q:174"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
Likewise, <span class="inlinecode"><span class="id" title="var">xseq_lemma</span></span> reformulates <span class="inlinecode"><span class="id" title="var">wpgen_seq</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xseq_lemma" class="idref" href="#xseq_lemma"><span class="id" title="lemma">xseq_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H:176" class="idref" href="#H:176"><span class="id" title="binder">H</span></a> <a id="F<sub>1</sub>:177" class="idref" href="#F<sub>1</sub>:177"><span class="id" title="binder">F<sub>1</sub></span></a> <a id="F<sub>2</sub>:178" class="idref" href="#F<sub>2</sub>:178"><span class="id" title="binder">F<sub>2</sub></span></a> <a id="Q:179" class="idref" href="#Q:179"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:176"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:177"><span class="id" title="variable">F<sub>1</sub></span></a> (<span class="id" title="keyword">fun</span> <a id="v:180" class="idref" href="#v:180"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#F<sub>2</sub>:178"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:179"><span class="id" title="variable">Q</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:176"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> <a class="idref" href="WPgen.html#F<sub>1</sub>:177"><span class="id" title="variable">F<sub>1</sub></span></a> <a class="idref" href="WPgen.html#F<sub>2</sub>:178"><span class="id" title="variable">F<sub>2</sub></span></a> <a class="idref" href="WPgen.html#Q:179"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">xchange</span> <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xapp_lemma</span></span> applies to goals produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on an application. In such
    cases, the proof obligation is of the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode">(<span class="id" title="var">wpgen_app</span></span> <span class="inlinecode"><span class="id" title="var">t</span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.
    <span class="inlinecode"><span class="id" title="var">xapp_lemma</span></span> reformulates the frame-consequence rule in a way that enables
    exploiting a specification triple for a function to reason about a call to
    that function. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xapp_lemma" class="idref" href="#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="t:181" class="idref" href="#t:181"><span class="id" title="binder">t</span></a> <a id="Q<sub>1</sub>:182" class="idref" href="#Q<sub>1</sub>:182"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="H<sub>1</sub>:183" class="idref" href="#H<sub>1</sub>:183"><span class="id" title="binder">H<sub>1</sub></span></a> <a id="H<sub>2</sub>:184" class="idref" href="#H<sub>2</sub>:184"><span class="id" title="binder">H<sub>2</sub></span></a> <a id="H:185" class="idref" href="#H:185"><span class="id" title="binder">H</span></a> <a id="Q:186" class="idref" href="#Q:186"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="WPgen.html#t:181"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#H<sub>1</sub>:183"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:182"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:185"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#H<sub>1</sub>:183"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:184"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:182"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:184"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q:186"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:185"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> <a class="idref" href="WPgen.html#t:181"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:186"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span> <span class="id" title="var">WH</span> <span class="id" title="var">WQ</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a>. <span class="id" title="var">xsimpl</span>. <span class="id" title="var">applys</span>* <a class="idref" href="WPsem.html#triple_conseq_frame"><span class="id" title="axiom">triple_conseq_frame</span></a> <span class="id" title="var">M</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xwp_lemma</span></span> is another name for <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span>. It is used for
    establishing a triple for a function application. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xwp_lemma" class="idref" href="#xwp_lemma"><span class="id" title="lemma">xwp_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="v<sub>1</sub>:187" class="idref" href="#v<sub>1</sub>:187"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="v<sub>2</sub>:188" class="idref" href="#v<sub>2</sub>:188"><span class="id" title="binder">v<sub>2</sub></span></a> <a id="x:189" class="idref" href="#x:189"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:190" class="idref" href="#t<sub>1</sub>:190"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H:191" class="idref" href="#H:191"><span class="id" title="binder">H</span></a> <a id="Q:192" class="idref" href="#Q:192"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#v<sub>1</sub>:187"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:189"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:190"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:191"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:189"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v<sub>2</sub>:188"><span class="id" title="variable">v<sub>2</sub></span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:190"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q:192"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:187"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="WPgen.html#v<sub>2</sub>:188"><span class="id" title="variable">v<sub>2</sub></span></a>) <a class="idref" href="WPgen.html#H:191"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:192"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M<sub>1</sub></span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span>* <a class="idref" href="WPgen.html#triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a>. <span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab345"></a><h3 class="section">Example Proofs using X-lemmas</h3>

<div class="paragraph"> </div>

 Let us illustrate how "x-lemmas" help clarifying verification proof scripts.
    
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithXlemmas" class="idref" href="#ProofsWithXlemmas"><span class="id" title="module">ProofsWithXlemmas</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="Rules.html#ExamplePrograms"><span class="id" title="module">ExamplePrograms</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXlemmas.triple_incr" class="idref" href="#ProofsWithXlemmas.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:193" class="idref" href="#p:193"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:194" class="idref" href="#n:194"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:193"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:193"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:194"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:193"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:194"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xwp_lemma"><span class="id" title="lemma">xwp_lemma</span></a>. { <span class="id" title="tactic">reflexivity</span>. }<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Here&nbsp;the&nbsp;<span class="inlinecode"><span class="id" title="var">wpgen</span></span>&nbsp;function&nbsp;computes.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;<span class="comment">(*&nbsp;Observe&nbsp;how&nbsp;each&nbsp;node&nbsp;begin&nbsp;with&nbsp;<span class="inlinecode"><span class="id" title="var">mkstruct</span></span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Observe&nbsp;how&nbsp;program&nbsp;variables&nbsp;are&nbsp;all&nbsp;eliminated.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>. { <span class="id" title="tactic">apply</span> <a class="idref" href="Rules.html#triple_get"><span class="id" title="lemma">triple_get</span></a>. } { <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xpull</span>; <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>. { <span class="id" title="tactic">apply</span> <a class="idref" href="Rules.html#triple_add"><span class="id" title="lemma">triple_add</span></a>. } { <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xpull</span>; <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>. { <span class="id" title="tactic">apply</span> <a class="idref" href="Rules.html#triple_set"><span class="id" title="axiom">triple_set</span></a>. } { <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab346"></a><h4 class="section">Exercise: 2 stars, standard, especially useful (triple_succ_using_incr_with_xlemmas)</h4>
 Using x-lemmas, simplify the proof of <span class="inlinecode"><span class="id" title="var">triple_succ_using_incr</span></span>, which was
    carried out using triples in chapter <a href="Rules.html"><span class="inlineref">Rules</span></a>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXlemmas.triple_succ_using_incr_with_xlemmas" class="idref" href="#ProofsWithXlemmas.triple_succ_using_incr_with_xlemmas"><span class="id" title="lemma">triple_succ_using_incr_with_xlemmas</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:195" class="idref" href="#n:195"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.succ_using_incr"><span class="id" title="definition">succ_using_incr</span></a> <a class="idref" href="WPgen.html#n:195"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="v:196" class="idref" href="#v:196"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#v:196"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:195"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithXlemmas"><span class="id" title="module">ProofsWithXlemmas</span></a>.<br/>
</div>

<div class="doc">
<a id="lab347"></a><h3 class="section">Definition of X-tactics</h3>

<div class="paragraph"> </div>

 Next, for each x-lemma, we introduce a dedicated tactic to apply that lemma
    and perform the associated bookkeeping. <span class="inlinecode"><span class="id" title="var">xstruct</span></span> eliminates the leading
    <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> that appears in a goal of the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> <span class="inlinecode"><span class="id" title="var">F</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xstruct" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
</div>

<div class="doc">
The tactics <span class="inlinecode"><span class="id" title="var">xval</span></span>, <span class="inlinecode"><span class="id" title="var">xseq</span></span> and <span class="inlinecode"><span class="id" title="var">xlet</span></span> invoke the corresponding x-lemmas,
    after calling <span class="inlinecode"><span class="id" title="var">xstruct</span></span> if a leading <span class="inlinecode"><span class="id" title="var">mkstruct</span></span> is in the way. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xstruct_if_needed" :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> &#x22A2; ?<span class="id" title="var">H</span> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> ?<span class="id" title="var">F</span> ?<span class="id" title="var">Q</span> ⇒ <span class="id" title="var">xstruct</span> <span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xval" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xval_lemma"><span class="id" title="lemma">xval_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xlet" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xseq" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xseq_lemma"><span class="id" title="lemma">xseq_lemma</span></a>.<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> applys <span class="inlinecode"><span class="id" title="var">xapp_lemma</span></span>, after calling <span class="inlinecode"><span class="id" title="var">xseq</span></span> or <span class="inlinecode"><span class="id" title="var">xlet</span></span> if
    applicable. Further on, we will define <span class="inlinecode"><span class="id" title="var">xapp</span></span> as an enhanced version of
    <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> that is able to automatically perform substitutions. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xseq_xlet_if_needed" :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span> &#x22A2; ?<span class="id" title="var">H</span> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> ?<span class="id" title="var">F</span> ?<span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">F</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> ?<span class="id" title="var">F<sub>1</sub></span> ?<span class="id" title="var">F<sub>2</sub></span> ⇒ <span class="id" title="var">xseq</span><br/>
&nbsp;&nbsp;| <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> ?<span class="id" title="var">F<sub>1</sub></span> ?<span class="id" title="var">F2of</span> ⇒ <span class="id" title="var">xlet</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span> <span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xapp_nosubst" <span class="id" title="keyword">constr</span>(<span class="id" title="var">E</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a> <span class="id" title="var">E</span>; [ <span class="id" title="var">xsimpl</span> | <span class="id" title="var">xpull</span> ].<br/>
</div>

<div class="doc">
<span class="inlinecode"><span class="id" title="var">xwp</span></span> applys <span class="inlinecode"><span class="id" title="var">xwp_lemma</span></span>, then requests Coq to evaluate the <span class="inlinecode"><span class="id" title="var">wpgen</span></span>
    function. (For technical reasons, in the definition shown below we need to
    explicitly request the unfolding of <span class="inlinecode"><span class="id" title="var">wpgen_var</span></span>.) 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xwp" :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xwp_lemma"><span class="id" title="lemma">xwp_lemma</span></a>;<br/>
&nbsp;&nbsp;[ <span class="id" title="tactic">first</span> [ <span class="id" title="tactic">reflexivity</span> | <span class="id" title="var">eassumption</span> ]<br/>
&nbsp;&nbsp;| <span class="id" title="tactic">simpl</span>; <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a>; <span class="id" title="tactic">simpl</span> ].<br/>
</div>

<div class="doc">
Now let us revisit the previous proof scripts using x-tactics instead of
    x-lemmas. The reader is invited to contemplate the gain in conciseness. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithXtactics" class="idref" href="#ProofsWithXtactics"><span class="id" title="module">ProofsWithXtactics</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="Rules.html#ExamplePrograms"><span class="id" title="module">ExamplePrograms</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXtactics.triple_incr" class="idref" href="#ProofsWithXtactics.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:197" class="idref" href="#p:197"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:198" class="idref" href="#n:198"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:197"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:197"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:198"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:197"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:198"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <a class="idref" href="Rules.html#triple_get"><span class="id" title="lemma">triple_get</span></a>. <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <a class="idref" href="Rules.html#triple_add"><span class="id" title="lemma">triple_add</span></a>. <span class="id" title="tactic">intros</span> ? →.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <a class="idref" href="Rules.html#triple_set"><span class="id" title="axiom">triple_set</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab348"></a><h4 class="section">Exercise: 2 stars, standard, especially useful (triple_succ_using_incr_with_xtactics)</h4>
 Using x-tactics, prove <span class="inlinecode"><span class="id" title="var">succ_using_incr</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithXtactics.triple_succ_using_incr_with_xtactics" class="idref" href="#ProofsWithXtactics.triple_succ_using_incr_with_xtactics"><span class="id" title="lemma">triple_succ_using_incr_with_xtactics</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:199" class="idref" href="#n:199"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.succ_using_incr"><span class="id" title="definition">succ_using_incr</span></a> <a class="idref" href="WPgen.html#n:199"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="v:200" class="idref" href="#v:200"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#v:200"><span class="id" title="variable">v</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:199"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithXtactics"><span class="id" title="module">ProofsWithXtactics</span></a>.<br/>
</div>

<div class="doc">
<a id="lab349"></a><h3 class="section">Improved Postprocessing for <span class="inlinecode"><span class="id" title="var">xapp</span></span>.</h3>

<div class="paragraph"> </div>

 The above proofs frequently exhibit the patterns <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode">?</span> <span class="inlinecode">→</span> or
    <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode">?</span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">→</span> for some variable <span class="inlinecode"><span class="id" title="var">x</span></span>. This pattern is typically occurs
    whenever the specification of the function being called in the code features
    a postcondition of the form <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">v</span></span> <span class="inlinecode">=</span> <span class="inlinecode">..]</span> or of the form
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">v</span></span> <span class="inlinecode">=</span> <span class="inlinecode">..]</span> <span class="inlinecode"><span class='gray-font'>\</span>*</span> <span class="inlinecode">..</span>. Let us devise a tactic called <span class="inlinecode"><span class="id" title="var">xapp</span></span> to
    automatically handle this pattern.

<div class="paragraph"> </div>

    The pattern in its implementation matches on the shape of the goal being
    produced by a call to <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span>. It attempts to perform the
    introduction and the substitution. The reader need not follow through the
    details of this Ltac definition. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xapp_try_subst" := <span class="comment">(*&nbsp;for&nbsp;internal&nbsp;use&nbsp;only&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="tactic">try</span> <span class="id" title="keyword">match</span> <span class="id" title="keyword">goal</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">∀</span> (<a id="r:202" class="idref" href="#r:202"><span class="id" title="binder">r</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>), <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#r:201"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="var">_</span> ⇒ <span class="id" title="tactic">intros</span> ? →<br/>
&nbsp;&nbsp;| &#x22A2; <span class="id" title="keyword">∀</span> (<a id="r:205" class="idref" href="#r:205"><span class="id" title="binder">r</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>), <span class="id" title="keyword">∀</span> <a id="x:206" class="idref" href="#x:206"><span class="id" title="binder">x</span></a>, <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#r:203"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <span class="id" title="var">_</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="var">_</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">y</span> := <span class="id" title="tactic">fresh</span> <span class="id" title="var">x</span> <span class="id" title="keyword">in</span> <span class="id" title="tactic">intros</span> ? <span class="id" title="var">y</span> <span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span>; <span class="id" title="var">revert</span> <span class="id" title="var">y</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xapp" <span class="id" title="keyword">constr</span>(<span class="id" title="var">E</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span> <span class="id" title="var">E</span>; <span class="id" title="var">xapp_try_subst</span>.<br/>
</div>

<div class="doc">
<a id="lab350"></a><h3 class="section">Database of Specification Lemmas for the <span class="inlinecode"><span class="id" title="var">xapp</span></span> Tactic.</h3>

<div class="paragraph"> </div>

 Explicitly providing arguments to <span class="inlinecode"><span class="id" title="var">xapp_nosubst</span></span> or <span class="inlinecode"><span class="id" title="var">xapp</span></span> is tedious. To
    avoid this effort, we set up a database of specification lemmas. Using this
    database, <span class="inlinecode"><span class="id" title="var">xapp</span></span> can automatically look up the relevant specification. The
    actual CFML tool uses a proper lookup table binding function names to
    specification lemmas. In this course, however, we'll rely on a simpler
    mechanism, based on standard hints for <span class="inlinecode"><span class="id" title="tactic">eauto</span></span>. In this setting, we can
    register specification lemmas using the <span class="inlinecode"><span class="id" title="keyword">Hint</span></span> <span class="inlinecode"><span class="id" title="keyword">Resolve</span></span> <span class="inlinecode">...</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">triple</span></span> command,
    as illustrated below. 
</div>
<div class="code">

#[<span class="id" title="var">global</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Resolve</span> <span class="id" title="var">triple_get</span> <span class="id" title="var">triple_set</span> <span class="id" title="var">triple_ref</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">triple_free</span> <span class="id" title="var">triple_add</span> : <span class="id" title="var">triple</span>.<br/>
</div>

<div class="doc">
The argument-free variants <span class="inlinecode"><span class="id" title="var">xapp_subst</span></span> and <span class="inlinecode"><span class="id" title="var">xapp</span></span> are implemented by
    invoking <span class="inlinecode"><span class="id" title="tactic">eauto</span></span> <span class="inlinecode"><span class="id" title="keyword">with</span></span> <span class="inlinecode"><span class="id" title="var">triple</span></span> to retrieve the relevant specification.

<div class="paragraph"> </div>

    One shortcoming of the version of the <span class="inlinecode"><span class="id" title="var">xapp</span></span> tactic that leverages the
    <span class="inlinecode"><span class="id" title="var">triple</span></span> database is that it is not able to automatically apply
    specifications that involve a premise that <span class="inlinecode"><span class="id" title="tactic">eauto</span></span> cannot solve. To exploit
    such specifications, we need to provide the specification explicitly using
    <span class="inlinecode"><span class="id" title="var">xapp</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>. This tactic is defined in <span class="inlinecode"><span class="id" title="var">LibSepReference.v</span></span>. Its implementation
    is a bit technical, we do not describe it here. 
</div>
<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xapp_nosubst" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>;<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xapp_lemma"><span class="id" title="lemma">xapp_lemma</span></a>; [ <span class="id" title="tactic">solve</span> [ <span class="id" title="tactic">eauto</span> <span class="id" title="keyword">with</span> <span class="id" title="var">triple</span> ] | <span class="id" title="var">xsimpl</span> | <span class="id" title="var">xpull</span> ].<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xapp" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp_nosubst</span>; <span class="id" title="var">xapp_try_subst</span>.<br/>
</div>

<div class="doc">
<a id="lab351"></a><h3 class="section">Demo of Verification using X-tactics</h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithAdvancedXtactics" class="idref" href="#ProofsWithAdvancedXtactics"><span class="id" title="module">ProofsWithAdvancedXtactics</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="Rules.html#ExamplePrograms"><span class="id" title="module">ExamplePrograms</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
The tactics defined in the previous sections may be used to complete proofs
    like done in the first two chapters of the course. For example, here is the
    proof of the increment function. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ProofsWithAdvancedXtactics.triple_incr" class="idref" href="#ProofsWithAdvancedXtactics.triple_incr"><span class="id" title="lemma">triple_incr</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:207" class="idref" href="#p:207"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:208" class="idref" href="#n:208"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:207"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:207"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:208"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:207"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:208"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">global</span>] <span class="id" title="keyword">Hint</span> <span class="id" title="keyword">Resolve</span> <span class="id" title="var">triple_incr</span> : <span class="id" title="var">triple</span>.<br/>
</div>

<div class="doc">
In summary, we have shown how to leverage <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, x-lemmas and x-tactics to
    implement the core of a practical verification framework based on Separation
    Logic. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithAdvancedXtactics"><span class="id" title="module">ProofsWithAdvancedXtactics</span></a>.<br/>
</div>

<div class="doc">
<a id="lab352"></a><h2 class="section">Reasoning about Local Functions</h2>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ExampleLocalFunWpgen" class="idref" href="#ExampleLocalFunWpgen"><span class="id" title="module">ExampleLocalFunWpgen</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="LibSepReference.html#DemoPrograms"><span class="id" title="module">DemoPrograms</span></a> <a class="idref" href="WPgen.html#WpgenExec2"><span class="id" title="module">WpgenExec2</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/>
</div>

<div class="doc">
Consider the following program, which defines a local function named <span class="inlinecode"><span class="id" title="var">f</span></span> for
    incrementing a reference cell <span class="inlinecode"><span class="id" title="var">p</span></span>, then invokes <span class="inlinecode"><span class="id" title="var">f</span>()</span> twice. The purpose of
    this example is to illustrate how to reason about a local function.

<div class="paragraph"> </div>

<span class="inlinecode-ocaml">&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">p</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">f</span> = (<span class="id" title="keyword">fun</span> () → <span class="id" title="var">incr</span> <span class="id" title="var">p</span>) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">f</span>();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">f</span>()
</span>
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="ExampleLocalFunWpgen.incrtwice" class="idref" href="#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">&lt;{</span></a> <a class="idref" href="LibSepReference.html#580b26347bf7760f2fc76a1944e0af<sub>93</sub>"><span class="id" title="notation">fun</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''p'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''p'"><span class="id" title="notation">p</span></a> <a class="idref" href="LibSepReference.html#580b26347bf7760f2fc76a1944e0af<sub>93</sub>"><span class="id" title="notation">⇒</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">let</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#2b10480be1a1611f7c8b850ecabd4776"><span class="id" title="notation">(</span></a><a class="idref" href="LibSepReference.html#18e506bfe2d719eeaa6cccd947a89ba<sub>6</sub>"><span class="id" title="notation">fun_</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''u'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''u'"><span class="id" title="notation">u</span></a> <a class="idref" href="LibSepReference.html#18e506bfe2d719eeaa6cccd947a89ba<sub>6</sub>"><span class="id" title="notation">⇒</span></a> <a class="idref" href="LibSepReference.html#DemoPrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''p'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''p'"><span class="id" title="notation">p</span></a><a class="idref" href="LibSepReference.html#2b10480be1a1611f7c8b850ecabd4776"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">in</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepReference.html#71337baa9b3f1f61552031a8e9cb9237"><span class="id" title="notation">()</span></a><a class="idref" href="LibSepReference.html#56accb00428c2a6753c1055752721c<sub>75</sub>"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepReference.html#71337baa9b3f1f61552031a8e9cb9237"><span class="id" title="notation">()</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">}&gt;</span></a>.<br/>
</div>

<div class="doc">
There are two possible approaches to reasoning about this code.

<div class="paragraph"> </div>

    In the first approach, we store the hypothesis capturing that <span class="inlinecode"><span class="id" title="var">f</span></span> has for
    code <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">()</span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span></span>, and each time we encounter a call to <span class="inlinecode"><span class="id" title="var">f</span></span>, we
    "inline" the code of <span class="inlinecode"><span class="id" title="var">f</span></span> at the call site. This approach is very effective
    when <span class="inlinecode"><span class="id" title="var">f</span></span> has a unique occurrence. However, if <span class="inlinecode"><span class="id" title="var">f</span></span> has multiple occurrences,
    then the user has to reason several times about the same code pattern.

<div class="paragraph"> </div>

    The second approach yields a modular proof. When reasoning about the
    definition of <span class="inlinecode"><span class="id" title="var">f</span></span>, we assert and prove a specification for <span class="inlinecode"><span class="id" title="var">f</span></span>, then
    immediately discard any information revealing what the code of <span class="inlinecode"><span class="id" title="var">f</span></span> is. Then,
    each time we encounter a call to <span class="inlinecode"><span class="id" title="var">f</span></span>, we use <span class="inlinecode"><span class="id" title="var">xapp</span></span> to leverage the
    specification of the local function <span class="inlinecode"><span class="id" title="var">f</span></span>, exactly like we have been doing
    everywhere for reasoning about calls to top-level functions.

<div class="paragraph"> </div>

    Let us illustrate the two approaches, and introduce on the way a few
    additional x-tactics relevant for local functions. 
</div>

<div class="doc">
<a id="lab353"></a><h3 class="section">1. Reasoning about Local Functions by Inlining</h3>

<div class="paragraph"> </div>

 To begin with, let us naively attempt to use the tactics <span class="inlinecode"><span class="id" title="var">xlet</span></span> and <span class="inlinecode"><span class="id" title="var">xval</span></span>
    to reason about the function definitions. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_incrtwice_using_xval" class="idref" href="#ExampleLocalFunWpgen.triple_incrtwice_using_xval"><span class="id" title="lemma">triple_incrtwice_using_xval</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:209" class="idref" href="#p:209"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:210" class="idref" href="#n:210"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:209"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:209"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:210"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:209"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:210"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
</div>

<div class="doc">
At this point, we have the formula for the body of the function <span class="inlinecode"><span class="id" title="var">incrtwice</span></span>,
    which binds (under the name <span class="inlinecode"><span class="id" title="var">v</span></span>) the value <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xlet</span>.<br/>
</div>

<div class="doc">
By typing <span class="inlinecode"><span class="id" title="var">xlet</span></span>, we focus on this value <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span>. The tactic
    <span class="inlinecode"><span class="id" title="var">xval</span></span> then substitutes this value throughout the remaining of the formula.
    
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xval</span>.<br/>
</div>

<div class="doc">
Because the body of <span class="inlinecode"><span class="id" title="var">incrtwice</span></span> contains two calls to the local function
    <span class="inlinecode"><span class="id" title="var">f</span></span>, the resulting formula contains two copies of the function
    <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span>. This kind of duplication, in general, is
    problematic, because the size of the formulae grow significantly. 
</div>
<div class="code">
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
We therefore introduce a variant of the <span class="inlinecode"><span class="id" title="var">xlet</span></span> tactic, called <span class="inlinecode"><span class="id" title="var">xletval</span></span>,
    that processes let-bindings by introducing an equality in the Coq context.
    For example, for our local function <span class="inlinecode"><span class="id" title="var">f</span></span>, a fresh hypothesis named <span class="inlinecode"><span class="id" title="var">f</span></span> of
    type <span class="inlinecode"><span class="id" title="var">val</span></span> is introduced, and an hypothesis of type asserting that <span class="inlinecode"><span class="id" title="var">f</span></span> is
    equal to <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span> is provided to characterize the value <span class="inlinecode"><span class="id" title="var">f</span></span>.
    Let us first defined the tactic <span class="inlinecode"><span class="id" title="var">xval</span></span>, then illustrate its usage. 
<div class="paragraph"> </div>

 The tactic <span class="inlinecode"><span class="id" title="var">xletval</span></span> applies to formulae arising from terms of the form
    <span class="inlinecode"><span class="id" title="keyword">let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. It processes the binding <span class="inlinecode"><span class="id" title="keyword">let</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span> by introducing in
    the goal a universal quantification over a variable <span class="inlinecode"><span class="id" title="var">x</span></span> and over an
    hypothesis of type <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">=</span> <span class="inlinecode"><span class="id" title="var">v<sub>1</sub></span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.xletval_lemma" class="idref" href="#ExampleLocalFunWpgen.xletval_lemma"><span class="id" title="lemma">xletval_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H:211" class="idref" href="#H:211"><span class="id" title="binder">H</span></a> <a id="v<sub>1</sub>:212" class="idref" href="#v<sub>1</sub>:212"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="F2of:213" class="idref" href="#F2of:213"><span class="id" title="binder">F2of</span></a> <a id="Q:214" class="idref" href="#Q:214"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="x:215" class="idref" href="#x:215"><span class="id" title="binder">x</span></a>, <a class="idref" href="WPgen.html#x:215"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:212"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="WPgen.html#H:211"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F2of:213"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#x:215"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#Q:214"><span class="id" title="variable">Q</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:211"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:212"><span class="id" title="variable">v<sub>1</sub></span></a>)) <a class="idref" href="WPgen.html#F2of:213"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#Q:214"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xlet_lemma"><span class="id" title="lemma">xlet_lemma</span></a>. <span class="id" title="tactic">apply</span> <a class="idref" href="WPgen.html#xstruct_lemma"><span class="id" title="lemma">xstruct_lemma</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <a class="idref" href="WPgen.html#xval_lemma"><span class="id" title="lemma">xval_lemma</span></a>. <span class="id" title="var">applys</span>* <span class="id" title="var">M</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xletval" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen.xletval_lemma"><span class="id" title="lemma">xletval_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_incrtwice_using_xletval" class="idref" href="#ExampleLocalFunWpgen.triple_incrtwice_using_xletval"><span class="id" title="lemma">triple_incrtwice_using_xletval</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:216" class="idref" href="#p:216"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:217" class="idref" href="#n:217"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:216"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:216"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:217"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:216"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:217"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>. <span class="id" title="var">xletval</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">f</span> <span class="id" title="var">Hf</span>.<br/>
</div>

<div class="doc">
As announced, reasoning about the local function definition using <span class="inlinecode"><span class="id" title="var">xletval</span></span>
    introduces a name <span class="inlinecode"><span class="id" title="var">f</span></span> and an hypothesis <span class="inlinecode"><span class="id" title="var">Hf</span></span> of type
    <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode">=</span> <span class="inlinecode">&lt;{</span> <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span> <span class="inlinecode">}&gt;</span>  There remains to reason about calls to the function <span class="inlinecode"><span class="id" title="var">f</span></span>. Let us first show
    how it could be done step by step. We will subsequently define a tactic,
    named <span class="inlinecode"><span class="id" title="var">xappfun</span></span>, to improve conciseness. To reason about the remaining of
    the code of <span class="inlinecode"><span class="id" title="var">incrtwice</span></span>, we begin by focusing on the first call to <span class="inlinecode"><span class="id" title="var">f</span>()</span>,
    using <span class="inlinecode"><span class="id" title="var">xseq</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xseq</span>.<br/>
</div>

<div class="doc">
At this stage, we can remove the leading <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>, unfold the definition
    of <span class="inlinecode"><span class="id" title="var">wgpgen_app</span></span>, and simplify the resulting statement using <span class="inlinecode"><span class="id" title="var">xsimpl</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xstruct</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a>. <span class="id" title="var">xsimpl</span>.<br/>
</div>

<div class="doc">
We are left with proving that <span class="inlinecode"><span class="id" title="var">f</span>()</span> admits a certain behaviour, under the
    hypothesis that the code of <span class="inlinecode"><span class="id" title="var">f</span></span> is <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span>. We can make
    progress by invoking the tactic <span class="inlinecode"><span class="id" title="var">xwp</span></span>, exactly as we do for reasoning about
    top-level functions. 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
</div>

<div class="doc">
There remains to reason about the code from the body of the function <span class="inlinecode"><span class="id" title="var">f</span></span>,
    that is, the instruction <span class="inlinecode"><span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span></span>. We can use <span class="inlinecode"><span class="id" title="var">xapp</span></span> for that purpose. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xapp</span>.<br/>
</div>

<div class="doc">
We could similarly handle the second call to <span class="inlinecode"><span class="id" title="var">f</span></span>, then complete the proof.
    Let us show how to do so in the next lemma, after introducing a tactic to
    factorize the proof pattern for reasoning about calls to local functions. 
</div>
<div class="code">
<span class="id" title="keyword">Abort</span>.<br/>
</div>

<div class="doc">
The tactic <span class="inlinecode"><span class="id" title="var">xappfun</span></span> applies to formulae arising from function calls of the
    form <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span> where <span class="inlinecode"><span class="id" title="var">f</span></span> is a local function previously handled using <span class="inlinecode"><span class="id" title="var">xletval</span></span>.
    Essentially, this tactic inline the formula associated with the body of <span class="inlinecode"><span class="id" title="var">f</span></span>,
    specializing the body to the argument <span class="inlinecode"><span class="id" title="var">v</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.xappfun_lemma" class="idref" href="#ExampleLocalFunWpgen.xappfun_lemma"><span class="id" title="lemma">xappfun_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="t:218" class="idref" href="#t:218"><span class="id" title="binder">t</span></a> <a id="H:219" class="idref" href="#H:219"><span class="id" title="binder">H</span></a> <a id="Q:220" class="idref" href="#Q:220"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="WPgen.html#t:218"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#H:219"><span class="id" title="variable">H</span></a> <a class="idref" href="WPgen.html#Q:220"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:219"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> <a class="idref" href="WPgen.html#t:218"><span class="id" title="variable">t</span></a> <a class="idref" href="WPgen.html#Q:220"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a>. <span class="id" title="var">xsimpl</span>*. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xappfun" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen.xappfun_lemma"><span class="id" title="lemma">xappfun_lemma</span></a>; <span class="id" title="var">xwp</span>.<br/>
</div>

<div class="doc">
Let us revisit the previous proof using this new tactic <span class="inlinecode"><span class="id" title="var">xappfun</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_incrtwice_using_xletva_and_xapp_fun" class="idref" href="#ExampleLocalFunWpgen.triple_incrtwice_using_xletva_and_xapp_fun"><span class="id" title="lemma">triple_incrtwice_using_xletva_and_xapp_fun</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:221" class="idref" href="#p:221"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:222" class="idref" href="#n:222"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:221"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:221"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:222"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:221"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:222"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xletval</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">f</span> <span class="id" title="var">Hf</span>. <span class="comment">(*&nbsp;Reason&nbsp;about&nbsp;the&nbsp;definition&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">f</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xappfun</span>. <span class="comment">(*&nbsp;Reason&nbsp;about&nbsp;the&nbsp;1st&nbsp;call&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">f</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;Reason&nbsp;about&nbsp;the&nbsp;call&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">incr</span></span>&nbsp;triggered&nbsp;by&nbsp;the&nbsp;1st&nbsp;call&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">f</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xappfun</span>. <span class="comment">(*&nbsp;Reason&nbsp;about&nbsp;the&nbsp;2nd&nbsp;call&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">f</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;Reason&nbsp;about&nbsp;the&nbsp;call&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">incr</span></span>&nbsp;triggered&nbsp;by&nbsp;the&nbsp;2nd&nbsp;call&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">f</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>. <span class="id" title="var">math</span>. <span class="comment">(*&nbsp;Conclude&nbsp;the&nbsp;proof.&nbsp;*)</span><br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
This completes the presentation of the first approach. As illustrated in the
    example proof above, reasoning twice about the body of the function <span class="inlinecode"><span class="id" title="var">f</span></span>
    leads to some duplication. The second approach shows how to avoid
    duplication, by stating and proving a specification for <span class="inlinecode"><span class="id" title="var">f</span></span>. 
</div>

<div class="doc">
<a id="lab354"></a><h3 class="section">2. Reasoning about Local Functions Modularly</h3>

<div class="paragraph"> </div>

 In the second approach, immediately after obtaining the hypothesis that <span class="inlinecode"><span class="id" title="var">f</span></span>
    has code <span class="inlinecode"><span class="id" title="keyword">fun</span></span> <span class="inlinecode">{&quot;<span class="id" title="var">u</span>&quot;}</span> <span class="inlinecode">⇒</span> <span class="inlinecode">{<span class="id" title="var">incr</span></span> <span class="inlinecode"><span class="id" title="var">p</span>}</span>, we establish a specification for <span class="inlinecode"><span class="id" title="var">f</span></span>,
    expressed using a triple, then discard the hypothesis about the code of <span class="inlinecode"><span class="id" title="var">f</span></span>.
    
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_incrtwice_with_assert" class="idref" href="#ExampleLocalFunWpgen.triple_incrtwice_with_assert"><span class="id" title="lemma">triple_incrtwice_with_assert</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:223" class="idref" href="#p:223"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:224" class="idref" href="#n:224"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:223"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:223"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:224"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:223"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:224"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
</div>

<div class="doc">
We begin the proof like the previous one. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xwp</span>. <span class="id" title="var">xletval</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">f</span> <span class="id" title="var">Hf</span>.<br/>
</div>

<div class="doc">
As soon as <span class="inlinecode"><span class="id" title="var">f</span></span> is introduced, we assert the specification of this function.
    
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="tactic">assert</span> (<span class="id" title="var">Sf</span> : <span class="id" title="keyword">∀</span> (<a id="m:226" class="idref" href="#m:226"><span class="id" title="binder">m</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">&lt;{</span></a> <span class="id" title="var">f</span> <a class="idref" href="LibSepReference.html#71337baa9b3f1f61552031a8e9cb9237"><span class="id" title="notation">()</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">}&gt;</span></a> (<span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:225"><span class="id" title="variable">m</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#m:225"><span class="id" title="variable">m</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>)). {<br/>
</div>

<div class="doc">
To establish this specification, we inline the code of <span class="inlinecode"><span class="id" title="var">f</span></span>. This is the one
    and only place where we inline the code of <span class="inlinecode"><span class="id" title="var">f</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">subst</span> <span class="id" title="var">f</span>.<br/>
</div>

<div class="doc">
Then, we complete the verification of <span class="inlinecode"><span class="id" title="var">f</span></span> as usual. 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xwp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xsimpl</span>. }<br/>
</div>

<div class="doc">
We have introduced an hypothesis <span class="inlinecode"><span class="id" title="var">Sf</span></span> that characterizes the behavior of <span class="inlinecode"><span class="id" title="var">f</span></span>
    by means of a triple. We can drop the hypothesis about the code of <span class="inlinecode"><span class="id" title="var">f</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">Hf</span>.<br/>
</div>

<div class="doc">
The remaining of the proof now proceeds just like if <span class="inlinecode"><span class="id" title="var">f</span></span> was a top-level
    function, using <span class="inlinecode"><span class="id" title="var">xapp</span></span> for reasoning about each call to <span class="inlinecode"><span class="id" title="var">f</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xapp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">math</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
The tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> applies to a formula arising from terms of the form
    <span class="inlinecode"><span class="id" title="keyword">let</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode">=</span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">→</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>2</sub></span></span>. This tactic simulates the invokation of
    <span class="inlinecode"><span class="id" title="tactic">assert</span></span> over the desired specification for <span class="inlinecode"><span class="id" title="var">f</span></span>. The tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> takes as
    argument the desired specification for the function. For example, in the
    proof of <span class="inlinecode"><span class="id" title="var">incrtwice</span></span> we will use a call of the form:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xfun</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">f</span> ⇒ <span class="id" title="keyword">∀</span> (<span class="id" title="var">m</span>:<span class="id" title="var">int</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">triple</span> &lt;{ <span class="id" title="var">f</span> () }&gt; (<span class="id" title="var">p</span> ~~&gt; <span class="id" title="var">m</span>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">p</span> ~~&gt; (<span class="id" title="var">m</span>+1)))
</span>
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.xfun_lemma" class="idref" href="#ExampleLocalFunWpgen.xfun_lemma"><span class="id" title="lemma">xfun_lemma</span></a> : <span class="id" title="keyword">∀</span> (<a id="Sof:227" class="idref" href="#Sof:227"><span class="id" title="binder">Sof</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><span class="id" title="keyword">Prop</span>) <a id="H:228" class="idref" href="#H:228"><span class="id" title="binder">H</span></a> <a id="v<sub>1</sub>:229" class="idref" href="#v<sub>1</sub>:229"><span class="id" title="binder">v<sub>1</sub></span></a> <a id="F2of:230" class="idref" href="#F2of:230"><span class="id" title="binder">F2of</span></a> <a id="Q:231" class="idref" href="#Q:231"><span class="id" title="binder">Q</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Sof:227"><span class="id" title="variable">Sof</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:229"><span class="id" title="variable">v<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="x:232" class="idref" href="#x:232"><span class="id" title="binder">x</span></a>, <a class="idref" href="WPgen.html#Sof:227"><span class="id" title="variable">Sof</span></a> <a class="idref" href="WPgen.html#x:232"><span class="id" title="variable">x</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="WPgen.html#H:228"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#F2of:230"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#x:232"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#Q:231"><span class="id" title="variable">Q</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:228"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> (<a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <a class="idref" href="WPgen.html#v<sub>1</sub>:229"><span class="id" title="variable">v<sub>1</sub></span></a>)) <a class="idref" href="WPgen.html#F2of:230"><span class="id" title="variable">F2of</span></a> <a class="idref" href="WPgen.html#Q:231"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="id" title="var">introv</span> <span class="id" title="var">Sf</span> <span class="id" title="var">M</span>. <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen.xletval_lemma"><span class="id" title="lemma">xletval_lemma</span></a>. <span class="id" title="tactic">intros</span> ? →. <span class="id" title="var">applys</span>* <span class="id" title="var">M</span>. <span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xfun" <span class="id" title="keyword">constr</span>(<span class="id" title="var">Sof</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">f</span> := <span class="id" title="tactic">fresh</span> <span class="id" title="keyword">in</span> <span class="id" title="keyword">let</span> <span class="id" title="var">Hf</span> := <span class="id" title="tactic">fresh</span> <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> (@<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.xfun_lemma"><span class="id" title="lemma">xfun_lemma</span></a> <span class="id" title="var">Sof</span>).<br/>
</div>

<div class="doc">
We are ready, at last, to show an elegant proof script for <span class="inlinecode"><span class="id" title="var">incrtwice</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_incrtwice_with_xfun" class="idref" href="#ExampleLocalFunWpgen.triple_incrtwice_with_xfun"><span class="id" title="lemma">triple_incrtwice_with_xfun</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:233" class="idref" href="#p:233"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:234" class="idref" href="#n:234"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:233"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:233"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:234"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:233"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:234"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
</div>

<div class="doc">
The key step is to invoke <span class="inlinecode"><span class="id" title="var">xfun</span></span> by providing the desired specification for
    the local function <span class="inlinecode"><span class="id" title="var">f</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xfun</span> (<span class="id" title="keyword">fun</span> (<a id="f:237" class="idref" href="#f:237"><span class="id" title="binder">f</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>) ⇒ <span class="id" title="keyword">∀</span> (<a id="m:238" class="idref" href="#m:238"><span class="id" title="binder">m</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">&lt;{</span></a> <a class="idref" href="WPgen.html#f:235"><span class="id" title="variable">f</span></a> <a class="idref" href="LibSepReference.html#71337baa9b3f1f61552031a8e9cb9237"><span class="id" title="notation">()</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">}&gt;</span></a> (<span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:236"><span class="id" title="variable">m</span></a>) (<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#m:236"><span class="id" title="variable">m</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>)).<br/>
</div>

<div class="doc">
The verification of the local function <span class="inlinecode"><span class="id" title="var">f</span></span> is similar to that of any
    top-level function. 
</div>
<div class="code">
&nbsp;&nbsp;{ <span class="id" title="var">xwp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xsimpl</span>. }<br/>
</div>

<div class="doc">
There remains to assign a name to the function and its specification. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">f</span> <span class="id" title="var">Sf</span>.<br/>
</div>

<div class="doc">
The rest of the proof is the same as before. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xapp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">math</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
In summary, we have presented the tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> for reasoning about local
    functions using the exact same mechanisms as for reasoning about top-level
    functions. The only difference is that the specification is not provided by
    the user as a lemma, but as an argument to <span class="inlinecode"><span class="id" title="var">xfun</span></span>. Using the tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span>
    leads to modular proofs, whereby the body of the local function is only
    processed once by the user. 
</div>

<div class="doc">
<a id="lab355"></a><h3 class="section">3. Exercises on Local Functions</h3>

<div class="paragraph"> </div>

 This section presents an exercice involving the verification of a program
    featuring a simple local functions, which consists of the 'successor'
    function.

<div class="paragraph"> </div>

<span class="inlinecode-ocaml">&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">n</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">f</span> = (<span class="id" title="keyword">fun</span> <span class="id" title="var">m</span> → <span class="id" title="var">m</span> + 1) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">a</span> = <span class="id" title="var">f</span> 2 <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">f</span> <span class="id" title="var">a</span>
</span>
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="ExampleLocalFunWpgen.succtwice" class="idref" href="#ExampleLocalFunWpgen.succtwice"><span class="id" title="definition">succtwice</span></a> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">&lt;{</span></a> <a class="idref" href="LibSepReference.html#580b26347bf7760f2fc76a1944e0af<sub>93</sub>"><span class="id" title="notation">fun</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''n'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''n'"><span class="id" title="notation">n</span></a> <a class="idref" href="LibSepReference.html#580b26347bf7760f2fc76a1944e0af<sub>93</sub>"><span class="id" title="notation">⇒</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">let</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#2b10480be1a1611f7c8b850ecabd4776"><span class="id" title="notation">(</span></a><a class="idref" href="LibSepReference.html#18e506bfe2d719eeaa6cccd947a89ba<sub>6</sub>"><span class="id" title="notation">fun_</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''m'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''m'"><span class="id" title="notation">m</span></a> <a class="idref" href="LibSepReference.html#18e506bfe2d719eeaa6cccd947a89ba<sub>6</sub>"><span class="id" title="notation">⇒</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''m'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''m'"><span class="id" title="notation">m</span></a> <a class="idref" href="LibSepReference.html#590da34eb63eef1c68773c655749c128"><span class="id" title="notation">+</span></a> 1<a class="idref" href="LibSepReference.html#2b10480be1a1611f7c8b850ecabd4776"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">in</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">let</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">a</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''n'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''n'"><span class="id" title="notation">n</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">in</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">a</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">}&gt;</span></a>.<br/>
</div>

<div class="doc">
<a id="lab356"></a><h4 class="section">Exercise: 2 stars, standard, optional (triple_succtwice_using_xletval)</h4>
 Verify the function <span class="inlinecode"><span class="id" title="var">succtwice</span></span> using <span class="inlinecode"><span class="id" title="var">xletval</span></span> and <span class="inlinecode"><span class="id" title="var">xappfun</span></span>, without using
    <span class="inlinecode"><span class="id" title="var">xfun</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_succtwice_using_xletval" class="idref" href="#ExampleLocalFunWpgen.triple_succtwice_using_xletval"><span class="id" title="lemma">triple_succtwice_using_xletval</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:239" class="idref" href="#n:239"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.succtwice"><span class="id" title="definition">succtwice</span></a> <a class="idref" href="WPgen.html#n:239"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="r:240" class="idref" href="#r:240"><span class="id" title="binder">r</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#r:240"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:239"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a> 2<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

<a id="lab357"></a><h4 class="section">Exercise: 2 stars, standard, optional (triple_succtwice_using_xfun)</h4>
 Verify the function <span class="inlinecode"><span class="id" title="var">succtwice</span></span> using <span class="inlinecode"><span class="id" title="var">xfun</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="ExampleLocalFunWpgen.triple_succtwice_using_xfun" class="idref" href="#ExampleLocalFunWpgen.triple_succtwice_using_xfun"><span class="id" title="lemma">triple_succtwice_using_xfun</span></a> : <span class="id" title="keyword">∀</span> (<a id="n:241" class="idref" href="#n:241"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#ExampleLocalFunWpgen.succtwice"><span class="id" title="definition">succtwice</span></a> <a class="idref" href="WPgen.html#n:241"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#0a700e54c124035039013e87e1a2bcaa"><span class="id" title="notation"><span class='gray-font'>\</span>[]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="r:242" class="idref" href="#r:242"><span class="id" title="binder">r</span></a> ⇒ <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><a class="idref" href="WPgen.html#r:242"><span class="id" title="variable">r</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#n:241"><span class="id" title="variable">n</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a> 2<a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 A more challenging exercise, named <span class="inlinecode"><span class="id" title="var">forloop</span></span>, may be found near the end of
    the chapter. It can be resolved using the tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span>, even without
    reading all the text from the 'optional material' section. 
</div>
<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen"><span class="id" title="module">ExampleLocalFunWpgen</span></a>.<br/>
</div>

<div class="doc">
<a id="lab358"></a><h2 class="section">Proof Structure and Proof Automation</h2>

<div class="paragraph"> </div>

 When looking at a proof of the form <span class="inlinecode"><span class="id" title="var">xwp</span>.</span> <span class="inlinecode"><span class="id" title="var">xapp</span>.</span> <span class="inlinecode"><span class="id" title="var">xapp</span>.</span> <span class="inlinecode"><span class="id" title="var">xapp</span>.</span> <span class="inlinecode"><span class="id" title="var">xsimpl</span>.</span>, where
    the application of tactics is fully directed by the code to be verified, one
    might wander why we do not take x-tactics one step further in terms of
    automation. Concretely, why not introduce a tactic for repeatedly applying
    the relevant x-tactics as far as possible?

<div class="paragraph"> </div>

    Such a tactic -- let's call it <span class="inlinecode"><span class="id" title="var">xgo</span></span> -- can indeed be defined, and can prove
    handy for proving short programs compactly. However, it often turns out to
    be counterproductive when verifying nontrivial programs. Let us explain why.

<div class="paragraph"> </div>

    In a nontrivial proof, calls to x-tactics do not appear in sequence: they
    are interleaved with conventional Coq tactics for discharging side
    conditions. Typically, when reasoning about a function whose specification
    contains preconditions, <span class="inlinecode"><span class="id" title="var">xapp</span></span> generates one subgoal for each precondition.
    Now, suppose that we have a sequence made of 3 such function calls. The
    proof script would look like:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xapp</span>. { <span class="id" title="var">prove_side_1_1</span>. } { <span class="id" title="var">prove_side_1_2</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xapp</span>. { <span class="id" title="var">prove_side_2_1</span>. } { <span class="id" title="var">prove_side_2_2</span>. } { <span class="id" title="var">prove_side_2_3</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xapp</span>. { <span class="id" title="var">prove_side_3_1</span>. } { <span class="id" title="var">prove_side_3_2</span>. } { <span class="id" title="var">prove_side_3_3</span>. }
</span>
<div class="paragraph"> </div>

    If we use <span class="inlinecode"><span class="id" title="var">xgo</span></span> instead of 3 calls to <span class="inlinecode"><span class="id" title="var">xapp</span></span>, we replace 3 calls to <span class="inlinecode"><span class="id" title="var">xapp</span></span>
    with a single call to <span class="inlinecode"><span class="id" title="var">xgo</span></span>, which may seem at first sight like to be
    improvement. However, the proof script now looks like:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xgo</span>. { <span class="id" title="var">prove_side_1_1</span>. } { <span class="id" title="var">prove_side_1_2</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">prove_side_2_1</span>. } { <span class="id" title="var">prove_side_2_2</span>. } { <span class="id" title="var">prove_side_2_3</span>. }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;{ <span class="id" title="var">prove_side_3_1</span>. } { <span class="id" title="var">prove_side_3_2</span>. } { <span class="id" title="var">prove_side_3_3</span>. }
</span>
<div class="paragraph"> </div>

    With <span class="inlinecode"><span class="id" title="var">xgo</span></span>, all the side-conditions are produced at once. Why is this a
    problem? Well suppose that either the code or the specifications of the
    functions being called are later modified. When we re-play the proof script
    with <span class="inlinecode"><span class="id" title="var">xgo</span></span>, a number of proof obligations will be added, others will be
    removed. The user will have no obvious way of associating proof obligations
    with the function call they arise from. In summary, in nontrivial proofs,
    the use of <span class="inlinecode"><span class="id" title="var">xgo</span></span> just to make the proof script a tiny bit more concise makes
    proof scripts much harder to maintain.

<div class="paragraph"> </div>

    One way to make proof script more concise without harming maintainability is
    to use a tactic call <span class="inlinecode"><span class="id" title="var">xstep</span></span>. A call to <span class="inlinecode"><span class="id" title="var">xstep</span></span> <span class="inlinecode"><span class="id" title="var">n</span></span> invokes <span class="inlinecode"><span class="id" title="var">n</span></span> times in a row
    the relevant x-tactic, with only the last of these x-tactics being allowed
    to produce subgoals. With <span class="inlinecode"><span class="id" title="var">xstep</span></span> <span class="inlinecode"><span class="id" title="var">n</span></span>, we are able to factorize consecutive
    calls to certain x-tactics, yet we are forced to keep all the x-tactics that
    participate in structuring the proof scripts.

<div class="paragraph"> </div>

    A useful generalization is the tactic <span class="inlinecode"><span class="id" title="var">xstep</span>*</span> <span class="inlinecode"><span class="id" title="var">n</span></span>, which is like <span class="inlinecode"><span class="id" title="var">xstep</span></span> <span class="inlinecode"><span class="id" title="var">n</span></span>
    except that the x-tactics before the last one are allowed to produce
    subgoals as long as these subgoals are all solved by automation. The tactic
    <span class="inlinecode"><span class="id" title="var">xgo</span>*</span> can now be defined as <span class="inlinecode"><span class="id" title="var">xstep</span>*</span> <span class="inlinecode"><span class="id" title="var">n</span></span> for the maximal possible value of
    <span class="inlinecode"><span class="id" title="var">n</span></span>, with a check that all the code has been processed, i.e., that the point
    of a <span class="inlinecode"><span class="id" title="var">xsimpl</span></span> has been reached. Examples of usage of <span class="inlinecode"><span class="id" title="var">xstep</span></span> and <span class="inlinecode"><span class="id" title="var">xgo</span></span> are
    beyond the scope of this course. 
</div>

<div class="doc">
<a id="lab359"></a><h1 class="section">Optional Material</h1>

</div>

<div class="doc">
<a id="lab360"></a><h2 class="section">Additional Tactics <span class="inlinecode"><span class="id" title="var">xconseq</span></span> and <span class="inlinecode"><span class="id" title="var">xframe</span></span></h2>

<div class="paragraph"> </div>

 The tactic <span class="inlinecode"><span class="id" title="var">xconseq</span></span> applies the weakening rule; from the perspective of the
    user, it replaces the current postcondition with a stronger one. Optionally,
    the tactic can be passed an explicit argument, using the syntax <span class="inlinecode"><span class="id" title="var">xconseq</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>.

<div class="paragraph"> </div>

    The tactic is implemented by applying the lemma <span class="inlinecode"><span class="id" title="var">xconseq_lemma</span></span>, stated
    below. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xconseq_lemma" class="idref" href="#xconseq_lemma"><span class="id" title="lemma">xconseq_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="Q<sub>1</sub>:243" class="idref" href="#Q<sub>1</sub>:243"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="Q<sub>2</sub>:244" class="idref" href="#Q<sub>2</sub>:244"><span class="id" title="binder">Q<sub>2</sub></span></a> <a id="H:245" class="idref" href="#H:245"><span class="id" title="binder">H</span></a> <a id="F:246" class="idref" href="#F:246"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:245"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:246"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:243"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:243"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:244"><span class="id" title="variable">Q<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:245"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:246"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>2</sub>:244"><span class="id" title="variable">Q<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
<a id="lab361"></a><h4 class="section">Exercise: 1 star, standard, optional (xconseq_lemma)</h4>
 Prove the <span class="inlinecode"><span class="id" title="var">xconseq_lemma</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xconseq" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xconseq_lemma"><span class="id" title="axiom">xconseq_lemma</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xconseq" <span class="id" title="keyword">constr</span>(<span class="id" title="var">Q</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#xconseq_lemma"><span class="id" title="axiom">xconseq_lemma</span></a> <span class="id" title="var">Q</span>.<br/>
</div>

<div class="doc">
The tactic <span class="inlinecode"><span class="id" title="var">xframe</span></span> enables applying the frame rule on a formula produced by
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span>. The syntax <span class="inlinecode"><span class="id" title="var">xframe</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> is used to specify the heap predicate to
    keep, and the syntax <span class="inlinecode"><span class="id" title="var">xframe_out</span></span> <span class="inlinecode"><span class="id" title="var">H</span></span> is used to specify the heap predicate to
    frame out---everything else is kept. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="xframe_lemma" class="idref" href="#xframe_lemma"><span class="id" title="lemma">xframe_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H<sub>1</sub>:247" class="idref" href="#H<sub>1</sub>:247"><span class="id" title="binder">H<sub>1</sub></span></a> <a id="H<sub>2</sub>:248" class="idref" href="#H<sub>2</sub>:248"><span class="id" title="binder">H<sub>2</sub></span></a> <a id="H:249" class="idref" href="#H:249"><span class="id" title="binder">H</span></a> <a id="Q:250" class="idref" href="#Q:250"><span class="id" title="binder">Q</span></a> <a id="Q<sub>1</sub>:251" class="idref" href="#Q<sub>1</sub>:251"><span class="id" title="binder">Q<sub>1</sub></span></a> <a id="F:252" class="idref" href="#F:252"><span class="id" title="binder">F</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:249"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#H<sub>1</sub>:247"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:248"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H<sub>1</sub>:247"><span class="id" title="variable">H<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:252"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q<sub>1</sub>:251"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#Q<sub>1</sub>:251"><span class="id" title="variable">Q<sub>1</sub></span></a> <a class="idref" href="LibSepReference.html#635f8491703dab9d0d18a6c2474b0d2a"><span class="id" title="notation"><span class='gray-font'>\</span>*+</span></a> <a class="idref" href="WPgen.html#H<sub>2</sub>:248"><span class="id" title="variable">H<sub>2</sub></span></a> <a class="idref" href="LibSepReference.html#9351a4f098e275023c32e0091e608189"><span class="id" title="notation">===&gt;</span></a> <a class="idref" href="WPgen.html#Q:250"><span class="id" title="variable">Q</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:249"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <a class="idref" href="WPgen.html#F:252"><span class="id" title="variable">F</span></a> <a class="idref" href="WPgen.html#Q:250"><span class="id" title="variable">Q</span></a>.<br/>
</div>

<div class="doc">
<a id="lab362"></a><h4 class="section">Exercise: 2 stars, standard, optional (xframe_lemma)</h4>
 Prove the <span class="inlinecode"><span class="id" title="var">xframe_lemma</span></span>. Exploit the properties of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>; do not try
    to unfold the definition of <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">Tactic Notation</span> "xframe" <span class="id" title="keyword">constr</span>(<span class="id" title="var">H</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> (@<a class="idref" href="WPgen.html#xframe_lemma"><span class="id" title="axiom">xframe_lemma</span></a> <span class="id" title="var">H</span>); [ <span class="id" title="var">xsimpl</span> | | ].<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xframe_out" <span class="id" title="keyword">constr</span>(<span class="id" title="var">H</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="tactic">eapply</span> (@<a class="idref" href="WPgen.html#xframe_lemma"><span class="id" title="axiom">xframe_lemma</span></a> <span class="id" title="var">_</span> <span class="id" title="var">H</span>); [ <span class="id" title="var">xsimpl</span> | | ].<br/>
</div>

<div class="doc">
Let's illustrate the use of <span class="inlinecode"><span class="id" title="var">xframe</span></span> on an example. 
</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="ProofsWithStructuralXtactics" class="idref" href="#ProofsWithStructuralXtactics"><span class="id" title="module">ProofsWithStructuralXtactics</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="Rules.html#ExamplePrograms"><span class="id" title="module">ExamplePrograms</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wpgen_scope</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Lemma</span> <a id="ProofsWithStructuralXtactics.triple_incr_frame" class="idref" href="#ProofsWithStructuralXtactics.triple_incr_frame"><span class="id" title="lemma">triple_incr_frame</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:253" class="idref" href="#p:253"><span class="id" title="binder">p</span></a> <a id="q:254" class="idref" href="#q:254"><span class="id" title="binder">q</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:255" class="idref" href="#n:255"><span class="id" title="binder">n</span></a> <a id="m:256" class="idref" href="#m:256"><span class="id" title="binder">m</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="Rules.html#ExamplePrograms.incr"><span class="id" title="definition">incr</span></a> <a class="idref" href="WPgen.html#p:253"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:253"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:255"><span class="id" title="variable">n</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="WPgen.html#q:254"><span class="id" title="variable">q</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:256"><span class="id" title="variable">m</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#p:253"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:255"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation"><span class='gray-font'>\</span>*</span></a> <a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#q:254"><span class="id" title="variable">q</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:256"><span class="id" title="variable">m</span></a><a class="idref" href="LibSepReference.html#6e7aeeae3643da4efcca62b993bbca40"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
</div>

<div class="doc">
Instead of calling <span class="inlinecode"><span class="id" title="var">xapp</span></span>, we put aside <span class="inlinecode"><span class="id" title="var">q</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">m</span></span> and focus on <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">n</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xframe</span> (<span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <span class="id" title="var">n</span>). <span class="comment">(*&nbsp;equivalent&nbsp;to&nbsp;<span class="inlinecode"><span class="id" title="var">xframe_out</span></span> <span class="inlinecode">(<span class="id" title="var">q</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">m</span>)</span>.&nbsp;*)</span><br/>
</div>

<div class="doc">
Then we can work in a smaller state that mentions only <span class="inlinecode"><span class="id" title="var">p</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">n</span></span>. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>. <span class="id" title="var">xapp</span>.<br/>
</div>

<div class="doc">
Finally we check the check that the current state augmented with the framed
    predicate <span class="inlinecode"><span class="id" title="var">q</span></span> <span class="inlinecode">~~&gt;</span> <span class="inlinecode"><span class="id" title="var">m</span></span> matches with the claimed postcondition. 
</div>
<div class="code">
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#ProofsWithStructuralXtactics"><span class="id" title="module">ProofsWithStructuralXtactics</span></a>.<br/>
</div>

<div class="doc">
<a id="lab363"></a><h2 class="section">Evaluation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> Recursively inside Local Functions</h2>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WPgenRec" class="idref" href="#WPgenRec"><span class="id" title="module">WPgenRec</span></a>.<br/>
<span class="id" title="keyword">Implicit</span> <span class="id" title="keyword">Types</span> <span class="id" title="var">vx</span> <span class="id" title="var">vf</span> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>.<br/>
</div>

<div class="doc">
<a id="lab364"></a><h3 class="section">1. Motivation for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to Recurse in Local Functions</h3>

<div class="paragraph"> </div>

 So far in the chapter, in the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we have treated the
    constructions <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> and <span class="inlinecode"><span class="id" title="var">trm_fix</span></span> as terms directly constructing a
    value, following the same pattern as for the construction <span class="inlinecode"><span class="id" title="var">trm_val</span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) (<span class="id" title="var">Q</span>:<span class="id" title="var">val</span>→<span class="id" title="var">hprop</span>) : <span class="id" title="var">hprop</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span>      ⇒ <span class="id" title="var">Q</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>   ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">Q</span> (<span class="id" title="var">val_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    This section explains how to extend the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> to make it
    recurse inside the body of the function definitions. Doing so does not
    increase expressiveness, because the user had the possibility of manually
    requesting the computation of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> on a function value of the form
    <span class="inlinecode"><span class="id" title="var">val_fun</span></span> or <span class="inlinecode"><span class="id" title="var">val_fix</span></span>. However, having <span class="inlinecode"><span class="id" title="var">wpgen</span></span> automatically recurse into
    function bodies simplifies and improves the efficiency of the implementation
    of the <span class="inlinecode"><span class="id" title="var">xfun</span></span> tactic.

<div class="paragraph"> </div>

    The new definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> takes the shape shown below, for well-suited
    definitions of <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span> and <span class="inlinecode"><span class="id" title="var">wpgen_fix</span></span> yet to be introduced. In the code
    snippet below, <span class="inlinecode"><span class="id" title="var">vx</span></span> denotes a value to which the function may be applied,
    and <span class="inlinecode"><span class="id" title="var">vf</span></span> denotes the value associated with the function itself. This value
    is involved where the function defined by <span class="inlinecode"><span class="id" title="var">trm_fix</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> invokes itself
    recursively inside its body <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> <span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_val</span> <span class="id" title="var">v</span>      ⇒ <span class="id" title="var">wpgen_val</span> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span>   ⇒ <span class="id" title="var">wpgen_fun</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">vx</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">wpgen_fix</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">vf</span> <span class="id" title="var">vx</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">f</span>,<span class="id" title="var">vf</span>)::(<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
</div>

<div class="doc">
<a id="lab365"></a><h3 class="section">2. A New Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that Recurses in Local Functions</h3>

<div class="paragraph"> </div>

 For simplicity, let us assume for now the substitution context <span class="inlinecode"><span class="id" title="var">E</span></span> to be
    empty and ignore the presence of the predicate <span class="inlinecode"><span class="id" title="var">mkstruct</span></span>. Our first task is
    to provide a definition for <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, expressed in terms of
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>.

<div class="paragraph"> </div>

    Let <span class="inlinecode"><span class="id" title="var">vf</span></span> denote the function <span class="inlinecode"><span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>, which the term <span class="inlinecode"><span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>
    evaluates to. The heap predicate <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> should assert that
    that the postcondition <span class="inlinecode"><span class="id" title="var">Q</span></span> holds of the result value <span class="inlinecode"><span class="id" title="var">vf</span></span>, i.e., that <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span>
    should hold.

<div class="paragraph"> </div>

    Rather than specifying that <span class="inlinecode"><span class="id" title="var">vf</span></span> is equal to <span class="inlinecode"><span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> as we were doing
    previously, we would like to specify that <span class="inlinecode"><span class="id" title="var">vf</span></span> denotes a function whose body
    admits <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> as weakest precondition. To that end, we define the heap
    predicate <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> to be of the form
    <span class="inlinecode">\<span class="id" title="keyword">∀</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>,</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>]</span> <span class="inlinecode"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span> for a carefully crafted predicate <span class="inlinecode"><span class="id" title="var">P</span></span> that
    describes the behavior of the function by means of its weakest precondition.
    This predicate <span class="inlinecode"><span class="id" title="var">P</span></span> is defined further on.

<div class="paragraph"> </div>

    The universal quantification on <span class="inlinecode"><span class="id" title="var">vf</span></span> is intended to hide away from the user
    the fact that <span class="inlinecode"><span class="id" title="var">vf</span></span> actually denotes <span class="inlinecode"><span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>. It would be correct to
    replace <span class="inlinecode">\<span class="id" title="keyword">∀</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>,</span> <span class="inlinecode">...</span> with <span class="inlinecode"><span class="id" title="keyword">let</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">val_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="keyword">in</span></span> <span class="inlinecode">...</span>, yet we are
    purposely trying to abstract away from the syntax of <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span>, hence the
    universal quantification of <span class="inlinecode"><span class="id" title="var">vf</span></span>.

<div class="paragraph"> </div>

    In the heap predicate <span class="inlinecode">\<span class="id" title="keyword">∀</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>,</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>]</span> <span class="inlinecode"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span>, the magic wand
    features a left-hand side of the form <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>]</span> intended to provide to the
    user the knowledge of the weakest precondition of the body <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> of the
    function, in such a way that the user is able to derive the specification
    aimed for the local function <span class="inlinecode"><span class="id" title="var">vf</span></span>.

<div class="paragraph"> </div>

    Concretely, the proposition <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span> should enable the user establishing
    properties of applications of the form <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span> <span class="inlinecode"><span class="id" title="var">vx</span></span>, where <span class="inlinecode"><span class="id" title="var">vf</span></span> denotes
    the function and <span class="inlinecode"><span class="id" title="var">vx</span></span> denotes an argument to which the function is applied.

<div class="paragraph"> </div>

    To figure out the details of the statement of <span class="inlinecode"><span class="id" title="var">P</span></span>, it is useful to recall
    from chapter <a href="WPgen.html"><span class="inlineref">WPgen</span></a> the statement of the lemma
    <span class="inlinecode"><span class="id" title="var">triple_app_fun_from_wpgen</span></span>, which we used for reasoning about top-level
    functions. 
</div>
<div class="code">

<span class="id" title="keyword">Parameter</span> <a id="WPgenRec.triple_app_fun_from_wpgen" class="idref" href="#WPgenRec.triple_app_fun_from_wpgen"><span class="id" title="axiom">triple_app_fun_from_wpgen</span></a> : <span class="id" title="keyword">∀</span> <a id="vf:257" class="idref" href="#vf:257"><span class="id" title="binder">vf</span></a> <a id="vx:258" class="idref" href="#vx:258"><span class="id" title="binder">vx</span></a> <a id="x:259" class="idref" href="#x:259"><span class="id" title="binder">x</span></a> <a id="t<sub>1</sub>:260" class="idref" href="#t<sub>1</sub>:260"><span class="id" title="binder">t<sub>1</sub></span></a> <a id="H':261" class="idref" href="#H':261"><span class="id" title="binder">H'</span></a> <a id="Q':262" class="idref" href="#Q':262"><span class="id" title="binder">Q'</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#vf:257"><span class="id" title="variable">vf</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#val_fun"><span class="id" title="constructor">val_fun</span></a> <a class="idref" href="WPgen.html#x:259"><span class="id" title="variable">x</span></a> <a class="idref" href="WPgen.html#t<sub>1</sub>:260"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H':261"><span class="id" title="variable">H'</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#wpgen"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#x:259"><span class="id" title="variable">x</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#vx:258"><span class="id" title="variable">vx</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nil"><span class="id" title="constructor">nil</span></a>) <a class="idref" href="WPgen.html#t<sub>1</sub>:260"><span class="id" title="variable">t<sub>1</sub></span></a> <a class="idref" href="WPgen.html#Q':262"><span class="id" title="variable">Q'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#vf:257"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:258"><span class="id" title="variable">vx</span></a>) <a class="idref" href="WPgen.html#H':261"><span class="id" title="variable">H'</span></a> <a class="idref" href="WPgen.html#Q':262"><span class="id" title="variable">Q'</span></a>.<br/>
</div>

<div class="doc">
The lemma above enables establishing a triple for an application
    <span class="inlinecode"><span class="id" title="var">trm_app</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span> <span class="inlinecode"><span class="id" title="var">vx</span></span> with precondition <span class="inlinecode"><span class="id" title="var">H'</span></span> and postcondition <span class="inlinecode"><span class="id" title="var">Q'</span></span>, from the
    premise <span class="inlinecode"><span class="id" title="var">H'</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wgen</span></span> <span class="inlinecode">((<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">nil</span>)</span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> <span class="inlinecode"><span class="id" title="var">Q'</span></span>.

<div class="paragraph"> </div>

    It therefore makes sense, in our definition of the predicate
    <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span>, which we said would take the form
    <span class="inlinecode">\<span class="id" title="keyword">∀</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>,</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>]</span> <span class="inlinecode"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span>, to define <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span> as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">vx</span> <span class="id" title="var">H'</span> <span class="id" title="var">Q'</span>, (<span class="id" title="var">H'</span> ==&gt; <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">nil</span>) <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">Q'</span>) →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">triple</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">vf</span> <span class="id" title="var">vx</span>) <span class="id" title="var">H'</span> <span class="id" title="var">Q'</span>
</span>    Overall, the definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> is as follows. Note that the
    occurence of <span class="inlinecode"><span class="id" title="var">nil</span></span> is replaced with <span class="inlinecode"><span class="id" title="var">E</span></span> to account for the case of a
    nonempty context.
<br/>
<span class="inlinecode">&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> <span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="keyword">fun</span> <span class="id" title="var">Q</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">P</span> <span class="id" title="var">vf</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">∀</span> <span class="id" title="var">vx</span> <span class="id" title="var">H'</span> <span class="id" title="var">Q'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H'</span> ==&gt; <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">Q'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">triple</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">vf</span> <span class="id" title="var">vx</span>) <span class="id" title="var">H'</span> <span class="id" title="var">Q'</span>) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\<span class="id" title="keyword">∀</span> <span class="id" title="var">vf</span>, <span class='gray-font'>\</span>[<span class="id" title="var">P</span> <span class="id" title="var">vf</span>] <span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span> <span class="id" title="var">Q</span> <span class="id" title="var">vf</span><br/>
&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>
<div class="paragraph"> </div>

 The actual definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> exploits an intermediate definition called
    <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span>, as shown below:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> <span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fun</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">wpgen_fun</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">vx</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.
</span>    where <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span> could be defined as follows: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="WPgenRec.wpgen_fun'" class="idref" href="#WPgenRec.wpgen_fun'"><span class="id" title="definition">wpgen_fun'</span></a> (<a id="Fof:264" class="idref" href="#Fof:264"><span class="id" title="binder">Fof</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:265" class="idref" href="#Q:265"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">∀</span></a> <a id="vf:266" class="idref" href="#vf:266"><span class="id" title="binder">vf</span></a><a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><span class="id" title="keyword">∀</span> <a id="vx:267" class="idref" href="#vx:267"><span class="id" title="binder">vx</span></a> <a id="H':268" class="idref" href="#H':268"><span class="id" title="binder">H'</span></a> <a id="Q':269" class="idref" href="#Q':269"><span class="id" title="binder">Q'</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#H':268"><span class="id" title="variable">H'</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Fof:264"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#vx:267"><span class="id" title="variable">vx</span></a> <a class="idref" href="WPgen.html#Q':269"><span class="id" title="variable">Q'</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#vf:266"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:267"><span class="id" title="variable">vx</span></a>) <a class="idref" href="WPgen.html#H':268"><span class="id" title="variable">H'</span></a> <a class="idref" href="WPgen.html#Q':269"><span class="id" title="variable">Q'</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#1153660e6ba8dfddb6aef382b72370c<sub>9</sub>"><span class="id" title="notation"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span></a> <a class="idref" href="WPgen.html#Q:265"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#vf:266"><span class="id" title="variable">vf</span></a>.<br/>
</div>

<div class="doc">
In the definition above, the assumption about <span class="inlinecode"><span class="id" title="var">vf</span></span>, enclosed above in
    brackets, can be slightly simplfied, by using <span class="inlinecode"><span class="id" title="var">wp</span></span> instead of <span class="inlinecode"><span class="id" title="var">triple</span></span>,
    allowing to eliminate <span class="inlinecode"><span class="id" title="var">H'</span></span>. This observation leads to a more concise
    definition of <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="WPgenRec.wpgen_fun" class="idref" href="#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a> (<a id="Fof:270" class="idref" href="#Fof:270"><span class="id" title="binder">Fof</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:271" class="idref" href="#Q:271"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">∀</span></a> <a id="vf:272" class="idref" href="#vf:272"><span class="id" title="binder">vf</span></a><a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><span class="id" title="keyword">∀</span> <a id="vx:273" class="idref" href="#vx:273"><span class="id" title="binder">vx</span></a> <a id="Q':274" class="idref" href="#Q':274"><span class="id" title="binder">Q'</span></a>, <a class="idref" href="WPgen.html#Fof:270"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#vx:273"><span class="id" title="variable">vx</span></a> <a class="idref" href="WPgen.html#Q':274"><span class="id" title="variable">Q'</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#vf:272"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:273"><span class="id" title="variable">vx</span></a>) <a class="idref" href="WPgen.html#Q':274"><span class="id" title="variable">Q'</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#1153660e6ba8dfddb6aef382b72370c<sub>9</sub>"><span class="id" title="notation"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span></a> <a class="idref" href="WPgen.html#Q:271"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#vf:272"><span class="id" title="variable">vf</span></a>.<br/>
</div>

<div class="doc">
<a id="lab366"></a><h4 class="section">Exercise: 2 stars, standard, optional (wpgen_fun_eq)</h4>
 Prove that <span class="inlinecode"><span class="id" title="var">wpgen_fun'</span></span> is equivalent to <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenRec.wpgen_fun_eq" class="idref" href="#WPgenRec.wpgen_fun_eq"><span class="id" title="lemma">wpgen_fun_eq</span></a> :<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun'"><span class="id" title="definition">wpgen_fun'</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a>, <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun'"><span class="id" title="definition">wpgen_fun'</span></a>. <span class="id" title="var">applys</span> <span class="id" title="lemma">fun_ext_2</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">intros</span> <span class="id" title="var">Fof</span> <span class="id" title="var">Q</span>. <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_antisym"><span class="id" title="lemma">himpl_antisym</span></a>.<br/>
&nbsp;{ <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_hforall_r"><span class="id" title="lemma">himpl_hforall_r</span></a>. <span class="id" title="tactic">intros</span> <span class="id" title="var">vf</span>. <span class="id" title="var">xchange</span> (<a class="idref" href="LibSepReference.html#SepSimplArgs.hforall_specialize"><span class="id" title="lemma">hforall_specialize</span></a> <span class="id" title="var">vf</span>).<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">M</span>. <span class="id" title="tactic">rewrite</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.hwand_hpure_l"><span class="id" title="lemma">hwand_hpure_l</span></a>. <span class="id" title="var">xsimpl</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id" title="var">introv</span>. <span class="id" title="tactic">rewrite</span> <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="lemma">wp_equiv</span></a>. <span class="id" title="var">applys</span> <span class="id" title="var">M</span>. <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;<span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="doc"> 
<div class="paragraph"> </div>

 Like for other auxiliary functions associated with <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, we introduce a
    custom notation for <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span>. Here, we let <span class="inlinecode"><span class="id" title="var">Fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">F</span></span> stand for
    <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F</span>)</span>. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="a72f42993dcbd144b3dcd14bb8c0feaa" class="idref" href="#a72f42993dcbd144b3dcd14bb8c0feaa"><span class="id" title="notation">&quot;</span></a>'Fun' x ':=' F<sub>1</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a> (<span class="id" title="keyword">fun</span> <a id="x:275" class="idref" href="#x:275"><span class="id" title="binder">x</span></a> ⇒ <span class="id" title="var">F<sub>1</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69, <span class="id" title="var">x</span> <span class="id" title="var">name</span>, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>,<br/>
&nbsp;&nbsp;<span class="id" title="var">format</span> "'[v' '[' 'Fun'  x  ':='  F<sub>1</sub>  ']' ']'").<br/>
</div>

<div class="doc">
<a id="lab367"></a><h3 class="section">3. Treatment of Recursive Functions</h3>

<div class="paragraph"> </div>

 The formula produced by <span class="inlinecode"><span class="id" title="var">wpgen</span></span> for a recursive function <span class="inlinecode"><span class="id" title="var">trm_fix</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span></span> is
    almost the same as for a non-recursive function. The main difference is that
    we need to add a binding in the context from the name <span class="inlinecode"><span class="id" title="var">f</span></span> to the value <span class="inlinecode"><span class="id" title="var">vf</span></span>.
    Like for <span class="inlinecode"><span class="id" title="var">trm_fun</span></span>, the heap predicate <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode">(<span class="id" title="var">trm_fix</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode"><span class="id" title="var">t<sub>1</sub></span>)</span> <span class="inlinecode"><span class="id" title="var">Q</span></span> is of the
    form <span class="inlinecode">\<span class="id" title="keyword">∀</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>,</span> <span class="inlinecode"><span class='gray-font'>\</span>[<span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">vf</span>]</span> <span class="inlinecode"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode"><span class="id" title="var">vf</span></span>. The predicate <span class="inlinecode"><span class="id" title="var">P</span></span> is similar to that
    for <span class="inlinecode"><span class="id" title="var">trm_fun</span></span>, the only difference is that the context <span class="inlinecode"><span class="id" title="var">E</span></span> needs to be
    extended not with one but with two bindings: one for the argument, and one
    for the function. Concretely, <span class="inlinecode"><span class="id" title="var">P</span></span> is defined as:
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">∀</span> <span class="id" title="var">vx</span> <span class="id" title="var">H'</span> <span class="id" title="var">Q'</span>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">H'</span> ==&gt; <span class="id" title="var">wpgen</span> ((<span class="id" title="var">f</span>,<span class="id" title="var">vf</span>)::(<span class="id" title="var">x</span>,<span class="id" title="var">vx</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">Q'</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">triple</span> (<span class="id" title="var">trm_app</span> <span class="id" title="var">vf</span> <span class="id" title="var">vx</span>) <span class="id" title="var">H'</span> <span class="id" title="var">Q'</span>
</span>    Like for <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span>, we can make the definition more concise by eliminating
    <span class="inlinecode"><span class="id" title="var">H'</span></span>. Concretely, we define: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="WPgenRec.wpgen_fix" class="idref" href="#WPgenRec.wpgen_fix"><span class="id" title="definition">wpgen_fix</span></a> (<a id="Fof:276" class="idref" href="#Fof:276"><span class="id" title="binder">Fof</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> := <span class="id" title="keyword">fun</span> <a id="Q:277" class="idref" href="#Q:277"><span class="id" title="binder">Q</span></a> ⇒<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">\</span></a><a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">∀</span></a> <a id="vf:278" class="idref" href="#vf:278"><span class="id" title="binder">vf</span></a><a class="idref" href="LibSepReference.html#466ecb7d71d07e4d74c1c028c2497a<sub>33</sub>"><span class="id" title="notation">,</span></a> <a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation"><span class='gray-font'>\</span>[</span></a><span class="id" title="keyword">∀</span> <a id="vx:279" class="idref" href="#vx:279"><span class="id" title="binder">vx</span></a> <a id="Q':280" class="idref" href="#Q':280"><span class="id" title="binder">Q'</span></a>, <a class="idref" href="WPgen.html#Fof:276"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#vf:278"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:279"><span class="id" title="variable">vx</span></a> <a class="idref" href="WPgen.html#Q':280"><span class="id" title="variable">Q'</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPsem.html#wp"><span class="id" title="definition">wp</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#vf:278"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:279"><span class="id" title="variable">vx</span></a>) <a class="idref" href="WPgen.html#Q':280"><span class="id" title="variable">Q'</span></a><a class="idref" href="LibSepReference.html#d090ebaffe5a082b6a27552ccf013e<sub>09</sub>"><span class="id" title="notation">]</span></a> <a class="idref" href="LibSepReference.html#1153660e6ba8dfddb6aef382b72370c<sub>9</sub>"><span class="id" title="notation"><span class='gray-font'>\</span><span class="nowrap">&minus;&lowast;</span></span></a> <a class="idref" href="WPgen.html#Q:277"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#vf:278"><span class="id" title="variable">vf</span></a>.<br/>
</div>

<div class="doc">
Then we integrate this definition is <span class="inlinecode"><span class="id" title="var">wpgen</span></span> as shown below.
<br/>
<span class="inlinecode">&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">wpgen</span> (<span class="id" title="var">E</span>:<span class="id" title="var">ctx</span>) (<span class="id" title="var">t</span>:<span class="id" title="var">trm</span>) : <span class="id" title="var">formula</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">mkstruct</span> <span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">trm_fix</span> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <span class="id" title="var">wpgen_fix</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">vf</span> <span class="id" title="var">v</span> ⇒ <span class="id" title="var">wpgen</span> ((<span class="id" title="var">f</span>,<span class="id" title="var">vf</span>)::(<span class="id" title="var">x</span>,<span class="id" title="var">v</span>)::<span class="id" title="var">E</span>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| ..<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>
</span>
<div class="paragraph"> </div>

 Here again, we introduce a piece of notation for <span class="inlinecode"><span class="id" title="var">wpgen_fix</span></span>. We let
    <span class="inlinecode"><span class="id" title="keyword">Fix</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">:=</span> <span class="inlinecode"><span class="id" title="var">F</span></span> stand for <span class="inlinecode"><span class="id" title="var">wpgen_fix</span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">x</span></span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="var">F</span>)</span>. 
</div>
<div class="code">

<span class="id" title="keyword">Notation</span> <a id="4c5078ddaf826ed91da3bc8edba85b8b" class="idref" href="#4c5078ddaf826ed91da3bc8edba85b8b"><span class="id" title="notation">&quot;</span></a>'Fix' f x ':=' F<sub>1</sub>" :=<br/>
&nbsp;&nbsp;((<a class="idref" href="WPgen.html#WPgenRec.wpgen_fix"><span class="id" title="definition">wpgen_fix</span></a> (<span class="id" title="keyword">fun</span> <a id="f:281" class="idref" href="#f:281"><span class="id" title="binder">f</span></a> <a id="x:282" class="idref" href="#x:282"><span class="id" title="binder">x</span></a> ⇒ <span class="id" title="var">F<sub>1</sub></span>)))<br/>
&nbsp;&nbsp;(<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 69, <span class="id" title="var">f</span> <span class="id" title="var">name</span>, <span class="id" title="var">x</span> <span class="id" title="var">name</span>, <span class="id" title="tactic">right</span> <span class="id" title="keyword">associativity</span>,<br/>
&nbsp;&nbsp;<span class="id" title="var">format</span> "'[v' '[' 'Fix'  f  x  ':='  F<sub>1</sub>  ']' ']'").<br/>
</div>

<div class="doc">
<a id="lab368"></a><h3 class="section">4. Final Definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, with Processing a Local Functions</h3>

<div class="paragraph"> </div>

 The final definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span>, including the recursive processing of local
    function definitions, appears below. Note that we here aim at supporting
    only local functions with one argument. The proper treatment of n-ary local
    functions would require a nested recursive function for accumulating the
    list of arguments involved in each local function. It is beyond the scope of
    this course. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="WPgenRec.wpgen" class="idref" href="#WPgenRec.wpgen"><span class="id" title="definition">wpgen</span></a> (<a id="E:283" class="idref" href="#E:283"><span class="id" title="binder">E</span></a>:<a class="idref" href="WPgen.html#ctx"><span class="id" title="definition">ctx</span></a>) (<a id="t:284" class="idref" href="#t:284"><span class="id" title="binder">t</span></a>:<a class="idref" href="LibSepReference.html#trm"><span class="id" title="inductive">trm</span></a>) : <a class="idref" href="WPgen.html#formula"><span class="id" title="definition">formula</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#mkstruct"><span class="id" title="definition">mkstruct</span></a> <span class="id" title="keyword">match</span> <a class="idref" href="WPgen.html#t:284"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_val"><span class="id" title="constructor">trm_val</span></a> <span class="id" title="var">v</span> ⇒ <a class="idref" href="WPgen.html#wpgen_val"><span class="id" title="definition">wpgen_val</span></a> <span class="id" title="var">v</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_var"><span class="id" title="constructor">trm_var</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="WPgen.html#wpgen_var"><span class="id" title="definition">wpgen_var</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fun"><span class="id" title="constructor">trm_fun</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a> (<span class="id" title="keyword">fun</span> <a id="v:287" class="idref" href="#v:287"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:287"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_fix"><span class="id" title="constructor">trm_fix</span></a> <span class="id" title="var">f</span> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> ⇒ <a class="idref" href="WPgen.html#WPgenRec.wpgen_fix"><span class="id" title="definition">wpgen_fix</span></a> (<span class="id" title="keyword">fun</span> <a id="vf:288" class="idref" href="#vf:288"><span class="id" title="binder">vf</span></a> <a id="v:289" class="idref" href="#v:289"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">f</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#vf:288"><span class="id" title="variable">vf</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:289"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>1</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_app"><span class="id" title="definition">wpgen_app</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <a class="idref" href="WPgen.html#t:284"><span class="id" title="variable">t</span></a>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_seq"><span class="id" title="constructor">trm_seq</span></a> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_seq"><span class="id" title="definition">wpgen_seq</span></a> (<a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_let"><span class="id" title="constructor">trm_let</span></a> <span class="id" title="var">x</span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_let"><span class="id" title="definition">wpgen_let</span></a> (<a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<span class="id" title="keyword">fun</span> <a id="v:290" class="idref" href="#v:290"><span class="id" title="binder">v</span></a> ⇒ <a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">(</span></a><span class="id" title="var">x</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">,</span></a><a class="idref" href="WPgen.html#v:290"><span class="id" title="variable">v</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e6756e10c36f149b18b4a8741ed83079"><span class="id" title="notation">)</span></a><span class="id" title="notation">::</span><a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a>) <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;| <a class="idref" href="LibSepReference.html#trm_if"><span class="id" title="constructor">trm_if</span></a> <span class="id" title="var">t<sub>0</sub></span> <span class="id" title="var">t<sub>1</sub></span> <span class="id" title="var">t<sub>2</sub></span> ⇒ <a class="idref" href="WPgen.html#wpgen_if"><span class="id" title="definition">wpgen_if</span></a> (<a class="idref" href="WPgen.html#isubst"><span class="id" title="definition">isubst</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>0</sub></span>) (<a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>1</sub></span>) (<a class="idref" href="WPgen.html#wpgen:285"><span class="id" title="definition">wpgen</span></a> <a class="idref" href="WPgen.html#E:283"><span class="id" title="variable">E</span></a> <span class="id" title="var">t<sub>2</sub></span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab369"></a><h3 class="section">5. Tactic for Reasoning About Functions</h3>

<div class="paragraph"> </div>

 This section refines the tactic <span class="inlinecode"><span class="id" title="keyword">fun</span></span>, to reflect on the fact that the new
    definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> removes the need for the user to invoke <span class="inlinecode"><span class="id" title="var">xwp</span></span> by hand
    for reasoning about the body of local functions. The tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> presented
    here may be invoked either with or without providing a specification for the
    local function. If no specification is provided, the formula associated with
    the local function is taken as specification. This formula corresponds to
    the "most general specification" of the function. Exploiting this formula
    has a similar effect as inlining the code of the local function.

<div class="paragraph"> </div>

    First, we describe the tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> <span class="inlinecode"><span class="id" title="var">S</span></span>, where <span class="inlinecode"><span class="id" title="var">S</span></span> describes the
    specification of the local function. A typical call is of the form
    <span class="inlinecode"><span class="id" title="var">xfun</span></span> <span class="inlinecode">(<span class="id" title="keyword">fun</span></span> <span class="inlinecode">(<span class="id" title="var">f</span>:<span class="id" title="var">val</span>)</span> <span class="inlinecode">⇒</span> <span class="inlinecode"><span class="id" title="keyword">∀</span></span> <span class="inlinecode">...,</span> <span class="inlinecode"><span class="id" title="var">triple</span></span> <span class="inlinecode">(<span class="id" title="var">f</span></span> <span class="inlinecode">..)</span> <span class="inlinecode">..</span> <span class="inlinecode">..)</span>. The tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> <span class="inlinecode"><span class="id" title="var">S</span></span>
    generates two subgoals. The first one requires the user to establish the
    specification <span class="inlinecode"><span class="id" title="var">S</span></span> for the function. The second one requires the user to
    prove that the rest of the program is correct, in a context where the local
    function can be assumed to satisfy the specification <span class="inlinecode"><span class="id" title="var">S</span></span>. The definition of
    <span class="inlinecode"><span class="id" title="var">xfun</span></span> <span class="inlinecode"><span class="id" title="var">S</span></span> appears next. It is not required to understand the details. An
    example use case appears further on. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenRec.xfun_spec_lemma" class="idref" href="#WPgenRec.xfun_spec_lemma"><span class="id" title="lemma">xfun_spec_lemma</span></a> : <span class="id" title="keyword">∀</span> (<a id="S:291" class="idref" href="#S:291"><span class="id" title="binder">S</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><span class="id" title="keyword">Prop</span>) <a id="H:292" class="idref" href="#H:292"><span class="id" title="binder">H</span></a> <a id="Q:293" class="idref" href="#Q:293"><span class="id" title="binder">Q</span></a> <a id="Fof:294" class="idref" href="#Fof:294"><span class="id" title="binder">Fof</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="vf:295" class="idref" href="#vf:295"><span class="id" title="binder">vf</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="vx:296" class="idref" href="#vx:296"><span class="id" title="binder">vx</span></a> <a id="H':297" class="idref" href="#H':297"><span class="id" title="binder">H'</span></a> <a id="Q':298" class="idref" href="#Q':298"><span class="id" title="binder">Q'</span></a>, <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#H':297"><span class="id" title="variable">H'</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Fof:294"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#vx:296"><span class="id" title="variable">vx</span></a> <a class="idref" href="WPgen.html#Q':298"><span class="id" title="variable">Q'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#vf:295"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:296"><span class="id" title="variable">vx</span></a>) <a class="idref" href="WPgen.html#H':297"><span class="id" title="variable">H'</span></a> <a class="idref" href="WPgen.html#Q':298"><span class="id" title="variable">Q'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="WPgen.html#S:291"><span class="id" title="variable">S</span></a> <a class="idref" href="WPgen.html#vf:295"><span class="id" title="variable">vf</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="vf:299" class="idref" href="#vf:299"><span class="id" title="binder">vf</span></a>, <a class="idref" href="WPgen.html#S:291"><span class="id" title="variable">S</span></a> <a class="idref" href="WPgen.html#vf:299"><span class="id" title="variable">vf</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#H:292"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Q:293"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#vf:299"><span class="id" title="variable">vf</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">))</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:292"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a> <a class="idref" href="WPgen.html#Fof:294"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#Q:293"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M<sub>1</sub></span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a>. <span class="id" title="var">xsimpl</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">vf</span> <span class="id" title="var">N</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <span class="id" title="var">M<sub>2</sub></span>. <span class="id" title="var">applys</span> <span class="id" title="var">M<sub>1</sub></span>. <span class="id" title="var">introv</span> <span class="id" title="var">K</span>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="lemma">wp_equiv</span></a>.<br/>
&nbsp;&nbsp;<span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans_r"><span class="id" title="lemma">himpl_trans_r</span></a> <span class="id" title="var">K</span>. <span class="id" title="var">applys</span> <span class="id" title="var">N</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xfun" <span class="id" title="keyword">constr</span>(<span class="id" title="var">S</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenRec.xfun_spec_lemma"><span class="id" title="lemma">xfun_spec_lemma</span></a> <span class="id" title="var">S</span>.<br/>
</div>

<div class="doc">
Second, we describe the tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> with no argument. It applies to a goal
    of the form <span class="inlinecode"><span class="id" title="var">H</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen_fun</span></span> <span class="inlinecode"><span class="id" title="var">Fof</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span>. The tactic <span class="inlinecode"><span class="id" title="var">xfun</span></span> simply provides an
    hypothesis about the local function. The user may subsequently exploit this
    hypothesis for reasoning about a call to that function, just like if the
    code of the function was inlined at its call site. In practice, the use of
    <span class="inlinecode"><span class="id" title="var">xfun</span></span> without argument is most relevant for local functions that are
    invoked exactly once. For example, higher-order iterators such as
    <span class="inlinecode"><span class="id" title="var">List.iter</span></span> or <span class="inlinecode"><span class="id" title="var">List.map</span></span> are typically invoked with an ad-hoc functions
    that appears exactly once. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenRec.xfun_nospec_lemma" class="idref" href="#WPgenRec.xfun_nospec_lemma"><span class="id" title="lemma">xfun_nospec_lemma</span></a> : <span class="id" title="keyword">∀</span> <a id="H:300" class="idref" href="#H:300"><span class="id" title="binder">H</span></a> <a id="Q:301" class="idref" href="#Q:301"><span class="id" title="binder">Q</span></a> <a id="Fof:302" class="idref" href="#Fof:302"><span class="id" title="binder">Fof</span></a>,<br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="vf:303" class="idref" href="#vf:303"><span class="id" title="binder">vf</span></a>,<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="vx:304" class="idref" href="#vx:304"><span class="id" title="binder">vx</span></a> <a id="H':305" class="idref" href="#H':305"><span class="id" title="binder">H'</span></a> <a id="Q':306" class="idref" href="#Q':306"><span class="id" title="binder">Q'</span></a>, <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#H':305"><span class="id" title="variable">H'</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Fof:302"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#vx:304"><span class="id" title="variable">vx</span></a> <a class="idref" href="WPgen.html#Q':306"><span class="id" title="variable">Q'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#vf:303"><span class="id" title="variable">vf</span></a> <a class="idref" href="WPgen.html#vx:304"><span class="id" title="variable">vx</span></a>) <a class="idref" href="WPgen.html#H':305"><span class="id" title="variable">H'</span></a> <a class="idref" href="WPgen.html#Q':306"><span class="id" title="variable">Q'</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#H:300"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#Q:301"><span class="id" title="variable">Q</span></a> <a class="idref" href="WPgen.html#vf:303"><span class="id" title="variable">vf</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">))</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#H:300"><span class="id" title="variable">H</span></a> <a class="idref" href="LibSepReference.html#c7ebd77e939e3f02c508e57b470dc021"><span class="id" title="notation">==&gt;</span></a> <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a> <a class="idref" href="WPgen.html#Fof:302"><span class="id" title="variable">Fof</span></a> <a class="idref" href="WPgen.html#Q:301"><span class="id" title="variable">Q</span></a>.<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">M</span>. <span class="id" title="tactic">unfold</span> <a class="idref" href="WPgen.html#WPgenRec.wpgen_fun"><span class="id" title="definition">wpgen_fun</span></a>. <span class="id" title="var">xsimpl</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">vf</span> <span class="id" title="var">N</span>. <span class="id" title="var">applys</span> <span class="id" title="var">M</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">introv</span> <span class="id" title="var">K</span>. <span class="id" title="tactic">rewrite</span> &lt;- <a class="idref" href="WPsem.html#wp_equiv"><span class="id" title="lemma">wp_equiv</span></a>. <span class="id" title="var">applys</span> <a class="idref" href="LibSepReference.html#SepSimplArgs.himpl_trans_r"><span class="id" title="lemma">himpl_trans_r</span></a> <span class="id" title="var">K</span>. <span class="id" title="var">applys</span> <span class="id" title="var">N</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Tactic Notation</span> "xfun" :=<br/>
&nbsp;&nbsp;<span class="id" title="var">xseq_xlet_if_needed</span>; <span class="id" title="var">xstruct_if_needed</span>; <span class="id" title="var">applys</span> <a class="idref" href="WPgen.html#WPgenRec.xfun_nospec_lemma"><span class="id" title="lemma">xfun_nospec_lemma</span></a>.<br/>
</div>

<div class="doc">
A generalization of <span class="inlinecode"><span class="id" title="var">xfun</span></span> that handles recursive functions may be defined
    following exactly the same pattern. Details may be found in the file
    <span class="inlinecode"><span class="id" title="var">LibSepReference.v</span></span> 
<div class="paragraph"> </div>

 This completes our presentation of a version of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that recursively
    processes the local definition of non-recursive functions. A practical
    example is presented next. 
</div>

<div class="doc">
<a id="lab370"></a><h3 class="section">6. Example Revisited with the New <span class="inlinecode"><span class="id" title="var">wpgen</span></span></h3>

</div>
<div class="code">

<span class="id" title="keyword">Module</span> <a id="WPgenRec.ExampleLocalFunWpgenRec" class="idref" href="#WPgenRec.ExampleLocalFunWpgenRec"><span class="id" title="module">ExampleLocalFunWpgenRec</span></a>.<br/>
<span class="id" title="keyword">Import</span> <a class="idref" href="LibSepReference.html#DemoPrograms"><span class="id" title="module">DemoPrograms</span></a> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen"><span class="id" title="module">ExampleLocalFunWpgen</span></a>.<br/>
</div>

<div class="doc">
We import here the definitions from <span class="inlinecode"><span class="id" title="var">LibSepReference</span></span>, which provides the a
    definition of <span class="inlinecode"><span class="id" title="var">wpgen</span></span> that recurse in function bodies exactly as defined in
    subsection 4 above, and which defines all the other x-tactics as previously
    but for this recursive version of [wpgen]. 
</div>
<div class="code">

<span class="id" title="keyword">Import</span> <a class="idref" href="LibSepReference.html#"><span class="id" title="module">LibSepReference</span></a>.<br/>
<span class="id" title="keyword">Open</span> <span class="id" title="keyword">Scope</span> <span class="id" title="var">wp_scope</span>.<br/>
</div>

<div class="doc">
Consider again the example program <span class="inlinecode"><span class="id" title="var">myincr</span></span>, whose code is:

<div class="paragraph"> </div>

<span class="inlinecode-ocaml">&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">p</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">f</span> = (<span class="id" title="keyword">fun</span> () → <span class="id" title="var">incr</span> <span class="id" title="var">p</span>) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">f</span>();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">f</span>()
</span>
<div class="paragraph"> </div>

 We first illustrate a call to <span class="inlinecode"><span class="id" title="var">xfun</span></span> with an explicit specification. Here,
    the function <span class="inlinecode"><span class="id" title="var">f</span></span> is specified as incrementing the reference <span class="inlinecode"><span class="id" title="var">p</span></span>. Observe
    that the body function of the function <span class="inlinecode"><span class="id" title="var">f</span></span> is verified only once. The
    reasoning about the two calls to the function <span class="inlinecode"><span class="id" title="var">f</span></span> that appears in the code
    are done with respect to the specification that we provide as argument to
    <span class="inlinecode"><span class="id" title="var">xfun</span></span> in the proof script. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenRec.ExampleLocalFunWpgenRec.triple_incrtwice" class="idref" href="#WPgenRec.ExampleLocalFunWpgenRec.triple_incrtwice"><span class="id" title="lemma">triple_incrtwice</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:307" class="idref" href="#p:307"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:308" class="idref" href="#n:308"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:307"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:307"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:308"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:307"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:308"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xfun</span> (<span class="id" title="keyword">fun</span> (<a id="f:311" class="idref" href="#f:311"><span class="id" title="binder">f</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>) ⇒ <span class="id" title="keyword">∀</span> (<a id="m:312" class="idref" href="#m:312"><span class="id" title="binder">m</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#f:309"><span class="id" title="variable">f</span></a><a class="idref" href="LibSepReference.html#3127c6bc552ca21a494fc6e3474a507d"><span class="id" title="notation">()</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#m:310"><span class="id" title="variable">m</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <span class="id" title="var">p</span> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#m:310"><span class="id" title="variable">m</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>)); <span class="id" title="tactic">intros</span> <span class="id" title="var">f</span> <span class="id" title="var">Hf</span>.<br/>
&nbsp;&nbsp;{ <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">applys</span> <span class="id" title="var">Hf</span>. <span class="comment">(*&nbsp;<span class="inlinecode"><span class="id" title="var">Hf</span></span>&nbsp;is&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;hypothesis&nbsp;on&nbsp;the&nbsp;body&nbsp;of&nbsp;<span class="inlinecode"><span class="id" title="var">f</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">clear</span> <span class="id" title="var">Hf</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">triple_incr</span></span>&nbsp;*)</span> <span class="id" title="var">xsimpl</span>. }<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">Hf</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">Hf</span></span>.&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>. <span class="id" title="var">math</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
We next illustrate a call to <span class="inlinecode"><span class="id" title="var">xfun</span></span> without argument. The "generic
    specification" that comes as hypothesis about the local function is a
    proposition that describes the behavior of the function in terms of the
    weakest-precondition of its body. When reasoning about a call to the
    function, one can invoke this generic specification. The effect is
    equivalent to that of inlining the code of the function at its call site.
    The example shown below contains two calls to the function <span class="inlinecode"><span class="id" title="var">f</span></span>. The script
    invokes <span class="inlinecode"><span class="id" title="var">xfun</span></span> without argument. Then, each of the two calls to <span class="inlinecode"><span class="id" title="var">f</span></span> executes
    a call to <span class="inlinecode"><span class="id" title="var">incr</span></span>. Thus the proof script involves two calls to <span class="inlinecode"><span class="id" title="var">xapp</span></span> that
    each exploit the specification <span class="inlinecode"><span class="id" title="var">triple_incr</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenRec.ExampleLocalFunWpgenRec.triple_incrtwice'" class="idref" href="#WPgenRec.ExampleLocalFunWpgenRec.triple_incrtwice'"><span class="id" title="lemma">triple_incrtwice'</span></a> : <span class="id" title="keyword">∀</span> (<a id="p:313" class="idref" href="#p:313"><span class="id" title="binder">p</span></a>:<a class="idref" href="LibSepReference.html#loc"><span class="id" title="definition">loc</span></a>) (<a id="n:314" class="idref" href="#n:314"><span class="id" title="binder">n</span></a>:<span class="id" title="notation">int</span>),<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="LibSepReference.html#trm_app"><span class="id" title="constructor">trm_app</span></a> <a class="idref" href="WPgen.html#ExampleLocalFunWpgen.incrtwice"><span class="id" title="definition">incrtwice</span></a> <a class="idref" href="WPgen.html#p:313"><span class="id" title="variable">p</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#p:313"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="WPgen.html#n:314"><span class="id" title="variable">n</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> ⇒ <a class="idref" href="WPgen.html#p:313"><span class="id" title="variable">p</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">~~&gt;</span></a> <a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">(</span></a><a class="idref" href="WPgen.html#n:314"><span class="id" title="variable">n</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>2<a class="idref" href="LibSepReference.html#04d59e26c33e7500ff8979242a3d649f"><span class="id" title="notation">)</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xwp</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xfun</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">f</span> <span class="id" title="var">Hf</span>.<br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">Hf</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">triple_incr</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">Hf</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xapp</span>. <span class="comment">(*&nbsp;exploits&nbsp;<span class="inlinecode"><span class="id" title="var">triple_incr</span></span>&nbsp;*)</span><br/>
&nbsp;&nbsp;<span class="id" title="var">xsimpl</span>. <span class="id" title="var">math</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>

<div class="doc">
<a id="lab371"></a><h3 class="section">7. Exercise on a Local Recursive Function</h3>

<div class="paragraph"> </div>

 Consider a program that uses a local function to encode a for-loop. This
    program generalizes the <span class="inlinecode"><span class="id" title="tactic">repeat</span></span> program presented in the chapter
    <a href="Repr.html"><span class="inlineref">Repr</span></a>. The loop function takes as argument the loop bounds <span class="inlinecode"><span class="id" title="var">a</span></span> and
    <span class="inlinecode"><span class="id" title="var">b</span></span>, as well a function <span class="inlinecode"><span class="id" title="var">f</span></span> describing the body of the loop. A locally
    defined, recursive function named <span class="inlinecode"><span class="id" title="var">g</span></span> is used to execute <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">i</span></span> for every
    integer value of <span class="inlinecode"><span class="id" title="var">i</span></span> in the range from <span class="inlinecode"><span class="id" title="var">a</span></span> inclusive to <span class="inlinecode"><span class="id" title="var">b</span></span> exclusive.

<div class="paragraph"> </div>

<span class="inlinecode-ocaml">&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">a</span> <span class="id" title="var">b</span> <span class="id" title="var">f</span> →<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">let</span> <span class="id" title="var">g</span> = (<span class="id" title="keyword">fix</span> <span class="id" title="var">g</span> <span class="id" title="var">i</span> → <span class="id" title="keyword">if</span> <span class="id" title="var">i</span> &lt; <span class="id" title="var">b</span> <span class="id" title="keyword">then</span> (<span class="id" title="var">f</span> <span class="id" title="var">i</span>; <span class="id" title="var">g</span> (<span class="id" title="var">i</span>+1)) <span class="id" title="keyword">end</span>) <span class="id" title="keyword">in</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">g</span> <span class="id" title="var">a</span>
</span>
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="WPgenRec.ExampleLocalFunWpgenRec.forloop" class="idref" href="#WPgenRec.ExampleLocalFunWpgenRec.forloop"><span class="id" title="definition">forloop</span></a> : <a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">&lt;{</span></a> <a class="idref" href="LibSepReference.html#bfe3f2ff4c10f23c7c7f24aa5367bca5"><span class="id" title="notation">fun</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">a</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''b'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''b'"><span class="id" title="notation">b</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepReference.html#bfe3f2ff4c10f23c7c7f24aa5367bca5"><span class="id" title="notation">⇒</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">let</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">g</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepReference.html#2b10480be1a1611f7c8b850ecabd4776"><span class="id" title="notation">(</span></a><a class="idref" href="LibSepReference.html#4210c51c60ffc743d66f7854f5c20267"><span class="id" title="notation">fix_</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">g</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">i</span></a> <a class="idref" href="LibSepReference.html#4210c51c60ffc743d66f7854f5c20267"><span class="id" title="notation">⇒</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">let</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''c'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''c'"><span class="id" title="notation">c</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">i</span></a> <a class="idref" href="LibSepReference.html#:trm:trm_scope:x_'&lt;'_x"><span class="id" title="notation">&lt;</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''b'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''b'"><span class="id" title="notation">b</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">in</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#:trm:trm_scope:'if'_x_'then'_x_'end'"><span class="id" title="notation">if</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''c'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''c'"><span class="id" title="notation">c</span></a> <a class="idref" href="LibSepReference.html#:trm:trm_scope:'if'_x_'then'_x_'end'"><span class="id" title="notation">then</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''f'"><span class="id" title="notation">f</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">i</span></a> <a class="idref" href="LibSepReference.html#56accb00428c2a6753c1055752721c<sub>75</sub>"><span class="id" title="notation">;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">let</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''j'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''j'"><span class="id" title="notation">j</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">=</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''i'"><span class="id" title="notation">i</span></a> <a class="idref" href="LibSepReference.html#590da34eb63eef1c68773c655749c128"><span class="id" title="notation">+</span></a> 1 <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">in</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">g</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''j'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''j'"><span class="id" title="notation">j</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#:trm:trm_scope:'if'_x_'then'_x_'end'"><span class="id" title="notation">end</span></a><a class="idref" href="LibSepReference.html#2b10480be1a1611f7c8b850ecabd4776"><span class="id" title="notation">)</span></a> <a class="idref" href="LibSepReference.html#3a3686de54cc1093527e5e95b371bea7"><span class="id" title="notation">in</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''g'"><span class="id" title="notation">g</span></a> <a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">'</span></a><a class="idref" href="LibSepVar.html#NotationForVariables.:trm:trm_scope:'''a'"><span class="id" title="notation">a</span></a> <a class="idref" href="LibSepReference.html#e0b85224b7295b880f5ac68dccd380d<sub>1</sub>"><span class="id" title="notation">}&gt;</span></a>.<br/>
</div>

<div class="doc">
Like for the function <span class="inlinecode"><span class="id" title="tactic">repeat</span></span>, the specification of <span class="inlinecode"><span class="id" title="var">forloop</span></span> is expressed
    using an invariant, named <span class="inlinecode"><span class="id" title="var">I</span></span>, of type <span class="inlinecode"><span class="id" title="var">int</span>→<span class="id" title="var">hprop</span></span>. The hypothesis on <span class="inlinecode"><span class="id" title="var">f</span></span>
    asserts that a call to <span class="inlinecode"><span class="id" title="var">f</span></span> <span class="inlinecode"><span class="id" title="var">i</span></span> takes a state satisfying <span class="inlinecode"><span class="id" title="var">I</span></span> <span class="inlinecode"><span class="id" title="var">i</span></span> to a state
    satisfying <span class="inlinecode"><span class="id" title="var">I</span></span> <span class="inlinecode">(<span class="id" title="var">i</span>+1)</span>. For simplicity, we specify the function only in the
    case where <span class="inlinecode"><span class="id" title="var">a</span></span> <span class="inlinecode">≤</span> <span class="inlinecode"><span class="id" title="var">b</span></span>. 
<div class="paragraph"> </div>

<a id="lab372"></a><h4 class="section">Exercise: 4 stars, standard, especially useful (triple_forloop)</h4>
 Verify the function <span class="inlinecode"><span class="id" title="var">forloop</span></span>. Hint: provide the specification of <span class="inlinecode"><span class="id" title="var">g</span></span> to
    <span class="inlinecode"><span class="id" title="var">xfun</span></span>. To set up the induction, use the sequence:
    <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode"><span class="id" title="var">i</span>.</span> <span class="inlinecode"><span class="id" title="var">induction_wf</span></span> <span class="inlinecode"><span class="id" title="var">IH</span>:</span> <span class="inlinecode">(<span class="id" title="var">upto</span></span> <span class="inlinecode"><span class="id" title="var">b</span>)</span> <span class="inlinecode"><span class="id" title="var">i</span>.</span> <span class="inlinecode"><span class="id" title="tactic">intros</span></span> <span class="inlinecode"><span class="id" title="var">Hi</span>.</span>. Besides, the tactics
    <span class="inlinecode"><span class="id" title="var">math_rewrite</span></span> is helpful at one point in the proof. 
</div>
<div class="code">

<span class="id" title="keyword">Lemma</span> <a id="WPgenRec.ExampleLocalFunWpgenRec.triple_forloop" class="idref" href="#WPgenRec.ExampleLocalFunWpgenRec.triple_forloop"><span class="id" title="lemma">triple_forloop</span></a> : <span class="id" title="keyword">∀</span> (<a id="I:315" class="idref" href="#I:315"><span class="id" title="binder">I</span></a>:<span class="id" title="notation">int</span><a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><a class="idref" href="LibSepReference.html#SepSimplArgs.hprop"><span class="id" title="definition">hprop</span></a>) (<a id="a:316" class="idref" href="#a:316"><span class="id" title="binder">a</span></a> <a id="b:317" class="idref" href="#b:317"><span class="id" title="binder">b</span></a>:<span class="id" title="notation">int</span>) (<a id="f:318" class="idref" href="#f:318"><span class="id" title="binder">f</span></a>:<a class="idref" href="LibSepReference.html#val"><span class="id" title="inductive">val</span></a>),<br/>
&nbsp;&nbsp;<a class="idref" href="WPgen.html#a:316"><span class="id" title="variable">a</span></a> <span class="id" title="notation">≤</span> <a class="idref" href="WPgen.html#b:317"><span class="id" title="variable">b</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">(</span></a><span class="id" title="keyword">∀</span> <a id="i:319" class="idref" href="#i:319"><span class="id" title="binder">i</span></a>, <a class="idref" href="WPgen.html#a:316"><span class="id" title="variable">a</span></a> <span class="id" title="notation">≤</span> <a class="idref" href="WPgen.html#i:319"><span class="id" title="variable">i</span></a> <span class="id" title="notation">≤</span> <a class="idref" href="WPgen.html#b:317"><span class="id" title="variable">b</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#f:318"><span class="id" title="variable">f</span></a> <a class="idref" href="WPgen.html#i:319"><span class="id" title="variable">i</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#I:315"><span class="id" title="variable">I</span></a> <a class="idref" href="WPgen.html#i:319"><span class="id" title="variable">i</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="u:320" class="idref" href="#u:320"><span class="id" title="binder">u</span></a> ⇒ <a class="idref" href="WPgen.html#I:315"><span class="id" title="variable">I</span></a> (<a class="idref" href="WPgen.html#i:319"><span class="id" title="variable">i</span></a><a class="idref" href="http://coq.inria.fr/library//Coq.ZArith.BinInt.html#46584eddd5fdb16176a10a2843177d3a"><span class="id" title="notation">+</span></a>1))<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">)</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="LibSepReference.html#triple"><span class="id" title="definition">triple</span></a> (<a class="idref" href="WPgen.html#WPgenRec.ExampleLocalFunWpgenRec.forloop"><span class="id" title="definition">forloop</span></a> <a class="idref" href="WPgen.html#a:316"><span class="id" title="variable">a</span></a> <a class="idref" href="WPgen.html#b:317"><span class="id" title="variable">b</span></a> <a class="idref" href="WPgen.html#f:318"><span class="id" title="variable">f</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<a class="idref" href="WPgen.html#I:315"><span class="id" title="variable">I</span></a> <a class="idref" href="WPgen.html#a:316"><span class="id" title="variable">a</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="keyword">fun</span> <a id="r:321" class="idref" href="#r:321"><span class="id" title="binder">r</span></a> ⇒ <a class="idref" href="WPgen.html#I:315"><span class="id" title="variable">I</span></a> <a class="idref" href="WPgen.html#b:317"><span class="id" title="variable">b</span></a>).<br/>
<span class="id" title="keyword">Proof</span> <span class="id" title="keyword">using</span>. <span class="comment">(*&nbsp;FILL&nbsp;IN&nbsp;HERE&nbsp;*)</span> <span class="id" title="var">Admitted</span>.<br/>
<font size=-2>&#9744;</font>
</div>

<div class="code">

<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WPgenRec.ExampleLocalFunWpgenRec"><span class="id" title="module">ExampleLocalFunWpgenRec</span></a>.<br/>
<span class="id" title="keyword">End</span> <a class="idref" href="WPgen.html#WPgenRec"><span class="id" title="module">WPgenRec</span></a>.<br/>
</div>

<div class="doc">
<a id="lab373"></a><h2 class="section">Historical Notes</h2>

<div class="paragraph"> </div>

 Many verification tools for Hoare Logic are based on weakest-precondition
    generators. Typically, a tool takes as input source code annotated with
    specifications and invariants and produces a logical formula that entails
    the correctness of the program. This logical formula is typically expressed
    in first-order logic and is discharged using automated tools such as SMT
    solvers.

<div class="paragraph"> </div>

    In contrast, the weakest-precondition generator presented in this chapter
    applies to un-annotated code. It thus produces a logical formula that does
    not depend at all on the specifications and invariants. Such formula, which
    can be constructed in a systematic manner, is called a "characteristic
    formula" in the literature. The notion of characteristic formulae was
    introduced in work by <a href="Bib.html#Hennessy-and Milner 1985"><span class="inlineref">[Hennessy and Milner 1985]</span></a> on process calculi. It
    was first applied to program logics by
    <a href="Bib.html#Honda,-Berger, and Yoshida 2006"><span class="inlineref">[Honda, Berger, and Yoshida 2006]</span></a> and to Separation Logic in the PhD
    work of <a href="Bib.html#Charguéraud-2010"><span class="inlineref">[Charguéraud 2010]</span></a>, which led to CFML.

<div class="paragraph"> </div>

    In general, a characteristic formula provides not just a sound but also a
    complete description of the semantics of a program. In Charguéraud's PhD
    thesis, completeness is established on paper, and a mechanized proof in Coq
    is provided only for the simple IMP language. Even if a result of the form
    <span class="inlinecode"><span class="id" title="var">wp</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> <span class="inlinecode">==&gt;</span> <span class="inlinecode"><span class="id" title="var">wpgen</span></span> <span class="inlinecode"><span class="id" title="var">t</span></span> <span class="inlinecode"><span class="id" title="var">Q</span></span> were proved in Coq, such a completeness result would
    be relatively unsatisfying. Indeed, this entailment asserts that if a
    program admits a behavior, then the program logic can be used to establish
    that this program admits that behavior. Yet, this statement does not capture
    the existence of a <i>pretty</i> Separation Logic proof featuring local reasoning
that is, allowing for maximal usage of the frame rule. 
</div>
<div class="code">

<span class="comment">(*&nbsp;2024-08-25&nbsp;18:06&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>